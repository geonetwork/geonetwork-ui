/*! For license information please see 5024.9a7fcf2f.iframe.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkgeonetwork_ui=self.webpackChunkgeonetwork_ui||[]).push([[5024],{"./node_modules/@camptocamp/ogc-client/dist/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{TL:()=>OgcApiEndpoint,ym:()=>WfsEndpoint,DE:()=>WmsEndpoint,bf:()=>WmtsEndpoint,cB:()=>sharedFetch,E6:()=>useCache});var asyncToGenerator=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js");let counter=0;function sendTaskRequest(taskName,workerInstance2,params){return new Promise(((resolve,reject)=>{const requestId=function worker_getUniqueId(){return counter++}(),request={requestId,taskName,params};null===workerInstance2?globalThis.dispatchEvent(new CustomEvent("ogc-client.request",{detail:request})):workerInstance2.postMessage(request);const handler=response=>{response.requestId===requestId&&(null===workerInstance2?globalThis.removeEventListener("message",windowHandler):workerInstance2.removeEventListener("message",workerHandler),"error"in response?reject(response.error):resolve(response.response))},windowHandler=event=>handler(event.detail),workerHandler=event=>handler(event.data);null===workerInstance2?globalThis.addEventListener("ogc-client.response",windowHandler):workerInstance2.addEventListener("message",workerHandler)}))}var mod,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,src_exports={};((target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})})(src_exports,{XmlCdata:()=>XmlCdata,XmlComment:()=>XmlComment,XmlDeclaration:()=>XmlDeclaration,XmlDocument:()=>XmlDocument,XmlDocumentType:()=>XmlDocumentType,XmlElement:()=>XmlElement,XmlError:()=>XmlError,XmlNode:()=>XmlNode,XmlProcessingInstruction:()=>XmlProcessingInstruction,XmlText:()=>XmlText,parseXml:()=>parseXml}),mod=src_exports,((to,from,except,desc)=>{if(from&&"object"==typeof from||"function"==typeof from)for(let key of __getOwnPropNames(from))__hasOwnProp.call(to,key)||key===except||__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})})(__defProp({},"__esModule",{value:!0}),mod);var surrogatePair=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,StringScanner=class{constructor(string){if(this.k=this.q(string,!0),this.d=0,this.length=string.length,this.n=this.k!==this.length,this.m=string,this.n){let charsToBytes=[];for(let byteIndex=0,charIndex=0;charIndex<this.k;++charIndex)charsToBytes[charIndex]=byteIndex,byteIndex+=string.codePointAt(byteIndex)>65535?2:1;this.y=charsToBytes}}get z(){return this.d>=this.k}q(string,multiByteSafe=this.n){return multiByteSafe?string.replace(surrogatePair,"_").length:string.length}g(count=1){this.d=Math.min(this.k,this.d+count)}i(charIndex=this.d){var _a;return this.n?null!=(_a=this.y[charIndex])?_a:1/0:charIndex}F(count=1){let chars=this.h(count);return this.g(count),chars}G(regex){if(!regex.sticky)throw new Error('`regex` must have a sticky flag ("y")');regex.lastIndex=this.i();let result=regex.exec(this.m);if(null===result||0===result.length)return"";let match=result[0];return this.g(this.q(match)),match}v(fn){let char,match="";for(;(char=this.h())&&fn(char);)match+=char,this.g();return match}Q(stringToConsume){if(this.b(stringToConsume))return stringToConsume;if(this.n){let{length}=stringToConsume,charLengthToMatch=this.q(stringToConsume);if(charLengthToMatch!==length&&stringToConsume===this.h(charLengthToMatch))return this.g(charLengthToMatch),stringToConsume}return""}b(stringToConsume){let{length}=stringToConsume;return this.h(length)===stringToConsume?(this.g(length),stringToConsume):""}A(regex){let restOfString=this.m.slice(this.i()),matchByteIndex=restOfString.search(regex);if(matchByteIndex<=0)return"";let result=restOfString.slice(0,matchByteIndex);return this.g(this.q(result)),result}t(searchString){let{m:string}=this,byteIndex=this.i(),matchByteIndex=string.indexOf(searchString,byteIndex);if(matchByteIndex<=0)return"";let result=string.slice(byteIndex,matchByteIndex);return this.g(this.q(result)),result}h(count=1){let{d:charIndex,n:multiByteMode,m:string}=this;return multiByteMode?charIndex>=this.k?"":string.slice(this.i(charIndex),this.i(charIndex+count)):string.slice(charIndex,charIndex+count)}o(index=0){this.d=index>=0?Math.min(this.k,index):Math.max(0,this.d+index)}},attValueCharDoubleQuote=/[^"&<]+/y,attValueCharSingleQuote=/[^'&<]+/y,attValueNormalizedWhitespace=/\r\n|[\n\r\t]/g,endCharData=/<|&|]]>/,predefinedEntities=Object.freeze(Object.assign(Object.create(null),{amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}));function isNameChar(char){let cp=getCodePoint(char);return cp>=97&&cp<=122||cp>=65&&cp<=90||cp>=48&&cp<=57||45===cp||46===cp||183===cp||cp>=768&&cp<=879||cp>=8255&&cp<=8256||isNameStartChar(char,cp)}function isNameStartChar(char,cp=getCodePoint(char)){return cp>=97&&cp<=122||cp>=65&&cp<=90||58===cp||95===cp||cp>=192&&cp<=214||cp>=216&&cp<=246||cp>=248&&cp<=767||cp>=880&&cp<=893||cp>=895&&cp<=8191||cp>=8204&&cp<=8205||cp>=8304&&cp<=8591||cp>=11264&&cp<=12271||cp>=12289&&cp<=55295||cp>=63744&&cp<=64975||cp>=65008&&cp<=65533||cp>=65536&&cp<=983039}function isReferenceChar(char){return"#"===char||isNameChar(char)}function isWhitespace(char){let cp=getCodePoint(char);return 32===cp||9===cp||10===cp||13===cp}function isXmlCodePoint(cp){return 9===cp||10===cp||13===cp||cp>=32&&cp<=55295||cp>=57344&&cp<=65533||cp>=65536&&cp<=1114111}function getCodePoint(char){return char.codePointAt(0)||-1}var _XmlNode=class{constructor(){this.parent=null,this.start=-1,this.end=-1}get document(){var _a,_b;return null!=(_b=null==(_a=this.parent)?void 0:_a.document)?_b:null}get isRootNode(){return null!==this.parent&&this.parent===this.document&&this.type===_XmlNode.TYPE_ELEMENT}get preserveWhitespace(){var _a;return!!(null==(_a=this.parent)?void 0:_a.preserveWhitespace)}get type(){return""}toJSON(){let json={type:this.type};return this.isRootNode&&(json.isRootNode=!0),this.preserveWhitespace&&(json.preserveWhitespace=!0),-1!==this.start&&(json.start=this.start,json.end=this.end),json}},XmlNode=_XmlNode;XmlNode.TYPE_CDATA="cdata",XmlNode.TYPE_COMMENT="comment",XmlNode.TYPE_DOCUMENT="document",XmlNode.TYPE_DOCUMENT_TYPE="doctype",XmlNode.TYPE_ELEMENT="element",XmlNode.TYPE_PROCESSING_INSTRUCTION="pi",XmlNode.TYPE_TEXT="text",XmlNode.TYPE_XML_DECLARATION="xmldecl";var XmlText=class extends XmlNode{constructor(text=""){super(),this.text=text}get type(){return XmlNode.TYPE_TEXT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{text:this.text})}},XmlCdata=class extends XmlText{get type(){return XmlNode.TYPE_CDATA}},XmlComment=class extends XmlNode{constructor(content=""){super(),this.content=content}get type(){return XmlNode.TYPE_COMMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{content:this.content})}},XmlDeclaration=class extends XmlNode{constructor(version,encoding,standalone){super(),this.version=version,this.encoding=null!=encoding?encoding:null,this.standalone=null!=standalone?standalone:null}get type(){return XmlNode.TYPE_XML_DECLARATION}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.version=this.version;for(let key of["encoding","standalone"])null!==this[key]&&(json[key]=this[key]);return json}},XmlElement=class extends XmlNode{constructor(name,attributes=Object.create(null),children=[]){super(),this.name=name,this.attributes=attributes,this.children=children}get isEmpty(){return 0===this.children.length}get preserveWhitespace(){let node=this;for(;node instanceof XmlElement;){if("xml:space"in node.attributes)return"preserve"===node.attributes["xml:space"];node=node.parent}return!1}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_ELEMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,attributes:this.attributes,children:this.children.map((child=>child.toJSON()))})}},XmlDocument=class extends XmlNode{constructor(children=[]){super(),this.children=children}get document(){return this}get root(){for(let child of this.children)if(child instanceof XmlElement)return child;return null}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_DOCUMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{children:this.children.map((child=>child.toJSON()))})}},XmlDocumentType=class extends XmlNode{constructor(name,publicId,systemId,internalSubset){super(),this.name=name,this.publicId=null!=publicId?publicId:null,this.systemId=null!=systemId?systemId:null,this.internalSubset=null!=internalSubset?internalSubset:null}get type(){return XmlNode.TYPE_DOCUMENT_TYPE}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.name=this.name;for(let key of["publicId","systemId","internalSubset"])null!==this[key]&&(json[key]=this[key]);return json}},XmlError=class extends Error{constructor(message,charIndex,xml){let column=1,excerpt="",line=1;for(let i=0;i<charIndex;++i){let char=xml[i];"\n"===char?(column=1,excerpt="",line+=1):(column+=1,excerpt+=char)}let eol=xml.indexOf("\n",charIndex);excerpt+=-1===eol?xml.slice(charIndex):xml.slice(charIndex,eol);let excerptStart=0;excerpt.length>50&&(column<40?excerpt=excerpt.slice(0,50):(excerptStart=column-20,excerpt=excerpt.slice(excerptStart,column+30))),super(`${message} (line ${line}, column ${column})\n  ${excerpt}\n`+" ".repeat(column-excerptStart+1)+"^\n"),this.column=column,this.excerpt=excerpt,this.line=line,this.name="XmlError",this.pos=charIndex}},XmlProcessingInstruction=class extends XmlNode{constructor(name,content=""){super(),this.name=name,this.content=content}get type(){return XmlNode.TYPE_PROCESSING_INSTRUCTION}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,content:this.content})}},Parser=class{constructor(xml,options={}){let doc=this.document=new XmlDocument,scanner=this.c=new StringScanner(xml);if(this.l=doc,this.f=options,this.f.includeOffsets&&(doc.start=0,doc.end=xml.length),scanner.b("\ufeff"),this.H(),!this.B())throw this.a("Root element is missing or invalid");for(;this.w(););if(!scanner.z)throw this.a("Extra content at the end of the document")}j(node,charIndex){return node.parent=this.l,this.f.includeOffsets&&(node.start=this.c.i(charIndex),node.end=this.c.i()),this.l.children.push(node),!0}x(text,charIndex){let{children}=this.l,{length}=children;if(text=normalizeLineBreaks(text),length>0){let prevNode=children[length-1];if((null==prevNode?void 0:prevNode.type)===XmlNode.TYPE_TEXT){let textNode=prevNode;return textNode.text+=text,this.f.includeOffsets&&(textNode.end=this.c.i()),!0}}return this.j(new XmlText(text),charIndex)}I(){let attributes=Object.create(null);for(;this.e();){let attrName=this.r();if(!attrName)break;let attrValue=this.u()&&this.J();if(!1===attrValue)throw this.a("Attribute value expected");if(attrName in attributes)throw this.a(`Duplicate attribute: ${attrName}`);if("xml:space"===attrName&&"default"!==attrValue&&"preserve"!==attrValue)throw this.a('Value of the `xml:space` attribute must be "default" or "preserve"');attributes[attrName]=attrValue}if(this.f.sortAttributes){let attrNames=Object.keys(attributes).sort(),sortedAttributes=Object.create(null);for(let i=0;i<attrNames.length;++i){let attrName=attrNames[i];sortedAttributes[attrName]=attributes[attrName]}attributes=sortedAttributes}return attributes}J(){let chars,{c:scanner}=this,quote=scanner.h();if('"'!==quote&&"'"!==quote)return!1;scanner.g();let isClosed=!1,value="",regex='"'===quote?attValueCharDoubleQuote:attValueCharSingleQuote;matchLoop:for(;!scanner.z;)switch(chars=scanner.G(regex),chars&&(this.p(chars),value+=chars.replace(attValueNormalizedWhitespace," ")),scanner.h()){case quote:isClosed=!0;break matchLoop;case"&":value+=this.C();continue;case"<":throw this.a("Unescaped `<` is not allowed in an attribute value");case"":break matchLoop}if(!isClosed)throw this.a("Unclosed attribute");return scanner.g(),value}K(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<![CDATA["))return!1;let text=scanner.t("]]>");if(this.p(text),!scanner.b("]]>"))throw this.a("Unclosed CDATA section");return this.f.preserveCdata?this.j(new XmlCdata(normalizeLineBreaks(text)),startIndex):this.x(text,startIndex)}L(){let{c:scanner}=this,startIndex=scanner.d,charData=scanner.A(endCharData);if(!charData)return!1;if(this.p(charData),"]]>"===scanner.h(3))throw this.a("Element content may not contain the CDATA section close delimiter `]]>`");return this.x(charData,startIndex)}D(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("\x3c!--"))return!1;let content=scanner.t("--");if(this.p(content),!scanner.b("--\x3e")){if("--"===scanner.h(2))throw this.a("The string `--` isn't allowed inside a comment");throw this.a("Unclosed comment")}return!this.f.preserveComments||this.j(new XmlComment(normalizeLineBreaks(content)),startIndex)}M(){let startIndex=this.c.d,ref=this.C();return!!ref&&this.x(ref,startIndex)}N(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<!DOCTYPE"))return!1;let publicId,systemId,internalSubset,name=this.e()&&this.r();if(!name)throw this.a("Expected a name");if(this.e()){if(scanner.b("PUBLIC")){if(publicId=this.e()&&this.O(),!1===publicId)throw this.a("Expected a public identifier");this.e()}if(void 0!==publicId||scanner.b("SYSTEM")){if(this.e(),systemId=this.s(),!1===systemId)throw this.a("Expected a system identifier");this.e()}}if(scanner.b("[")){if(internalSubset=scanner.A(/\][\x20\t\r\n]*>/),!scanner.b("]"))throw this.a("Unclosed internal subset");this.e()}if(!scanner.b(">"))throw this.a("Unclosed doctype declaration");return!this.f.preserveDocumentType||this.j(new XmlDocumentType(name,publicId,systemId,internalSubset),startIndex)}B(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<"))return!1;let name=this.r();if(!name)return scanner.o(startIndex),!1;let attributes=this.I(),isEmpty=!!scanner.b("/>"),element=new XmlElement(name,attributes);if(element.parent=this.l,!isEmpty){if(!scanner.b(">"))throw this.a(`Unclosed start tag for element \`${name}\``);this.l=element;do{this.L()}while(this.B()||this.M()||this.K()||this.E()||this.D());let endTagName,endTagMark=scanner.d;if(!scanner.b("</")||!(endTagName=this.r())||endTagName!==name)throw scanner.o(endTagMark),this.a(`Missing end tag for element ${name}`);if(this.e(),!scanner.b(">"))throw this.a(`Unclosed end tag for element ${name}`);this.l=element.parent}return this.j(element,startIndex)}u(){return this.e(),!!this.c.b("=")&&(this.e(),!0)}w(){return this.D()||this.E()||this.e()}r(){return isNameStartChar(this.c.h())?this.c.v(isNameChar):""}E(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?"))return!1;let name=this.r();if(!name)throw this.a("Invalid processing instruction");if("xml"===name.toLowerCase())throw scanner.o(startIndex),this.a("XML declaration isn't allowed here");if(!this.e()){if(scanner.b("?>"))return this.j(new XmlProcessingInstruction(name),startIndex);throw this.a("Whitespace is required after a processing instruction name")}let content=scanner.t("?>");if(this.p(content),!scanner.b("?>"))throw this.a("Unterminated processing instruction");return this.j(new XmlProcessingInstruction(name,normalizeLineBreaks(content)),startIndex)}H(){let{c:scanner}=this,startIndex=scanner.d;for(this.P();this.w(););if(this.N())for(;this.w(););return startIndex<scanner.d}O(){let startIndex=this.c.d,value=this.s();if(!1!==value&&!/^[-\x20\r\na-zA-Z0-9'()+,./:=?;!*#@$_%]*$/.test(value))throw this.c.o(startIndex),this.a("Invalid character in public identifier");return value}C(){let{c:scanner}=this;if(!scanner.b("&"))return!1;let parsedValue,ref=scanner.v(isReferenceChar);if(";"!==scanner.F())throw this.a("Unterminated reference (a reference must end with `;`)");if("#"===ref[0]){let codePoint="x"===ref[1]?parseInt(ref.slice(2),16):parseInt(ref.slice(1),10);if(isNaN(codePoint))throw this.a("Invalid character reference");if(!isXmlCodePoint(codePoint))throw this.a("Character reference resolves to an invalid character");parsedValue=String.fromCodePoint(codePoint)}else if(parsedValue=predefinedEntities[ref],void 0===parsedValue){let{ignoreUndefinedEntities,resolveUndefinedEntity}=this.f,wrappedRef=`&${ref};`;if(resolveUndefinedEntity){let resolvedValue=resolveUndefinedEntity(wrappedRef);if(null!=resolvedValue){let type=typeof resolvedValue;if("string"!==type)throw new TypeError(`\`resolveUndefinedEntity()\` must return a string, \`null\`, or \`undefined\`, but returned a value of type ${type}`);return resolvedValue}}if(ignoreUndefinedEntities)return wrappedRef;throw scanner.o(-wrappedRef.length),this.a(`Named entity isn't defined: ${wrappedRef}`)}return parsedValue}s(){let{c:scanner}=this,quote=scanner.b('"')||scanner.b("'");if(!quote)return!1;let value=scanner.t(quote);if(this.p(value),!scanner.b(quote))throw this.a("Missing end quote");return value}e(){return!!this.c.v(isWhitespace)}P(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?xml"))return!1;if(!this.e())throw this.a("Invalid XML declaration");let encoding,standalone,version=!!scanner.b("version")&&this.u()&&this.s();if(!1===version)throw this.a("XML version is missing or invalid");if(!/^1\.[0-9]+$/.test(version))throw this.a("Invalid character in version number");if(this.e()&&(encoding=!!scanner.b("encoding")&&this.u()&&this.s(),encoding&&this.e(),standalone=!!scanner.b("standalone")&&this.u()&&this.s(),standalone)){if("yes"!==standalone&&"no"!==standalone)throw this.a('Only "yes" and "no" are permitted as values of `standalone`');this.e()}if(!scanner.b("?>"))throw this.a("Invalid or unclosed XML declaration");return!this.f.preserveXmlDeclaration||this.j(new XmlDeclaration(version,encoding||void 0,standalone||void 0),startIndex)}a(message){let{c:scanner}=this;return new XmlError(message,scanner.d,scanner.m)}p(string){let{length}=string;for(let i=0;i<length;++i){let cp=string.codePointAt(i);if(!isXmlCodePoint(cp))throw this.c.o(-([...string].length-i)),this.a("Invalid character");cp>65535&&(i+=1)}}};function normalizeLineBreaks(text){let i=0;for(;-1!==(i=text.indexOf("\r",i));)text="\n"===text[i+1]?text.slice(0,i)+text.slice(i+1):text.slice(0,i)+"\n"+text.slice(i+1);return text}function parseXml(xml,options){return new Parser(xml,options).document}const encodedJs="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICBmdW5jdGlvbiBhZGRUYXNrSGFuZGxlcih0YXNrTmFtZSwgc2NvcGUsIGhhbmRsZXIpIHsKICAgIGNvbnN0IHVzZVdvcmtlciA9IHR5cGVvZiBXb3JrZXJHbG9iYWxTY29wZSAhPT0gInVuZGVmaW5lZCI7CiAgICBjb25zdCBldmVudEhhbmRsZXIgPSBhc3luYyAocmVxdWVzdCkgPT4gewogICAgICBpZiAocmVxdWVzdC50YXNrTmFtZSA9PT0gdGFza05hbWUpIHsKICAgICAgICBsZXQgcmVzcG9uc2UsIGVycm9yOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIocmVxdWVzdC5wYXJhbXMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGVycm9yID0gZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICgKICAgICAgICAgIC8qKiBAdHlwZSB7V29ya2VyUmVzcG9uc2V9ICovCiAgICAgICAgICB7CiAgICAgICAgICAgIHRhc2tOYW1lLAogICAgICAgICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICAgICAgICAuLi5yZXNwb25zZSAmJiB7IHJlc3BvbnNlIH0sCiAgICAgICAgICAgIC4uLmVycm9yICYmIHsgZXJyb3IgfQogICAgICAgICAgfQogICAgICAgICk7CiAgICAgICAgaWYgKHVzZVdvcmtlcikgewogICAgICAgICAgc2NvcGUucG9zdE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjb3BlLmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgIG5ldyBDdXN0b21FdmVudCgib2djLWNsaWVudC5yZXNwb25zZSIsIHsKICAgICAgICAgICAgICBkZXRhaWw6IG1lc3NhZ2UKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgaWYgKHVzZVdvcmtlcikgewogICAgICBzY29wZS5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKGV2ZW50KSA9PiBldmVudEhhbmRsZXIoZXZlbnQuZGF0YSkpOwogICAgfSBlbHNlIHsKICAgICAgc2NvcGUuYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgICAib2djLWNsaWVudC5yZXF1ZXN0IiwKICAgICAgICAoZXZlbnQpID0+IGV2ZW50SGFuZGxlcihldmVudC5kZXRhaWwpCiAgICAgICk7CiAgICB9CiAgfQogIC8qISBAcmdyb3ZlL3BhcnNlLXhtbCB2NC4xLjAgfCBJU0MgTGljZW5zZSB8IENvcHlyaWdodCBSeWFuIEdyb3ZlICovCiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgICBmb3IgKHZhciBuYW1lIGluIGFsbCkKICAgICAgX19kZWZQcm9wKHRhcmdldCwgbmFtZSwgeyBnZXQ6IGFsbFtuYW1lXSwgZW51bWVyYWJsZTogdHJ1ZSB9KTsKICB9OwogIHZhciBfX2NvcHlQcm9wcyA9ICh0bywgZnJvbSwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZm9yIChsZXQga2V5IG9mIF9fZ2V0T3duUHJvcE5hbWVzKGZyb20pKQogICAgICAgIGlmICghX19oYXNPd25Qcm9wLmNhbGwodG8sIGtleSkgJiYga2V5ICE9PSBleGNlcHQpCiAgICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgICB9CiAgICByZXR1cm4gdG87CiAgfTsKICB2YXIgX190b0NvbW1vbkpTID0gKG1vZCkgPT4gX19jb3B5UHJvcHMoX19kZWZQcm9wKHt9LCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSksIG1vZCk7CiAgdmFyIHNyY19leHBvcnRzID0ge307CiAgX19leHBvcnQoc3JjX2V4cG9ydHMsIHsKICAgIFhtbENkYXRhOiAoKSA9PiBYbWxDZGF0YSwKICAgIFhtbENvbW1lbnQ6ICgpID0+IFhtbENvbW1lbnQsCiAgICBYbWxEZWNsYXJhdGlvbjogKCkgPT4gWG1sRGVjbGFyYXRpb24sCiAgICBYbWxEb2N1bWVudDogKCkgPT4gWG1sRG9jdW1lbnQsCiAgICBYbWxEb2N1bWVudFR5cGU6ICgpID0+IFhtbERvY3VtZW50VHlwZSwKICAgIFhtbEVsZW1lbnQ6ICgpID0+IFhtbEVsZW1lbnQsCiAgICBYbWxFcnJvcjogKCkgPT4gWG1sRXJyb3IsCiAgICBYbWxOb2RlOiAoKSA9PiBYbWxOb2RlLAogICAgWG1sUHJvY2Vzc2luZ0luc3RydWN0aW9uOiAoKSA9PiBYbWxQcm9jZXNzaW5nSW5zdHJ1Y3Rpb24sCiAgICBYbWxUZXh0OiAoKSA9PiBYbWxUZXh0LAogICAgcGFyc2VYbWw6ICgpID0+IHBhcnNlWG1sCiAgfSk7CiAgdmFyIGJyb3dzZXIgPSBfX3RvQ29tbW9uSlMoc3JjX2V4cG9ydHMpOwogIHZhciBlbXB0eVN0cmluZyA9ICIiOwogIHZhciBzdXJyb2dhdGVQYWlyID0gL1tcdUQ4MDAtXHVEQkZGXVtcdURDMDAtXHVERkZGXS9nOwogIHZhciBTdHJpbmdTY2FubmVyID0gY2xhc3MgewogICAgY29uc3RydWN0b3Ioc3RyaW5nKSB7CiAgICAgIHRoaXMuayA9IHRoaXMucShzdHJpbmcsIHRydWUpOwogICAgICB0aGlzLmQgPSAwOwogICAgICB0aGlzLmxlbmd0aCA9IHN0cmluZy5sZW5ndGg7CiAgICAgIHRoaXMubiA9IHRoaXMuayAhPT0gdGhpcy5sZW5ndGg7CiAgICAgIHRoaXMubSA9IHN0cmluZzsKICAgICAgaWYgKHRoaXMubikgewogICAgICAgIGxldCBjaGFyc1RvQnl0ZXMgPSBbXTsKICAgICAgICBmb3IgKGxldCBieXRlSW5kZXggPSAwLCBjaGFySW5kZXggPSAwOyBjaGFySW5kZXggPCB0aGlzLms7ICsrY2hhckluZGV4KSB7CiAgICAgICAgICBjaGFyc1RvQnl0ZXNbY2hhckluZGV4XSA9IGJ5dGVJbmRleDsKICAgICAgICAgIGJ5dGVJbmRleCArPSBzdHJpbmcuY29kZVBvaW50QXQoYnl0ZUluZGV4KSA+IDY1NTM1ID8gMiA6IDE7CiAgICAgICAgfQogICAgICAgIHRoaXMueSA9IGNoYXJzVG9CeXRlczsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoZSBjdXJyZW50IGNoYXJhY3RlciBpbmRleCBpcyBhdCB0aGUgZW5kIG9mIHRoZSBpbnB1dCBzdHJpbmcuCiAgICAgKi8KICAgIGdldCB6KCkgewogICAgICByZXR1cm4gdGhpcy5kID49IHRoaXMuazsKICAgIH0KICAgIC8vIC0tIFByb3RlY3RlZCBNZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgY2hhcmFjdGVycyBpbiB0aGUgZ2l2ZW4gc3RyaW5nLCB3aGljaCBtYXkgZGlmZmVyIGZyb20KICAgICAqIHRoZSBieXRlIGxlbmd0aCBpZiB0aGUgc3RyaW5nIGNvbnRhaW5zIG11bHRpYnl0ZSBjaGFyYWN0ZXJzLgogICAgICovCiAgICBxKHN0cmluZywgbXVsdGlCeXRlU2FmZSA9IHRoaXMubikgewogICAgICByZXR1cm4gbXVsdGlCeXRlU2FmZSA/IHN0cmluZy5yZXBsYWNlKHN1cnJvZ2F0ZVBhaXIsICJfIikubGVuZ3RoIDogc3RyaW5nLmxlbmd0aDsKICAgIH0KICAgIC8vIC0tIFB1YmxpYyBNZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLyoqCiAgICAgKiBBZHZhbmNlcyB0aGUgc2Nhbm5lciBieSB0aGUgZ2l2ZW4gbnVtYmVyIG9mIGNoYXJhY3RlcnMsIHN0b3BwaW5nIGlmIHRoZSBlbmQKICAgICAqIG9mIHRoZSBzdHJpbmcgaXMgcmVhY2hlZC4KICAgICAqLwogICAgZyhjb3VudCA9IDEpIHsKICAgICAgdGhpcy5kID0gTWF0aC5taW4odGhpcy5rLCB0aGlzLmQgKyBjb3VudCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGJ5dGUgaW5kZXggb2YgdGhlIGdpdmVuIGNoYXJhY3RlciBpbmRleCBpbiB0aGUgc3RyaW5nLiBUaGUgdHdvCiAgICAgKiBtYXkgZGlmZmVyIGluIHN0cmluZ3MgdGhhdCBjb250YWluIG11bHRpYnl0ZSBjaGFyYWN0ZXJzLgogICAgICovCiAgICBpKGNoYXJJbmRleCA9IHRoaXMuZCkgewogICAgICB2YXIgX2E7CiAgICAgIHJldHVybiB0aGlzLm4gPyAoX2EgPSB0aGlzLnlbY2hhckluZGV4XSkgIT0gbnVsbCA/IF9hIDogSW5maW5pdHkgOiBjaGFySW5kZXg7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGFuZCByZXR1cm5zIHRoZSBnaXZlbiBudW1iZXIgb2YgY2hhcmFjdGVycyBpZiBwb3NzaWJsZSwgYWR2YW5jaW5nCiAgICAgKiB0aGUgc2Nhbm5lciBhbmQgc3RvcHBpbmcgaWYgdGhlIGVuZCBvZiB0aGUgc3RyaW5nIGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogSWYgbm8gY2hhcmFjdGVycyBjb3VsZCBiZSBjb25zdW1lZCwgYW4gZW1wdHkgc3RyaW5nIHdpbGwgYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIEYoY291bnQgPSAxKSB7CiAgICAgIGxldCBjaGFycyA9IHRoaXMuaChjb3VudCk7CiAgICAgIHRoaXMuZyhjb3VudCk7CiAgICAgIHJldHVybiBjaGFyczsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBtYXRjaCBmb3IgdGhlIGdpdmVuIHN0aWNreSByZWdleCwgYWR2YW5jZXMgdGhlIHNjYW5uZXIsIHVwZGF0ZXMKICAgICAqIHRoZSBgbGFzdEluZGV4YCBwcm9wZXJ0eSBvZiB0aGUgcmVnZXgsIGFuZCByZXR1cm5zIHRoZSBtYXRjaGluZyBzdHJpbmcuCiAgICAgKgogICAgICogVGhlIHJlZ2V4IG11c3QgaGF2ZSBhIHN0aWNreSBmbGFnICgieSIpIHNvIHRoYXQgaXRzIGBsYXN0SW5kZXhgIHByb3AgY2FuIGJlCiAgICAgKiB1c2VkIHRvIGFuY2hvciB0aGUgbWF0Y2ggYXQgdGhlIGN1cnJlbnQgc2Nhbm5lciBwb3NpdGlvbi4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjb25zdW1lZCBzdHJpbmcsIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBjb25zdW1lZC4KICAgICAqLwogICAgRyhyZWdleCkgewogICAgICBpZiAoIXJlZ2V4LnN0aWNreSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignYHJlZ2V4YCBtdXN0IGhhdmUgYSBzdGlja3kgZmxhZyAoInkiKScpOwogICAgICB9CiAgICAgIHJlZ2V4Lmxhc3RJbmRleCA9IHRoaXMuaSgpOwogICAgICBsZXQgcmVzdWx0ID0gcmVnZXguZXhlYyh0aGlzLm0pOwogICAgICBpZiAocmVzdWx0ID09PSBudWxsIHx8IHJlc3VsdC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZW1wdHlTdHJpbmc7CiAgICAgIH0KICAgICAgbGV0IG1hdGNoID0gcmVzdWx0WzBdOwogICAgICB0aGlzLmcodGhpcy5xKG1hdGNoKSk7CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYW5kIHJldHVybnMgYWxsIGNoYXJhY3RlcnMgZm9yIHdoaWNoIHRoZSBnaXZlbiBmdW5jdGlvbiByZXR1cm5zIGEKICAgICAqIHRydXRoeSB2YWx1ZSwgc3RvcHBpbmcgb24gdGhlIGZpcnN0IGZhbHN5IHJldHVybiB2YWx1ZSBvciBpZiB0aGUgZW5kIG9mIHRoZQogICAgICogaW5wdXQgaXMgcmVhY2hlZC4KICAgICAqLwogICAgdihmbikgewogICAgICBsZXQgY2hhcjsKICAgICAgbGV0IG1hdGNoID0gZW1wdHlTdHJpbmc7CiAgICAgIHdoaWxlICgoY2hhciA9IHRoaXMuaCgpKSAmJiBmbihjaGFyKSkgewogICAgICAgIG1hdGNoICs9IGNoYXI7CiAgICAgICAgdGhpcy5nKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyB0aGUgZ2l2ZW4gc3RyaW5nIGlmIGl0IGV4aXN0cyBhdCB0aGUgY3VycmVudCBjaGFyYWN0ZXIgaW5kZXgsIGFuZAogICAgICogYWR2YW5jZXMgdGhlIHNjYW5uZXIuCiAgICAgKgogICAgICogSWYgdGhlIGdpdmVuIHN0cmluZyBkb2Vzbid0IGV4aXN0IGF0IHRoZSBjdXJyZW50IGNoYXJhY3RlciBpbmRleCwgYW4gZW1wdHkKICAgICAqIHN0cmluZyB3aWxsIGJlIHJldHVybmVkIGFuZCB0aGUgc2Nhbm5lciB3aWxsIG5vdCBiZSBhZHZhbmNlZC4KICAgICAqLwogICAgUShzdHJpbmdUb0NvbnN1bWUpIHsKICAgICAgaWYgKHRoaXMuYihzdHJpbmdUb0NvbnN1bWUpKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZ1RvQ29uc3VtZTsKICAgICAgfQogICAgICBpZiAodGhpcy5uKSB7CiAgICAgICAgbGV0IHsgbGVuZ3RoIH0gPSBzdHJpbmdUb0NvbnN1bWU7CiAgICAgICAgbGV0IGNoYXJMZW5ndGhUb01hdGNoID0gdGhpcy5xKHN0cmluZ1RvQ29uc3VtZSk7CiAgICAgICAgaWYgKGNoYXJMZW5ndGhUb01hdGNoICE9PSBsZW5ndGggJiYgc3RyaW5nVG9Db25zdW1lID09PSB0aGlzLmgoY2hhckxlbmd0aFRvTWF0Y2gpKSB7CiAgICAgICAgICB0aGlzLmcoY2hhckxlbmd0aFRvTWF0Y2gpOwogICAgICAgICAgcmV0dXJuIHN0cmluZ1RvQ29uc3VtZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGVtcHR5U3RyaW5nOwogICAgfQogICAgLyoqCiAgICAgKiBEb2VzIHRoZSBzYW1lIHRoaW5nIGFzIGBjb25zdW1lU3RyaW5nKClgLCBidXQgZG9lc24ndCBzdXBwb3J0IGNvbnN1bWluZwogICAgICogbXVsdGlieXRlIGNoYXJhY3RlcnMuIFRoaXMgY2FuIGJlIGZhc3RlciBpZiB5b3Ugb25seSBuZWVkIHRvIG1hdGNoIHNpbmdsZQogICAgICogYnl0ZSBjaGFyYWN0ZXJzLgogICAgICovCiAgICBiKHN0cmluZ1RvQ29uc3VtZSkgewogICAgICBsZXQgeyBsZW5ndGggfSA9IHN0cmluZ1RvQ29uc3VtZTsKICAgICAgaWYgKHRoaXMuaChsZW5ndGgpID09PSBzdHJpbmdUb0NvbnN1bWUpIHsKICAgICAgICB0aGlzLmcobGVuZ3RoKTsKICAgICAgICByZXR1cm4gc3RyaW5nVG9Db25zdW1lOwogICAgICB9CiAgICAgIHJldHVybiBlbXB0eVN0cmluZzsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgY2hhcmFjdGVycyB1bnRpbCB0aGUgZ2l2ZW4gZ2xvYmFsIHJlZ2V4IGlzIG1hdGNoZWQsIGFkdmFuY2luZyB0aGUKICAgICAqIHNjYW5uZXIgdXAgdG8gKGJ1dCBub3QgYmV5b25kKSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBtYXRjaC4gSWYgdGhlIHJlZ2V4CiAgICAgKiBkb2Vzbid0IG1hdGNoLCBub3RoaW5nIHdpbGwgYmUgY29uc3VtZWQuCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgY29uc3VtZWQgc3RyaW5nLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgY29uc3VtZWQuCiAgICAgKi8KICAgIEEocmVnZXgpIHsKICAgICAgbGV0IHJlc3RPZlN0cmluZyA9IHRoaXMubS5zbGljZSh0aGlzLmkoKSk7CiAgICAgIGxldCBtYXRjaEJ5dGVJbmRleCA9IHJlc3RPZlN0cmluZy5zZWFyY2gocmVnZXgpOwogICAgICBpZiAobWF0Y2hCeXRlSW5kZXggPD0gMCkgewogICAgICAgIHJldHVybiBlbXB0eVN0cmluZzsKICAgICAgfQogICAgICBsZXQgcmVzdWx0ID0gcmVzdE9mU3RyaW5nLnNsaWNlKDAsIG1hdGNoQnl0ZUluZGV4KTsKICAgICAgdGhpcy5nKHRoaXMucShyZXN1bHQpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgY2hhcmFjdGVycyB1bnRpbCB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGZvdW5kLCBhZHZhbmNpbmcgdGhlIHNjYW5uZXIKICAgICAqIHVwIHRvIChidXQgbm90IGJleW9uZCkgdGhhdCBwb2ludC4gSWYgdGhlIHN0cmluZyBpcyBuZXZlciBmb3VuZCwgbm90aGluZwogICAgICogd2lsbCBiZSBjb25zdW1lZC4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjb25zdW1lZCBzdHJpbmcsIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBjb25zdW1lZC4KICAgICAqLwogICAgdChzZWFyY2hTdHJpbmcpIHsKICAgICAgbGV0IHsgbTogc3RyaW5nIH0gPSB0aGlzOwogICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5pKCk7CiAgICAgIGxldCBtYXRjaEJ5dGVJbmRleCA9IHN0cmluZy5pbmRleE9mKHNlYXJjaFN0cmluZywgYnl0ZUluZGV4KTsKICAgICAgaWYgKG1hdGNoQnl0ZUluZGV4IDw9IDApIHsKICAgICAgICByZXR1cm4gZW1wdHlTdHJpbmc7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHN0cmluZy5zbGljZShieXRlSW5kZXgsIG1hdGNoQnl0ZUluZGV4KTsKICAgICAgdGhpcy5nKHRoaXMucShyZXN1bHQpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgZ2l2ZW4gbnVtYmVyIG9mIGNoYXJhY3RlcnMgc3RhcnRpbmcgYXQgdGhlIGN1cnJlbnQgY2hhcmFjdGVyCiAgICAgKiBpbmRleCwgd2l0aG91dCBhZHZhbmNpbmcgdGhlIHNjYW5uZXIgYW5kIHdpdGhvdXQgZXhjZWVkaW5nIHRoZSBlbmQgb2YgdGhlCiAgICAgKiBpbnB1dCBzdHJpbmcuCiAgICAgKi8KICAgIGgoY291bnQgPSAxKSB7CiAgICAgIGxldCB7IGQ6IGNoYXJJbmRleCwgbjogbXVsdGlCeXRlTW9kZSwgbTogc3RyaW5nIH0gPSB0aGlzOwogICAgICBpZiAobXVsdGlCeXRlTW9kZSkgewogICAgICAgIGlmIChjaGFySW5kZXggPj0gdGhpcy5rKSB7CiAgICAgICAgICByZXR1cm4gZW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHJpbmcuc2xpY2UoCiAgICAgICAgICB0aGlzLmkoY2hhckluZGV4KSwKICAgICAgICAgIHRoaXMuaShjaGFySW5kZXggKyBjb3VudCkKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBzdHJpbmcuc2xpY2UoY2hhckluZGV4LCBjaGFySW5kZXggKyBjb3VudCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlc2V0cyB0aGUgc2Nhbm5lciBwb3NpdGlvbiB0byB0aGUgZ2l2ZW4gY2hhcmFjdGVyIF9pbmRleF8sIG9yIHRvIHRoZSBzdGFydAogICAgICogb2YgdGhlIGlucHV0IHN0cmluZyBpZiBubyBpbmRleCBpcyBnaXZlbi4KICAgICAqCiAgICAgKiBJZiBfaW5kZXhfIGlzIG5lZ2F0aXZlLCB0aGUgc2Nhbm5lciBwb3NpdGlvbiB3aWxsIGJlIG1vdmVkIGJhY2t3YXJkIGJ5IHRoYXQKICAgICAqIG1hbnkgY2hhcmFjdGVycywgc3RvcHBpbmcgaWYgdGhlIGJlZ2lubmluZyBvZiB0aGUgc3RyaW5nIGlzIHJlYWNoZWQuCiAgICAgKi8KICAgIG8oaW5kZXggPSAwKSB7CiAgICAgIHRoaXMuZCA9IGluZGV4ID49IDAgPyBNYXRoLm1pbih0aGlzLmssIGluZGV4KSA6IE1hdGgubWF4KDAsIHRoaXMuZCArIGluZGV4KTsKICAgIH0KICB9OwogIHZhciBhdHRWYWx1ZUNoYXJEb3VibGVRdW90ZSA9IC9bXiImPF0rL3k7CiAgdmFyIGF0dFZhbHVlQ2hhclNpbmdsZVF1b3RlID0gL1teJyY8XSsveTsKICB2YXIgYXR0VmFsdWVOb3JtYWxpemVkV2hpdGVzcGFjZSA9IC9cclxufFtcblxyXHRdL2c7CiAgdmFyIGVuZENoYXJEYXRhID0gLzx8JnxdXT4vOwogIHZhciBwcmVkZWZpbmVkRW50aXRpZXMgPSBPYmplY3QuZnJlZXplKE9iamVjdC5hc3NpZ24oLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksIHsKICAgIGFtcDogIiYiLAogICAgYXBvczogIiciLAogICAgZ3Q6ICI+IiwKICAgIGx0OiAiPCIsCiAgICBxdW90OiAnIicKICB9KSk7CiAgZnVuY3Rpb24gaXNOYW1lQ2hhcihjaGFyKSB7CiAgICBsZXQgY3AgPSBnZXRDb2RlUG9pbnQoY2hhcik7CiAgICByZXR1cm4gY3AgPj0gOTcgJiYgY3AgPD0gMTIyIHx8IGNwID49IDY1ICYmIGNwIDw9IDkwIHx8IGNwID49IDQ4ICYmIGNwIDw9IDU3IHx8IGNwID09PSA0NSB8fCBjcCA9PT0gNDYgfHwgY3AgPT09IDE4MyB8fCBjcCA+PSA3NjggJiYgY3AgPD0gODc5IHx8IGNwID49IDgyNTUgJiYgY3AgPD0gODI1NiB8fCBpc05hbWVTdGFydENoYXIoY2hhciwgY3ApOwogIH0KICBmdW5jdGlvbiBpc05hbWVTdGFydENoYXIoY2hhciwgY3AgPSBnZXRDb2RlUG9pbnQoY2hhcikpIHsKICAgIHJldHVybiBjcCA+PSA5NyAmJiBjcCA8PSAxMjIgfHwgY3AgPj0gNjUgJiYgY3AgPD0gOTAgfHwgY3AgPT09IDU4IHx8IGNwID09PSA5NSB8fCBjcCA+PSAxOTIgJiYgY3AgPD0gMjE0IHx8IGNwID49IDIxNiAmJiBjcCA8PSAyNDYgfHwgY3AgPj0gMjQ4ICYmIGNwIDw9IDc2NyB8fCBjcCA+PSA4ODAgJiYgY3AgPD0gODkzIHx8IGNwID49IDg5NSAmJiBjcCA8PSA4MTkxIHx8IGNwID49IDgyMDQgJiYgY3AgPD0gODIwNSB8fCBjcCA+PSA4MzA0ICYmIGNwIDw9IDg1OTEgfHwgY3AgPj0gMTEyNjQgJiYgY3AgPD0gMTIyNzEgfHwgY3AgPj0gMTIyODkgJiYgY3AgPD0gNTUyOTUgfHwgY3AgPj0gNjM3NDQgJiYgY3AgPD0gNjQ5NzUgfHwgY3AgPj0gNjUwMDggJiYgY3AgPD0gNjU1MzMgfHwgY3AgPj0gNjU1MzYgJiYgY3AgPD0gOTgzMDM5OwogIH0KICBmdW5jdGlvbiBpc1JlZmVyZW5jZUNoYXIoY2hhcikgewogICAgcmV0dXJuIGNoYXIgPT09ICIjIiB8fCBpc05hbWVDaGFyKGNoYXIpOwogIH0KICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2hhcikgewogICAgbGV0IGNwID0gZ2V0Q29kZVBvaW50KGNoYXIpOwogICAgcmV0dXJuIGNwID09PSAzMiB8fCBjcCA9PT0gOSB8fCBjcCA9PT0gMTAgfHwgY3AgPT09IDEzOwogIH0KICBmdW5jdGlvbiBpc1htbENvZGVQb2ludChjcCkgewogICAgcmV0dXJuIGNwID09PSA5IHx8IGNwID09PSAxMCB8fCBjcCA9PT0gMTMgfHwgY3AgPj0gMzIgJiYgY3AgPD0gNTUyOTUgfHwgY3AgPj0gNTczNDQgJiYgY3AgPD0gNjU1MzMgfHwgY3AgPj0gNjU1MzYgJiYgY3AgPD0gMTExNDExMTsKICB9CiAgZnVuY3Rpb24gZ2V0Q29kZVBvaW50KGNoYXIpIHsKICAgIHJldHVybiBjaGFyLmNvZGVQb2ludEF0KDApIHx8IC0xOwogIH0KICB2YXIgX1htbE5vZGUgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5wYXJlbnQgPSBudWxsOwogICAgICB0aGlzLnN0YXJ0ID0gLTE7CiAgICAgIHRoaXMuZW5kID0gLTE7CiAgICB9CiAgICAvKioKICAgICAqIERvY3VtZW50IHRoYXQgY29udGFpbnMgdGhpcyBub2RlLCBvciBgbnVsbGAgaWYgdGhpcyBub2RlIGlzIG5vdCBhc3NvY2lhdGVkCiAgICAgKiB3aXRoIGEgZG9jdW1lbnQuCiAgICAgKi8KICAgIGdldCBkb2N1bWVudCgpIHsKICAgICAgdmFyIF9hLCBfYjsKICAgICAgcmV0dXJuIChfYiA9IChfYSA9IHRoaXMucGFyZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2EuZG9jdW1lbnQpICE9IG51bGwgPyBfYiA6IG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIFdoZXRoZXIgdGhpcyBub2RlIGlzIHRoZSByb290IG5vZGUgb2YgdGhlIGRvY3VtZW50IChhbHNvIGtub3duIGFzIHRoZQogICAgICogZG9jdW1lbnQgZWxlbWVudCkuCiAgICAgKi8KICAgIGdldCBpc1Jvb3ROb2RlKCkgewogICAgICByZXR1cm4gdGhpcy5wYXJlbnQgIT09IG51bGwgJiYgdGhpcy5wYXJlbnQgPT09IHRoaXMuZG9jdW1lbnQgJiYgdGhpcy50eXBlID09PSBfWG1sTm9kZS5UWVBFX0VMRU1FTlQ7CiAgICB9CiAgICAvKioKICAgICAqIFdoZXRoZXIgd2hpdGVzcGFjZSBzaG91bGQgYmUgcHJlc2VydmVkIGluIHRoZSBjb250ZW50IG9mIHRoaXMgZWxlbWVudCBhbmQKICAgICAqIGl0cyBjaGlsZHJlbi4KICAgICAqCiAgICAgKiBUaGlzIGlzIGluZmx1ZW5jZWQgYnkgdGhlIHZhbHVlIG9mIHRoZSBzcGVjaWFsIGB4bWw6c3BhY2VgIGF0dHJpYnV0ZSwgYW5kCiAgICAgKiB3aWxsIGJlIGB0cnVlYCBmb3IgYW55IG5vZGUgd2hvc2UgYHhtbDpzcGFjZWAgYXR0cmlidXRlIGlzIHNldCB0bwogICAgICogInByZXNlcnZlIi4gSWYgYSBub2RlIGhhcyBubyBzdWNoIGF0dHJpYnV0ZSwgaXQgd2lsbCBpbmhlcml0IHRoZSB2YWx1ZSBvZgogICAgICogdGhlIG5lYXJlc3QgYW5jZXN0b3IgdGhhdCBkb2VzIChpZiBhbnkpLgogICAgICoKICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLXdoaXRlLXNwYWNlCiAgICAgKi8KICAgIGdldCBwcmVzZXJ2ZVdoaXRlc3BhY2UoKSB7CiAgICAgIHZhciBfYTsKICAgICAgcmV0dXJuICEhKChfYSA9IHRoaXMucGFyZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2EucHJlc2VydmVXaGl0ZXNwYWNlKTsKICAgIH0KICAgIC8qKgogICAgICogVHlwZSBvZiB0aGlzIG5vZGUuCiAgICAgKgogICAgICogVGhlIHZhbHVlIG9mIHRoaXMgcHJvcGVydHkgaXMgYSBzdHJpbmcgdGhhdCBtYXRjaGVzIG9uZSBvZiB0aGUgc3RhdGljCiAgICAgKiBgVFlQRV8qYCBwcm9wZXJ0aWVzIG9uIHRoZSBgWG1sTm9kZWAgY2xhc3MgKGUuZy4gYFRZUEVfRUxFTUVOVGAsCiAgICAgKiBgVFlQRV9URVhUYCwgZXRjLikuCiAgICAgKgogICAgICogVGhlIGBYbWxOb2RlYCBjbGFzcyBpdHNlbGYgaXMgYSBiYXNlIGNsYXNzIGFuZCBkb2Vzbid0IGhhdmUgaXRzIG93biB0eXBlCiAgICAgKiBuYW1lLgogICAgICovCiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuICIiOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgSlNPTi1zZXJpYWxpemFibGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGlzIG5vZGUsIG1pbnVzIHByb3BlcnRpZXMKICAgICAqIHRoYXQgY291bGQgcmVzdWx0IGluIGNpcmN1bGFyIHJlZmVyZW5jZXMuCiAgICAgKi8KICAgIHRvSlNPTigpIHsKICAgICAgbGV0IGpzb24gPSB7CiAgICAgICAgdHlwZTogdGhpcy50eXBlCiAgICAgIH07CiAgICAgIGlmICh0aGlzLmlzUm9vdE5vZGUpIHsKICAgICAgICBqc29uLmlzUm9vdE5vZGUgPSB0cnVlOwogICAgICB9CiAgICAgIGlmICh0aGlzLnByZXNlcnZlV2hpdGVzcGFjZSkgewogICAgICAgIGpzb24ucHJlc2VydmVXaGl0ZXNwYWNlID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy5zdGFydCAhPT0gLTEpIHsKICAgICAgICBqc29uLnN0YXJ0ID0gdGhpcy5zdGFydDsKICAgICAgICBqc29uLmVuZCA9IHRoaXMuZW5kOwogICAgICB9CiAgICAgIHJldHVybiBqc29uOwogICAgfQogIH07CiAgdmFyIFhtbE5vZGUgPSBfWG1sTm9kZTsKICBYbWxOb2RlLlRZUEVfQ0RBVEEgPSAiY2RhdGEiOwogIFhtbE5vZGUuVFlQRV9DT01NRU5UID0gImNvbW1lbnQiOwogIFhtbE5vZGUuVFlQRV9ET0NVTUVOVCA9ICJkb2N1bWVudCI7CiAgWG1sTm9kZS5UWVBFX0RPQ1VNRU5UX1RZUEUgPSAiZG9jdHlwZSI7CiAgWG1sTm9kZS5UWVBFX0VMRU1FTlQgPSAiZWxlbWVudCI7CiAgWG1sTm9kZS5UWVBFX1BST0NFU1NJTkdfSU5TVFJVQ1RJT04gPSAicGkiOwogIFhtbE5vZGUuVFlQRV9URVhUID0gInRleHQiOwogIFhtbE5vZGUuVFlQRV9YTUxfREVDTEFSQVRJT04gPSAieG1sZGVjbCI7CiAgdmFyIFhtbFRleHQgPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IodGV4dCA9ICIiKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB9CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9URVhUOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIHRleHQ6IHRoaXMudGV4dAogICAgICB9KTsKICAgIH0KICB9OwogIHZhciBYbWxDZGF0YSA9IGNsYXNzIGV4dGVuZHMgWG1sVGV4dCB7CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9DREFUQTsKICAgIH0KICB9OwogIHZhciBYbWxDb21tZW50ID0gY2xhc3MgZXh0ZW5kcyBYbWxOb2RlIHsKICAgIGNvbnN0cnVjdG9yKGNvbnRlbnQgPSAiIikgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLmNvbnRlbnQgPSBjb250ZW50OwogICAgfQogICAgZ2V0IHR5cGUoKSB7CiAgICAgIHJldHVybiBYbWxOb2RlLlRZUEVfQ09NTUVOVDsKICAgIH0KICAgIHRvSlNPTigpIHsKICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oWG1sTm9kZS5wcm90b3R5cGUudG9KU09OLmNhbGwodGhpcyksIHsKICAgICAgICBjb250ZW50OiB0aGlzLmNvbnRlbnQKICAgICAgfSk7CiAgICB9CiAgfTsKICB2YXIgWG1sRGVjbGFyYXRpb24gPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IodmVyc2lvbiwgZW5jb2RpbmcsIHN0YW5kYWxvbmUpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjsKICAgICAgdGhpcy5lbmNvZGluZyA9IGVuY29kaW5nICE9IG51bGwgPyBlbmNvZGluZyA6IG51bGw7CiAgICAgIHRoaXMuc3RhbmRhbG9uZSA9IHN0YW5kYWxvbmUgIT0gbnVsbCA/IHN0YW5kYWxvbmUgOiBudWxsOwogICAgfQogICAgZ2V0IHR5cGUoKSB7CiAgICAgIHJldHVybiBYbWxOb2RlLlRZUEVfWE1MX0RFQ0xBUkFUSU9OOwogICAgfQogICAgdG9KU09OKCkgewogICAgICBsZXQganNvbiA9IFhtbE5vZGUucHJvdG90eXBlLnRvSlNPTi5jYWxsKHRoaXMpOwogICAgICBqc29uLnZlcnNpb24gPSB0aGlzLnZlcnNpb247CiAgICAgIGZvciAobGV0IGtleSBvZiBbImVuY29kaW5nIiwgInN0YW5kYWxvbmUiXSkgewogICAgICAgIGlmICh0aGlzW2tleV0gIT09IG51bGwpIHsKICAgICAgICAgIGpzb25ba2V5XSA9IHRoaXNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpzb247CiAgICB9CiAgfTsKICB2YXIgWG1sRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgWG1sTm9kZSB7CiAgICBjb25zdHJ1Y3RvcihuYW1lLCBhdHRyaWJ1dGVzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksIGNoaWxkcmVuID0gW10pIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgfQogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoaXMgZWxlbWVudCBpcyBlbXB0eSAobWVhbmluZyBpdCBoYXMgbm8gY2hpbGRyZW4pLgogICAgICovCiAgICBnZXQgaXNFbXB0eSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4ubGVuZ3RoID09PSAwOwogICAgfQogICAgZ2V0IHByZXNlcnZlV2hpdGVzcGFjZSgpIHsKICAgICAgbGV0IG5vZGUgPSB0aGlzOwogICAgICB3aGlsZSAobm9kZSBpbnN0YW5jZW9mIFhtbEVsZW1lbnQpIHsKICAgICAgICBpZiAoInhtbDpzcGFjZSIgaW4gbm9kZS5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5hdHRyaWJ1dGVzWyJ4bWw6c3BhY2UiXSA9PT0gInByZXNlcnZlIjsKICAgICAgICB9CiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50OwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogVGV4dCBjb250ZW50IG9mIHRoaXMgZWxlbWVudCBhbmQgYWxsIGl0cyBkZXNjZW5kYW50cy4KICAgICAqLwogICAgZ2V0IHRleHQoKSB7CiAgICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLm1hcCgoY2hpbGQpID0+ICJ0ZXh0IiBpbiBjaGlsZCA/IGNoaWxkLnRleHQgOiAiIikuam9pbigiIik7CiAgICB9CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9FTEVNRU5UOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICBhdHRyaWJ1dGVzOiB0aGlzLmF0dHJpYnV0ZXMsCiAgICAgICAgY2hpbGRyZW46IHRoaXMuY2hpbGRyZW4ubWFwKChjaGlsZCkgPT4gY2hpbGQudG9KU09OKCkpCiAgICAgIH0pOwogICAgfQogIH07CiAgdmFyIFhtbERvY3VtZW50ID0gY2xhc3MgZXh0ZW5kcyBYbWxOb2RlIHsKICAgIGNvbnN0cnVjdG9yKGNoaWxkcmVuID0gW10pIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgfQogICAgZ2V0IGRvY3VtZW50KCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogUm9vdCBlbGVtZW50IG9mIHRoaXMgZG9jdW1lbnQsIG9yIGBudWxsYCBpZiB0aGlzIGRvY3VtZW50IGlzIGVtcHR5LgogICAgICovCiAgICBnZXQgcm9vdCgpIHsKICAgICAgZm9yIChsZXQgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIFhtbEVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIFRleHQgY29udGVudCBvZiB0aGlzIGRvY3VtZW50IGFuZCBhbGwgaXRzIGRlc2NlbmRhbnRzLgogICAgICovCiAgICBnZXQgdGV4dCgpIHsKICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4ubWFwKChjaGlsZCkgPT4gInRleHQiIGluIGNoaWxkID8gY2hpbGQudGV4dCA6ICIiKS5qb2luKCIiKTsKICAgIH0KICAgIGdldCB0eXBlKCkgewogICAgICByZXR1cm4gWG1sTm9kZS5UWVBFX0RPQ1VNRU5UOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIGNoaWxkcmVuOiB0aGlzLmNoaWxkcmVuLm1hcCgoY2hpbGQpID0+IGNoaWxkLnRvSlNPTigpKQogICAgICB9KTsKICAgIH0KICB9OwogIHZhciBYbWxEb2N1bWVudFR5cGUgPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IobmFtZSwgcHVibGljSWQsIHN5c3RlbUlkLCBpbnRlcm5hbFN1YnNldCkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnB1YmxpY0lkID0gcHVibGljSWQgIT0gbnVsbCA/IHB1YmxpY0lkIDogbnVsbDsKICAgICAgdGhpcy5zeXN0ZW1JZCA9IHN5c3RlbUlkICE9IG51bGwgPyBzeXN0ZW1JZCA6IG51bGw7CiAgICAgIHRoaXMuaW50ZXJuYWxTdWJzZXQgPSBpbnRlcm5hbFN1YnNldCAhPSBudWxsID8gaW50ZXJuYWxTdWJzZXQgOiBudWxsOwogICAgfQogICAgZ2V0IHR5cGUoKSB7CiAgICAgIHJldHVybiBYbWxOb2RlLlRZUEVfRE9DVU1FTlRfVFlQRTsKICAgIH0KICAgIHRvSlNPTigpIHsKICAgICAgbGV0IGpzb24gPSBYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKTsKICAgICAganNvbi5uYW1lID0gdGhpcy5uYW1lOwogICAgICBmb3IgKGxldCBrZXkgb2YgWyJwdWJsaWNJZCIsICJzeXN0ZW1JZCIsICJpbnRlcm5hbFN1YnNldCJdKSB7CiAgICAgICAgaWYgKHRoaXNba2V5XSAhPT0gbnVsbCkgewogICAgICAgICAganNvbltrZXldID0gdGhpc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4ganNvbjsKICAgIH0KICB9OwogIHZhciBYbWxFcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3IgewogICAgY29uc3RydWN0b3IobWVzc2FnZSwgY2hhckluZGV4LCB4bWwpIHsKICAgICAgbGV0IGNvbHVtbiA9IDE7CiAgICAgIGxldCBleGNlcnB0ID0gIiI7CiAgICAgIGxldCBsaW5lID0gMTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFySW5kZXg7ICsraSkgewogICAgICAgIGxldCBjaGFyID0geG1sW2ldOwogICAgICAgIGlmIChjaGFyID09PSAiXG4iKSB7CiAgICAgICAgICBjb2x1bW4gPSAxOwogICAgICAgICAgZXhjZXJwdCA9ICIiOwogICAgICAgICAgbGluZSArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb2x1bW4gKz0gMTsKICAgICAgICAgIGV4Y2VycHQgKz0gY2hhcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IGVvbCA9IHhtbC5pbmRleE9mKCJcbiIsIGNoYXJJbmRleCk7CiAgICAgIGV4Y2VycHQgKz0gZW9sID09PSAtMSA/IHhtbC5zbGljZShjaGFySW5kZXgpIDogeG1sLnNsaWNlKGNoYXJJbmRleCwgZW9sKTsKICAgICAgbGV0IGV4Y2VycHRTdGFydCA9IDA7CiAgICAgIGlmIChleGNlcnB0Lmxlbmd0aCA+IDUwKSB7CiAgICAgICAgaWYgKGNvbHVtbiA8IDQwKSB7CiAgICAgICAgICBleGNlcnB0ID0gZXhjZXJwdC5zbGljZSgwLCA1MCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4Y2VycHRTdGFydCA9IGNvbHVtbiAtIDIwOwogICAgICAgICAgZXhjZXJwdCA9IGV4Y2VycHQuc2xpY2UoZXhjZXJwdFN0YXJ0LCBjb2x1bW4gKyAzMCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1cGVyKAogICAgICAgIGAke21lc3NhZ2V9IChsaW5lICR7bGluZX0sIGNvbHVtbiAke2NvbHVtbn0pCiAgJHtleGNlcnB0fQpgICsgIiAiLnJlcGVhdChjb2x1bW4gLSBleGNlcnB0U3RhcnQgKyAxKSArICJeXG4iCiAgICAgICk7CiAgICAgIHRoaXMuY29sdW1uID0gY29sdW1uOwogICAgICB0aGlzLmV4Y2VycHQgPSBleGNlcnB0OwogICAgICB0aGlzLmxpbmUgPSBsaW5lOwogICAgICB0aGlzLm5hbWUgPSAiWG1sRXJyb3IiOwogICAgICB0aGlzLnBvcyA9IGNoYXJJbmRleDsKICAgIH0KICB9OwogIHZhciBYbWxQcm9jZXNzaW5nSW5zdHJ1Y3Rpb24gPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IobmFtZSwgY29udGVudCA9ICIiKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuY29udGVudCA9IGNvbnRlbnQ7CiAgICB9CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9QUk9DRVNTSU5HX0lOU1RSVUNUSU9OOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICBjb250ZW50OiB0aGlzLmNvbnRlbnQKICAgICAgfSk7CiAgICB9CiAgfTsKICB2YXIgZW1wdHlTdHJpbmcyID0gIiI7CiAgdmFyIFBhcnNlciA9IGNsYXNzIHsKICAgIC8qKgogICAgICogQHBhcmFtIHhtbCBYTUwgc3RyaW5nIHRvIHBhcnNlLgogICAgICogQHBhcmFtIG9wdGlvbnMgUGFyc2VyIG9wdGlvbnMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHhtbCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGxldCBkb2MgPSB0aGlzLmRvY3VtZW50ID0gbmV3IFhtbERvY3VtZW50KCk7CiAgICAgIGxldCBzY2FubmVyID0gdGhpcy5jID0gbmV3IFN0cmluZ1NjYW5uZXIoeG1sKTsKICAgICAgdGhpcy5sID0gZG9jOwogICAgICB0aGlzLmYgPSBvcHRpb25zOwogICAgICBpZiAodGhpcy5mLmluY2x1ZGVPZmZzZXRzKSB7CiAgICAgICAgZG9jLnN0YXJ0ID0gMDsKICAgICAgICBkb2MuZW5kID0geG1sLmxlbmd0aDsKICAgICAgfQogICAgICBzY2FubmVyLmIoIlx1RkVGRiIpOwogICAgICB0aGlzLkgoKTsKICAgICAgaWYgKCF0aGlzLkIoKSkgewogICAgICAgIHRocm93IHRoaXMuYSgiUm9vdCBlbGVtZW50IGlzIG1pc3Npbmcgb3IgaW52YWxpZCIpOwogICAgICB9CiAgICAgIHdoaWxlICh0aGlzLncoKSkgewogICAgICB9CiAgICAgIGlmICghc2Nhbm5lci56KSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJFeHRyYSBjb250ZW50IGF0IHRoZSBlbmQgb2YgdGhlIGRvY3VtZW50Iik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQWRkcyB0aGUgZ2l2ZW4gYFhtbE5vZGVgIGFzIGEgY2hpbGQgb2YgYHRoaXMuY3VycmVudE5vZGVgLgogICAgICovCiAgICBqKG5vZGUsIGNoYXJJbmRleCkgewogICAgICBub2RlLnBhcmVudCA9IHRoaXMubDsKICAgICAgaWYgKHRoaXMuZi5pbmNsdWRlT2Zmc2V0cykgewogICAgICAgIG5vZGUuc3RhcnQgPSB0aGlzLmMuaShjaGFySW5kZXgpOwogICAgICAgIG5vZGUuZW5kID0gdGhpcy5jLmkoKTsKICAgICAgfQogICAgICB0aGlzLmwuY2hpbGRyZW4ucHVzaChub2RlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgdGhlIGdpdmVuIF90ZXh0XyB0byB0aGUgZG9jdW1lbnQsIGVpdGhlciBieSBhcHBlbmRpbmcgaXQgdG8gYQogICAgICogcHJlY2VkaW5nIGBYbWxUZXh0YCBub2RlIChpZiBwb3NzaWJsZSkgb3IgYnkgY3JlYXRpbmcgYSBuZXcgYFhtbFRleHRgIG5vZGUuCiAgICAgKi8KICAgIHgodGV4dCwgY2hhckluZGV4KSB7CiAgICAgIGxldCB7IGNoaWxkcmVuIH0gPSB0aGlzLmw7CiAgICAgIGxldCB7IGxlbmd0aCB9ID0gY2hpbGRyZW47CiAgICAgIHRleHQgPSBub3JtYWxpemVMaW5lQnJlYWtzKHRleHQpOwogICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgIGxldCBwcmV2Tm9kZSA9IGNoaWxkcmVuW2xlbmd0aCAtIDFdOwogICAgICAgIGlmICgocHJldk5vZGUgPT0gbnVsbCA/IHZvaWQgMCA6IHByZXZOb2RlLnR5cGUpID09PSBYbWxOb2RlLlRZUEVfVEVYVCkgewogICAgICAgICAgbGV0IHRleHROb2RlID0gcHJldk5vZGU7CiAgICAgICAgICB0ZXh0Tm9kZS50ZXh0ICs9IHRleHQ7CiAgICAgICAgICBpZiAodGhpcy5mLmluY2x1ZGVPZmZzZXRzKSB7CiAgICAgICAgICAgIHRleHROb2RlLmVuZCA9IHRoaXMuYy5pKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaihuZXcgWG1sVGV4dCh0ZXh0KSwgY2hhckluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgZWxlbWVudCBhdHRyaWJ1dGVzLgogICAgICoKICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLXN0YXJ0dGFncwogICAgICovCiAgICBJKCkgewogICAgICBsZXQgYXR0cmlidXRlcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB3aGlsZSAodGhpcy5lKCkpIHsKICAgICAgICBsZXQgYXR0ck5hbWUgPSB0aGlzLnIoKTsKICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgbGV0IGF0dHJWYWx1ZSA9IHRoaXMudSgpICYmIHRoaXMuSigpOwogICAgICAgIGlmIChhdHRyVmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIkF0dHJpYnV0ZSB2YWx1ZSBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoYXR0ck5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgdGhyb3cgdGhpcy5hKGBEdXBsaWNhdGUgYXR0cmlidXRlOiAke2F0dHJOYW1lfWApOwogICAgICAgIH0KICAgICAgICBpZiAoYXR0ck5hbWUgPT09ICJ4bWw6c3BhY2UiICYmIGF0dHJWYWx1ZSAhPT0gImRlZmF1bHQiICYmIGF0dHJWYWx1ZSAhPT0gInByZXNlcnZlIikgewogICAgICAgICAgdGhyb3cgdGhpcy5hKCdWYWx1ZSBvZiB0aGUgYHhtbDpzcGFjZWAgYXR0cmlidXRlIG11c3QgYmUgImRlZmF1bHQiIG9yICJwcmVzZXJ2ZSInKTsKICAgICAgICB9CiAgICAgICAgYXR0cmlidXRlc1thdHRyTmFtZV0gPSBhdHRyVmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZi5zb3J0QXR0cmlidXRlcykgewogICAgICAgIGxldCBhdHRyTmFtZXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKS5zb3J0KCk7CiAgICAgICAgbGV0IHNvcnRlZEF0dHJpYnV0ZXMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dHJOYW1lcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgbGV0IGF0dHJOYW1lID0gYXR0ck5hbWVzW2ldOwogICAgICAgICAgc29ydGVkQXR0cmlidXRlc1thdHRyTmFtZV0gPSBhdHRyaWJ1dGVzW2F0dHJOYW1lXTsKICAgICAgICB9CiAgICAgICAgYXR0cmlidXRlcyA9IHNvcnRlZEF0dHJpYnV0ZXM7CiAgICAgIH0KICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGFuIGBBdHRWYWx1ZWAgKGF0dHJpYnV0ZSB2YWx1ZSkgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMKICAgICAqICAgQ29udGVudHMgb2YgdGhlIGBBdHRWYWx1ZWAgbWludXMgcXVvdGVzLCBvciBgZmFsc2VgIGlmIG5vdGhpbmcgd2FzCiAgICAgKiAgIGNvbnN1bWVkLiBBbiBlbXB0eSBzdHJpbmcgaW5kaWNhdGVzIHRoYXQgYW4gYEF0dFZhbHVlYCB3YXMgY29uc3VtZWQgYnV0CiAgICAgKiAgIHdhcyBlbXB0eS4KICAgICAqCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULUF0dFZhbHVlCiAgICAgKi8KICAgIEooKSB7CiAgICAgIGxldCB7IGM6IHNjYW5uZXIgfSA9IHRoaXM7CiAgICAgIGxldCBxdW90ZSA9IHNjYW5uZXIuaCgpOwogICAgICBpZiAocXVvdGUgIT09ICciJyAmJiBxdW90ZSAhPT0gIiciKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHNjYW5uZXIuZygpOwogICAgICBsZXQgY2hhcnM7CiAgICAgIGxldCBpc0Nsb3NlZCA9IGZhbHNlOwogICAgICBsZXQgdmFsdWUgPSBlbXB0eVN0cmluZzI7CiAgICAgIGxldCByZWdleCA9IHF1b3RlID09PSAnIicgPyBhdHRWYWx1ZUNoYXJEb3VibGVRdW90ZSA6IGF0dFZhbHVlQ2hhclNpbmdsZVF1b3RlOwogICAgICBtYXRjaExvb3A6CiAgICAgICAgd2hpbGUgKCFzY2FubmVyLnopIHsKICAgICAgICAgIGNoYXJzID0gc2Nhbm5lci5HKHJlZ2V4KTsKICAgICAgICAgIGlmIChjaGFycykgewogICAgICAgICAgICB0aGlzLnAoY2hhcnMpOwogICAgICAgICAgICB2YWx1ZSArPSBjaGFycy5yZXBsYWNlKGF0dFZhbHVlTm9ybWFsaXplZFdoaXRlc3BhY2UsICIgIik7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHNjYW5uZXIuaCgpKSB7CiAgICAgICAgICAgIGNhc2UgcXVvdGU6CiAgICAgICAgICAgICAgaXNDbG9zZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrIG1hdGNoTG9vcDsKICAgICAgICAgICAgY2FzZSAiJiI6CiAgICAgICAgICAgICAgdmFsdWUgKz0gdGhpcy5DKCk7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGNhc2UgIjwiOgogICAgICAgICAgICAgIHRocm93IHRoaXMuYSgiVW5lc2NhcGVkIGA8YCBpcyBub3QgYWxsb3dlZCBpbiBhbiBhdHRyaWJ1dGUgdmFsdWUiKTsKICAgICAgICAgICAgY2FzZSBlbXB0eVN0cmluZzI6CiAgICAgICAgICAgICAgYnJlYWsgbWF0Y2hMb29wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgaWYgKCFpc0Nsb3NlZCkgewogICAgICAgIHRocm93IHRoaXMuYSgiVW5jbG9zZWQgYXR0cmlidXRlIik7CiAgICAgIH0KICAgICAgc2Nhbm5lci5nKCk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBDREFUQSBzZWN0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYSBDREFUQSBzZWN0aW9uIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLWNkYXRhLXNlY3QKICAgICAqLwogICAgSygpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8IVtDREFUQVsiKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgdGV4dCA9IHNjYW5uZXIudCgiXV0+Iik7CiAgICAgIHRoaXMucCh0ZXh0KTsKICAgICAgaWYgKCFzY2FubmVyLmIoIl1dPiIpKSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJVbmNsb3NlZCBDREFUQSBzZWN0aW9uIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZi5wcmVzZXJ2ZUNkYXRhID8gdGhpcy5qKG5ldyBYbWxDZGF0YShub3JtYWxpemVMaW5lQnJlYWtzKHRleHQpKSwgc3RhcnRJbmRleCkgOiB0aGlzLngodGV4dCwgc3RhcnRJbmRleCk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGNoYXJhY3RlciBkYXRhIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgY2hhcmFjdGVyIGRhdGEgd2FzIGNvbnN1bWVkLgogICAgICogQHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sLTIwMDgxMTI2LyNkdC1jaGFyZGF0YQogICAgICovCiAgICBMKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBsZXQgc3RhcnRJbmRleCA9IHNjYW5uZXIuZDsKICAgICAgbGV0IGNoYXJEYXRhID0gc2Nhbm5lci5BKGVuZENoYXJEYXRhKTsKICAgICAgaWYgKCFjaGFyRGF0YSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB0aGlzLnAoY2hhckRhdGEpOwogICAgICBpZiAoc2Nhbm5lci5oKDMpID09PSAiXV0+IikgewogICAgICAgIHRocm93IHRoaXMuYSgiRWxlbWVudCBjb250ZW50IG1heSBub3QgY29udGFpbiB0aGUgQ0RBVEEgc2VjdGlvbiBjbG9zZSBkZWxpbWl0ZXIgYF1dPmAiKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy54KGNoYXJEYXRhLCBzdGFydEluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBjb21tZW50IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYSBjb21tZW50IHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtQ29tbWVudAogICAgICovCiAgICBEKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBsZXQgc3RhcnRJbmRleCA9IHNjYW5uZXIuZDsKICAgICAgaWYgKCFzY2FubmVyLmIoIjwhLS0iKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgY29udGVudCA9IHNjYW5uZXIudCgiLS0iKTsKICAgICAgdGhpcy5wKGNvbnRlbnQpOwogICAgICBpZiAoIXNjYW5uZXIuYigiLS0+IikpIHsKICAgICAgICBpZiAoc2Nhbm5lci5oKDIpID09PSAiLS0iKSB7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIlRoZSBzdHJpbmcgYC0tYCBpc24ndCBhbGxvd2VkIGluc2lkZSBhIGNvbW1lbnQiKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgdGhpcy5hKCJVbmNsb3NlZCBjb21tZW50Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZi5wcmVzZXJ2ZUNvbW1lbnRzID8gdGhpcy5qKG5ldyBYbWxDb21tZW50KG5vcm1hbGl6ZUxpbmVCcmVha3MoY29udGVudCkpLCBzdGFydEluZGV4KSA6IHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGEgcmVmZXJlbmNlIGluIGEgY29udGVudCBjb250ZXh0IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIFRoaXMgZGlmZmVycyBmcm9tIGBjb25zdW1lUmVmZXJlbmNlKClgIGluIHRoYXQgYSBjb25zdW1lZCByZWZlcmVuY2Ugd2lsbCBiZQogICAgICogYWRkZWQgdG8gdGhlIGRvY3VtZW50IGFzIGEgdGV4dCBub2RlIGluc3RlYWQgb2YgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhIHJlZmVyZW5jZSB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI2VudHByb2MKICAgICAqLwogICAgTSgpIHsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSB0aGlzLmMuZDsKICAgICAgbGV0IHJlZiA9IHRoaXMuQygpOwogICAgICByZXR1cm4gcmVmID8gdGhpcy54KHJlZiwgc3RhcnRJbmRleCkgOiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBkb2N0eXBlIGRlY2xhcmF0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIFRoaXMgaXMgYSBsb29zZSBpbXBsZW1lbnRhdGlvbiBzaW5jZSBkb2N0eXBlIGRlY2xhcmF0aW9ucyBhcmUgY3VycmVudGx5CiAgICAgKiBkaXNjYXJkZWQgd2l0aG91dCBmdXJ0aGVyIHBhcnNpbmcuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhIGRvY3R5cGUgZGVjbGFyYXRpb24gd2FzIGNvbnN1bWVkLgogICAgICogQHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sLTIwMDgxMTI2LyNkdGQKICAgICAqLwogICAgTigpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8IURPQ1RZUEUiKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgbmFtZSA9IHRoaXMuZSgpICYmIHRoaXMucigpOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIkV4cGVjdGVkIGEgbmFtZSIpOwogICAgICB9CiAgICAgIGxldCBwdWJsaWNJZDsKICAgICAgbGV0IHN5c3RlbUlkOwogICAgICBpZiAodGhpcy5lKCkpIHsKICAgICAgICBpZiAoc2Nhbm5lci5iKCJQVUJMSUMiKSkgewogICAgICAgICAgcHVibGljSWQgPSB0aGlzLmUoKSAmJiB0aGlzLk8oKTsKICAgICAgICAgIGlmIChwdWJsaWNJZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgdGhyb3cgdGhpcy5hKCJFeHBlY3RlZCBhIHB1YmxpYyBpZGVudGlmaWVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHB1YmxpY0lkICE9PSB2b2lkIDAgfHwgc2Nhbm5lci5iKCJTWVNURU0iKSkgewogICAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgICBzeXN0ZW1JZCA9IHRoaXMucygpOwogICAgICAgICAgaWYgKHN5c3RlbUlkID09PSBmYWxzZSkgewogICAgICAgICAgICB0aHJvdyB0aGlzLmEoIkV4cGVjdGVkIGEgc3lzdGVtIGlkZW50aWZpZXIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgaW50ZXJuYWxTdWJzZXQ7CiAgICAgIGlmIChzY2FubmVyLmIoIlsiKSkgewogICAgICAgIGludGVybmFsU3Vic2V0ID0gc2Nhbm5lci5BKC9cXVtceDIwXHRcclxuXSo+Lyk7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIl0iKSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKCJVbmNsb3NlZCBpbnRlcm5hbCBzdWJzZXQiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lKCk7CiAgICAgIH0KICAgICAgaWYgKCFzY2FubmVyLmIoIj4iKSkgewogICAgICAgIHRocm93IHRoaXMuYSgiVW5jbG9zZWQgZG9jdHlwZSBkZWNsYXJhdGlvbiIpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmYucHJlc2VydmVEb2N1bWVudFR5cGUgPyB0aGlzLmoobmV3IFhtbERvY3VtZW50VHlwZShuYW1lLCBwdWJsaWNJZCwgc3lzdGVtSWQsIGludGVybmFsU3Vic2V0KSwgc3RhcnRJbmRleCkgOiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBhbiBlbGVtZW50IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYW4gZWxlbWVudCB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULWVsZW1lbnQKICAgICAqLwogICAgQigpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8IikpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGV0IG5hbWUgPSB0aGlzLnIoKTsKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgc2Nhbm5lci5vKHN0YXJ0SW5kZXgpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgYXR0cmlidXRlcyA9IHRoaXMuSSgpOwogICAgICBsZXQgaXNFbXB0eSA9ICEhc2Nhbm5lci5iKCIvPiIpOwogICAgICBsZXQgZWxlbWVudCA9IG5ldyBYbWxFbGVtZW50KG5hbWUsIGF0dHJpYnV0ZXMpOwogICAgICBlbGVtZW50LnBhcmVudCA9IHRoaXMubDsKICAgICAgaWYgKCFpc0VtcHR5KSB7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIj4iKSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKGBVbmNsb3NlZCBzdGFydCB0YWcgZm9yIGVsZW1lbnQgXGAke25hbWV9XGBgKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sID0gZWxlbWVudDsKICAgICAgICBkbyB7CiAgICAgICAgICB0aGlzLkwoKTsKICAgICAgICB9IHdoaWxlICh0aGlzLkIoKSB8fCB0aGlzLk0oKSB8fCB0aGlzLksoKSB8fCB0aGlzLkUoKSB8fCB0aGlzLkQoKSk7CiAgICAgICAgbGV0IGVuZFRhZ01hcmsgPSBzY2FubmVyLmQ7CiAgICAgICAgbGV0IGVuZFRhZ05hbWU7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIjwvIikgfHwgIShlbmRUYWdOYW1lID0gdGhpcy5yKCkpIHx8IGVuZFRhZ05hbWUgIT09IG5hbWUpIHsKICAgICAgICAgIHNjYW5uZXIubyhlbmRUYWdNYXJrKTsKICAgICAgICAgIHRocm93IHRoaXMuYShgTWlzc2luZyBlbmQgdGFnIGZvciBlbGVtZW50ICR7bmFtZX1gKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIj4iKSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKGBVbmNsb3NlZCBlbmQgdGFnIGZvciBlbGVtZW50ICR7bmFtZX1gKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sID0gZWxlbWVudC5wYXJlbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaihlbGVtZW50LCBzdGFydEluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYW4gYEVxYCBwcm9kdWN0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYW4gYEVxYCBwcm9kdWN0aW9uIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtRXEKICAgICAqLwogICAgdSgpIHsKICAgICAgdGhpcy5lKCk7CiAgICAgIGlmICh0aGlzLmMuYigiPSIpKSB7CiAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBgTWlzY2AgY29udGVudCBpZiBwb3NzaWJsZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyBXaGV0aGVyIGFueXRoaW5nIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtTWlzYwogICAgICovCiAgICB3KCkgewogICAgICByZXR1cm4gdGhpcy5EKCkgfHwgdGhpcy5FKCkgfHwgdGhpcy5lKCk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIG9uZSBvciBtb3JlIGBOYW1lYCBjaGFyYWN0ZXJzIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIGBOYW1lYCBjaGFyYWN0ZXJzLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm9uZSB3ZXJlIGNvbnN1bWVkLgogICAgICogQHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sLTIwMDgxMTI2LyNOVC1OYW1lCiAgICAgKi8KICAgIHIoKSB7CiAgICAgIHJldHVybiBpc05hbWVTdGFydENoYXIodGhpcy5jLmgoKSkgPyB0aGlzLmMudihpc05hbWVDaGFyKSA6IGVtcHR5U3RyaW5nMjsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBwcm9jZXNzaW5nIGluc3RydWN0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYSBwcm9jZXNzaW5nIGluc3RydWN0aW9uIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLXBpCiAgICAgKi8KICAgIEUoKSB7CiAgICAgIGxldCB7IGM6IHNjYW5uZXIgfSA9IHRoaXM7CiAgICAgIGxldCBzdGFydEluZGV4ID0gc2Nhbm5lci5kOwogICAgICBpZiAoIXNjYW5uZXIuYigiPD8iKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgbmFtZSA9IHRoaXMucigpOwogICAgICBpZiAobmFtZSkgewogICAgICAgIGlmIChuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ4bWwiKSB7CiAgICAgICAgICBzY2FubmVyLm8oc3RhcnRJbmRleCk7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIlhNTCBkZWNsYXJhdGlvbiBpc24ndCBhbGxvd2VkIGhlcmUiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJJbnZhbGlkIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb24iKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuZSgpKSB7CiAgICAgICAgaWYgKHNjYW5uZXIuYigiPz4iKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuaihuZXcgWG1sUHJvY2Vzc2luZ0luc3RydWN0aW9uKG5hbWUpLCBzdGFydEluZGV4KTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgdGhpcy5hKCJXaGl0ZXNwYWNlIGlzIHJlcXVpcmVkIGFmdGVyIGEgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBuYW1lIik7CiAgICAgIH0KICAgICAgbGV0IGNvbnRlbnQgPSBzY2FubmVyLnQoIj8+Iik7CiAgICAgIHRoaXMucChjb250ZW50KTsKICAgICAgaWYgKCFzY2FubmVyLmIoIj8+IikpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIlVudGVybWluYXRlZCBwcm9jZXNzaW5nIGluc3RydWN0aW9uIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaihuZXcgWG1sUHJvY2Vzc2luZ0luc3RydWN0aW9uKG5hbWUsIG5vcm1hbGl6ZUxpbmVCcmVha3MoY29udGVudCkpLCBzdGFydEluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBwcm9sb2cgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhIHByb2xvZyB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI3NlYy1wcm9sb2ctZHRkCiAgICAgKi8KICAgIEgoKSB7CiAgICAgIGxldCB7IGM6IHNjYW5uZXIgfSA9IHRoaXM7CiAgICAgIGxldCBzdGFydEluZGV4ID0gc2Nhbm5lci5kOwogICAgICB0aGlzLlAoKTsKICAgICAgd2hpbGUgKHRoaXMudygpKSB7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuTigpKSB7CiAgICAgICAgd2hpbGUgKHRoaXMudygpKSB7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzdGFydEluZGV4IDwgc2Nhbm5lci5kOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBhIHB1YmxpYyBpZGVudGlmaWVyIGxpdGVyYWwgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMKICAgICAqICAgVmFsdWUgb2YgdGhlIHB1YmxpYyBpZGVudGlmaWVyIGxpdGVyYWwgbWludXMgcXVvdGVzLCBvciBgZmFsc2VgIGlmCiAgICAgKiAgIG5vdGhpbmcgd2FzIGNvbnN1bWVkLiBBbiBlbXB0eSBzdHJpbmcgaW5kaWNhdGVzIHRoYXQgYSBwdWJsaWMgaWQgbGl0ZXJhbAogICAgICogICB3YXMgY29uc3VtZWQgYnV0IHdhcyBlbXB0eS4KICAgICAqCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULVB1YmlkTGl0ZXJhbAogICAgICovCiAgICBPKCkgewogICAgICBsZXQgc3RhcnRJbmRleCA9IHRoaXMuYy5kOwogICAgICBsZXQgdmFsdWUgPSB0aGlzLnMoKTsKICAgICAgaWYgKHZhbHVlICE9PSBmYWxzZSAmJiAhL15bLVx4MjBcclxuYS16QS1aMC05JygpKywuLzo9PzshKiNAJF8lXSokLy50ZXN0KHZhbHVlKSkgewogICAgICAgIHRoaXMuYy5vKHN0YXJ0SW5kZXgpOwogICAgICAgIHRocm93IHRoaXMuYSgiSW52YWxpZCBjaGFyYWN0ZXIgaW4gcHVibGljIGlkZW50aWZpZXIiKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGEgcmVmZXJlbmNlIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIFRoaXMgZGlmZmVycyBmcm9tIGBjb25zdW1lQ29udGVudFJlZmVyZW5jZSgpYCBpbiB0aGF0IGEgY29uc3VtZWQgcmVmZXJlbmNlCiAgICAgKiB3aWxsIGJlIHJldHVybmVkIHJhdGhlciB0aGFuIGFkZGVkIHRvIHRoZSBkb2N1bWVudC4KICAgICAqCiAgICAgKiBAcmV0dXJucwogICAgICogICBQYXJzZWQgcmVmZXJlbmNlIHZhbHVlLCBvciBgZmFsc2VgIGlmIG5vdGhpbmcgd2FzIGNvbnN1bWVkICh0bwogICAgICogICBkaXN0aW5ndWlzaCBmcm9tIGEgcmVmZXJlbmNlIHRoYXQgcmVzb2x2ZXMgdG8gYW4gZW1wdHkgc3RyaW5nKS4KICAgICAqCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULVJlZmVyZW5jZQogICAgICovCiAgICBDKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBpZiAoIXNjYW5uZXIuYigiJiIpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxldCByZWYgPSBzY2FubmVyLnYoaXNSZWZlcmVuY2VDaGFyKTsKICAgICAgaWYgKHNjYW5uZXIuRigpICE9PSAiOyIpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIlVudGVybWluYXRlZCByZWZlcmVuY2UgKGEgcmVmZXJlbmNlIG11c3QgZW5kIHdpdGggYDtgKSIpOwogICAgICB9CiAgICAgIGxldCBwYXJzZWRWYWx1ZTsKICAgICAgaWYgKHJlZlswXSA9PT0gIiMiKSB7CiAgICAgICAgbGV0IGNvZGVQb2ludCA9IHJlZlsxXSA9PT0gIngiID8gcGFyc2VJbnQocmVmLnNsaWNlKDIpLCAxNikgOiBwYXJzZUludChyZWYuc2xpY2UoMSksIDEwKTsKICAgICAgICBpZiAoaXNOYU4oY29kZVBvaW50KSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKCJJbnZhbGlkIGNoYXJhY3RlciByZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc1htbENvZGVQb2ludChjb2RlUG9pbnQpKSB7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIkNoYXJhY3RlciByZWZlcmVuY2UgcmVzb2x2ZXMgdG8gYW4gaW52YWxpZCBjaGFyYWN0ZXIiKTsKICAgICAgICB9CiAgICAgICAgcGFyc2VkVmFsdWUgPSBTdHJpbmcuZnJvbUNvZGVQb2ludChjb2RlUG9pbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnNlZFZhbHVlID0gcHJlZGVmaW5lZEVudGl0aWVzW3JlZl07CiAgICAgICAgaWYgKHBhcnNlZFZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgIGxldCB7CiAgICAgICAgICAgIGlnbm9yZVVuZGVmaW5lZEVudGl0aWVzLAogICAgICAgICAgICByZXNvbHZlVW5kZWZpbmVkRW50aXR5CiAgICAgICAgICB9ID0gdGhpcy5mOwogICAgICAgICAgbGV0IHdyYXBwZWRSZWYgPSBgJiR7cmVmfTtgOwogICAgICAgICAgaWYgKHJlc29sdmVVbmRlZmluZWRFbnRpdHkpIHsKICAgICAgICAgICAgbGV0IHJlc29sdmVkVmFsdWUgPSByZXNvbHZlVW5kZWZpbmVkRW50aXR5KHdyYXBwZWRSZWYpOwogICAgICAgICAgICBpZiAocmVzb2x2ZWRWYWx1ZSAhPT0gbnVsbCAmJiByZXNvbHZlZFZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiByZXNvbHZlZFZhbHVlOwogICAgICAgICAgICAgIGlmICh0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgXGByZXNvbHZlVW5kZWZpbmVkRW50aXR5KClcYCBtdXN0IHJldHVybiBhIHN0cmluZywgXGBudWxsXGAsIG9yIFxgdW5kZWZpbmVkXGAsIGJ1dCByZXR1cm5lZCBhIHZhbHVlIG9mIHR5cGUgJHt0eXBlfWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlnbm9yZVVuZGVmaW5lZEVudGl0aWVzKSB7CiAgICAgICAgICAgIHJldHVybiB3cmFwcGVkUmVmOwogICAgICAgICAgfQogICAgICAgICAgc2Nhbm5lci5vKC13cmFwcGVkUmVmLmxlbmd0aCk7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoYE5hbWVkIGVudGl0eSBpc24ndCBkZWZpbmVkOiAke3dyYXBwZWRSZWZ9YCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwYXJzZWRWYWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBgU3lzdGVtTGl0ZXJhbGAgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQSBgU3lzdGVtTGl0ZXJhbGAgaXMgc2ltaWxhciB0byBhbiBhdHRyaWJ1dGUgdmFsdWUsIGJ1dCBhbGxvd3MgdGhlCiAgICAgKiBjaGFyYWN0ZXJzIGA8YCBhbmQgYCZgIGFuZCBkb2Vzbid0IHJlcGxhY2UgcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiBAcmV0dXJucwogICAgICogICBWYWx1ZSBvZiB0aGUgYFN5c3RlbUxpdGVyYWxgIG1pbnVzIHF1b3Rlcywgb3IgYGZhbHNlYCBpZiBub3RoaW5nIHdhcwogICAgICogICBjb25zdW1lZC4gQW4gZW1wdHkgc3RyaW5nIGluZGljYXRlcyB0aGF0IGEgYFN5c3RlbUxpdGVyYWxgIHdhcyBjb25zdW1lZAogICAgICogICBidXQgd2FzIGVtcHR5LgogICAgICoKICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtU3lzdGVtTGl0ZXJhbAogICAgICovCiAgICBzKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBsZXQgcXVvdGUgPSBzY2FubmVyLmIoJyInKSB8fCBzY2FubmVyLmIoIiciKTsKICAgICAgaWYgKCFxdW90ZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgdmFsdWUgPSBzY2FubmVyLnQocXVvdGUpOwogICAgICB0aGlzLnAodmFsdWUpOwogICAgICBpZiAoIXNjYW5uZXIuYihxdW90ZSkpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIk1pc3NpbmcgZW5kIHF1b3RlIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBvbmUgb3IgbW9yZSB3aGl0ZXNwYWNlIGNoYXJhY3RlcnMgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhbnkgd2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHdlcmUgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI3doaXRlCiAgICAgKi8KICAgIGUoKSB7CiAgICAgIHJldHVybiAhIXRoaXMuYy52KGlzV2hpdGVzcGFjZSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGFuIFhNTCBkZWNsYXJhdGlvbiBpZiBwb3NzaWJsZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyBXaGV0aGVyIGFuIFhNTCBkZWNsYXJhdGlvbiB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULVhNTERlY2wKICAgICAqLwogICAgUCgpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8P3htbCIpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICghdGhpcy5lKCkpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIkludmFsaWQgWE1MIGRlY2xhcmF0aW9uIik7CiAgICAgIH0KICAgICAgbGV0IHZlcnNpb24gPSAhIXNjYW5uZXIuYigidmVyc2lvbiIpICYmIHRoaXMudSgpICYmIHRoaXMucygpOwogICAgICBpZiAodmVyc2lvbiA9PT0gZmFsc2UpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIlhNTCB2ZXJzaW9uIGlzIG1pc3Npbmcgb3IgaW52YWxpZCIpOwogICAgICB9IGVsc2UgaWYgKCEvXjFcLlswLTldKyQvLnRlc3QodmVyc2lvbikpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIkludmFsaWQgY2hhcmFjdGVyIGluIHZlcnNpb24gbnVtYmVyIik7CiAgICAgIH0KICAgICAgbGV0IGVuY29kaW5nOwogICAgICBsZXQgc3RhbmRhbG9uZTsKICAgICAgaWYgKHRoaXMuZSgpKSB7CiAgICAgICAgZW5jb2RpbmcgPSAhIXNjYW5uZXIuYigiZW5jb2RpbmciKSAmJiB0aGlzLnUoKSAmJiB0aGlzLnMoKTsKICAgICAgICBpZiAoZW5jb2RpbmcpIHsKICAgICAgICAgIHRoaXMuZSgpOwogICAgICAgIH0KICAgICAgICBzdGFuZGFsb25lID0gISFzY2FubmVyLmIoInN0YW5kYWxvbmUiKSAmJiB0aGlzLnUoKSAmJiB0aGlzLnMoKTsKICAgICAgICBpZiAoc3RhbmRhbG9uZSkgewogICAgICAgICAgaWYgKHN0YW5kYWxvbmUgIT09ICJ5ZXMiICYmIHN0YW5kYWxvbmUgIT09ICJubyIpIHsKICAgICAgICAgICAgdGhyb3cgdGhpcy5hKCdPbmx5ICJ5ZXMiIGFuZCAibm8iIGFyZSBwZXJtaXR0ZWQgYXMgdmFsdWVzIG9mIGBzdGFuZGFsb25lYCcpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghc2Nhbm5lci5iKCI/PiIpKSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJJbnZhbGlkIG9yIHVuY2xvc2VkIFhNTCBkZWNsYXJhdGlvbiIpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmYucHJlc2VydmVYbWxEZWNsYXJhdGlvbiA/IHRoaXMuaihuZXcgWG1sRGVjbGFyYXRpb24oCiAgICAgICAgdmVyc2lvbiwKICAgICAgICBlbmNvZGluZyB8fCB2b2lkIDAsCiAgICAgICAgc3RhbmRhbG9uZSB8fCB2b2lkIDAKICAgICAgKSwgc3RhcnRJbmRleCkgOiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFuIGBYbWxFcnJvcmAgZm9yIHRoZSBjdXJyZW50IHNjYW5uZXIgcG9zaXRpb24uCiAgICAgKi8KICAgIGEobWVzc2FnZSkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFhtbEVycm9yKG1lc3NhZ2UsIHNjYW5uZXIuZCwgc2Nhbm5lci5tKTsKICAgIH0KICAgIC8qKgogICAgICogVGhyb3dzIGFuIGludmFsaWQgY2hhcmFjdGVyIGVycm9yIGlmIGFueSBjaGFyYWN0ZXIgaW4gdGhlIGdpdmVuIF9zdHJpbmdfCiAgICAgKiBpc24ndCBhIHZhbGlkIFhNTCBjaGFyYWN0ZXIuCiAgICAgKi8KICAgIHAoc3RyaW5nKSB7CiAgICAgIGxldCB7IGxlbmd0aCB9ID0gc3RyaW5nOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgbGV0IGNwID0gc3RyaW5nLmNvZGVQb2ludEF0KGkpOwogICAgICAgIGlmICghaXNYbWxDb2RlUG9pbnQoY3ApKSB7CiAgICAgICAgICB0aGlzLmMubygtKFsuLi5zdHJpbmddLmxlbmd0aCAtIGkpKTsKICAgICAgICAgIHRocm93IHRoaXMuYSgiSW52YWxpZCBjaGFyYWN0ZXIiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNwID4gNjU1MzUpIHsKICAgICAgICAgIGkgKz0gMTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIGZ1bmN0aW9uIG5vcm1hbGl6ZUxpbmVCcmVha3ModGV4dCkgewogICAgbGV0IGkgPSAwOwogICAgd2hpbGUgKChpID0gdGV4dC5pbmRleE9mKCJcciIsIGkpKSAhPT0gLTEpIHsKICAgICAgdGV4dCA9IHRleHRbaSArIDFdID09PSAiXG4iID8gdGV4dC5zbGljZSgwLCBpKSArIHRleHQuc2xpY2UoaSArIDEpIDogdGV4dC5zbGljZSgwLCBpKSArICJcbiIgKyB0ZXh0LnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIHJldHVybiB0ZXh0OwogIH0KICBmdW5jdGlvbiBwYXJzZVhtbCh4bWwsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgUGFyc2VyKHhtbCwgb3B0aW9ucykuZG9jdW1lbnQ7CiAgfQogIGNsYXNzIFhtbFBhcnNlRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlKSB7CiAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgfQogIH0KICBmdW5jdGlvbiBwYXJzZVhtbFN0cmluZyh4bWxTdHJpbmcpIHsKICAgIGxldCBkb2MgPSBudWxsOwogICAgdHJ5IHsKICAgICAgZG9jID0gYnJvd3Nlci5wYXJzZVhtbCh4bWxTdHJpbmcpOwogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgWG1sUGFyc2VFcnJvcihlLm1lc3NhZ2UpOwogICAgfQogICAgcmV0dXJuIGRvYzsKICB9CiAgZnVuY3Rpb24gc3RyaXBOYW1lc3BhY2UobmFtZSkgewogICAgY29uc3QgY29sb24gPSBuYW1lLmluZGV4T2YoIjoiKTsKICAgIHJldHVybiBjb2xvbiA+IC0xID8gbmFtZS5zdWJzdHIoY29sb24gKyAxKSA6IG5hbWU7CiAgfQogIGZ1bmN0aW9uIGdldFJvb3RFbGVtZW50KHhtbERvYykgewogICAgcmV0dXJuIHhtbERvYy5jaGlsZHJlblswXTsKICB9CiAgZnVuY3Rpb24gZ2V0RWxlbWVudE5hbWUoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQubmFtZSB8fCAiIjsKICB9CiAgZnVuY3Rpb24gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCBuYW1lLCBuZXN0ZWQgPSBmYWxzZSkgewogICAgY29uc3Qgc3RyaXBwZWROYW1lID0gc3RyaXBOYW1lc3BhY2UobmFtZSk7CiAgICBmdW5jdGlvbiByZWR1Y2VyKHByZXYsIGN1cnIpIHsKICAgICAgaWYgKHN0cmlwTmFtZXNwYWNlKGdldEVsZW1lbnROYW1lKGN1cnIpKSA9PT0gc3RyaXBwZWROYW1lKSB7CiAgICAgICAgcHJldi5wdXNoKGN1cnIpOwogICAgICB9CiAgICAgIGlmIChuZXN0ZWQgJiYgQXJyYXkuaXNBcnJheShjdXJyLmNoaWxkcmVuKSkgewogICAgICAgIHJldHVybiBbLi4ucHJldiwgLi4uY3Vyci5jaGlsZHJlbi5yZWR1Y2UocmVkdWNlciwgW10pXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gcHJldjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGVsZW1lbnQgJiYgQXJyYXkuaXNBcnJheShlbGVtZW50LmNoaWxkcmVuKSA/IGVsZW1lbnQuY2hpbGRyZW4ucmVkdWNlKHJlZHVjZXIsIFtdKSA6IFtdOwogIH0KICBmdW5jdGlvbiBmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsIG5hbWUsIG5lc3RlZCA9IGZhbHNlKSB7CiAgICByZXR1cm4gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCBuYW1lLCBuZXN0ZWQpWzBdIHx8IG51bGw7CiAgfQogIGZ1bmN0aW9uIGdldENoaWxkcmVuRWxlbWVudChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudCAmJiBBcnJheS5pc0FycmF5KGVsZW1lbnQuY2hpbGRyZW4pID8gWwogICAgICAuLi5lbGVtZW50LmNoaWxkcmVuLmZpbHRlcigKICAgICAgICAoZWwpID0+IGVsIGluc3RhbmNlb2YgYnJvd3Nlci5YbWxFbGVtZW50CiAgICAgICkKICAgIF0gOiBbXTsKICB9CiAgZnVuY3Rpb24gZ2V0RWxlbWVudFRleHQoZWxlbWVudCkgewogICAgY29uc3QgdGV4dE5vZGUgPSBlbGVtZW50ICYmIEFycmF5LmlzQXJyYXkoZWxlbWVudC5jaGlsZHJlbikgPyBlbGVtZW50LmNoaWxkcmVuLmZpbmQoKG5vZGUpID0+IG5vZGUudHlwZSA9PT0gInRleHQiKSA6IG51bGw7CiAgICByZXR1cm4gdGV4dE5vZGUgPyB0ZXh0Tm9kZS50ZXh0IDogIiI7CiAgfQogIGZ1bmN0aW9uIGdldEVsZW1lbnRBdHRyaWJ1dGUoZWxlbWVudCwgYXR0ck5hbWUpIHsKICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQuYXR0cmlidXRlc1thdHRyTmFtZV0gfHwgIiI7CiAgfQogIGNsYXNzIEVuZHBvaW50RXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBodHRwU3RhdHVzLCBpc0Nyb3NzT3JpZ2luUmVsYXRlZCkgewogICAgICBzdXBlcihtZXNzYWdlKTsKICAgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICAgICAgdGhpcy5odHRwU3RhdHVzID0gaHR0cFN0YXR1czsKICAgICAgdGhpcy5pc0Nyb3NzT3JpZ2luUmVsYXRlZCA9IGlzQ3Jvc3NPcmlnaW5SZWxhdGVkOwogICAgfQogIH0KICBjb25zdCBFTkNPRElOR1MgPSBbInV0Zi04IiwgInV0Zi0xNiIsICJpc28tODg1OS0xIl07CiAgY29uc3QgRkFMTEJBQ0tfRU5DT0RJTkcgPSAidXRmLTgiOwogIGZ1bmN0aW9uIGV4dHJhY3RFbmNvZGluZyhjb250ZW50VHlwZSkgewogICAgY29uc3QgbWF0Y2hlcyA9IC9jaGFyc2V0PShbXjtdKykvLmV4ZWMoY29udGVudFR5cGUpOwogICAgcmV0dXJuIG1hdGNoZXMgPyBtYXRjaGVzWzFdIDogbnVsbDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlU3RyaW5nKGJ1ZmZlciwgY29udGVudFR5cGUpIHsKICAgIGNvbnN0IGVuY29kaW5nSGludCA9IGNvbnRlbnRUeXBlID8gZXh0cmFjdEVuY29kaW5nKGNvbnRlbnRUeXBlKSA6IG51bGw7CiAgICBjb25zdCBlbmNvZGluZ0F0dGVtcHRzID0gZW5jb2RpbmdIaW50ID8gW2VuY29kaW5nSGludCwgLi4uRU5DT0RJTkdTXSA6IEVOQ09ESU5HUzsKICAgIGZvciAoY29uc3QgZW5jb2Rpbmcgb2YgZW5jb2RpbmdBdHRlbXB0cykgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoZW5jb2RpbmcsIHsgZmF0YWw6IHRydWUgfSk7CiAgICAgICAgcmV0dXJuIGRlY29kZXIuZGVjb2RlKGJ1ZmZlcik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgfQogICAgfQogICAgY29uc29sZS53YXJuKAogICAgICBgW29nYy1jbGllbnRdIFhNTCBkb2N1bWVudCBlbmNvZGluZyBjb3VsZCBub3QgYmUgZGV0ZXJtaW5lZCwgZmFsbGluZyBiYWNrIHRvICR7RkFMTEJBQ0tfRU5DT0RJTkd9LmAKICAgICk7CiAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKEZBTExCQUNLX0VOQ09ESU5HKS5kZWNvZGUoYnVmZmVyKTsKICB9CiAgY29uc3QgZmV0Y2hQcm9taXNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IGZldGNoT3B0aW9ucyA9IHt9OwogIGZ1bmN0aW9uIHNldEZldGNoT3B0aW9ucyhvcHRpb25zKSB7CiAgICBmZXRjaE9wdGlvbnMgPSBvcHRpb25zOwogIH0KICBmdW5jdGlvbiBnZXRGZXRjaE9wdGlvbnMoKSB7CiAgICByZXR1cm4gZmV0Y2hPcHRpb25zOwogIH0KICBmdW5jdGlvbiBzaGFyZWRGZXRjaCh1cmwsIG1ldGhvZCA9ICJHRVQiLCBhc0pzb24pIHsKICAgIGxldCBmZXRjaEtleSA9IGAke21ldGhvZH0jJHt1cmx9YDsKICAgIGlmIChhc0pzb24pIHsKICAgICAgZmV0Y2hLZXkgPSBgJHttZXRob2R9I2FzSnNvbiMke3VybH1gOwogICAgfQogICAgaWYgKGZldGNoUHJvbWlzZXMuaGFzKGZldGNoS2V5KSkgewogICAgICByZXR1cm4gZmV0Y2hQcm9taXNlcy5nZXQoZmV0Y2hLZXkpOwogICAgfQogICAgY29uc3Qgb3B0aW9ucyA9IHsgLi4uZ2V0RmV0Y2hPcHRpb25zKCkgfTsKICAgIG9wdGlvbnMubWV0aG9kID0gbWV0aG9kOwogICAgaWYgKGFzSnNvbikgewogICAgICBvcHRpb25zLmhlYWRlcnMgPSAiaGVhZGVycyIgaW4gb3B0aW9ucyA/IG9wdGlvbnMuaGVhZGVycyA6IHt9OwogICAgICBvcHRpb25zLmhlYWRlcnNbIkFjY2VwdCJdID0gImFwcGxpY2F0aW9uL2pzb24iOwogICAgfQogICAgY29uc3QgcHJvbWlzZSA9IGZldGNoKHVybCwgb3B0aW9ucykuY2F0Y2goKGUpID0+IGUpLnRoZW4oKHJlc3ApID0+IHsKICAgICAgZmV0Y2hQcm9taXNlcy5kZWxldGUoZmV0Y2hLZXkpOwogICAgICByZXR1cm4gcmVzcDsKICAgIH0pOwogICAgZmV0Y2hQcm9taXNlcy5zZXQoZmV0Y2hLZXksIHByb21pc2UpOwogICAgcmV0dXJuIHByb21pc2UudGhlbigocmVzcCkgPT4gewogICAgICBpZiAocmVzcCBpbnN0YW5jZW9mIEVycm9yKQogICAgICAgIHRocm93IHJlc3A7CiAgICAgIHJldHVybiByZXNwOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHF1ZXJ5WG1sRG9jdW1lbnQodXJsKSB7CiAgICByZXR1cm4gc2hhcmVkRmV0Y2godXJsKS5jYXRjaCgKICAgICAgKCkgPT4gKAogICAgICAgIC8vIGF0dGVtcHQgYSBIRUFEIHRvIHNlZSBpZiB0aGUgZmFpbHVyZSBjb21lcyBmcm9tIENPUlMgb3IgdGhlIHNlcnZpY2UgaXMgZ2VuZXJhbGx5IHVucmVhY2hhYmxlCiAgICAgICAgZmV0Y2godXJsLCB7IC4uLmdldEZldGNoT3B0aW9ucygpLCBtZXRob2Q6ICJIRUFEIiwgbW9kZTogIm5vLWNvcnMiIH0pLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgdGhyb3cgbmV3IEVuZHBvaW50RXJyb3IoCiAgICAgICAgICAgIGBGZXRjaGluZyB0aGUgZG9jdW1lbnQgZmFpbGVkIGVpdGhlciBkdWUgdG8gbmV0d29yayBlcnJvcnMgb3IgdW5yZWFjaGFibGUgaG9zdCwgZXJyb3IgaXM6ICR7ZXJyb3IubWVzc2FnZX1gLAogICAgICAgICAgICAwLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KS50aGVuKCgpID0+IHsKICAgICAgICAgIHRocm93IG5ldyBFbmRwb2ludEVycm9yKAogICAgICAgICAgICBgVGhlIGRvY3VtZW50IGNvdWxkIG5vdCBiZSBmZXRjaGVkIGR1ZSB0byBDT1JTIGxpbWl0YXRpb25zYCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICB9KQogICAgICApCiAgICApLnRoZW4oYXN5bmMgKHJlc3ApID0+IHsKICAgICAgaWYgKCFyZXNwLm9rKSB7CiAgICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IHJlc3AudGV4dCgpOwogICAgICAgIHRocm93IG5ldyBFbmRwb2ludEVycm9yKAogICAgICAgICAgYFJlY2VpdmVkIGFuIGVycm9yIHdpdGggY29kZSAke3Jlc3Auc3RhdHVzfTogJHt0ZXh0fWAsCiAgICAgICAgICByZXNwLnN0YXR1cywKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgfQogICAgICBjb25zdCBidWZmZXIgPSBhd2FpdCByZXNwLmFycmF5QnVmZmVyKCk7CiAgICAgIGNvbnN0IGNvbnRlbnRUeXBlSGVhZGVyID0gcmVzcC5oZWFkZXJzLmdldCgiQ29udGVudC1UeXBlIik7CiAgICAgIHJldHVybiBkZWNvZGVTdHJpbmcoYnVmZmVyLCBjb250ZW50VHlwZUhlYWRlcik7CiAgICB9KS50aGVuKCh4bWwpID0+IHBhcnNlWG1sU3RyaW5nKHhtbCkpOwogIH0KICBmdW5jdGlvbiBzZXRRdWVyeVBhcmFtcyh1cmwsIHBhcmFtcykgewogICAgY29uc3QgZW5jb2RlZFVybE1hdGNoID0gdXJsLm1hdGNoKC8oaHR0cHM/JTNBJTJGJTJGW14vXSspJC8pOwogICAgaWYgKGVuY29kZWRVcmxNYXRjaCkgewogICAgICBjb25zdCBlbmNvZGVkVXJsID0gZW5jb2RlZFVybE1hdGNoWzFdOwogICAgICBjb25zdCBtb2RpZmllZFVybCA9IHNldFF1ZXJ5UGFyYW1zKGRlY29kZVVSSUNvbXBvbmVudChlbmNvZGVkVXJsKSwgcGFyYW1zKTsKICAgICAgcmV0dXJuIHVybC5yZXBsYWNlKGVuY29kZWRVcmwsIGVuY29kZVVSSUNvbXBvbmVudChtb2RpZmllZFVybCkpOwogICAgfQogICAgY29uc3QgdXJsT2JqID0gbmV3IFVSTCh1cmwpOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7CiAgICBjb25zdCBrZXlzTG93ZXIgPSBrZXlzLm1hcCgoa2V5KSA9PiBrZXkudG9Mb3dlckNhc2UoKSk7CiAgICBjb25zdCB0b0RlbGV0ZSA9IFtdOwogICAgZm9yIChjb25zdCBwYXJhbSBvZiB1cmxPYmouc2VhcmNoUGFyYW1zLmtleXMoKSkgewogICAgICBpZiAoa2V5c0xvd2VyLmluZGV4T2YocGFyYW0udG9Mb3dlckNhc2UoKSkgPiAtMSkgewogICAgICAgIHRvRGVsZXRlLnB1c2gocGFyYW0pOwogICAgICB9CiAgICB9CiAgICB0b0RlbGV0ZS5tYXAoKHBhcmFtKSA9PiB1cmxPYmouc2VhcmNoUGFyYW1zLmRlbGV0ZShwYXJhbSkpOwogICAga2V5cy5mb3JFYWNoKAogICAgICAoa2V5KSA9PiB1cmxPYmouc2VhcmNoUGFyYW1zLnNldCgKICAgICAgICBrZXksCiAgICAgICAgcGFyYW1zW2tleV0gPT09IHRydWUgPyAiIiA6IHBhcmFtc1trZXldCiAgICAgICkKICAgICk7CiAgICByZXR1cm4gdXJsT2JqLnRvU3RyaW5nKCk7CiAgfQogIGNsYXNzIFNlcnZpY2VFeGNlcHRpb25FcnJvciBleHRlbmRzIEVycm9yIHsKICAgIC8qKgogICAgICogQ29uc3RydWN0b3IKICAgICAqIEBwYXJhbSBtZXNzYWdlIEVycm9yIG1lc3NhZ2UKICAgICAqIEBwYXJhbSByZXF1ZXN0VXJsIFVSTCB3aGljaCByZXN1bHRlZCBpbiB0aGUgU2VydmljZUV4Y2VwdGlvbgogICAgICogQHBhcmFtIGNvZGUgT3B0aW9uYWwgU2VydmljZUV4Y2VwdGlvbiBjb2RlCiAgICAgKiBAcGFyYW0gbG9jYXRvciBPcHRpb25hbCBTZXJ2aWNlRXhjZXB0aW9uIGxvY2F0b3IKICAgICAqIEBwYXJhbSByZXNwb25zZSBPcHRpb25hbCByZXNwb25zZSBjb250ZW50IHJlY2VpdmVkCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHJlcXVlc3RVcmwsIGNvZGUsIGxvY2F0b3IsIHJlc3BvbnNlKSB7CiAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgICB0aGlzLnJlcXVlc3RVcmwgPSByZXF1ZXN0VXJsOwogICAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgICB0aGlzLmxvY2F0b3IgPSBsb2NhdG9yOwogICAgICB0aGlzLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHBhcnNlKHNlcnZpY2VFeGNlcHRpb24sIHVybCkgewogICAgY29uc3QgZXJyb3JDb2RlID0gZ2V0RWxlbWVudEF0dHJpYnV0ZShzZXJ2aWNlRXhjZXB0aW9uLCAiY29kZSIpIHx8IGdldEVsZW1lbnRBdHRyaWJ1dGUoc2VydmljZUV4Y2VwdGlvbiwgImV4Y2VwdGlvbkNvZGUiKTsKICAgIGNvbnN0IGVycm9yTG9jYXRvciA9IGdldEVsZW1lbnRBdHRyaWJ1dGUoc2VydmljZUV4Y2VwdGlvbiwgImxvY2F0b3IiKTsKICAgIGNvbnN0IHRleHRFbGVtZW50ID0gZmluZENoaWxkRWxlbWVudChzZXJ2aWNlRXhjZXB0aW9uLCAiRXhjZXB0aW9uVGV4dCIpIHx8IHNlcnZpY2VFeGNlcHRpb247CiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBnZXRFbGVtZW50VGV4dCh0ZXh0RWxlbWVudCkudHJpbSgpOwogICAgcmV0dXJuIG5ldyBTZXJ2aWNlRXhjZXB0aW9uRXJyb3IoCiAgICAgIGVycm9yTWVzc2FnZSwKICAgICAgdXJsLAogICAgICBlcnJvckNvZGUsCiAgICAgIGVycm9yTG9jYXRvciwKICAgICAgc2VydmljZUV4Y2VwdGlvbi5kb2N1bWVudAogICAgKTsKICB9CiAgZnVuY3Rpb24gY2hlY2socmVzcG9uc2UsIHVybCkgewogICAgY29uc3Qgcm9vdEVsID0gZ2V0Um9vdEVsZW1lbnQocmVzcG9uc2UpOwogICAgY29uc3Qgcm9vdEVsTmFtZSA9IHN0cmlwTmFtZXNwYWNlKGdldEVsZW1lbnROYW1lKHJvb3RFbCkpOwogICAgaWYgKHJvb3RFbE5hbWUgPT09ICJTZXJ2aWNlRXhjZXB0aW9uUmVwb3J0IikgewogICAgICBjb25zdCBlcnJvciA9IGZpbmRDaGlsZEVsZW1lbnQocm9vdEVsLCAiU2VydmljZUV4Y2VwdGlvbiIpOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICB0aHJvdyBwYXJzZShlcnJvciwgdXJsKTsKICAgICAgfQogICAgfQogICAgaWYgKHJvb3RFbE5hbWUgPT09ICJFeGNlcHRpb25SZXBvcnQiKSB7CiAgICAgIGNvbnN0IGVycm9yID0gZmluZENoaWxkRWxlbWVudChyb290RWwsICJFeGNlcHRpb24iKTsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgdGhyb3cgcGFyc2UoZXJyb3IsIHVybCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXNwb25zZTsKICB9CiAgY29uc3QgTGF0TG9uQ3JzTGlzdCA9IFsKICAgICJFUFNHOjQwNDYiLAogICAgLy8gUkdSREMgMjAwNQogICAgIkVQU0c6NDA3NSIsCiAgICAvLyBTUkVGOTgKICAgICJFUFNHOjQxMjAiLAogICAgLy8gR3JlZWsKICAgICJFUFNHOjQxMjIiLAogICAgLy8gQVRTNzcKICAgICJFUFNHOjQxMjQiLAogICAgLy8gUlQ5MAogICAgIkVQU0c6NDEyNiIsCiAgICAvLyBMS1M5NCAoRVRSUzg5KQogICAgIkVQU0c6NDE0OSIsCiAgICAvLyBDSDE5MDMKICAgICJFUFNHOjQxNTEiLAogICAgLy8gQ0hUUkY5NQogICAgIkVQU0c6NDE1MyIsCiAgICAvLyBSYXNzYWRpcmFuCiAgICAiRVBTRzo0MTU1IiwKICAgIC8vIERhYm9sYSAxOTgxCiAgICAiRVBTRzo0MTU3IiwKICAgIC8vIE1vdW50IERpbGxvbgogICAgIkVQU0c6NDE1OSIsCiAgICAvLyBFTEQ3OQogICAgIkVQU0c6NDE2MSIsCiAgICAvLyBQYW1wYSBkZWwgQ2FzdGlsbG8KICAgICJFUFNHOjQxNjMiLAogICAgLy8gWWVtZW4gTkdOOTYKICAgICJFUFNHOjQxNjUiLAogICAgLy8gQmlzc2F1CiAgICAiRVBTRzo0MTY3IiwKICAgIC8vIE5aR0QyMDAwCiAgICAiRVBTRzo0MTY5IiwKICAgIC8vIEFtZXJpY2FuIFNhbW9hIDE5NjIKICAgICJFUFNHOjQxNzEiLAogICAgLy8gUkdGOTMKICAgICJFUFNHOjQxNzMiLAogICAgLy8gSVJFTkVUOTUKICAgICJFUFNHOjQxNzUiLAogICAgLy8gU2llcnJhIExlb25lIDE5NjgKICAgICJFUFNHOjQxNzgiLAogICAgLy8gUHVsa292byAxOTQyKDgzKQogICAgIkVQU0c6NDE4MCIsCiAgICAvLyBFU1Q5NwogICAgIkVQU0c6NDE4MiIsCiAgICAvLyBBem9yZXMgT2NjaWRlbnRhbCAxOTM5CiAgICAiRVBTRzo0MTg0IiwKICAgIC8vIEF6b3JlcyBPcmllbnRhbCAxOTQwCiAgICAiRVBTRzo0MTg4IiwKICAgIC8vIE9TTkkgMTk1MgogICAgIkVQU0c6NDE5MCIsCiAgICAvLyBQT1NHQVIgOTgKICAgICJFUFNHOjQxOTEiLAogICAgLy8gQWxiYW5pYW4gMTk4NwogICAgIkVQU0c6NDE5NiIsCiAgICAvLyBBbW1hc3NhbGlrIDE5NTgKICAgICJFUFNHOjQxOTgiLAogICAgLy8gS291c3NlcmkKICAgICJFUFNHOjQyMDIiLAogICAgLy8gQUdENjYKICAgICJFUFNHOjQyMTAiLAogICAgLy8gQXJjIDE5NjAKICAgICJFUFNHOjQyMTEiLAogICAgLy8gQmF0YXZpYQogICAgIkVQU0c6NDIxNCIsCiAgICAvLyBCZWlqaW5nIDE5NTQKICAgICJFUFNHOjQyMjYiLAogICAgLy8gQ290ZSBkJ0l2b2lyZQogICAgIkVQU0c6NDIyOSIsCiAgICAvLyBFZ3lwdCAxOTA3CiAgICAiRVBTRzo0MjMxIiwKICAgIC8vIEVEODcKICAgICJFUFNHOjQyMzMiLAogICAgLy8gR2FuZGFqaWthIDE5NzAKICAgICJFUFNHOjQyMzYiLAogICAgLy8gSHUgVHp1IFNoYW4gMTk1MAogICAgIkVQU0c6NDIzOCIsCiAgICAvLyBJRDc0CiAgICAiRVBTRzo0MjQwIiwKICAgIC8vIEluZGlhbiAxOTc1CiAgICAiRVBTRzo0MjQyIiwKICAgIC8vIEpBRDY5CiAgICAiRVBTRzo0MjQ0IiwKICAgIC8vIEthbmRhd2FsYQogICAgIkVQU0c6NDI0NiIsCiAgICAvLyBLT0MKICAgICJFUFNHOjQyNDgiLAogICAgLy8gUFNBRDU2CiAgICAiRVBTRzo0MjUwIiwKICAgIC8vIExlaWdvbgogICAgIkVQU0c6NDI1MiIsCiAgICAvLyBMb21lCiAgICAiRVBTRzo0MjU1IiwKICAgIC8vIEhlcmF0IE5vcnRoCiAgICAiRVBTRzo0MjU4IiwKICAgIC8vIEVUUlM4OQogICAgIkVQU0c6NDI2MSIsCiAgICAvLyBNZXJjaGljaAogICAgIkVQU0c6NDI2NCIsCiAgICAvLyBNaGFzdAogICAgIkVQU0c6NDI2NyIsCiAgICAvLyBOQUQyNwogICAgIkVQU0c6NDI3MCIsCiAgICAvLyBOYWhyd2FuIDE5NjcKICAgICJFUFNHOjQyNzMiLAogICAgLy8gTkdPIDE5NDgKICAgICJFUFNHOjQyNzYiLAogICAgLy8gTlNXQyA5Wi0yCiAgICAiRVBTRzo0Mjc5IiwKICAgIC8vIE9TKFNOKTgwCiAgICAiRVBTRzo0MjgxIiwKICAgIC8vIFBhbGVzdGluZSAxOTIzCiAgICAiRVBTRzo0Mjg0IiwKICAgIC8vIFB1bGtvdm8gMTk0MgogICAgIkVQU0c6NDI4NiIsCiAgICAvLyBRYXRhciAxOTQ4CiAgICAiRVBTRzo0Mjg4IiwKICAgIC8vIExvbWEgUXVpbnRhbmEKICAgICJFUFNHOjQyOTIiLAogICAgLy8gU2FwcGVyIEhpbGwgMTk0MwogICAgIkVQU0c6NDI5NSIsCiAgICAvLyBTZXJpbmR1bmcKICAgICJFUFNHOjQyOTciLAogICAgLy8gVGFuYW5hcml2ZQogICAgIkVQU0c6NDI5OSIsCiAgICAvLyBUTTY1CiAgICAiRVBTRzo0MzAyIiwKICAgIC8vIFRyaW5pZGFkIDE5MDMKICAgICJFUFNHOjQzMjQiLAogICAgLy8gV0dTIDcyQkUKICAgICJFUFNHOjQzMjYiCiAgICAvLyBXR1MgODQKICBdOwogIGZ1bmN0aW9uIGhhc0ludmVydGVkQ29vcmRpbmF0ZXMoY3JzTmFtZSkgewogICAgcmV0dXJuIExhdExvbkNyc0xpc3QuaW5kZXhPZihzaW1wbGlmeUVwc2dVcm4oY3JzTmFtZSkpID4gLTE7CiAgfQogIGZ1bmN0aW9uIHNpbXBsaWZ5RXBzZ1VybihmdWxsQ3JzTmFtZSkgewogICAgaWYgKC9edXJuOig/OngtKT9vZ2M6ZGVmOmNyczplcHNnOi8udGVzdChmdWxsQ3JzTmFtZS50b0xvd2VyQ2FzZSgpKSkgewogICAgICBjb25zdCBjb2RlID0gLyhbMC05XSspJC8uZXhlYyhmdWxsQ3JzTmFtZSlbMV07CiAgICAgIHJldHVybiBgRVBTRzoke2NvZGV9YDsKICAgIH0KICAgIHJldHVybiBmdWxsQ3JzTmFtZTsKICB9CiAgZnVuY3Rpb24gcmVhZE9wZXJhdGlvblVybHNGcm9tQ2FwYWJpbGl0aWVzJDEoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICBjb25zdCB1cmxzID0ge307CiAgICBjb25zdCBjYXBhYmlsaXR5ID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwKICAgICAgIkNhcGFiaWxpdHkiCiAgICApOwogICAgY29uc3QgcmVxdWVzdCA9IGZpbmRDaGlsZEVsZW1lbnQoY2FwYWJpbGl0eSwgIlJlcXVlc3QiKTsKICAgIGdldENoaWxkcmVuRWxlbWVudChyZXF1ZXN0KS5mb3JFYWNoKChvcGVyYXRpb24pID0+IHsKICAgICAgY29uc3Qgb3BlcmF0aW9uTmFtZSA9IHN0cmlwTmFtZXNwYWNlKGdldEVsZW1lbnROYW1lKG9wZXJhdGlvbikpOwogICAgICB1cmxzW29wZXJhdGlvbk5hbWVdID0gcGFyc2VPcGVyYXRpb24ob3BlcmF0aW9uKTsKICAgIH0pOwogICAgcmV0dXJuIHVybHM7CiAgfQogIGZ1bmN0aW9uIHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyQxKGNhcGFiaWxpdGllc0RvYykgewogICAgcmV0dXJuIGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYykuYXR0cmlidXRlc1sidmVyc2lvbiJdOwogIH0KICBmdW5jdGlvbiByZWFkTGF5ZXJzRnJvbUNhcGFiaWxpdGllcyQxKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3QgdmVyc2lvbiA9IHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyQxKGNhcGFiaWxpdGllc0RvYyk7CiAgICBjb25zdCBjYXBhYmlsaXR5ID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwKICAgICAgIkNhcGFiaWxpdHkiCiAgICApOwogICAgcmV0dXJuIGZpbmRDaGlsZHJlbkVsZW1lbnQoY2FwYWJpbGl0eSwgIkxheWVyIikubWFwKAogICAgICAobGF5ZXJFbCkgPT4gcGFyc2VMYXllcihsYXllckVsLCB2ZXJzaW9uKQogICAgKTsKICB9CiAgZnVuY3Rpb24gcmVhZE91dHB1dEZvcm1hdHNGcm9tQ2FwYWJpbGl0aWVzJDEoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICBjb25zdCBjYXBhYmlsaXR5ID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwKICAgICAgIkNhcGFiaWxpdHkiCiAgICApOwogICAgY29uc3QgZ2V0TWFwID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgZmluZENoaWxkRWxlbWVudChjYXBhYmlsaXR5LCAiUmVxdWVzdCIpLAogICAgICAiR2V0TWFwIgogICAgKTsKICAgIGNvbnN0IG91dHB1dEZvcm1hdHMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGdldE1hcCwgIkZvcm1hdCIpLm1hcCgKICAgICAgZ2V0RWxlbWVudFRleHQKICAgICk7CiAgICByZXR1cm4gb3V0cHV0Rm9ybWF0czsKICB9CiAgZnVuY3Rpb24gcmVhZEluZm9Gb3JtYXRzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IGNhcGFiaWxpdHkgPSBmaW5kQ2hpbGRFbGVtZW50KAogICAgICBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLAogICAgICAiQ2FwYWJpbGl0eSIKICAgICk7CiAgICBjb25zdCBnZXRGZWF0dXJlSW5mbyA9IGZpbmRDaGlsZEVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQoY2FwYWJpbGl0eSwgIlJlcXVlc3QiKSwKICAgICAgIkdldEZlYXR1cmVJbmZvIgogICAgKTsKICAgIGNvbnN0IG91dHB1dEZvcm1hdHMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGdldEZlYXR1cmVJbmZvLCAiRm9ybWF0IikubWFwKAogICAgICBnZXRFbGVtZW50VGV4dAogICAgKTsKICAgIHJldHVybiBvdXRwdXRGb3JtYXRzOwogIH0KICBmdW5jdGlvbiByZWFkRXhjZXB0aW9uRm9ybWF0c0Zyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICBjb25zdCBjYXBhYmlsaXR5ID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwKICAgICAgIkNhcGFiaWxpdHkiCiAgICApOwogICAgY29uc3QgZXhjZXB0aW9uID0gZmluZENoaWxkRWxlbWVudChjYXBhYmlsaXR5LCAiRXhjZXB0aW9uIik7CiAgICBjb25zdCBleGNlcHRpb25Gb3JtYXRzID0gZmluZENoaWxkcmVuRWxlbWVudChleGNlcHRpb24sICJGb3JtYXQiKS5tYXAoCiAgICAgIGdldEVsZW1lbnRUZXh0CiAgICApOwogICAgcmV0dXJuIGV4Y2VwdGlvbkZvcm1hdHM7CiAgfQogIGZ1bmN0aW9uIHJlYWRJbmZvRnJvbUNhcGFiaWxpdGllcyQyKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3Qgc2VydmljZSA9IGZpbmRDaGlsZEVsZW1lbnQoZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwgIlNlcnZpY2UiKTsKICAgIGNvbnN0IG91dHB1dEZvcm1hdHMgPSByZWFkT3V0cHV0Rm9ybWF0c0Zyb21DYXBhYmlsaXRpZXMkMShjYXBhYmlsaXRpZXNEb2MpOwogICAgY29uc3QgaW5mb0Zvcm1hdHMgPSByZWFkSW5mb0Zvcm1hdHNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYyk7CiAgICBjb25zdCBleGNlcHRpb25Gb3JtYXRzID0gcmVhZEV4Y2VwdGlvbkZvcm1hdHNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYyk7CiAgICBjb25zdCBrZXl3b3JkcyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIktleXdvcmRMaXN0IiksCiAgICAgICJLZXl3b3JkIgogICAgKS5tYXAoZ2V0RWxlbWVudFRleHQpLmZpbHRlcigodiwgaSwgYXJyKSA9PiBhcnIuaW5kZXhPZih2KSA9PT0gaSk7CiAgICBjb25zdCBwcm92aWRlciA9IHJlYWRQcm92aWRlckZyb21DYXBhYmlsaXRpZXMkMShjYXBhYmlsaXRpZXNEb2MpOwogICAgcmV0dXJuIHsKICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIlRpdGxlIikpLAogICAgICBuYW1lOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJOYW1lIikpLAogICAgICBhYnN0cmFjdDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiQWJzdHJhY3QiKSksCiAgICAgIG91dHB1dEZvcm1hdHMsCiAgICAgIGluZm9Gb3JtYXRzLAogICAgICBleGNlcHRpb25Gb3JtYXRzLAogICAgICBmZWVzOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJGZWVzIikpLAogICAgICBjb25zdHJhaW50czogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiQWNjZXNzQ29uc3RyYWludHMiKSksCiAgICAgIHByb3ZpZGVyLAogICAgICBrZXl3b3JkcwogICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VPcGVyYXRpb24ob3BlcmF0aW9uKSB7CiAgICBjb25zdCB1cmxzID0ge307CiAgICBjb25zdCBkY3BUeXBlID0gZmluZENoaWxkcmVuRWxlbWVudChvcGVyYXRpb24sICJEQ1BUeXBlIik7CiAgICBjb25zdCBodHRwID0gZGNwVHlwZS5mbGF0TWFwKChkKSA9PiBmaW5kQ2hpbGRFbGVtZW50KGQsICJIVFRQIikpOwogICAgY29uc3QgbWV0aG9kcyA9IGh0dHAuZmxhdE1hcCgoaCkgPT4gZ2V0Q2hpbGRyZW5FbGVtZW50KGgpKTsKICAgIG1ldGhvZHMuZm9yRWFjaCgobWV0aG9kKSA9PiB7CiAgICAgIGNvbnN0IG9ubGluZVJlc291cmNlID0gZmluZENoaWxkRWxlbWVudChtZXRob2QsICJPbmxpbmVSZXNvdXJjZSIpOwogICAgICBjb25zdCBtZXRob2ROYW1lID0gc3RyaXBOYW1lc3BhY2UoZ2V0RWxlbWVudE5hbWUobWV0aG9kKSk7CiAgICAgIHVybHNbbWV0aG9kTmFtZV0gPSBnZXRFbGVtZW50QXR0cmlidXRlKG9ubGluZVJlc291cmNlLCAieGxpbms6aHJlZiIpOwogICAgfSk7CiAgICByZXR1cm4gdXJsczsKICB9CiAgZnVuY3Rpb24gcGFyc2VMYXllcihsYXllckVsLCB2ZXJzaW9uLCBpbmhlcml0ZWRTcnMgPSBbXSwgaW5oZXJpdGVkU3R5bGVzID0gW10sIGluaGVyaXRlZEF0dHJpYnV0aW9uID0gbnVsbCwgaW5oZXJpdGVkQm91bmRpbmdCb3hlcyA9IG51bGwsIGluaGVyaXRlZE1heFNjYWxlRGVub20gPSBudWxsLCBpbmhlcml0ZWRNaW5TY2FsZURlbm9tID0gbnVsbCkgewogICAgY29uc3Qgc3JzVGFnID0gdmVyc2lvbiA9PT0gIjEuMy4wIiA/ICJDUlMiIDogIlNSUyI7CiAgICBjb25zdCBzcnNMaXN0ID0gZmluZENoaWxkcmVuRWxlbWVudChsYXllckVsLCBzcnNUYWcpLm1hcChnZXRFbGVtZW50VGV4dCk7CiAgICBjb25zdCBhdmFpbGFibGVDcnMgPSBzcnNMaXN0Lmxlbmd0aCA+IDAgPyBzcnNMaXN0IDogaW5oZXJpdGVkU3JzOwogICAgY29uc3QgbGF5ZXJTdHlsZXMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGxheWVyRWwsICJTdHlsZSIpLm1hcCgKICAgICAgcGFyc2VMYXllclN0eWxlCiAgICApOwogICAgY29uc3Qgc3R5bGVzID0gbGF5ZXJTdHlsZXMubGVuZ3RoID4gMCA/IGxheWVyU3R5bGVzIDogaW5oZXJpdGVkU3R5bGVzOwogICAgZnVuY3Rpb24gcGFyc2VCQm94MihiYm94RWwpIHsKICAgICAgY29uc3Qgc3JzID0gZ2V0RWxlbWVudEF0dHJpYnV0ZShiYm94RWwsIHNyc1RhZyk7CiAgICAgIGNvbnN0IGF0dHJzID0gaGFzSW52ZXJ0ZWRDb29yZGluYXRlcyhzcnMpICYmIHZlcnNpb24gPT09ICIxLjMuMCIgPyBbIm1pbnkiLCAibWlueCIsICJtYXh5IiwgIm1heHgiXSA6IFsibWlueCIsICJtaW55IiwgIm1heHgiLCAibWF4eSJdOwogICAgICByZXR1cm4gYXR0cnMubWFwKChuYW1lKSA9PiBnZXRFbGVtZW50QXR0cmlidXRlKGJib3hFbCwgbmFtZSkpOwogICAgfQogICAgZnVuY3Rpb24gcGFyc2VFeEdlb2dyYXBoaWNCb3VuZGluZ0JveChiYm94RWwpIHsKICAgICAgcmV0dXJuIFsKICAgICAgICAid2VzdEJvdW5kTG9uZ2l0dWRlIiwKICAgICAgICAic291dGhCb3VuZExhdGl0dWRlIiwKICAgICAgICAiZWFzdEJvdW5kTG9uZ2l0dWRlIiwKICAgICAgICAibm9ydGhCb3VuZExhdGl0dWRlIgogICAgICBdLm1hcCgobmFtZSkgPT4gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChiYm94RWwsIG5hbWUpKSk7CiAgICB9CiAgICBmdW5jdGlvbiBwYXJzZUxhdExvbkJvdW5kaW5nQm94KGJib3hFbCkgewogICAgICByZXR1cm4gWyJtaW54IiwgIm1pbnkiLCAibWF4eCIsICJtYXh5Il0ubWFwKAogICAgICAgIChuYW1lKSA9PiBnZXRFbGVtZW50QXR0cmlidXRlKGJib3hFbCwgbmFtZSkKICAgICAgKTsKICAgIH0KICAgIGZ1bmN0aW9uIHBhcnNlU2NhbGVIaW50VmFsdWUodGV4dFZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHRleHRWYWx1ZSA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBNYXRoLnNxcnQoMC41ICogcGFyc2VGbG9hdCh0ZXh0VmFsdWUpICoqIDIpIC8gMjhlLTU7CiAgICB9CiAgICBmdW5jdGlvbiBwYXJzZVNjYWxlSGludCgpIHsKICAgICAgY29uc3Qgc2NhbGVIaW50ID0gZmluZENoaWxkRWxlbWVudChsYXllckVsLCAiU2NhbGVIaW50Iik7CiAgICAgIGlmICghc2NhbGVIaW50KSB7CiAgICAgICAgcmV0dXJuIFtpbmhlcml0ZWRNaW5TY2FsZURlbm9tLCBpbmhlcml0ZWRNYXhTY2FsZURlbm9tXTsKICAgICAgfQogICAgICBjb25zdCBtaW4gPSBnZXRFbGVtZW50QXR0cmlidXRlKHNjYWxlSGludCwgIm1pbiIpOwogICAgICBjb25zdCBtYXggPSBnZXRFbGVtZW50QXR0cmlidXRlKHNjYWxlSGludCwgIm1heCIpOwogICAgICByZXR1cm4gWwogICAgICAgIHBhcnNlU2NhbGVIaW50VmFsdWUobWluLCBpbmhlcml0ZWRNaW5TY2FsZURlbm9tKSwKICAgICAgICBwYXJzZVNjYWxlSGludFZhbHVlKG1heCwgaW5oZXJpdGVkTWF4U2NhbGVEZW5vbSkKICAgICAgXTsKICAgIH0KICAgIGZ1bmN0aW9uIHBhcnNlU2NhbGVEZW5vbWluYXRvcihuYW1lLCBpbmhlcml0ZWRWYWx1ZSkgewogICAgICBjb25zdCB0ZXh0VmFsdWUgPSBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGxheWVyRWwsIG5hbWUpKTsKICAgICAgcmV0dXJuIHRleHRWYWx1ZSA9PT0gIiIgPyBpbmhlcml0ZWRWYWx1ZSA6IHBhcnNlRmxvYXQodGV4dFZhbHVlKTsKICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0aW9uRWwgPSBmaW5kQ2hpbGRFbGVtZW50KGxheWVyRWwsICJBdHRyaWJ1dGlvbiIpOwogICAgY29uc3QgYXR0cmlidXRpb24gPSBhdHRyaWJ1dGlvbkVsICE9PSBudWxsID8gcGFyc2VMYXllckF0dHJpYnV0aW9uKGF0dHJpYnV0aW9uRWwpIDogaW5oZXJpdGVkQXR0cmlidXRpb247CiAgICBjb25zdCBsYXRMb25CYm94RWwgPSB2ZXJzaW9uID09PSAiMS4zLjAiID8gZmluZENoaWxkRWxlbWVudChsYXllckVsLCAiRVhfR2VvZ3JhcGhpY0JvdW5kaW5nQm94IikgOiBmaW5kQ2hpbGRFbGVtZW50KGxheWVyRWwsICJMYXRMb25Cb3VuZGluZ0JveCIpOwogICAgY29uc3QgYmFzZUJvdW5kaW5nQm94ID0ge307CiAgICBpZiAobGF0TG9uQmJveEVsKSB7CiAgICAgIGJhc2VCb3VuZGluZ0JveFsiRVBTRzo0MzI2Il0gPSB2ZXJzaW9uID09PSAiMS4zLjAiID8gcGFyc2VFeEdlb2dyYXBoaWNCb3VuZGluZ0JveChsYXRMb25CYm94RWwpIDogcGFyc2VMYXRMb25Cb3VuZGluZ0JveChsYXRMb25CYm94RWwpOwogICAgfQogICAgbGV0IGJvdW5kaW5nQm94ZXMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGxheWVyRWwsICJCb3VuZGluZ0JveCIpLnJlZHVjZSgKICAgICAgKHByZXYsIGJib3hFbCkgPT4gKHsKICAgICAgICAuLi5wcmV2LAogICAgICAgIFtnZXRFbGVtZW50QXR0cmlidXRlKGJib3hFbCwgc3JzVGFnKV06IHBhcnNlQkJveDIoYmJveEVsKQogICAgICB9KSwKICAgICAgYmFzZUJvdW5kaW5nQm94CiAgICApOwogICAgYm91bmRpbmdCb3hlcyA9IE9iamVjdC5rZXlzKGJvdW5kaW5nQm94ZXMpLmxlbmd0aCA+IDAgfHwgaW5oZXJpdGVkQm91bmRpbmdCb3hlcyA9PT0gbnVsbCA/IGJvdW5kaW5nQm94ZXMgOiBpbmhlcml0ZWRCb3VuZGluZ0JveGVzOwogICAgY29uc3QgcXVlcnlhYmxlID0gbGF5ZXJFbC5hdHRyaWJ1dGVzLnF1ZXJ5YWJsZSA9PT0gIjEiIHx8IGxheWVyRWwuYXR0cmlidXRlcy5xdWVyeWFibGUgPT09ICJ0cnVlIiA/IHRydWUgOiBmYWxzZTsKICAgIGNvbnN0IG9wYXF1ZSA9IGxheWVyRWwuYXR0cmlidXRlcy5vcGFxdWUgPT09ICIxIiB8fCBsYXllckVsLmF0dHJpYnV0ZXMub3BhcXVlID09PSAidHJ1ZSIgPyB0cnVlIDogZmFsc2U7CiAgICBjb25zdCBrZXl3b3JkcyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQobGF5ZXJFbCwgIktleXdvcmRMaXN0IiksCiAgICAgICJLZXl3b3JkIgogICAgKS5tYXAoZ2V0RWxlbWVudFRleHQpLmZpbHRlcigodiwgaSwgYXJyKSA9PiBhcnIuaW5kZXhPZih2KSA9PT0gaSk7CiAgICBsZXQgbWluU2NhbGVEZW5vbWluYXRvciwgbWF4U2NhbGVEZW5vbWluYXRvcjsKICAgIGlmICh2ZXJzaW9uID09PSAiMS4zLjAiKSB7CiAgICAgIG1pblNjYWxlRGVub21pbmF0b3IgPSBwYXJzZVNjYWxlRGVub21pbmF0b3IoCiAgICAgICAgIk1pblNjYWxlRGVub21pbmF0b3IiLAogICAgICAgIGluaGVyaXRlZE1pblNjYWxlRGVub20KICAgICAgKTsKICAgICAgbWF4U2NhbGVEZW5vbWluYXRvciA9IHBhcnNlU2NhbGVEZW5vbWluYXRvcigKICAgICAgICAiTWF4U2NhbGVEZW5vbWluYXRvciIsCiAgICAgICAgaW5oZXJpdGVkTWF4U2NhbGVEZW5vbQogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgW21pblNjYWxlRGVub21pbmF0b3IsIG1heFNjYWxlRGVub21pbmF0b3JdID0gcGFyc2VTY2FsZUhpbnQoKTsKICAgIH0KICAgIGNvbnN0IG1ldGFkYXRhID0gZmluZENoaWxkcmVuRWxlbWVudChsYXllckVsLCAiTWV0YWRhdGFVUkwiKS5tYXAoCiAgICAgIChtZXRhZGF0YVVybEVsKSA9PiAoewogICAgICAgIHR5cGU6IGdldEVsZW1lbnRBdHRyaWJ1dGUobWV0YWRhdGFVcmxFbCwgInR5cGUiKSwKICAgICAgICBmb3JtYXQ6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQobWV0YWRhdGFVcmxFbCwgIkZvcm1hdCIpKSwKICAgICAgICB1cmw6IGdldEVsZW1lbnRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KG1ldGFkYXRhVXJsRWwsICJPbmxpbmVSZXNvdXJjZSIpLAogICAgICAgICAgInhsaW5rOmhyZWYiCiAgICAgICAgKQogICAgICB9KQogICAgKTsKICAgIGNvbnN0IGNoaWxkcmVuID0gZmluZENoaWxkcmVuRWxlbWVudChsYXllckVsLCAiTGF5ZXIiKS5tYXAoCiAgICAgIChsYXllcikgPT4gcGFyc2VMYXllcigKICAgICAgICBsYXllciwKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGF2YWlsYWJsZUNycywKICAgICAgICBzdHlsZXMsCiAgICAgICAgYXR0cmlidXRpb24sCiAgICAgICAgYm91bmRpbmdCb3hlcywKICAgICAgICBtYXhTY2FsZURlbm9taW5hdG9yLAogICAgICAgIG1pblNjYWxlRGVub21pbmF0b3IKICAgICAgKQogICAgKTsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQobGF5ZXJFbCwgIk5hbWUiKSksCiAgICAgIHRpdGxlOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGxheWVyRWwsICJUaXRsZSIpKSwKICAgICAgYWJzdHJhY3Q6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQobGF5ZXJFbCwgIkFic3RyYWN0IikpLAogICAgICBhdmFpbGFibGVDcnMsCiAgICAgIHN0eWxlcywKICAgICAgYXR0cmlidXRpb24sCiAgICAgIGJvdW5kaW5nQm94ZXMsCiAgICAgIGtleXdvcmRzLAogICAgICBxdWVyeWFibGUsCiAgICAgIG9wYXF1ZSwKICAgICAgLi4ubWluU2NhbGVEZW5vbWluYXRvciAhPT0gbnVsbCA/IHsgbWluU2NhbGVEZW5vbWluYXRvciB9IDoge30sCiAgICAgIC4uLm1heFNjYWxlRGVub21pbmF0b3IgIT09IG51bGwgPyB7IG1heFNjYWxlRGVub21pbmF0b3IgfSA6IHt9LAogICAgICAuLi5tZXRhZGF0YS5sZW5ndGggJiYgeyBtZXRhZGF0YSB9LAogICAgICAuLi5jaGlsZHJlbi5sZW5ndGggJiYgeyBjaGlsZHJlbiB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZUxheWVyU3R5bGUoc3R5bGVFbCkgewogICAgY29uc3QgbGVnZW5kVXJsID0gZ2V0RWxlbWVudEF0dHJpYnV0ZSgKICAgICAgZmluZENoaWxkRWxlbWVudChmaW5kQ2hpbGRFbGVtZW50KHN0eWxlRWwsICJMZWdlbmRVUkwiKSwgIk9ubGluZVJlc291cmNlIiksCiAgICAgICJ4bGluazpocmVmIgogICAgKTsKICAgIGNvbnN0IGFic3RyYWN0ID0gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzdHlsZUVsLCAiQWJzdHJhY3QiKSk7CiAgICByZXR1cm4gewogICAgICBuYW1lOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHN0eWxlRWwsICJOYW1lIikpLAogICAgICB0aXRsZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzdHlsZUVsLCAiVGl0bGUiKSksCiAgICAgIC4uLmFic3RyYWN0ICYmIHsgYWJzdHJhY3QgfSwKICAgICAgLi4ubGVnZW5kVXJsICYmIHsgbGVnZW5kVXJsIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlTGF5ZXJBdHRyaWJ1dGlvbihhdHRyaWJ1dGlvbkVsKSB7CiAgICBjb25zdCBsb2dvVXJsID0gZ2V0RWxlbWVudEF0dHJpYnV0ZSgKICAgICAgZmluZENoaWxkRWxlbWVudCgKICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGF0dHJpYnV0aW9uRWwsICJMb2dvVVJMIiksCiAgICAgICAgIk9ubGluZVJlc291cmNlIgogICAgICApLAogICAgICAieGxpbms6aHJlZiIKICAgICk7CiAgICBjb25zdCB1cmwgPSBnZXRFbGVtZW50QXR0cmlidXRlKAogICAgICBmaW5kQ2hpbGRFbGVtZW50KGF0dHJpYnV0aW9uRWwsICJPbmxpbmVSZXNvdXJjZSIpLAogICAgICAieGxpbms6aHJlZiIKICAgICk7CiAgICBjb25zdCB0aXRsZSA9IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoYXR0cmlidXRpb25FbCwgIlRpdGxlIikpOwogICAgcmV0dXJuIHsKICAgICAgLi4udGl0bGUgJiYgeyB0aXRsZSB9LAogICAgICAuLi51cmwgJiYgeyB1cmwgfSwKICAgICAgLi4ubG9nb1VybCAmJiB7IGxvZ29VcmwgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gcmVhZFByb3ZpZGVyRnJvbUNhcGFiaWxpdGllcyQxKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3Qgc2VydmljZSA9IGZpbmRDaGlsZEVsZW1lbnQoZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwgIlNlcnZpY2UiKTsKICAgIGNvbnN0IGNvbnRhY3RJbmZvcm1hdGlvbiA9IGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIkNvbnRhY3RJbmZvcm1hdGlvbiIpOwogICAgY29uc3QgY29udGFjdFBlcnNvblByaW1hcnkgPSBmaW5kQ2hpbGRFbGVtZW50KAogICAgICBjb250YWN0SW5mb3JtYXRpb24sCiAgICAgICJDb250YWN0UGVyc29uUHJpbWFyeSIKICAgICk7CiAgICBjb25zdCBhZGRyZXNzID0gZmluZENoaWxkRWxlbWVudChjb250YWN0SW5mb3JtYXRpb24sICJDb250YWN0QWRkcmVzcyIpOwogICAgcmV0dXJuIHsKICAgICAgY29udGFjdDogewogICAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KAogICAgICAgICAgZmluZENoaWxkRWxlbWVudChjb250YWN0UGVyc29uUHJpbWFyeSwgIkNvbnRhY3RQZXJzb24iKQogICAgICAgICksCiAgICAgICAgb3JnYW5pemF0aW9uOiBnZXRFbGVtZW50VGV4dCgKICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoY29udGFjdFBlcnNvblByaW1hcnksICJDb250YWN0T3JnYW5pemF0aW9uIikKICAgICAgICApLAogICAgICAgIHBvc2l0aW9uOiBnZXRFbGVtZW50VGV4dCgKICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoY29udGFjdEluZm9ybWF0aW9uLCAiQ29udGFjdFBvc2l0aW9uIikKICAgICAgICApLAogICAgICAgIHBob25lOiBnZXRFbGVtZW50VGV4dCgKICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoY29udGFjdEluZm9ybWF0aW9uLCAiQ29udGFjdFZvaWNlVGVsZXBob25lIikKICAgICAgICApLAogICAgICAgIGZheDogZ2V0RWxlbWVudFRleHQoCiAgICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGNvbnRhY3RJbmZvcm1hdGlvbiwgIkNvbnRhY3RGYWNzaW1pbGVUZWxlcGhvbmUiKQogICAgICAgICksCiAgICAgICAgYWRkcmVzczogewogICAgICAgICAgZGVsaXZlcnlQb2ludDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChhZGRyZXNzLCAiQWRkcmVzcyIpKSwKICAgICAgICAgIGNpdHk6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoYWRkcmVzcywgIkNpdHkiKSksCiAgICAgICAgICBhZG1pbmlzdHJhdGl2ZUFyZWE6IGdldEVsZW1lbnRUZXh0KAogICAgICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGFkZHJlc3MsICJTdGF0ZU9yUHJvdmluY2UiKQogICAgICAgICAgKSwKICAgICAgICAgIHBvc3RhbENvZGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoYWRkcmVzcywgIlBvc3RDb2RlIikpLAogICAgICAgICAgY291bnRyeTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChhZGRyZXNzLCAiQ291bnRyeSIpKQogICAgICAgIH0sCiAgICAgICAgZW1haWw6IGdldEVsZW1lbnRUZXh0KAogICAgICAgICAgZmluZENoaWxkRWxlbWVudChjb250YWN0SW5mb3JtYXRpb24sICJDb250YWN0RWxlY3Ryb25pY01haWxBZGRyZXNzIikKICAgICAgICApCiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIHJlYWRQcm92aWRlckZyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICBjb25zdCBzZXJ2aWNlUHJvdmlkZXIgPSBmaW5kQ2hpbGRFbGVtZW50KAogICAgICBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLAogICAgICAiU2VydmljZVByb3ZpZGVyIgogICAgKTsKICAgIGNvbnN0IHNlcnZpY2VDb250YWN0ID0gZmluZENoaWxkRWxlbWVudChzZXJ2aWNlUHJvdmlkZXIsICJTZXJ2aWNlQ29udGFjdCIpOwogICAgY29uc3QgY29udGFjdEluZm8gPSBmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2VDb250YWN0LCAiQ29udGFjdEluZm8iKTsKICAgIGNvbnN0IHBob25lID0gZmluZENoaWxkRWxlbWVudChjb250YWN0SW5mbywgIlBob25lIik7CiAgICBjb25zdCBhZGRyZXNzID0gZmluZENoaWxkRWxlbWVudChjb250YWN0SW5mbywgIkFkZHJlc3MiKTsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZVByb3ZpZGVyLCAiUHJvdmlkZXJOYW1lIikpLAogICAgICBzaXRlOiBnZXRFbGVtZW50QXR0cmlidXRlKAogICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZVByb3ZpZGVyLCAiUHJvdmlkZXJTaXRlIiksCiAgICAgICAgInhsaW5rOmhyZWYiCiAgICAgICksCiAgICAgIGNvbnRhY3Q6IHsKICAgICAgICBuYW1lOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2VDb250YWN0LCAiSW5kaXZpZHVhbE5hbWUiKSksCiAgICAgICAgcG9zaXRpb246IGdldEVsZW1lbnRUZXh0KAogICAgICAgICAgZmluZENoaWxkRWxlbWVudChzZXJ2aWNlQ29udGFjdCwgIlBvc2l0aW9uTmFtZSIpCiAgICAgICAgKSwKICAgICAgICBwaG9uZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChwaG9uZSwgIlZvaWNlIikpLAogICAgICAgIGZheDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChwaG9uZSwgIkZhY3NpbWlsZSIpKSwKICAgICAgICBhZGRyZXNzOiB7CiAgICAgICAgICBkZWxpdmVyeVBvaW50OiBnZXRFbGVtZW50VGV4dCgKICAgICAgICAgICAgZmluZENoaWxkRWxlbWVudChhZGRyZXNzLCAiRGVsaXZlcnlQb2ludCIpCiAgICAgICAgICApLAogICAgICAgICAgY2l0eTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChhZGRyZXNzLCAiQ2l0eSIpKSwKICAgICAgICAgIGFkbWluaXN0cmF0aXZlQXJlYTogZ2V0RWxlbWVudFRleHQoCiAgICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoYWRkcmVzcywgIkFkbWluaXN0cmF0aXZlQXJlYSIpCiAgICAgICAgICApLAogICAgICAgICAgcG9zdGFsQ29kZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChhZGRyZXNzLCAiUG9zdGFsQ29kZSIpKSwKICAgICAgICAgIGNvdW50cnk6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoYWRkcmVzcywgIkNvdW50cnkiKSkKICAgICAgICB9LAogICAgICAgIGVtYWlsOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGFkZHJlc3MsICJFbGVjdHJvbmljTWFpbEFkZHJlc3MiKSkKICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gcmVhZE9wZXJhdGlvblVybHNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3QgdXJscyA9IHt9OwogICAgY29uc3QgY2FwYWJpbGl0aWVzID0gZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGNvbnN0IG9wZXJhdGlvbnNNZXRhZGF0YSA9IGZpbmRDaGlsZEVsZW1lbnQoCiAgICAgIGNhcGFiaWxpdGllcywKICAgICAgIk9wZXJhdGlvbnNNZXRhZGF0YSIKICAgICk7CiAgICBpZiAob3BlcmF0aW9uc01ldGFkYXRhKSB7CiAgICAgIGZpbmRDaGlsZHJlbkVsZW1lbnQob3BlcmF0aW9uc01ldGFkYXRhLCAiT3BlcmF0aW9uIikuZm9yRWFjaCgKICAgICAgICAob3BlcmF0aW9uKSA9PiB7CiAgICAgICAgICBjb25zdCBuYW1lID0gZ2V0RWxlbWVudEF0dHJpYnV0ZShvcGVyYXRpb24sICJuYW1lIik7CiAgICAgICAgICB1cmxzW25hbWVdID0gcGFyc2VPcGVyYXRpb24xMTAob3BlcmF0aW9uKTsKICAgICAgICB9CiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBjYXBhYmlsaXR5ID0gZmluZENoaWxkRWxlbWVudChjYXBhYmlsaXRpZXMsICJDYXBhYmlsaXR5Iik7CiAgICAgIGNvbnN0IHJlcXVlc3QgPSBmaW5kQ2hpbGRFbGVtZW50KGNhcGFiaWxpdHksICJSZXF1ZXN0Iik7CiAgICAgIGdldENoaWxkcmVuRWxlbWVudChyZXF1ZXN0KS5mb3JFYWNoKChvcGVyYXRpb24pID0+IHsKICAgICAgICBjb25zdCBuYW1lID0gc3RyaXBOYW1lc3BhY2UoZ2V0RWxlbWVudE5hbWUob3BlcmF0aW9uKSk7CiAgICAgICAgdXJsc1tuYW1lXSA9IHBhcnNlT3BlcmF0aW9uMTAwKG9wZXJhdGlvbik7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHVybHM7CiAgfQogIGZ1bmN0aW9uIHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIHJldHVybiBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLmF0dHJpYnV0ZXNbInZlcnNpb24iXTsKICB9CiAgZnVuY3Rpb24gcmVhZE91dHB1dEZvcm1hdHNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3QgdmVyc2lvbiA9IHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpOwogICAgbGV0IG91dHB1dEZvcm1hdHM7CiAgICBpZiAodmVyc2lvbi5zdGFydHNXaXRoKCIxLjAiKSkgewogICAgICBjb25zdCBnZXRGZWF0dXJlID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KAogICAgICAgICAgZmluZENoaWxkRWxlbWVudChnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLCAiQ2FwYWJpbGl0eSIpLAogICAgICAgICAgIlJlcXVlc3QiCiAgICAgICAgKSwKICAgICAgICAiR2V0RmVhdHVyZSIKICAgICAgKTsKICAgICAgb3V0cHV0Rm9ybWF0cyA9IGdldENoaWxkcmVuRWxlbWVudCgKICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGdldEZlYXR1cmUsICJSZXN1bHRGb3JtYXQiKQogICAgICApLm1hcChnZXRFbGVtZW50TmFtZSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBvcGVyYXRpb25zID0gZmluZENoaWxkRWxlbWVudCgKICAgICAgICBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLAogICAgICAgICJPcGVyYXRpb25zTWV0YWRhdGEiCiAgICAgICk7CiAgICAgIGNvbnN0IGdldEZlYXR1cmUgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KG9wZXJhdGlvbnMsICJPcGVyYXRpb24iKS5maW5kKAogICAgICAgIChlbCkgPT4gZ2V0RWxlbWVudEF0dHJpYnV0ZShlbCwgIm5hbWUiKSA9PT0gIkdldEZlYXR1cmUiCiAgICAgICk7CiAgICAgIGNvbnN0IHBhcmFtZXRlciA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZ2V0RmVhdHVyZSwgIlBhcmFtZXRlciIpLmZpbmQoCiAgICAgICAgKGVsKSA9PiBnZXRFbGVtZW50QXR0cmlidXRlKGVsLCAibmFtZSIpID09PSAib3V0cHV0Rm9ybWF0IgogICAgICApOwogICAgICBvdXRwdXRGb3JtYXRzID0gZmluZENoaWxkcmVuRWxlbWVudChwYXJhbWV0ZXIsICJWYWx1ZSIsIHRydWUpLm1hcCgKICAgICAgICBnZXRFbGVtZW50VGV4dAogICAgICApOwogICAgfQogICAgcmV0dXJuIG91dHB1dEZvcm1hdHM7CiAgfQogIGZ1bmN0aW9uIHJlYWRJbmZvRnJvbUNhcGFiaWxpdGllcyQxKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3QgdmVyc2lvbiA9IHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpOwogICAgY29uc3Qgc2VydmljZVRhZyA9IHZlcnNpb24uc3RhcnRzV2l0aCgiMS4wIikgPyAiU2VydmljZSIgOiAiU2VydmljZUlkZW50aWZpY2F0aW9uIjsKICAgIGNvbnN0IG5hbWVUYWcgPSB2ZXJzaW9uLnN0YXJ0c1dpdGgoIjEuMCIpID8gIk5hbWUiIDogIlNlcnZpY2VUeXBlIjsKICAgIGNvbnN0IHNlcnZpY2UgPSBmaW5kQ2hpbGRFbGVtZW50KGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYyksIHNlcnZpY2VUYWcpOwogICAgbGV0IGtleXdvcmRzOwogICAgaWYgKHZlcnNpb24uc3RhcnRzV2l0aCgiMS4wIikpIHsKICAgICAga2V5d29yZHMgPSBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJLZXl3b3JkcyIpKS5zcGxpdCgiLCIpLm1hcCgoa2V5d29yZCkgPT4ga2V5d29yZC50cmltKCkpOwogICAgfSBlbHNlIHsKICAgICAga2V5d29yZHMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KAogICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIktleXdvcmRzIiksCiAgICAgICAgIktleXdvcmQiCiAgICAgICkubWFwKGdldEVsZW1lbnRUZXh0KTsKICAgIH0KICAgIGxldCBwcm92aWRlcjsKICAgIGlmICh2ZXJzaW9uICE9PSAiMS4wLjAiKSB7CiAgICAgIHByb3ZpZGVyID0gcmVhZFByb3ZpZGVyRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIlRpdGxlIikpLAogICAgICBuYW1lOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsIG5hbWVUYWcpKSwKICAgICAgYWJzdHJhY3Q6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIkFic3RyYWN0IikpLAogICAgICBmZWVzOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJGZWVzIikpLAogICAgICBjb25zdHJhaW50czogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiQWNjZXNzQ29uc3RyYWludHMiKSksCiAgICAgIGtleXdvcmRzLAogICAgICBwcm92aWRlciwKICAgICAgb3V0cHV0Rm9ybWF0czogcmVhZE91dHB1dEZvcm1hdHNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYykKICAgIH07CiAgfQogIGZ1bmN0aW9uIHJlYWRGZWF0dXJlVHlwZXNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3QgdmVyc2lvbiA9IHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpOwogICAgY29uc3Qgb3V0cHV0Rm9ybWF0cyA9IHJlYWRPdXRwdXRGb3JtYXRzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpOwogICAgY29uc3QgY2FwYWJpbGl0eSA9IGZpbmRDaGlsZEVsZW1lbnQoCiAgICAgIGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYyksCiAgICAgICJGZWF0dXJlVHlwZUxpc3QiCiAgICApOwogICAgcmV0dXJuIGZpbmRDaGlsZHJlbkVsZW1lbnQoY2FwYWJpbGl0eSwgIkZlYXR1cmVUeXBlIikubWFwKAogICAgICAoZmVhdHVyZVR5cGVFbCkgPT4gcGFyc2VGZWF0dXJlVHlwZShmZWF0dXJlVHlwZUVsLCB2ZXJzaW9uLCBvdXRwdXRGb3JtYXRzKQogICAgKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VPcGVyYXRpb24xMDAob3BlcmF0aW9uKSB7CiAgICBjb25zdCB1cmxzID0ge307CiAgICBjb25zdCBkY3BUeXBlID0gZmluZENoaWxkcmVuRWxlbWVudChvcGVyYXRpb24sICJEQ1BUeXBlIik7CiAgICBjb25zdCBodHRwID0gZGNwVHlwZS5mbGF0TWFwKChkKSA9PiBmaW5kQ2hpbGRyZW5FbGVtZW50KGQsICJIVFRQIikpOwogICAgY29uc3QgbWV0aG9kcyA9IGh0dHAuZmxhdE1hcCgoaCkgPT4gZ2V0Q2hpbGRyZW5FbGVtZW50KGgpKTsKICAgIG1ldGhvZHMuZm9yRWFjaCgobWV0aG9kKSA9PiB7CiAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBzdHJpcE5hbWVzcGFjZShnZXRFbGVtZW50TmFtZShtZXRob2QpKTsKICAgICAgdXJsc1ttZXRob2ROYW1lXSA9IGdldEVsZW1lbnRBdHRyaWJ1dGUobWV0aG9kLCAib25saW5lUmVzb3VyY2UiKTsKICAgIH0pOwogICAgcmV0dXJuIHVybHM7CiAgfQogIGZ1bmN0aW9uIHBhcnNlT3BlcmF0aW9uMTEwKG9wZXJhdGlvbikgewogICAgY29uc3QgdXJscyA9IHt9OwogICAgY29uc3QgZGNwVHlwZSA9IGZpbmRDaGlsZHJlbkVsZW1lbnQob3BlcmF0aW9uLCAiRENQIik7CiAgICBjb25zdCBodHRwID0gZGNwVHlwZS5mbGF0TWFwKChkKSA9PiBmaW5kQ2hpbGRFbGVtZW50KGQsICJIVFRQIikpOwogICAgY29uc3QgbWV0aG9kcyA9IGh0dHAuZmxhdE1hcCgoaCkgPT4gZ2V0Q2hpbGRyZW5FbGVtZW50KGgpKTsKICAgIG1ldGhvZHMuZm9yRWFjaCgobWV0aG9kKSA9PiB7CiAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBzdHJpcE5hbWVzcGFjZShnZXRFbGVtZW50TmFtZShtZXRob2QpKTsKICAgICAgdXJsc1ttZXRob2ROYW1lXSA9IGdldEVsZW1lbnRBdHRyaWJ1dGUobWV0aG9kLCAieGxpbms6aHJlZiIpOwogICAgfSk7CiAgICByZXR1cm4gdXJsczsKICB9CiAgZnVuY3Rpb24gcGFyc2VGZWF0dXJlVHlwZShmZWF0dXJlVHlwZUVsLCBzZXJ2aWNlVmVyc2lvbiwgZGVmYXVsdE91dHB1dEZvcm1hdHMpIHsKICAgIGNvbnN0IHNyc1RhZyA9IHNlcnZpY2VWZXJzaW9uLnN0YXJ0c1dpdGgoIjIuIikgPyAiQ1JTIiA6ICJTUlMiOwogICAgY29uc3QgZGVmYXVsdFNyc1RhZyA9IHNlcnZpY2VWZXJzaW9uLnN0YXJ0c1dpdGgoIjEuMCIpID8gIlNSUyIgOiBgRGVmYXVsdCR7c3JzVGFnfWA7CiAgICBmdW5jdGlvbiBwYXJzZUJCb3gxMDAoKSB7CiAgICAgIGNvbnN0IGJib3hFbCA9IGZpbmRDaGlsZEVsZW1lbnQoZmVhdHVyZVR5cGVFbCwgIkxhdExvbmdCb3VuZGluZ0JveCIpOwogICAgICByZXR1cm4gWyJtaW54IiwgIm1pbnkiLCAibWF4eCIsICJtYXh5Il0ubWFwKChuYW1lKSA9PiBnZXRFbGVtZW50QXR0cmlidXRlKGJib3hFbCwgbmFtZSkpLm1hcChwYXJzZUZsb2F0KTsKICAgIH0KICAgIGZ1bmN0aW9uIHBhcnNlQkJveDIoKSB7CiAgICAgIGNvbnN0IGJib3hFbCA9IGZpbmRDaGlsZEVsZW1lbnQoZmVhdHVyZVR5cGVFbCwgIldHUzg0Qm91bmRpbmdCb3giKTsKICAgICAgcmV0dXJuIFsiTG93ZXJDb3JuZXIiLCAiVXBwZXJDb3JuZXIiXS5tYXAoKGVsTmFtZSkgPT4gZmluZENoaWxkRWxlbWVudChiYm94RWwsIGVsTmFtZSkpLm1hcCgoY29ybmVyRWwpID0+IGdldEVsZW1lbnRUZXh0KGNvcm5lckVsKS5zcGxpdCgiICIpKS5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IFsuLi5wcmV2LCAuLi5jdXJyXSkubWFwKHBhcnNlRmxvYXQpOwogICAgfQogICAgY29uc3Qgb3RoZXJDcnMgPSBzZXJ2aWNlVmVyc2lvbi5zdGFydHNXaXRoKCIxLjAiKSA/IFtdIDogZmluZENoaWxkcmVuRWxlbWVudChmZWF0dXJlVHlwZUVsLCBgT3RoZXIke3Nyc1RhZ31gKS5tYXAoZ2V0RWxlbWVudFRleHQpLm1hcChzaW1wbGlmeUVwc2dVcm4pOwogICAgY29uc3Qgb3V0cHV0Rm9ybWF0cyA9IHNlcnZpY2VWZXJzaW9uLnN0YXJ0c1dpdGgoIjEuMCIpID8gW10gOiBmaW5kQ2hpbGRyZW5FbGVtZW50KAogICAgICBmaW5kQ2hpbGRFbGVtZW50KGZlYXR1cmVUeXBlRWwsICJPdXRwdXRGb3JtYXRzIiksCiAgICAgICJGb3JtYXQiCiAgICApLm1hcChnZXRFbGVtZW50VGV4dCk7CiAgICBjb25zdCBrZXl3b3JkcyA9IHNlcnZpY2VWZXJzaW9uLnN0YXJ0c1dpdGgoIjEuMCIpID8gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiS2V5d29yZHMiKSkuc3BsaXQoIiwiKS5tYXAoKGtleXdvcmQpID0+IGtleXdvcmQudHJpbSgpKSA6IGZpbmRDaGlsZHJlbkVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZmVhdHVyZVR5cGVFbCwgIktleXdvcmRzIiksCiAgICAgICJLZXl3b3JkIgogICAgKS5tYXAoZ2V0RWxlbWVudFRleHQpLmZpbHRlcigodiwgaSwgYXJyKSA9PiBhcnIuaW5kZXhPZih2KSA9PT0gaSk7CiAgICBjb25zdCBtZXRhZGF0YSA9IHNlcnZpY2VWZXJzaW9uID09PSAiMi4wLjAiID8gZmluZENoaWxkcmVuRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiTWV0YWRhdGFVUkwiKS5tYXAoCiAgICAgIChtZXRhZGF0YVVybEVsKSA9PiAoewogICAgICAgIHVybDogZ2V0RWxlbWVudEF0dHJpYnV0ZShtZXRhZGF0YVVybEVsLCAieGxpbms6aHJlZiIpCiAgICAgIH0pCiAgICApIDogZmluZENoaWxkcmVuRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiTWV0YWRhdGFVUkwiKS5tYXAoCiAgICAgIChtZXRhZGF0YVVybEVsKSA9PiAoewogICAgICAgIGZvcm1hdDogZ2V0RWxlbWVudEF0dHJpYnV0ZShtZXRhZGF0YVVybEVsLCAiZm9ybWF0IiksCiAgICAgICAgdHlwZTogZ2V0RWxlbWVudEF0dHJpYnV0ZShtZXRhZGF0YVVybEVsLCAidHlwZSIpLAogICAgICAgIHVybDogZ2V0RWxlbWVudFRleHQobWV0YWRhdGFVcmxFbCkudHJpbSgpCiAgICAgIH0pCiAgICApOwogICAgcmV0dXJuIHsKICAgICAgbmFtZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiTmFtZSIpKSwKICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZmVhdHVyZVR5cGVFbCwgIlRpdGxlIikpLAogICAgICBhYnN0cmFjdDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiQWJzdHJhY3QiKSksCiAgICAgIGRlZmF1bHRDcnM6IHNpbXBsaWZ5RXBzZ1VybigKICAgICAgICBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGZlYXR1cmVUeXBlRWwsIGRlZmF1bHRTcnNUYWcpKQogICAgICApLAogICAgICBvdGhlckNycywKICAgICAgb3V0cHV0Rm9ybWF0czogb3V0cHV0Rm9ybWF0cy5sZW5ndGggPiAwID8gb3V0cHV0Rm9ybWF0cyA6IGRlZmF1bHRPdXRwdXRGb3JtYXRzLAogICAgICBsYXRMb25Cb3VuZGluZ0JveDogc2VydmljZVZlcnNpb24uc3RhcnRzV2l0aCgiMS4wIikgPyBwYXJzZUJCb3gxMDAoKSA6IHBhcnNlQkJveDIoKSwKICAgICAga2V5d29yZHMsCiAgICAgIC4uLm1ldGFkYXRhLmxlbmd0aCAmJiB7IG1ldGFkYXRhIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlQkJveCh4bWxFbGVtZW50KSB7CiAgICBjb25zdCByZXN1bHQgPSBbIkxvd2VyQ29ybmVyIiwgIlVwcGVyQ29ybmVyIl0ubWFwKChlbE5hbWUpID0+IGZpbmRDaGlsZEVsZW1lbnQoeG1sRWxlbWVudCwgZWxOYW1lKSkubWFwKChjb3JuZXJFbCkgPT4gZ2V0RWxlbWVudFRleHQoY29ybmVyRWwpLnNwbGl0KCIgIikpLnJlZHVjZSgocHJldiwgY3VycikgPT4gWy4uLnByZXYsIC4uLmN1cnJdKS5tYXAocGFyc2VGbG9hdCk7CiAgICBpZiAocmVzdWx0LnNvbWUoTnVtYmVyLmlzTmFOKSkKICAgICAgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiByZWFkSW5mb0Zyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICBjb25zdCByb290RWwgPSBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpOwogICAgY29uc3Qgc2VydmljZSA9IGZpbmRDaGlsZEVsZW1lbnQocm9vdEVsLCAiU2VydmljZUlkZW50aWZpY2F0aW9uIik7CiAgICBjb25zdCBrZXl3b3JkcyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIktleXdvcmRzIiksCiAgICAgICJLZXl3b3JkIgogICAgKS5tYXAoZ2V0RWxlbWVudFRleHQpOwogICAgY29uc3QgbWV0YWRhdGEgPSBmaW5kQ2hpbGRFbGVtZW50KHJvb3RFbCwgIk9wZXJhdGlvbnNNZXRhZGF0YSIpOwogICAgY29uc3QgZ2V0VGlsZU9wZXJhdGlvbiA9IGZpbmRDaGlsZHJlbkVsZW1lbnQobWV0YWRhdGEsICJPcGVyYXRpb24iKS5maW5kKAogICAgICAoZWwpID0+IGdldEVsZW1lbnRBdHRyaWJ1dGUoZWwsICJuYW1lIikgPT0gIkdldFRpbGUiCiAgICApOwogICAgY29uc3QgZ2V0VGlsZVVybHMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGdldFRpbGVPcGVyYXRpb24sICJHZXQiLCB0cnVlKS5yZWR1Y2UoCiAgICAgIChwcmV2LCBjdXJyKSA9PiB7CiAgICAgICAgY29uc3QgZW5jb2RpbmdUeXBlID0gZ2V0RWxlbWVudFRleHQoCiAgICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGN1cnIsICJWYWx1ZSIsIHRydWUpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB1cmwgPSBnZXRFbGVtZW50QXR0cmlidXRlKGN1cnIsICJ4bGluazpocmVmIik7CiAgICAgICAgaWYgKGVuY29kaW5nVHlwZS50b0xvd2VyQ2FzZSgpID09PSAicmVzdGZ1bCIpCiAgICAgICAgICByZXR1cm4geyAuLi5wcmV2LCByZXN0OiB1cmwgfTsKICAgICAgICByZXR1cm4geyAuLi5wcmV2LCBrdnA6IHVybCB9OwogICAgICB9LAogICAgICB7fQogICAgKTsKICAgIHJldHVybiB7CiAgICAgIHRpdGxlOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJUaXRsZSIpKSwKICAgICAgbmFtZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiU2VydmljZVR5cGUiKSksCiAgICAgIGFic3RyYWN0OiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJBYnN0cmFjdCIpKSwKICAgICAgZmVlczogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiRmVlcyIpKSwKICAgICAgY29uc3RyYWludHM6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIkFjY2Vzc0NvbnN0cmFpbnRzIikpLAogICAgICBrZXl3b3JkcywKICAgICAgcHJvdmlkZXI6IHJlYWRQcm92aWRlckZyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKSwKICAgICAgZ2V0VGlsZVVybHMKICAgIH07CiAgfQogIGZ1bmN0aW9uIHJlYWRNYXRyaXhTZXRzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGZ1bmN0aW9uIHBhcnNlTWF0cml4U2V0KGVsZW1lbnQpIHsKICAgICAgY29uc3QgdG9wTGVmdCA9IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIlRvcExlZnRDb3JuZXIiKSkuc3BsaXQoIiAiKS5tYXAocGFyc2VGbG9hdCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaWRlbnRpZmllcjogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiSWRlbnRpZmllciIpKSwKICAgICAgICB0aWxlV2lkdGg6IHBhcnNlSW50KAogICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiVGlsZVdpZHRoIikpCiAgICAgICAgKSwKICAgICAgICB0aWxlSGVpZ2h0OiBwYXJzZUludCgKICAgICAgICAgIGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIlRpbGVIZWlnaHQiKSkKICAgICAgICApLAogICAgICAgIG1hdHJpeFdpZHRoOiBwYXJzZUludCgKICAgICAgICAgIGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIk1hdHJpeFdpZHRoIikpCiAgICAgICAgKSwKICAgICAgICBtYXRyaXhIZWlnaHQ6IHBhcnNlSW50KAogICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiTWF0cml4SGVpZ2h0IikpCiAgICAgICAgKSwKICAgICAgICBzY2FsZURlbm9taW5hdG9yOiBwYXJzZUZsb2F0KAogICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiU2NhbGVEZW5vbWluYXRvciIpKQogICAgICAgICksCiAgICAgICAgdG9wTGVmdAogICAgICB9OwogICAgfQogICAgY29uc3QgY29udGVudHMgPSBmaW5kQ2hpbGRFbGVtZW50KAogICAgICBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLAogICAgICAiQ29udGVudHMiCiAgICApOwogICAgY29uc3QgbWF0cml4U2V0cyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoY29udGVudHMsICJUaWxlTWF0cml4U2V0Iik7CiAgICByZXR1cm4gbWF0cml4U2V0cy5tYXAoKGVsZW1lbnQpID0+IHsKICAgICAgY29uc3Qgd2VsbEtub3duU2NhbGVTZXQgPSBnZXRFbGVtZW50VGV4dCgKICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJXZWxsS25vd25TY2FsZVNldCIpCiAgICAgICk7CiAgICAgIGNvbnN0IGJvdW5kaW5nQm94ID0gcGFyc2VCQm94KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIkJvdW5kaW5nQm94IikpOwogICAgICByZXR1cm4gewogICAgICAgIGlkZW50aWZpZXI6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIklkZW50aWZpZXIiKSksCiAgICAgICAgY3JzOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJTdXBwb3J0ZWRDUlMiKSksCiAgICAgICAgdGlsZU1hdHJpY2VzOiBmaW5kQ2hpbGRyZW5FbGVtZW50KGVsZW1lbnQsICJUaWxlTWF0cml4IikubWFwKAogICAgICAgICAgcGFyc2VNYXRyaXhTZXQKICAgICAgICApLAogICAgICAgIC4uLmJvdW5kaW5nQm94ICYmIHsgYm91bmRpbmdCb3ggfSwKICAgICAgICAuLi53ZWxsS25vd25TY2FsZVNldCAmJiB7IHdlbGxLbm93blNjYWxlU2V0IH0KICAgICAgfTsKICAgIH0pOwogIH0KICBmdW5jdGlvbiByZWFkTGF5ZXJzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IHJvb3RFbCA9IGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYyk7CiAgICBjb25zdCBjb250ZW50c0VsID0gZmluZENoaWxkRWxlbWVudChyb290RWwsICJDb250ZW50cyIpOwogICAgZnVuY3Rpb24gcGFyc2VNYXRyaXhTZXRMaW5rKGVsZW1lbnQpIHsKICAgICAgY29uc3QgZnVsbE1hdHJpeFNldCA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoY29udGVudHNFbCwgIlRpbGVNYXRyaXhTZXQiKS5maW5kKAogICAgICAgIChlbCkgPT4gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbCwgIklkZW50aWZpZXIiKSkKICAgICAgKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpZGVudGlmaWVyOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJUaWxlTWF0cml4U2V0IikpLAogICAgICAgIGNyczogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChmdWxsTWF0cml4U2V0LCAiU3VwcG9ydGVkQ1JTIikpLAogICAgICAgIGxpbWl0czogZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCAiVGlsZU1hdHJpeExpbWl0cyIsIHRydWUpLm1hcCgKICAgICAgICAgIChlbGVtZW50MikgPT4gKHsKICAgICAgICAgICAgdGlsZU1hdHJpeDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIlRpbGVNYXRyaXgiKSksCiAgICAgICAgICAgIG1pblRpbGVSb3c6IHBhcnNlSW50KAogICAgICAgICAgICAgIGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJNaW5UaWxlUm93IikpCiAgICAgICAgICAgICksCiAgICAgICAgICAgIG1pblRpbGVDb2w6IHBhcnNlSW50KAogICAgICAgICAgICAgIGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJNaW5UaWxlQ29sIikpCiAgICAgICAgICAgICksCiAgICAgICAgICAgIG1heFRpbGVSb3c6IHBhcnNlSW50KAogICAgICAgICAgICAgIGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJNYXhUaWxlUm93IikpCiAgICAgICAgICAgICksCiAgICAgICAgICAgIG1heFRpbGVDb2w6IHBhcnNlSW50KAogICAgICAgICAgICAgIGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJNYXhUaWxlQ29sIikpCiAgICAgICAgICAgICkKICAgICAgICAgIH0pCiAgICAgICAgKQogICAgICB9OwogICAgfQogICAgY29uc3QgZ2V0VGlsZU9wZXJhdGlvbiA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQocm9vdEVsLCAiT3BlcmF0aW9uc01ldGFkYXRhIiksCiAgICAgICJPcGVyYXRpb24iCiAgICApLmZpbmQoKGVsKSA9PiBnZXRFbGVtZW50QXR0cmlidXRlKGVsLCAibmFtZSIpID09ICJHZXRUaWxlIik7CiAgICBjb25zdCBnZXRLdnBFbHQgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGdldFRpbGVPcGVyYXRpb24sICJHZXQiLCB0cnVlKS5maWx0ZXIoCiAgICAgIChlbHQpID0+IHsKICAgICAgICBjb25zdCBlbmNvZGluZ1R5cGUgPSBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsdCwgIlZhbHVlIiwgdHJ1ZSkpOwogICAgICAgIHJldHVybiBlbmNvZGluZ1R5cGUudG9Mb3dlckNhc2UoKSA9PT0gImt2cCI7CiAgICAgIH0KICAgIClbMF07CiAgICBjb25zdCBnZXRLdnBVcmwgPSBnZXRLdnBFbHQgPyBnZXRFbGVtZW50QXR0cmlidXRlKGdldEt2cEVsdCwgInhsaW5rOmhyZWYiKSA6ICIiOwogICAgY29uc3QgY29udGVudHMgPSBmaW5kQ2hpbGRFbGVtZW50KHJvb3RFbCwgIkNvbnRlbnRzIik7CiAgICBjb25zdCBsYXllcnMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGNvbnRlbnRzLCAiTGF5ZXIiKTsKICAgIHJldHVybiBsYXllcnMubWFwKChlbGVtZW50KSA9PiB7CiAgICAgIGNvbnN0IGxhdExvbkJvdW5kaW5nQm94ID0gcGFyc2VCQm94KAogICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIldHUzg0Qm91bmRpbmdCb3giKQogICAgICApOwogICAgICBsZXQgZGVmYXVsdFN0eWxlID0gIiI7CiAgICAgIGNvbnN0IHN0eWxlcyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZWxlbWVudCwgIlN0eWxlIikubWFwKChlbGVtZW50MikgPT4gewogICAgICAgIGNvbnN0IGxlZ2VuZFVybCA9IGdldEVsZW1lbnRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQyLCAiTGVnZW5kVVJMIiksCiAgICAgICAgICAieGxpbms6aHJlZiIKICAgICAgICApOwogICAgICAgIGNvbnN0IGFic3RyYWN0ID0gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIkFic3RyYWN0IikpOwogICAgICAgIGNvbnN0IHN0eWxlID0gewogICAgICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJUaXRsZSIpKSwKICAgICAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJJZGVudGlmaWVyIikpLAogICAgICAgICAgLi4uYWJzdHJhY3QgJiYgeyBhYnN0cmFjdCB9LAogICAgICAgICAgLi4ubGVnZW5kVXJsICYmIHsgbGVnZW5kVXJsIH0KICAgICAgICB9OwogICAgICAgIGlmIChnZXRFbGVtZW50QXR0cmlidXRlKGVsZW1lbnQyLCAiaXNEZWZhdWx0IikgPT09ICJ0cnVlIikgewogICAgICAgICAgZGVmYXVsdFN0eWxlID0gc3R5bGUubmFtZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0eWxlOwogICAgICB9KTsKICAgICAgY29uc3Qgb3V0cHV0Rm9ybWF0cyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZWxlbWVudCwgIkZvcm1hdCIpLm1hcCgKICAgICAgICBnZXRFbGVtZW50VGV4dAogICAgICApOwogICAgICBjb25zdCByZXNvdXJjZUxpbmtzID0gZmluZENoaWxkcmVuRWxlbWVudCgKICAgICAgICBlbGVtZW50LAogICAgICAgICJSZXNvdXJjZVVSTCIKICAgICAgKS5maWx0ZXIoCiAgICAgICAgKGVsZW1lbnQyKSA9PiBnZXRFbGVtZW50QXR0cmlidXRlKGVsZW1lbnQyLCAicmVzb3VyY2VUeXBlIikgPT09ICJ0aWxlIgogICAgICApLm1hcCgoZWxlbWVudDIpID0+IHsKICAgICAgICBjb25zdCBmb3JtYXQgPSBnZXRFbGVtZW50QXR0cmlidXRlKGVsZW1lbnQyLCAiZm9ybWF0Iik7CiAgICAgICAgY29uc3QgdXJsID0gZ2V0RWxlbWVudEF0dHJpYnV0ZShlbGVtZW50MiwgInRlbXBsYXRlIik7CiAgICAgICAgcmV0dXJuIHsgZm9ybWF0LCB1cmwsIGVuY29kaW5nOiAiUkVTVCIgfTsKICAgICAgfSk7CiAgICAgIGlmIChnZXRLdnBVcmwpIHsKICAgICAgICByZXNvdXJjZUxpbmtzLnB1c2goCiAgICAgICAgICAuLi5vdXRwdXRGb3JtYXRzLm1hcCgoZm9ybWF0KSA9PiAoewogICAgICAgICAgICBlbmNvZGluZzogIktWUCIsCiAgICAgICAgICAgIHVybDogZ2V0S3ZwVXJsLAogICAgICAgICAgICBmb3JtYXQKICAgICAgICAgIH0pKQogICAgICAgICk7CiAgICAgIH0KICAgICAgY29uc3QgbWF0cml4U2V0cyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZWxlbWVudCwgIlRpbGVNYXRyaXhTZXRMaW5rIikubWFwKAogICAgICAgIHBhcnNlTWF0cml4U2V0TGluawogICAgICApOwogICAgICBjb25zdCBkaW1lbnNpb25zID0gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCAiRGltZW5zaW9uIikubWFwKAogICAgICAgIChlbGVtZW50MikgPT4gewogICAgICAgICAgY29uc3QgaWRlbnRpZmllciA9IGdldEVsZW1lbnRUZXh0KAogICAgICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQyLCAiSWRlbnRpZmllciIpCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gZ2V0RWxlbWVudFRleHQoCiAgICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJEZWZhdWx0IikKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGVsZW1lbnQyLCAiVmFsdWVzIikubWFwKAogICAgICAgICAgICBnZXRFbGVtZW50VGV4dAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybiB7IGlkZW50aWZpZXIsIGRlZmF1bHRWYWx1ZSwgdmFsdWVzIH07CiAgICAgICAgfQogICAgICApOwogICAgICByZXR1cm4gewogICAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIklkZW50aWZpZXIiKSksCiAgICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIlRpdGxlIikpLAogICAgICAgIGFic3RyYWN0OiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJBYnN0cmFjdCIpKSwKICAgICAgICBzdHlsZXMsCiAgICAgICAgcmVzb3VyY2VMaW5rcywKICAgICAgICBtYXRyaXhTZXRzLAogICAgICAgIGRlZmF1bHRTdHlsZSwKICAgICAgICAuLi5sYXRMb25Cb3VuZGluZ0JveCAmJiB7IGxhdExvbkJvdW5kaW5nQm94IH0sCiAgICAgICAgLi4uZGltZW5zaW9ucyAmJiB7IGRpbWVuc2lvbnMgfQogICAgICB9OwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlRmVhdHVyZVByb3BzKGdldEZlYXR1cmVzRG9jLCBmZWF0dXJlVHlwZUZ1bGwsIHNlcnZpY2VWZXJzaW9uKSB7CiAgICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0Um9vdEVsZW1lbnQoZ2V0RmVhdHVyZXNEb2MpOwogICAgbGV0IG1lbWJlcnM7CiAgICBpZiAoc2VydmljZVZlcnNpb24uc3RhcnRzV2l0aCgiMi4wIikpIHsKICAgICAgbWVtYmVycyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoY29sbGVjdGlvbiwgIm1lbWJlciIpLm1hcCgKICAgICAgICAocGFyZW50KSA9PiBnZXRDaGlsZHJlbkVsZW1lbnQocGFyZW50KVswXQogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgbWVtYmVyc1Jvb3QgPSBmaW5kQ2hpbGRFbGVtZW50KGNvbGxlY3Rpb24sICJmZWF0dXJlTWVtYmVycyIpOwogICAgICBtZW1iZXJzID0gbWVtYmVyc1Jvb3QgPyBnZXRDaGlsZHJlbkVsZW1lbnQobWVtYmVyc1Jvb3QpIDogZmluZENoaWxkcmVuRWxlbWVudChjb2xsZWN0aW9uLCAiZmVhdHVyZU1lbWJlciIpLm1hcCgKICAgICAgICAocGFyZW50KSA9PiBnZXRDaGlsZHJlbkVsZW1lbnQocGFyZW50KVswXQogICAgICApOwogICAgfQogICAgY29uc3QgaWRBdHRyID0gc2VydmljZVZlcnNpb24gPT09ICIxLjAuMCIgPyAiZmlkIiA6ICJnbWw6aWQiOwogICAgZnVuY3Rpb24gaXNFbGVtZW50UHJvcGVydHkocHJvcE5hbWUpIHsKICAgICAgcmV0dXJuIHByb3BOYW1lIGluIGZlYXR1cmVUeXBlRnVsbC5wcm9wZXJ0aWVzOwogICAgfQogICAgZnVuY3Rpb24gcGFyc2VFbGVtZW50UHJvcGVydHlWYWx1ZShwcm9wTmFtZSwgdmFsdWVBc1N0cmluZykgewogICAgICBjb25zdCB0eXBlID0gZmVhdHVyZVR5cGVGdWxsLnByb3BlcnRpZXNbcHJvcE5hbWVdOwogICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICBjYXNlICJpbnRlZ2VyIjoKICAgICAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZUFzU3RyaW5nKTsKICAgICAgICBjYXNlICJmbG9hdCI6CiAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZUFzU3RyaW5nKTsKICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgIHJldHVybiB2YWx1ZUFzU3RyaW5nID09PSAidHJ1ZSI7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB2YWx1ZUFzU3RyaW5nOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKG1lbWJlckVsKSB7CiAgICAgIHJldHVybiBnZXRDaGlsZHJlbkVsZW1lbnQobWVtYmVyRWwpLmZpbHRlcigoZWwpID0+IGlzRWxlbWVudFByb3BlcnR5KHN0cmlwTmFtZXNwYWNlKGdldEVsZW1lbnROYW1lKGVsKSkpKS5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IHsKICAgICAgICBjb25zdCBwcm9wTmFtZSA9IHN0cmlwTmFtZXNwYWNlKGdldEVsZW1lbnROYW1lKGN1cnIpKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgLi4ucHJldiwKICAgICAgICAgIFtwcm9wTmFtZV06IHBhcnNlRWxlbWVudFByb3BlcnR5VmFsdWUocHJvcE5hbWUsIGdldEVsZW1lbnRUZXh0KGN1cnIpKQogICAgICAgIH07CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBtZW1iZXJzLm1hcCgoZWwpID0+ICh7CiAgICAgIGlkOiBnZXRFbGVtZW50QXR0cmlidXRlKGVsLCBpZEF0dHIpLAogICAgICBwcm9wZXJ0aWVzOiBnZXRQcm9wZXJ0aWVzKGVsKQogICAgfSkpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRmVhdHVyZVByb3BzRGV0YWlscyhmZWF0dXJlc1dpdGhQcm9wcykgewogICAgcmV0dXJuIGZlYXR1cmVzV2l0aFByb3BzLnJlZHVjZSgocHJldiwgY3VycikgPT4gewogICAgICBmb3IgKGNvbnN0IHByb3BOYW1lIGluIGN1cnIucHJvcGVydGllcykgewogICAgICAgIGNvbnN0IHByb3BWYWx1ZSA9IGN1cnIucHJvcGVydGllc1twcm9wTmFtZV07CiAgICAgICAgaWYgKCEocHJvcE5hbWUgaW4gcHJldikpIHsKICAgICAgICAgIHByZXZbcHJvcE5hbWVdID0geyB1bmlxdWVWYWx1ZXM6IFtdIH07CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVuaXF1ZVZhbHVlID0gcHJldltwcm9wTmFtZV0udW5pcXVlVmFsdWVzLmZpbmQoCiAgICAgICAgICAodikgPT4gdi52YWx1ZSA9PT0gcHJvcFZhbHVlCiAgICAgICAgKTsKICAgICAgICBpZiAodW5pcXVlVmFsdWUpCiAgICAgICAgICB1bmlxdWVWYWx1ZS5jb3VudCsrOwogICAgICAgIGVsc2UKICAgICAgICAgIHByZXZbcHJvcE5hbWVdLnVuaXF1ZVZhbHVlcy5wdXNoKHsgdmFsdWU6IHByb3BWYWx1ZSwgY291bnQ6IDEgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHByZXY7CiAgICB9LCB7fSk7CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlR2V0RmVhdHVyZVVybChzZXJ2aWNlVXJsLCB2ZXJzaW9uLCBmZWF0dXJlVHlwZSwgb3V0cHV0Rm9ybWF0LCBtYXhGZWF0dXJlcywgYXR0cmlidXRlcywgaGl0c09ubHksIG91dHB1dENycywgZXh0ZW50LCBleHRlbnRDcnMsIHN0YXJ0SW5kZXgpIHsKICAgIGNvbnN0IHR5cGVQYXJhbSA9IHZlcnNpb24gPT09ICIyLjAuMCIgPyAiVFlQRU5BTUVTIiA6ICJUWVBFTkFNRSI7CiAgICBjb25zdCBjb3VudFBhcmFtID0gdmVyc2lvbiA9PT0gIjIuMC4wIiA/ICJDT1VOVCIgOiAiTUFYRkVBVFVSRVMiOwogICAgY29uc3QgbmV3UGFyYW1zID0gewogICAgICBTRVJWSUNFOiAiV0ZTIiwKICAgICAgUkVRVUVTVDogIkdldEZlYXR1cmUiLAogICAgICBWRVJTSU9OOiB2ZXJzaW9uLAogICAgICBbdHlwZVBhcmFtXTogZmVhdHVyZVR5cGUKICAgIH07CiAgICBpZiAob3V0cHV0Rm9ybWF0ICE9PSB2b2lkIDApCiAgICAgIG5ld1BhcmFtcy5PVVRQVVRGT1JNQVQgPSBvdXRwdXRGb3JtYXQ7CiAgICBpZiAoYXR0cmlidXRlcyAhPT0gdm9pZCAwKQogICAgICBuZXdQYXJhbXMuUFJPUEVSVFlOQU1FID0gYXR0cmlidXRlcy5qb2luKCIsIik7CiAgICBpZiAoaGl0c09ubHkpIHsKICAgICAgbmV3UGFyYW1zLlJFU1VMVFRZUEUgPSAiaGl0cyI7CiAgICAgIG5ld1BhcmFtc1tjb3VudFBhcmFtXSA9ICIxIjsKICAgIH0gZWxzZSBpZiAobWF4RmVhdHVyZXMgIT09IHZvaWQgMCkKICAgICAgbmV3UGFyYW1zW2NvdW50UGFyYW1dID0gbWF4RmVhdHVyZXMudG9TdHJpbmcoMTApOwogICAgaWYgKG91dHB1dENycykgewogICAgICBuZXdQYXJhbXMuU1JTTkFNRSA9IG91dHB1dENyczsKICAgIH0KICAgIGlmIChleHRlbnQpIHsKICAgICAgY29uc3QgZXh0ZW50Sm9pbmVkID0gZXh0ZW50LmpvaW4oIiwiKTsKICAgICAgbmV3UGFyYW1zLkJCT1ggPSBleHRlbnRDcnMgPyBgJHtleHRlbnRKb2luZWR9LCR7ZXh0ZW50Q3JzfWAgOiBleHRlbnRKb2luZWQ7CiAgICB9CiAgICBpZiAoc3RhcnRJbmRleCkgewogICAgICBuZXdQYXJhbXMuU1RBUlRJTkRFWCA9IHN0YXJ0SW5kZXgudG9TdHJpbmcoMTApOwogICAgfQogICAgcmV0dXJuIHNldFF1ZXJ5UGFyYW1zKHNlcnZpY2VVcmwsIG5ld1BhcmFtcyk7CiAgfQogIGFkZFRhc2tIYW5kbGVyKAogICAgInBhcnNlV21zQ2FwYWJpbGl0aWVzIiwKICAgIGdsb2JhbFRoaXMsCiAgICAoeyB1cmwgfSkgPT4gcXVlcnlYbWxEb2N1bWVudCh1cmwpLnRoZW4oKHhtbERvYykgPT4gY2hlY2soeG1sRG9jLCB1cmwpKS50aGVuKCh4bWxEb2MpID0+ICh7CiAgICAgIGluZm86IHJlYWRJbmZvRnJvbUNhcGFiaWxpdGllcyQyKHhtbERvYyksCiAgICAgIGxheWVyczogcmVhZExheWVyc0Zyb21DYXBhYmlsaXRpZXMkMSh4bWxEb2MpLAogICAgICB1cmw6IHJlYWRPcGVyYXRpb25VcmxzRnJvbUNhcGFiaWxpdGllcyQxKHhtbERvYyksCiAgICAgIHZlcnNpb246IHJlYWRWZXJzaW9uRnJvbUNhcGFiaWxpdGllcyQxKHhtbERvYykKICAgIH0pKQogICk7CiAgYWRkVGFza0hhbmRsZXIoCiAgICAicGFyc2VXZnNDYXBhYmlsaXRpZXMiLAogICAgZ2xvYmFsVGhpcywKICAgICh7IHVybCB9KSA9PiBxdWVyeVhtbERvY3VtZW50KHVybCkudGhlbigoeG1sRG9jKSA9PiBjaGVjayh4bWxEb2MsIHVybCkpLnRoZW4oKHhtbERvYykgPT4gKHsKICAgICAgaW5mbzogcmVhZEluZm9Gcm9tQ2FwYWJpbGl0aWVzJDEoeG1sRG9jKSwKICAgICAgZmVhdHVyZVR5cGVzOiByZWFkRmVhdHVyZVR5cGVzRnJvbUNhcGFiaWxpdGllcyh4bWxEb2MpLAogICAgICB1cmw6IHJlYWRPcGVyYXRpb25VcmxzRnJvbUNhcGFiaWxpdGllcyh4bWxEb2MpLAogICAgICB2ZXJzaW9uOiByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMoeG1sRG9jKQogICAgfSkpCiAgKTsKICBhZGRUYXNrSGFuZGxlcigKICAgICJxdWVyeVdmc0ZlYXR1cmVUeXBlRGV0YWlscyIsCiAgICBnbG9iYWxUaGlzLAogICAgKHsKICAgICAgdXJsLAogICAgICBzZXJ2aWNlVmVyc2lvbiwKICAgICAgZmVhdHVyZVR5cGVGdWxsCiAgICB9KSA9PiB7CiAgICAgIGNvbnN0IGdldEZlYXR1cmVVcmwgPSBnZW5lcmF0ZUdldEZlYXR1cmVVcmwoCiAgICAgICAgdXJsLAogICAgICAgIHNlcnZpY2VWZXJzaW9uLAogICAgICAgIGZlYXR1cmVUeXBlRnVsbC5uYW1lLAogICAgICAgIHZvaWQgMCwKICAgICAgICB2b2lkIDAsCiAgICAgICAgT2JqZWN0LmtleXMoZmVhdHVyZVR5cGVGdWxsLnByb3BlcnRpZXMpCiAgICAgICk7CiAgICAgIHJldHVybiBxdWVyeVhtbERvY3VtZW50KGdldEZlYXR1cmVVcmwpLnRoZW4oKGdldEZlYXR1cmVEb2MpID0+ICh7CiAgICAgICAgcHJvcHM6IGNvbXB1dGVGZWF0dXJlUHJvcHNEZXRhaWxzKAogICAgICAgICAgcGFyc2VGZWF0dXJlUHJvcHMoZ2V0RmVhdHVyZURvYywgZmVhdHVyZVR5cGVGdWxsLCBzZXJ2aWNlVmVyc2lvbikKICAgICAgICApCiAgICAgIH0pKTsKICAgIH0KICApOwogIGFkZFRhc2tIYW5kbGVyKAogICAgInVwZGF0ZUZldGNoT3B0aW9ucyIsCiAgICBnbG9iYWxUaGlzLAogICAgKHsgb3B0aW9ucyB9KSA9PiB7CiAgICAgIHNldEZldGNoT3B0aW9ucyhvcHRpb25zKTsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7fSk7CiAgICB9CiAgKTsKICBhZGRUYXNrSGFuZGxlcigKICAgICJwYXJzZVdtdHNDYXBhYmlsaXRpZXMiLAogICAgZ2xvYmFsVGhpcywKICAgICh7IHVybCB9KSA9PiBxdWVyeVhtbERvY3VtZW50KHVybCkudGhlbigoeG1sRG9jKSA9PiBjaGVjayh4bWxEb2MsIHVybCkpLnRoZW4oKHhtbERvYykgPT4gKHsKICAgICAgaW5mbzogcmVhZEluZm9Gcm9tQ2FwYWJpbGl0aWVzKHhtbERvYyksCiAgICAgIGxheWVyczogcmVhZExheWVyc0Zyb21DYXBhYmlsaXRpZXMoeG1sRG9jKSwKICAgICAgbWF0cml4U2V0czogcmVhZE1hdHJpeFNldHNGcm9tQ2FwYWJpbGl0aWVzKHhtbERvYykKICAgIH0pKQogICk7Cn0pKCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXdvcmtlci1zYkdwV0V0Wi5qcy5tYXAK",blob="undefined"!=typeof window&&window.Blob&&new Blob([atob(encodedJs)],{type:"text/javascript;charset=utf-8"});function WorkerWrapper(options){let objURL;try{if(objURL=blob&&(window.URL||window.webkitURL).createObjectURL(blob),!objURL)throw"";const worker=new Worker(objURL,{name:null==options?void 0:options.name});return worker.addEventListener("error",(()=>{(window.URL||window.webkitURL).revokeObjectURL(objURL)})),worker}catch(e){return new Worker("data:text/javascript;base64,"+encodedJs,{name:null==options?void 0:options.name})}finally{objURL&&(window.URL||window.webkitURL).revokeObjectURL(objURL)}}let workerInstance,fallbackWithoutWorker=!1;function getWorkerInstance(){return fallbackWithoutWorker?null:(workerInstance||(workerInstance=new WorkerWrapper),workerInstance)}var browser=__webpack_require__("./node_modules/@rgrove/parse-xml/dist/browser.js");class XmlParseError extends Error{constructor(message){super(message)}}function stripNamespace(name){const colon=name.indexOf(":");return colon>-1?name.substr(colon+1):name}function getRootElement(xmlDoc){return xmlDoc.children[0]}function getElementName(element){return element.name||""}function findChildrenElement(element,name,nested=!1){const strippedName=stripNamespace(name);return element&&Array.isArray(element.children)?element.children.reduce((function reducer(prev,curr){return stripNamespace(getElementName(curr))===strippedName&&prev.push(curr),nested&&Array.isArray(curr.children)?[...prev,...curr.children.reduce(reducer,[])]:prev}),[]):[]}function findChildElement(element,name,nested=!1){return findChildrenElement(element,name,nested)[0]||null}function getChildrenElement(element){return element&&Array.isArray(element.children)?[...element.children.filter((el=>el instanceof browser.XmlElement))]:[]}function getElementText(element){const textNode=element&&Array.isArray(element.children)?element.children.find((node=>"text"===node.type)):null;return textNode?textNode.text:""}function getElementAttribute(element,attrName){return element&&element.attributes[attrName]||""}class EndpointError extends Error{constructor(message,httpStatus,isCrossOriginRelated){super(message),this.message=message,this.httpStatus=httpStatus,this.isCrossOriginRelated=isCrossOriginRelated}}const ENCODINGS=["utf-8","utf-16","iso-8859-1"],FALLBACK_ENCODING="utf-8";const fetchPromises=new Map;let fetchOptions={},fetchOptionsUpdateCallback=null;function getFetchOptions(){return fetchOptions}function sharedFetch(url,method="GET",asJson){let fetchKey=`${method}#${url}`;if(asJson&&(fetchKey=`${method}#asJson#${url}`),fetchPromises.has(fetchKey))return fetchPromises.get(fetchKey);const options={...getFetchOptions()};options.method=method,asJson&&(options.headers="headers"in options?options.headers:{},options.headers.Accept="application/json");const promise=fetch(url,options).catch((e=>e)).then((resp=>(fetchPromises.delete(fetchKey),resp)));return fetchPromises.set(fetchKey,promise),promise.then((resp=>{if(resp instanceof Error)throw resp;return resp}))}function queryXmlDocument(url){return sharedFetch(url).catch((()=>fetch(url,{...getFetchOptions(),method:"HEAD",mode:"no-cors"}).catch((error=>{throw new EndpointError(`Fetching the document failed either due to network errors or unreachable host, error is: ${error.message}`,0,!1)})).then((()=>{throw new EndpointError("The document could not be fetched due to CORS limitations",0,!0)})))).then(function(){var _ref=(0,asyncToGenerator.A)((function*(resp){if(!resp.ok){const text=yield resp.text();throw new EndpointError(`Received an error with code ${resp.status}: ${text}`,resp.status,!1)}return function decodeString(buffer,contentType){const encodingHint=contentType?function extractEncoding(contentType){const matches=/charset=([^;]+)/.exec(contentType);return matches?matches[1]:null}(contentType):null,encodingAttempts=encodingHint?[encodingHint,...ENCODINGS]:ENCODINGS;for(const encoding of encodingAttempts)try{return new TextDecoder(encoding,{fatal:!0}).decode(buffer)}catch(e){}return console.warn(`[ogc-client] XML document encoding could not be determined, falling back to ${FALLBACK_ENCODING}.`),new TextDecoder(FALLBACK_ENCODING).decode(buffer)}(yield resp.arrayBuffer(),resp.headers.get("Content-Type"))}));return function(_x){return _ref.apply(this,arguments)}}()).then((xml=>function parseXmlString(xmlString){let doc=null;try{doc=(0,browser.parseXml)(xmlString)}catch(e){throw new XmlParseError(e.message)}return doc}(xml)))}function setQueryParams(url,params){const encodedUrlMatch=url.match(/(https?%3A%2F%2F[^/]+)$/);if(encodedUrlMatch){const encodedUrl=encodedUrlMatch[1],modifiedUrl=setQueryParams(decodeURIComponent(encodedUrl),params);return url.replace(encodedUrl,encodeURIComponent(modifiedUrl))}const urlObj=new URL(url),keys=Object.keys(params),keysLower=keys.map((key=>key.toLowerCase())),toDelete=[];for(const param of urlObj.searchParams.keys())keysLower.indexOf(param.toLowerCase())>-1&&toDelete.push(param);return toDelete.map((param=>urlObj.searchParams.delete(param))),keys.forEach((key=>urlObj.searchParams.set(key,!0===params[key]?"":params[key]))),urlObj.toString()}function getTypeFromXsdType(xsdType){switch(xsdType.indexOf(":")>-1?xsdType.substr(xsdType.indexOf(":")+1):xsdType){case"string":default:return"string";case"boolean":return"boolean";case"float":case"double":case"decimal":return"float";case"long":case"byte":case"integer":case"int":case"positiveInteger":case"negativeInteger":case"nonPositiveInteger":case"nonNegativeInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":return"integer"}}let cachePromise,cacheExpiryDuration=36e5;function getCache(){return void 0!==cachePromise?cachePromise:"caches"in globalThis?(cachePromise=caches.open("ogc-client").catch((e=>(console.info("[ogc-client] Cache could not be accessed for the following reason:",e),null))),cachePromise):(cachePromise=Promise.resolve(null),cachePromise)}function _storeCacheEntry(){return(_storeCacheEntry=(0,asyncToGenerator.A)((function*(object,...keys){const cache=yield getCache();if(!cache)return;const entryUrl="https://cache/"+keys.join("/");try{yield cache.put(entryUrl,new Response(JSON.stringify(object),{headers:{"x-expiry":(Date.now()+cacheExpiryDuration).toString(10)}}))}catch(e){console.info("[ogc-client] Caching failed once for the following reason and will not be retried:",e),cachePromise=Promise.resolve(null)}}))).apply(this,arguments)}function _hasValidCacheEntry(){return(_hasValidCacheEntry=(0,asyncToGenerator.A)((function*(...keys){const cache=yield getCache();if(!cache)return;const entryUrl="https://cache/"+keys.join("/");return cache.match(entryUrl).then((req=>!!req&&parseInt(req.headers.get("x-expiry"))>Date.now()))}))).apply(this,arguments)}function _readCacheEntry(){return(_readCacheEntry=(0,asyncToGenerator.A)((function*(...keys){const cache=yield getCache();if(!cache)return;const entryUrl="https://cache/"+keys.join("/"),response=yield cache.match(entryUrl);return response?response.clone().json():null}))).apply(this,arguments)}const tasksMap=new Map;function useCache(_x2){return _useCache.apply(this,arguments)}function _useCache(){return _useCache=(0,asyncToGenerator.A)((function*(factory,...keys){if(yield function purgeOutdatedEntries(){return _purgeOutdatedEntries.apply(this,arguments)}(),yield function hasValidCacheEntry(){return _hasValidCacheEntry.apply(this,arguments)}(...keys))return function readCacheEntry(){return _readCacheEntry.apply(this,arguments)}(...keys);const taskKey=keys.join("#");if(tasksMap.has(taskKey))return tasksMap.get(taskKey);const taskRun=factory();taskRun instanceof Promise&&(taskRun.then((()=>tasksMap.delete(taskKey))),tasksMap.set(taskKey,taskRun));const result=yield taskRun;return yield function storeCacheEntry(_x){return _storeCacheEntry.apply(this,arguments)}(result,...keys),result})),_useCache.apply(this,arguments)}function _purgeOutdatedEntries(){return(_purgeOutdatedEntries=(0,asyncToGenerator.A)((function*(){const cache=yield getCache();if(!cache)return;const keys=yield cache.keys();for(const key of keys){const resp=yield cache.match(key);parseInt(resp.headers.get("x-expiry"))<=Date.now()&&(yield cache.delete(key))}}))).apply(this,arguments)}function generateGetFeatureUrl(serviceUrl,version,featureType,outputFormat,maxFeatures,attributes,hitsOnly,outputCrs,extent,extentCrs,startIndex){const typeParam="2.0.0"===version?"TYPENAMES":"TYPENAME",countParam="2.0.0"===version?"COUNT":"MAXFEATURES",newParams={SERVICE:"WFS",REQUEST:"GetFeature",VERSION:version,[typeParam]:featureType};if(void 0!==outputFormat&&(newParams.OUTPUTFORMAT=outputFormat),void 0!==attributes&&(newParams.PROPERTYNAME=attributes.join(",")),hitsOnly?(newParams.RESULTTYPE="hits",newParams[countParam]="1"):void 0!==maxFeatures&&(newParams[countParam]=maxFeatures.toString(10)),outputCrs&&(newParams.SRSNAME=outputCrs),extent){const extentJoined=extent.join(",");newParams.BBOX=extentCrs?`${extentJoined},${extentCrs}`:extentJoined}return startIndex&&(newParams.STARTINDEX=startIndex.toString(10)),setQueryParams(serviceUrl,newParams)}function isMimeTypeJson(mimeType){return mimeType.toLowerCase().indexOf("json")>-1}function isMimeTypeGeoJson(mimeType){return/geo.?json/.test(mimeType)}function isMimeTypeJsonFg(mimeType){return/json.?fg|fg.?json/.test(mimeType)}class WfsEndpoint{_capabilitiesUrl;_capabilitiesPromise;_info;_featureTypes;_url;_version;constructor(url){this._capabilitiesUrl=setQueryParams(url,{SERVICE:"WFS",REQUEST:"GetCapabilities"}),this._capabilitiesPromise=useCache((()=>function parseWfsCapabilities(capabilitiesUrl){return sendTaskRequest("parseWfsCapabilities",getWorkerInstance(),{url:capabilitiesUrl})}(this._capabilitiesUrl)),"WFS","CAPABILITIES",this._capabilitiesUrl).then((({info,featureTypes,url:url2,version})=>{this._info=info,this._featureTypes=featureTypes,this._url=url2,this._version=version}))}isReady(){return this._capabilitiesPromise.then((()=>this))}getServiceInfo(){return this._info}getFeatureTypes(){return this._featureTypes.map((featureType=>({name:featureType.name,..."title"in featureType&&{title:featureType.title},..."abstract"in featureType&&{abstract:featureType.abstract},..."latLonBoundingBox"in featureType&&{boundingBox:featureType.latLonBoundingBox}})))}_getFeatureTypeByName(name){if(!this._featureTypes)return null;const isQualified=stripNamespace(name)!==name;return this._featureTypes.find((featureType=>isQualified?featureType.name===name:stripNamespace(featureType.name)===name))||null}getFeatureTypeSummary(name){const featureType=this._getFeatureTypeByName(name);return featureType?{name:featureType.name,..."title"in featureType&&{title:featureType.title},..."abstract"in featureType&&{abstract:featureType.abstract},..."latLonBoundingBox"in featureType&&{boundingBox:featureType.latLonBoundingBox},defaultCrs:featureType.defaultCrs,otherCrs:featureType.otherCrs,outputFormats:featureType.outputFormats,keywords:featureType.keywords,..."metadata"in featureType&&{metadata:featureType.metadata}}:null}getFeatureTypeFull(name){const featureType=this._getFeatureTypeByName(name);return featureType?useCache((()=>{const describeUrl=function generateDescribeFeatureTypeUrl(serviceUrl,version,featureType){const typeParam="2.0.0"===version?"TYPENAMES":"TYPENAME";return setQueryParams(serviceUrl,{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:version,[typeParam]:featureType})}(this.getOperationUrl("DescribeFeatureType"),this._version,name),getFeatureUrl=generateGetFeatureUrl(this.getOperationUrl("GetFeature"),this._version,name,void 0,void 0,void 0,!0);return Promise.all([queryXmlDocument(describeUrl),queryXmlDocument(getFeatureUrl)]).then((([describeResponse,getFeatureResponse])=>function parseFeatureTypeInfo(featureType,describeFeatureTypeDoc,getFeatureHitsDoc,serviceVersion){const{name,title,abstract,defaultCrs,otherCrs,outputFormats,latLonBoundingBox:boundingBox,keywords,metadata}=featureType,hitsAttr=serviceVersion.startsWith("2.0")?"numberMatched":"numberOfFeatures",objectCount=parseInt(getElementAttribute(getRootElement(getFeatureHitsDoc),hitsAttr)),complexTypeEl=findChildrenElement(getRootElement(describeFeatureTypeDoc),"complexType",!0)[0],typeElementsEls=findChildrenElement(complexTypeEl,"element",!0),properties=typeElementsEls.filter((el=>/^xsd:|^xs:/.test(getElementAttribute(el,"type")))).reduce(((prev,curr)=>({...prev,[getElementAttribute(curr,"name")]:getTypeFromXsdType(getElementAttribute(curr,"type"))})),{}),geomEl=typeElementsEls.filter((el=>getElementAttribute(el,"type").startsWith("gml:")))[0],geometryName=geomEl?getElementAttribute(geomEl,"name"):void 0,geometryType=geomEl?function getGeomTypeFromGmlType(gmlType){switch(gmlType.indexOf(":")>-1?gmlType.substr(gmlType.indexOf(":")+1):gmlType){case"PointPropertyType":return"point";case"MultiPointPropertyType":return"multipoint";case"CurvePropertyType":case"LineStringPropertyType":case"MultiCurvePropertyType":case"MultiLineStringPropertyType":return"linestring";case"PolygonPropertyType":case"SurfacePropertyType":return"polygon";case"MultiPolygonPropertyType":case"MultiSurfacePropertyType":return"multipolygon";default:return"unknown"}}(getElementAttribute(geomEl,"type")):void 0;return{name,...title&&{title},...abstract&&{abstract},...boundingBox&&{boundingBox},...defaultCrs&&{defaultCrs},...otherCrs&&{otherCrs},...outputFormats&&{outputFormats},properties,...geometryName&&{geometryName},...geometryType&&{geometryType},...!Number.isNaN(objectCount)&&{objectCount},...keywords&&{keywords},...metadata&&{metadata}}}(featureType,describeResponse,getFeatureResponse,this._version)))}),"WFS","FEATURETYPEINFO",this._capabilitiesUrl,name):null}getSingleFeatureTypeName(){return this._featureTypes&&1===this._featureTypes.length?this._featureTypes[0].name:null}getFeatureTypePropDetails(name){var _this=this;return(0,asyncToGenerator.A)((function*(){const featureTypeFull=yield _this.getFeatureTypeFull(name);return null===featureTypeFull?null:useCache((()=>function queryWfsFeatureTypeDetails(capabilitiesUrl,serviceVersion,featureTypeFull){return sendTaskRequest("queryWfsFeatureTypeDetails",getWorkerInstance(),{url:capabilitiesUrl,serviceVersion,featureTypeFull})}(_this._capabilitiesUrl,_this._version,featureTypeFull).then((result=>result.props))),"WFS","FEATURETYPEPROPDETAILS",_this._capabilitiesUrl,name)}))()}getVersion(){return this._version}_getJsonCompatibleOutputFormat(featureType){const featureTypeInfo=this._getFeatureTypeByName(featureType);if(!featureTypeInfo)throw new Error(`The following feature type was not found in the service: ${featureType}`);const candidates=featureTypeInfo.outputFormats.filter(isMimeTypeJson);return candidates.length?candidates[0]:null}supportsJson(featureType){return this._featureTypes?!!this._getJsonCompatibleOutputFormat(featureType):null}supportsStartIndex(){return!!this._version&&this._version>="2.0.0"}getFeatureUrl(featureType,options){if(!this._featureTypes)return null;const{maxFeatures,asJson,outputFormat,outputCrs,extent,extentCrs,startIndex,attributes,hitsOnly}=options||{},internalFeatureType=this._getFeatureTypeByName(featureType);if(!internalFeatureType)throw new Error(`The following feature type was not found in the service: ${featureType}`);let format=outputFormat;if(asJson){if(format=this._getJsonCompatibleOutputFormat(featureType)||void 0,!format)throw new Error(`The endpoint does not appear to support GeoJSON for the feature type ${internalFeatureType.name}`)}else outputFormat&&-1===internalFeatureType.outputFormats.indexOf(outputFormat)&&console.warn(`[ogc-client] The following output format type was not found in the feature type ${internalFeatureType.name}: ${outputFormat}`);return generateGetFeatureUrl(this.getOperationUrl("GetFeature"),this._version,internalFeatureType.name,format,maxFeatures,attributes,hitsOnly,outputCrs,extent,extentCrs,startIndex)}getCapabilitiesUrl(){const baseUrl=this.getOperationUrl("GetCapabilities");return baseUrl?setQueryParams(baseUrl,{SERVICE:"WMS",REQUEST:"GetCapabilities"}):this._capabilitiesUrl}getOperationUrl(operationName,method="Get"){return this._url?this._url[operationName]?.[method]:null}}class WmsEndpoint{_capabilitiesUrl;_capabilitiesPromise;_info;_layers;_url;_version;constructor(url){this._capabilitiesUrl=setQueryParams(url,{SERVICE:"WMS",REQUEST:"GetCapabilities"}),this._capabilitiesPromise=useCache((()=>function parseWmsCapabilities(capabilitiesUrl){return sendTaskRequest("parseWmsCapabilities",getWorkerInstance(),{url:capabilitiesUrl})}(this._capabilitiesUrl)),"WMS","CAPABILITIES",this._capabilitiesUrl).then((({info,layers,url:url2,version})=>{this._info=info,this._layers=layers,this._url=url2,this._version=version}))}isReady(){return this._capabilitiesPromise.then((()=>this))}getServiceInfo(){return this._info}getLayers(){return this._layers.map((function layerSummaryMapper(layerFull){return{title:layerFull.title,name:layerFull.name,abstract:layerFull.abstract,..."children"in layerFull&&{children:layerFull.children.map(layerSummaryMapper)}}}))}getLayerByName(name){let result=null;return this._layers.map((function layerLookup(layer){null===result&&(layer.name!==name?"children"in layer&&layer.children.map(layerLookup):result=layer)})),result}getSingleLayerName(){if(!this._layers)return null;const layers=[];return this._layers.map((function layerLookup(layer){layer.name&&layers.push(layer),"children"in layer&&layer.children.map(layerLookup)})),1===layers.length?layers[0].name:null}getVersion(){return this._version}getMapUrl(layers,options){if(!this._layers)return null;const{widthPx,heightPx,crs,extent,outputFormat,styles}=options;return function generateGetMapUrl(serviceUrl,version,layers,widthPx,heightPx,crs,extent,outputFormat,styles){const crsParam="1.3.0"===version?"CRS":"SRS",newParams={SERVICE:"WMS",REQUEST:"GetMap",VERSION:version,LAYERS:layers,STYLES:styles??""};return newParams.WIDTH=widthPx.toString(),newParams.HEIGHT=heightPx.toString(),newParams.FORMAT=outputFormat??"image/png",newParams[crsParam]=crs,newParams.BBOX=extent.join(","),setQueryParams(serviceUrl,newParams)}(this.getOperationUrl("GetMap")||this._capabilitiesUrl,this._version,layers.join(","),widthPx,heightPx,crs,extent,outputFormat,void 0!==styles?styles.join(","):"")}getCapabilitiesUrl(){const baseUrl=this.getOperationUrl("GetCapabilities");return baseUrl?setQueryParams(baseUrl,{SERVICE:"WMS",REQUEST:"GetCapabilities"}):this._capabilitiesUrl}getOperationUrl(operationName,method="Get"){return this._url?this._url[operationName]?.[method]:null}}class WmtsEndpoint{_capabilitiesPromise;_info=null;_layers=null;_matrixSets=null;constructor(url){const capabilitiesUrl=setQueryParams(url,{SERVICE:"WMTS",REQUEST:"GetCapabilities"});this._capabilitiesPromise=useCache((()=>function parseWmtsCapabilities(capabilitiesUrl){return sendTaskRequest("parseWmtsCapabilities",getWorkerInstance(),{url:capabilitiesUrl})}(capabilitiesUrl)),"WMTS","CAPABILITIES",capabilitiesUrl).then((({info,layers,matrixSets})=>{this._info=info,this._layers=layers,this._matrixSets=matrixSets}))}isReady(){return this._capabilitiesPromise.then((()=>this))}getServiceInfo(){return this._info}getLayers(){return this._layers}getMatrixSets(){return this._matrixSets}getMatrixSetByIdentifier(identifier){return this._matrixSets?this._matrixSets.find((matrixSet=>matrixSet.identifier===identifier))??null:null}getLayerByName(name){return this._layers?this._layers.find((layer=>layer.name===name))??null:null}getSingleLayerName(){return this._layers&&1===this._layers.length?this._layers[0].name:null}getLayerResourceLink(layerName,formatHint){if(!this._layers)return null;const layer=this.getLayerByName(layerName);let resourceLinkIndex=0;formatHint&&(resourceLinkIndex=layer.resourceLinks.findIndex((resourceLink2=>resourceLink2.format===formatHint))||0);const resourceLink=layer.resourceLinks[resourceLinkIndex];return formatHint&&resourceLink.format!==formatHint&&console.warn(`[ogc-client] Requested '${formatHint}' format for the WMTS layer but it is not available in REST encoding, falling back to '${resourceLink.format}'`),resourceLink}getTileUrl(layerName,styleName,matrixSetName,tileMatrix,tileRow,tileCol,outputFormat){if(!this._layers)return null;const resourceLink=this.getLayerResourceLink(layerName,outputFormat);return function generateGetTileUrl(baseUrl,requestEncoding,layerName,styleName,matrixSetName,tileMatrix,tileRow,tileCol,outputFormat){const context={layer:layerName,style:styleName,tilematrixset:matrixSetName,Service:"WMTS",Request:"GetTile",Format:outputFormat,TileMatrix:tileMatrix,TileCol:tileCol.toString(),TileRow:tileRow.toString()};if("REST"===requestEncoding){let url=baseUrl;for(const key in context)url=url.replace(new RegExp(`{${key}}`,"ig"),context[key]);return url}return setQueryParams(baseUrl,context)}(resourceLink.url,resourceLink.encoding,layerName,styleName,matrixSetName,tileMatrix,tileRow,tileCol,resourceLink.format)}getDefaultDimensions(layerName){if(!this._layers)return null;const layer=this.getLayerByName(layerName);return layer.dimensions?layer.dimensions.reduce(((prev,curr)=>({...prev,[curr.identifier]:curr.defaultValue})),{}):{}}tileGridModule;getOpenLayersTileGrid(layerName,matrixSetIdentifier){if(!this._layers)return null;this.tileGridModule||(this.tileGridModule=Promise.all([__webpack_require__.e(5246),__webpack_require__.e(9365),__webpack_require__.e(3249)]).then(__webpack_require__.bind(__webpack_require__,"./node_modules/@camptocamp/ogc-client/dist/wmts/ol-tilegrid.js")).catch((e=>(console.warn("[ogc-client] Cannot use getOpenLayersTileGrid, the 'ol' package is probably not available.\n",e),null))));const layer=this.getLayerByName(layerName),matrixSetLink=layer.matrixSets.find((matrixSet2=>matrixSet2.identifier===matrixSetIdentifier))??layer.matrixSets[0],matrixSet=this.getMatrixSetByIdentifier(matrixSetLink.identifier);return this.tileGridModule.then((({buildOpenLayersTileGrid})=>buildOpenLayersTileGrid(matrixSet,matrixSetLink.limits)))}}const CollectionParameterTypes=["string","number","integer","date","point","linestring","polygon","geometry"];function fetchDocument(url){const urlObj=new URL(url,window.location.toString());return urlObj.searchParams.set("f","json"),sharedFetch(urlObj.toString(),"GET",!0).then((resp=>{if(!resp.ok)throw new Error(`The document at ${urlObj} could not be fetched.`);return resp.clone().json().catch((e=>{throw new Error(`The document at ${urlObj} does not appear to be valid JSON. Error was: ${e.message}`)}))}))}function fetchRoot(url){return fetchDocument(url).then((doc=>{if(!hasLinks(doc,["data","http://www.opengis.net/def/rel/ogc/1.0/data"])||!hasLinks(doc,["conformance","http://www.opengis.net/def/rel/ogc/1.0/conformance"])){let parentUrl=getParentPath(url);if(!parentUrl)throw new Error("Could not find a root JSON document containing both a link with rel='data' and a link with rel='conformance'.");if("collections"in doc){const urlObj=new URL(parentUrl);urlObj.pathname=`${urlObj.pathname}/`,parentUrl=urlObj.toString()}return fetchRoot(parentUrl)}return doc}))}function fetchCollectionRoot(url){return fetchDocument(url).then((doc=>{if(hasLinks(doc,["data","http://www.opengis.net/def/rel/ogc/1.0/data"]))return null;let parentUrl=getParentPath(url);return hasLinks(doc,["items"])?doc:("collections"in doc&&(parentUrl=`${parentUrl}/`),fetchCollectionRoot(parentUrl))}))}function getLinks(doc,relType,mimeType){const links=doc.links?.filter((link=>Array.isArray(relType)?relType.indexOf(link.rel)>-1:link.rel===relType))||[];return mimeType?links.filter((link=>link.type===mimeType)):links}function getLinkUrl(doc,relType,baseUrl,mimeType){const link=getLinks(doc,relType,mimeType)[0];return link?new URL(link.href,baseUrl||window.location.toString()).toString():null}function fetchLink(doc,relType,baseUrl){const url=getLinkUrl(doc,relType,baseUrl);return url?fetchDocument(url):Promise.reject(new EndpointError(`Could not find link with type: ${relType}`))}function hasLinks(doc,relType){return!!getLinkUrl(doc,relType)}function assertHasLinks(doc,relType){if(!hasLinks(doc,relType))throw new EndpointError(`Could not find link with type: ${relType}`)}function getParentPath(url){const urlObj=new URL(url,window.location.toString()),pathParts=urlObj.pathname.replace(/\/$/,"").split("/");return pathParts.length<=2?null:(urlObj.pathname=pathParts.slice(0,-1).join("/"),urlObj.toString())}function parseEndpointInfo(rootDoc){try{assertHasLinks(rootDoc,["data","http://www.opengis.net/def/rel/ogc/1.0/data"]),assertHasLinks(rootDoc,["conformance","http://www.opengis.net/def/rel/ogc/1.0/conformance"])}catch(e){throw new EndpointError(`The endpoint appears non-conforming, the following error was encountered:\n${e.message}`)}return{title:rootDoc.title,description:rootDoc.description,attribution:rootDoc.attribution}}function parseConformance(doc){return doc.conformsTo}function parseCollections(itemType=null){return doc=>doc.collections.filter((collection=>null===itemType||collection.itemType===itemType)).map((collection=>{const result={name:collection.id};return"record"===collection.itemType&&(result.hasRecords=!0),"feature"===collection.itemType&&(result.hasFeatures=!0),collection.links.some((link=>"http://www.opengis.net/def/rel/ogc/1.0/tilesets-vector"===link.rel))&&(result.hasVectorTiles=!0),collection.links.some((link=>"http://www.opengis.net/def/rel/ogc/1.0/tilesets-map"===link.rel))&&(result.hasMapTiles=!0),result}))}function checkTileConformance(conformance){return conformance.indexOf("http://www.opengis.net/spec/ogcapi-tiles-1/1.0/conf/core")>-1}function checkStyleConformance(conformance){return conformance.indexOf("http://www.opengis.net/spec/ogcapi-styles-1/0.0/conf/core")>-1||conformance.indexOf("http://www.opengis.net/spec/ogcapi-styles-1/1.0/conf/core")>-1}function checkHasRecords([collections,conformance]){return(["http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/record-core","http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/record-collection","http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/record-api"].every((confClass=>conformance.indexOf(confClass)>-1))||conformance.indexOf("http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/core")>-1)&&collections.some((collection=>"record"===collection.itemType))}function checkHasFeatures([collections,conformance]){return conformance.indexOf("http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/core")>-1&&collections.some((collection=>"feature"===collection.itemType))}function parseCollectionParameters(doc){return"properties"in doc&&"object"==typeof doc.properties?Object.keys(doc.properties).map((name=>{const prop=doc.properties[name];let type="string";if("string"==typeof prop.$ref){const schemaRef=prop.$ref.toLowerCase();schemaRef.indexOf("point")>-1?type="point":schemaRef.indexOf("linestring")>-1?type="linestring":schemaRef.indexOf("polygon")>-1?type="polygon":schemaRef.indexOf("geometry")>-1&&(type="geometry")}else"string"==typeof prop.type&&CollectionParameterTypes.indexOf(prop.type.toLowerCase())>-1&&(type=prop.type.toLowerCase());return{name,type,..."string"==typeof prop.title&&{title:prop.title}}})):Array.isArray(doc)?doc.map((prop=>({name:prop,type:"string"}))):[]}function parseTileMatrixSets(doc){return Array.isArray(doc.tileMatrixSets)?doc.tileMatrixSets.map((set=>({id:set.id,uri:set.uri}))):[]}function parseBasicStyleInfo(doc){return{formats:doc.links.filter((link=>"stylesheet"===link.rel)).map((link=>link.type)).filter((type=>"text/html"!==type)),id:doc.id,...doc.title&&{title:doc.title}}}class OgcApiEndpoint{constructor(baseUrl){this.baseUrl=baseUrl}root_;conformance_;data_;tileMatrixSetsFull_;styles_;get root(){return this.root_||(this.root_=fetchRoot(this.baseUrl).catch((e=>{throw new Error(`The endpoint appears non-conforming, the following error was encountered:\n${e.message}`)}))),this.root_}get conformance(){return this.conformance_||(this.conformance_=this.root.then((root=>fetchLink(root,["conformance","http://www.opengis.net/def/rel/ogc/1.0/conformance"],this.baseUrl)))),this.conformance_}get collectionsUrl(){return this.root.then((root=>getLinkUrl(root,["data","http://www.opengis.net/def/rel/ogc/1.0/data"],this.baseUrl)))}get data(){var _this=this;return this.data_||(this.data_=this.collectionsUrl.then(fetchDocument).then(function(){var _ref=(0,asyncToGenerator.A)((function*(data){const singleCollection=yield fetchCollectionRoot(_this.baseUrl);return null!==singleCollection&&Array.isArray(data.collections)&&(data.collections=data.collections.filter((collection=>collection.id===singleCollection.id))),data}));return function(_x){return _ref.apply(this,arguments)}}())),this.data_}get tileMatrixSetsFull(){var _this2=this;return this.tileMatrixSetsFull_||(this.tileMatrixSetsFull_=this.root.then(function(){var _ref2=(0,asyncToGenerator.A)((function*(root){return(yield _this2.hasTiles)?fetchLink(root,["http://www.opengis.net/def/rel/ogc/1.0/tiling-schemes"],_this2.baseUrl).then(parseTileMatrixSets):[]}));return function(_x2){return _ref2.apply(this,arguments)}}())),this.tileMatrixSetsFull_}get styles(){var _this3=this;return this.styles_||(this.styles_=this.root.then(function(){var _ref3=(0,asyncToGenerator.A)((function*(root){if(yield _this3.hasStyles)return fetchLink(root,["styles","http://www.opengis.net/def/rel/ogc/1.0/styles"],_this3.baseUrl)}));return function(_x3){return _ref3.apply(this,arguments)}}())),this.styles_}get info(){return this.root.then(parseEndpointInfo)}get conformanceClasses(){return this.conformance.then(parseConformance)}get allCollections(){return this.data.then(parseCollections())}get recordCollections(){return Promise.all([this.data,this.hasRecords]).then((([data,hasRecords])=>hasRecords?data:{collections:[]})).then(parseCollections("record")).then((collections=>collections.map((collection=>collection.name))))}get featureCollections(){return Promise.all([this.data,this.hasFeatures]).then((([data,hasFeatures])=>hasFeatures?data:{collections:[]})).then(parseCollections("feature")).then((collections=>collections.map((collection=>collection.name))))}get vectorTileCollections(){return Promise.all([this.data,this.hasTiles]).then((([data,hasTiles])=>hasTiles?data:{collections:[]})).then(parseCollections()).then((collections=>collections.filter((collection=>collection.hasVectorTiles)))).then((collections=>collections.map((collection=>collection.name))))}get mapTileCollections(){return Promise.all([this.data,this.hasTiles]).then((([data,hasTiles])=>hasTiles?data:{collections:[]})).then(parseCollections()).then((collections=>collections.filter((collection=>collection.hasMapTiles)))).then((collections=>collections.map((collection=>collection.name))))}get hasTiles(){return this.conformanceClasses.then(checkTileConformance)}get hasStyles(){return this.conformanceClasses.then(checkStyleConformance)}get hasFeatures(){return Promise.all([this.data.then((data=>data.collections)),this.conformanceClasses]).then(checkHasFeatures)}get hasRecords(){return Promise.all([this.data.then((data=>data.collections)),this.conformanceClasses]).then(checkHasRecords)}get tileMatrixSets(){return this.tileMatrixSetsFull.then((sets=>sets.map((set=>set.id))))}getCollectionDocument(collectionId){var _this4=this;return Promise.all([this.allCollections,this.data]).then((([collections,data])=>{if(!collections.find((collection=>collection.name===collectionId)))throw new EndpointError(`Collection not found: ${collectionId}`);return data.collections.find((collection=>collection.id===collectionId))})).then(function(){var _ref4=(0,asyncToGenerator.A)((function*(collection){return hasLinks(collection,["self"])?fetchLink(collection,"self",_this4.baseUrl):fetchDocument(`${yield _this4.collectionsUrl}/${collectionId}`)}));return function(_x4){return _ref4.apply(this,arguments)}}())}getStyleMetadataDocument(styleId,collectionId){var _this5=this;return(0,asyncToGenerator.A)((function*(){const doc=collectionId?yield _this5.getCollectionDocument(collectionId):yield _this5.root,stylesLinkJson=getLinkUrl(doc,["styles","http://www.opengis.net/def/rel/ogc/1.0/styles"],_this5.baseUrl,"application/json"),stylesLink=getLinkUrl(doc,["styles","http://www.opengis.net/def/rel/ogc/1.0/styles"],_this5.baseUrl),styleData=yield fetchDocument(stylesLinkJson??stylesLink);if(!styleData.styles.some((style=>style.id===styleId)))throw new EndpointError(`Style not found: "${styleId}".`);const styleDoc=styleData?.styles?.find((style=>style.id===styleId));return hasLinks(styleDoc,["describedby"])?fetchLink(styleDoc,"describedby",_this5.baseUrl):styleDoc}))()}getCollectionInfo(collectionId){var _this6=this;return(0,asyncToGenerator.A)((function*(){const collectionDoc=yield _this6.getCollectionDocument(collectionId),baseInfo=function parseBaseCollectionInfo(doc){const{links,...props}=doc,itemFormats=links.filter((link=>"items"===link.rel)).map((link=>link.type)),bulkDownloadLinks=links.filter((link=>"enclosure"===link.rel)).reduce(((acc,link)=>(acc[link.type]=link.href,acc)),{}),mimeTypes=Object.keys(bulkDownloadLinks),jsonMimeType=mimeTypes.find(isMimeTypeJsonFg)||mimeTypes.find(isMimeTypeGeoJson)||mimeTypes.find(isMimeTypeJson);return{itemFormats,bulkDownloadLinks,jsonDownloadLink:jsonMimeType?bulkDownloadLinks[jsonMimeType]:null,...props}}(collectionDoc),[queryables,sortables,tilesetsVector,tilesetsMap]=yield Promise.all([fetchLink(collectionDoc,["queryables","http://www.opengis.net/def/rel/ogc/1.0/queryables"],_this6.baseUrl).then(parseCollectionParameters).catch((()=>[])),fetchLink(collectionDoc,["sortables","http://www.opengis.net/def/rel/ogc/1.0/sortables"],_this6.baseUrl).then(parseCollectionParameters).catch((()=>[])),fetchLink(collectionDoc,["http://www.opengis.net/def/rel/ogc/1.0/tilesets-vector"],_this6.baseUrl).then((tilesetDoc=>tilesetDoc.tilesets)).catch((()=>[])),fetchLink(collectionDoc,["http://www.opengis.net/def/rel/ogc/1.0/tilesets-map"],_this6.baseUrl).then((tilesetDoc=>tilesetDoc.tilesets)).catch((()=>[]))]),tileMatrixSetsFull=yield _this6.tileMatrixSetsFull,supportedTileMatrixSets=tilesetsVector.map((tileset=>tileMatrixSetsFull.find((set=>set.uri===tileset.tileMatrixSetURI))?.id)).filter(Boolean),firstTilesetVector=tilesetsVector[0];let vectorTileFormats=[];if(firstTilesetVector){const tilesetUrl=getLinkUrl(firstTilesetVector,"self",_this6.baseUrl);if(!tilesetUrl)throw new Error("No links found for the tileset");vectorTileFormats=(yield fetchDocument(tilesetUrl)).links.filter((link=>"item"===link.rel)).map((link=>link.type))}const firstTilesetMap=tilesetsMap[0];let mapTileFormats=[];if(firstTilesetMap){const tilesetUrl=getLinkUrl(firstTilesetMap,"self",_this6.baseUrl);if(!tilesetUrl)throw new Error("No links found for the tileset");mapTileFormats=(yield fetchDocument(tilesetUrl)).links.filter((link=>"item"===link.rel)).map((link=>link.type))}return{...baseInfo,queryables,sortables,mapTileFormats,vectorTileFormats,supportedTileMatrixSets}}))()}getCollectionItems(collectionId,limit=10,offset=0,skipGeometry=null,sortby=null,bbox=null,properties=null){return this.getCollectionDocument(collectionId).then((collectionDoc=>{const url=new URL(getLinkUrl(collectionDoc,"items",this.baseUrl),window.location.toString());return url.searchParams.set("limit",limit.toString()),url.searchParams.set("offset",offset.toString()),null!==skipGeometry&&url.searchParams.set("skipGeometry",skipGeometry.toString()),null!==sortby&&url.searchParams.set("sortby",sortby.join(",").toString()),null!==bbox&&url.searchParams.set("bbox",bbox.join(",").toString()),null!==properties&&url.searchParams.set("properties",properties.join(",").toString()),url.toString()})).then(fetchDocument).then((doc=>doc.features))}getCollectionItem(collectionId,itemId){return this.getCollectionDocument(collectionId).then((collectionDoc=>{const url=new URL(getLinkUrl(collectionDoc,"items",this.baseUrl),window.location.toString());return url.pathname+=`/${itemId}`,url.toString()})).then(fetchDocument)}getCollectionItemsUrl(collectionId,options={}){return this.getCollectionDocument(collectionId).then((collectionDoc=>{const baseUrl=this.baseUrl||"",itemLinks=getLinks(collectionDoc,"items");let url,linkWithFormat=itemLinks.find((link=>link.type===options?.outputFormat));return options.asJson&&(linkWithFormat=itemLinks.find((link=>isMimeTypeJsonFg(link.type)))||itemLinks.find((link=>isMimeTypeGeoJson(link.type)))||itemLinks.find((link=>isMimeTypeJson(link.type)))),options?.outputFormat&&!linkWithFormat?(console.warn(`[ogc-client] The following output format type was not found in the collection '${collectionId}': ${options.outputFormat}`),url=new URL(itemLinks[0].href,baseUrl),url.searchParams.set("f",options.outputFormat)):url=linkWithFormat?new URL(linkWithFormat.href,baseUrl):new URL(itemLinks[0].href,baseUrl),void 0!==options.query&&(url.search+=(url.search?"&":"")+options.query),void 0!==options.limit&&url.searchParams.set("limit",options.limit.toString()),void 0!==options.offset&&url.searchParams.set("offset",options.offset.toString()),void 0!==options.outputCrs&&url.searchParams.set("crs",options.outputCrs),void 0!==options.extent&&4===options.extent.length&&url.searchParams.set("bbox",options.extent.join(",")),void 0!==options.extentCrs&&url.searchParams.set("bbox-crs",options.extentCrs),url.toString()})).catch((error=>{throw console.error("Error fetching collection items URL:",error),error}))}getVectorTilesetUrl(collectionId,tileMatrixSet="WebMercatorQuad"){var _this7=this;return this.getCollectionDocument(collectionId).then(function(){var _ref5=(0,asyncToGenerator.A)((function*(collectionDoc){const collectionTilesLink=getLinkUrl(collectionDoc,"http://www.opengis.net/def/rel/ogc/1.0/tilesets-vector",_this7.baseUrl),collectionTiles=yield fetchDocument(collectionTilesLink),matrixSet=(yield _this7.tileMatrixSetsFull).find((set=>set.id===tileMatrixSet));if(!matrixSet)throw new Error(`The following tile matrix set does not exist on this endpoint: '${tileMatrixSet}'.`);const tileset=collectionTiles.tilesets.find((tileset2=>tileset2.tileMatrixSetURI===matrixSet.uri));if(!tileset)throw new Error(`The collection '${collectionId}' does not support the tile matrix set '${tileMatrixSet}'.`);const tilesetUrl=getLinkUrl(tileset,"self",_this7.baseUrl);if(!tilesetUrl)throw new Error("No links found for the tileset");return tilesetUrl}));return function(_x5){return _ref5.apply(this,arguments)}}()).catch((error=>{throw console.error("Error fetching collection tileset URL:",error.message),error}))}getMapTilesetUrl(collectionId,tileMatrixSet="WebMercatorQuad"){var _this8=this;return this.getCollectionDocument(collectionId).then(function(){var _ref6=(0,asyncToGenerator.A)((function*(collectionDoc){const collectionTilesLink=getLinkUrl(collectionDoc,"http://www.opengis.net/def/rel/ogc/1.0/tilesets-map",_this8.baseUrl),collectionTiles=yield fetchDocument(collectionTilesLink),matrixSet=(yield _this8.tileMatrixSetsFull).find((set=>set.id===tileMatrixSet));if(!matrixSet)throw new Error(`The following tile matrix set does not exist on this endpoint: '${tileMatrixSet}'.`);const tileset=collectionTiles.tilesets.find((tileset2=>tileset2.tileMatrixSetURI===matrixSet.uri));if(!tileset)throw new Error(`The collection '${collectionId}' does not support the tile matrix set '${tileMatrixSet}'.`);const tilesetUrl=getLinkUrl(tileset,"self",_this8.baseUrl);if(!tilesetUrl)throw new Error("No links found for the tileset");return tilesetUrl}));return function(_x6){return _ref6.apply(this,arguments)}}()).catch((error=>{throw console.error("Error fetching collection tileset URL:",error.message),error}))}allStyles(collectionId){var _this9=this;return(0,asyncToGenerator.A)((function*(){const stylesLink=getLinkUrl(collectionId?yield _this9.getCollectionDocument(collectionId):yield _this9.root,["styles","http://www.opengis.net/def/rel/ogc/1.0/styles"],_this9.baseUrl);if(!stylesLink)throw new EndpointError('Could not get styles: there is no relation of type "styles"');return(yield fetchDocument(stylesLink)).styles.map(parseBasicStyleInfo)}))()}getStyle(styleId,collectionId){var _this10=this;return(0,asyncToGenerator.A)((function*(){const metadataDoc=yield _this10.getStyleMetadataDocument(styleId,collectionId);return metadataDoc?.stylesheets?function parseFullStyleInfo(doc){const{stylesheets,links,...props}=doc,stylesheetFormats=stylesheets?.filter((stylesheet=>"stylesheet"===stylesheet.link.rel))?.map((stylesheet=>stylesheet.link.type));return{...stylesheetFormats&&{stylesheetFormats},...stylesheets&&{stylesheets},...props}}(metadataDoc):parseBasicStyleInfo(metadataDoc)}))()}getStylesheetUrl(styleId,mimeType,collectionId){var _this11=this;return(0,asyncToGenerator.A)((function*(){const stylesDoc=yield _this11.getStyleMetadataDocument(styleId,collectionId);if(stylesDoc.stylesheets){const urlFromMetadata=stylesDoc?.stylesheets?.find((s=>s.link.type===mimeType&&"stylesheet"===s.link.rel))?.link?.href;return urlFromMetadata}const urlFromStyle=getLinkUrl(stylesDoc,"stylesheet",_this11.baseUrl,mimeType);if(!urlFromStyle)throw new EndpointError("Could not find stylesheet URL for given style ID and type.");return urlFromStyle}))()}}class ServiceExceptionError extends Error{constructor(message,requestUrl,code,locator,response){super(message),this.requestUrl=requestUrl,this.code=code,this.locator=locator,this.response=response}}function parse(serviceException,url){const errorCode=getElementAttribute(serviceException,"code")||getElementAttribute(serviceException,"exceptionCode"),errorLocator=getElementAttribute(serviceException,"locator"),errorMessage=getElementText(findChildElement(serviceException,"ExceptionText")||serviceException).trim();return new ServiceExceptionError(errorMessage,url,errorCode,errorLocator,serviceException.document)}function check(response,url){const rootEl=getRootElement(response),rootElName=stripNamespace(getElementName(rootEl));if("ServiceExceptionReport"===rootElName){const error=findChildElement(rootEl,"ServiceException");if(error)throw parse(error,url)}if("ExceptionReport"===rootElName){const error=findChildElement(rootEl,"Exception");if(error)throw parse(error,url)}return response}function addTaskHandler(taskName,scope,handler){const useWorker="undefined"!=typeof WorkerGlobalScope,eventHandler=function(){var _ref=(0,asyncToGenerator.A)((function*(request){if(request.taskName===taskName){let response,error;try{response=yield handler(request.params)}catch(e){error=e}const message={taskName,requestId:request.requestId,...response&&{response},...error&&{error}};useWorker?scope.postMessage(message):scope.dispatchEvent(new CustomEvent("ogc-client.response",{detail:message}))}}));return function eventHandler(_x){return _ref.apply(this,arguments)}}();useWorker?scope.addEventListener("message",(event=>eventHandler(event.data))):scope.addEventListener("ogc-client.request",(event=>eventHandler(event.detail)))}const LatLonCrsList=["EPSG:4046","EPSG:4075","EPSG:4120","EPSG:4122","EPSG:4124","EPSG:4126","EPSG:4149","EPSG:4151","EPSG:4153","EPSG:4155","EPSG:4157","EPSG:4159","EPSG:4161","EPSG:4163","EPSG:4165","EPSG:4167","EPSG:4169","EPSG:4171","EPSG:4173","EPSG:4175","EPSG:4178","EPSG:4180","EPSG:4182","EPSG:4184","EPSG:4188","EPSG:4190","EPSG:4191","EPSG:4196","EPSG:4198","EPSG:4202","EPSG:4210","EPSG:4211","EPSG:4214","EPSG:4226","EPSG:4229","EPSG:4231","EPSG:4233","EPSG:4236","EPSG:4238","EPSG:4240","EPSG:4242","EPSG:4244","EPSG:4246","EPSG:4248","EPSG:4250","EPSG:4252","EPSG:4255","EPSG:4258","EPSG:4261","EPSG:4264","EPSG:4267","EPSG:4270","EPSG:4273","EPSG:4276","EPSG:4279","EPSG:4281","EPSG:4284","EPSG:4286","EPSG:4288","EPSG:4292","EPSG:4295","EPSG:4297","EPSG:4299","EPSG:4302","EPSG:4324","EPSG:4326"];function simplifyEpsgUrn(fullCrsName){if(/^urn:(?:x-)?ogc:def:crs:epsg:/.test(fullCrsName.toLowerCase())){return`EPSG:${/([0-9]+)$/.exec(fullCrsName)[1]}`}return fullCrsName}function readOperationUrlsFromCapabilities(capabilitiesDoc){const urls={},capability=findChildElement(getRootElement(capabilitiesDoc),"Capability");return getChildrenElement(findChildElement(capability,"Request")).forEach((operation=>{const operationName=stripNamespace(getElementName(operation));urls[operationName]=function parseOperation(operation){const urls={},dcpType=findChildrenElement(operation,"DCPType"),http=dcpType.flatMap((d=>findChildElement(d,"HTTP")));return http.flatMap((h=>getChildrenElement(h))).forEach((method=>{const onlineResource=findChildElement(method,"OnlineResource"),methodName=stripNamespace(getElementName(method));urls[methodName]=getElementAttribute(onlineResource,"xlink:href")})),urls}(operation)})),urls}function readVersionFromCapabilities(capabilitiesDoc){return getRootElement(capabilitiesDoc).attributes.version}function readLayersFromCapabilities(capabilitiesDoc){const version=readVersionFromCapabilities(capabilitiesDoc);return findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"Capability"),"Layer").map((layerEl=>parseLayer(layerEl,version)))}function readInfoFromCapabilities(capabilitiesDoc){const service=findChildElement(getRootElement(capabilitiesDoc),"Service"),outputFormats=function readOutputFormatsFromCapabilities(capabilitiesDoc){const capability=findChildElement(getRootElement(capabilitiesDoc),"Capability");return findChildrenElement(findChildElement(findChildElement(capability,"Request"),"GetMap"),"Format").map(getElementText)}(capabilitiesDoc),infoFormats=function readInfoFormatsFromCapabilities(capabilitiesDoc){const capability=findChildElement(getRootElement(capabilitiesDoc),"Capability");return findChildrenElement(findChildElement(findChildElement(capability,"Request"),"GetFeatureInfo"),"Format").map(getElementText)}(capabilitiesDoc),exceptionFormats=function readExceptionFormatsFromCapabilities(capabilitiesDoc){const capability=findChildElement(getRootElement(capabilitiesDoc),"Capability");return findChildrenElement(findChildElement(capability,"Exception"),"Format").map(getElementText)}(capabilitiesDoc),keywords=findChildrenElement(findChildElement(service,"KeywordList"),"Keyword").map(getElementText).filter(((v,i,arr)=>arr.indexOf(v)===i)),provider=function readProviderFromCapabilities(capabilitiesDoc){const service=findChildElement(getRootElement(capabilitiesDoc),"Service"),contactInformation=findChildElement(service,"ContactInformation"),contactPersonPrimary=findChildElement(contactInformation,"ContactPersonPrimary"),address=findChildElement(contactInformation,"ContactAddress");return{contact:{name:getElementText(findChildElement(contactPersonPrimary,"ContactPerson")),organization:getElementText(findChildElement(contactPersonPrimary,"ContactOrganization")),position:getElementText(findChildElement(contactInformation,"ContactPosition")),phone:getElementText(findChildElement(contactInformation,"ContactVoiceTelephone")),fax:getElementText(findChildElement(contactInformation,"ContactFacsimileTelephone")),address:{deliveryPoint:getElementText(findChildElement(address,"Address")),city:getElementText(findChildElement(address,"City")),administrativeArea:getElementText(findChildElement(address,"StateOrProvince")),postalCode:getElementText(findChildElement(address,"PostCode")),country:getElementText(findChildElement(address,"Country"))},email:getElementText(findChildElement(contactInformation,"ContactElectronicMailAddress"))}}}(capabilitiesDoc);return{title:getElementText(findChildElement(service,"Title")),name:getElementText(findChildElement(service,"Name")),abstract:getElementText(findChildElement(service,"Abstract")),outputFormats,infoFormats,exceptionFormats,fees:getElementText(findChildElement(service,"Fees")),constraints:getElementText(findChildElement(service,"AccessConstraints")),provider,keywords}}function parseLayer(layerEl,version,inheritedSrs=[],inheritedStyles=[],inheritedAttribution=null,inheritedBoundingBoxes=null,inheritedMaxScaleDenom=null,inheritedMinScaleDenom=null){const srsTag="1.3.0"===version?"CRS":"SRS",srsList=findChildrenElement(layerEl,srsTag).map(getElementText),availableCrs=srsList.length>0?srsList:inheritedSrs,layerStyles=findChildrenElement(layerEl,"Style").map(parseLayerStyle),styles=layerStyles.length>0?layerStyles:inheritedStyles;function parseBBox(bboxEl){return(function hasInvertedCoordinates(crsName){return LatLonCrsList.indexOf(simplifyEpsgUrn(crsName))>-1}(getElementAttribute(bboxEl,srsTag))&&"1.3.0"===version?["miny","minx","maxy","maxx"]:["minx","miny","maxx","maxy"]).map((name=>getElementAttribute(bboxEl,name)))}function parseScaleHintValue(textValue,defaultValue){return""===textValue?defaultValue:Math.sqrt(.5*parseFloat(textValue)**2)/28e-5}function parseScaleDenominator(name,inheritedValue){const textValue=getElementText(findChildElement(layerEl,name));return""===textValue?inheritedValue:parseFloat(textValue)}const attributionEl=findChildElement(layerEl,"Attribution"),attribution=null!==attributionEl?function parseLayerAttribution(attributionEl){const logoUrl=getElementAttribute(findChildElement(findChildElement(attributionEl,"LogoURL"),"OnlineResource"),"xlink:href"),url=getElementAttribute(findChildElement(attributionEl,"OnlineResource"),"xlink:href"),title=getElementText(findChildElement(attributionEl,"Title"));return{...title&&{title},...url&&{url},...logoUrl&&{logoUrl}}}(attributionEl):inheritedAttribution,latLonBboxEl=findChildElement(layerEl,"1.3.0"===version?"EX_GeographicBoundingBox":"LatLonBoundingBox"),baseBoundingBox={};latLonBboxEl&&(baseBoundingBox["EPSG:4326"]="1.3.0"===version?function parseExGeographicBoundingBox(bboxEl){return["westBoundLongitude","southBoundLatitude","eastBoundLongitude","northBoundLatitude"].map((name=>getElementText(findChildElement(bboxEl,name))))}(latLonBboxEl):function parseLatLonBoundingBox(bboxEl){return["minx","miny","maxx","maxy"].map((name=>getElementAttribute(bboxEl,name)))}(latLonBboxEl));let boundingBoxes=findChildrenElement(layerEl,"BoundingBox").reduce(((prev,bboxEl)=>({...prev,[getElementAttribute(bboxEl,srsTag)]:parseBBox(bboxEl)})),baseBoundingBox);boundingBoxes=Object.keys(boundingBoxes).length>0||null===inheritedBoundingBoxes?boundingBoxes:inheritedBoundingBoxes;const queryable="1"===layerEl.attributes.queryable||"true"===layerEl.attributes.queryable,opaque="1"===layerEl.attributes.opaque||"true"===layerEl.attributes.opaque,keywords=findChildrenElement(findChildElement(layerEl,"KeywordList"),"Keyword").map(getElementText).filter(((v,i,arr)=>arr.indexOf(v)===i));let minScaleDenominator,maxScaleDenominator;"1.3.0"===version?(minScaleDenominator=parseScaleDenominator("MinScaleDenominator",inheritedMinScaleDenom),maxScaleDenominator=parseScaleDenominator("MaxScaleDenominator",inheritedMaxScaleDenom)):[minScaleDenominator,maxScaleDenominator]=function parseScaleHint(){const scaleHint=findChildElement(layerEl,"ScaleHint");if(!scaleHint)return[inheritedMinScaleDenom,inheritedMaxScaleDenom];const min=getElementAttribute(scaleHint,"min"),max=getElementAttribute(scaleHint,"max");return[parseScaleHintValue(min,inheritedMinScaleDenom),parseScaleHintValue(max,inheritedMaxScaleDenom)]}();const metadata=findChildrenElement(layerEl,"MetadataURL").map((metadataUrlEl=>({type:getElementAttribute(metadataUrlEl,"type"),format:getElementText(findChildElement(metadataUrlEl,"Format")),url:getElementAttribute(findChildElement(metadataUrlEl,"OnlineResource"),"xlink:href")}))),children=findChildrenElement(layerEl,"Layer").map((layer=>parseLayer(layer,version,availableCrs,styles,attribution,boundingBoxes,maxScaleDenominator,minScaleDenominator)));return{name:getElementText(findChildElement(layerEl,"Name")),title:getElementText(findChildElement(layerEl,"Title")),abstract:getElementText(findChildElement(layerEl,"Abstract")),availableCrs,styles,attribution,boundingBoxes,keywords,queryable,opaque,...null!==minScaleDenominator?{minScaleDenominator}:{},...null!==maxScaleDenominator?{maxScaleDenominator}:{},...metadata.length&&{metadata},...children.length&&{children}}}function parseLayerStyle(styleEl){const legendUrl=getElementAttribute(findChildElement(findChildElement(styleEl,"LegendURL"),"OnlineResource"),"xlink:href"),abstract=getElementText(findChildElement(styleEl,"Abstract"));return{name:getElementText(findChildElement(styleEl,"Name")),title:getElementText(findChildElement(styleEl,"Title")),...abstract&&{abstract},...legendUrl&&{legendUrl}}}function ows_readProviderFromCapabilities(capabilitiesDoc){const serviceProvider=findChildElement(getRootElement(capabilitiesDoc),"ServiceProvider"),serviceContact=findChildElement(serviceProvider,"ServiceContact"),contactInfo=findChildElement(serviceContact,"ContactInfo"),phone=findChildElement(contactInfo,"Phone"),address=findChildElement(contactInfo,"Address");return{name:getElementText(findChildElement(serviceProvider,"ProviderName")),site:getElementAttribute(findChildElement(serviceProvider,"ProviderSite"),"xlink:href"),contact:{name:getElementText(findChildElement(serviceContact,"IndividualName")),position:getElementText(findChildElement(serviceContact,"PositionName")),phone:getElementText(findChildElement(phone,"Voice")),fax:getElementText(findChildElement(phone,"Facsimile")),address:{deliveryPoint:getElementText(findChildElement(address,"DeliveryPoint")),city:getElementText(findChildElement(address,"City")),administrativeArea:getElementText(findChildElement(address,"AdministrativeArea")),postalCode:getElementText(findChildElement(address,"PostalCode")),country:getElementText(findChildElement(address,"Country"))},email:getElementText(findChildElement(address,"ElectronicMailAddress"))}}}function capabilities_readOperationUrlsFromCapabilities(capabilitiesDoc){const urls={},capabilities=getRootElement(capabilitiesDoc),operationsMetadata=findChildElement(capabilities,"OperationsMetadata");if(operationsMetadata)findChildrenElement(operationsMetadata,"Operation").forEach((operation=>{const name=getElementAttribute(operation,"name");urls[name]=function parseOperation110(operation){const urls={},dcpType=findChildrenElement(operation,"DCP"),http=dcpType.flatMap((d=>findChildElement(d,"HTTP")));return http.flatMap((h=>getChildrenElement(h))).forEach((method=>{const methodName=stripNamespace(getElementName(method));urls[methodName]=getElementAttribute(method,"xlink:href")})),urls}(operation)}));else{const capability=findChildElement(capabilities,"Capability");getChildrenElement(findChildElement(capability,"Request")).forEach((operation=>{const name=stripNamespace(getElementName(operation));urls[name]=function parseOperation100(operation){const urls={},dcpType=findChildrenElement(operation,"DCPType"),http=dcpType.flatMap((d=>findChildrenElement(d,"HTTP")));return http.flatMap((h=>getChildrenElement(h))).forEach((method=>{const methodName=stripNamespace(getElementName(method));urls[methodName]=getElementAttribute(method,"onlineResource")})),urls}(operation)}))}return urls}function capabilities_readVersionFromCapabilities(capabilitiesDoc){return getRootElement(capabilitiesDoc).attributes.version}function capabilities_readOutputFormatsFromCapabilities(capabilitiesDoc){let outputFormats;if(capabilities_readVersionFromCapabilities(capabilitiesDoc).startsWith("1.0")){const getFeature=findChildElement(findChildElement(findChildElement(getRootElement(capabilitiesDoc),"Capability"),"Request"),"GetFeature");outputFormats=getChildrenElement(findChildElement(getFeature,"ResultFormat")).map(getElementName)}else{const getFeature=findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"OperationsMetadata"),"Operation").find((el=>"GetFeature"===getElementAttribute(el,"name"))),parameter=findChildrenElement(getFeature,"Parameter").find((el=>"outputFormat"===getElementAttribute(el,"name")));outputFormats=findChildrenElement(parameter,"Value",!0).map(getElementText)}return outputFormats}function capabilities_readInfoFromCapabilities(capabilitiesDoc){const version=capabilities_readVersionFromCapabilities(capabilitiesDoc),serviceTag=version.startsWith("1.0")?"Service":"ServiceIdentification",nameTag=version.startsWith("1.0")?"Name":"ServiceType",service=findChildElement(getRootElement(capabilitiesDoc),serviceTag);let keywords,provider;return keywords=version.startsWith("1.0")?getElementText(findChildElement(service,"Keywords")).split(",").map((keyword=>keyword.trim())):findChildrenElement(findChildElement(service,"Keywords"),"Keyword").map(getElementText),"1.0.0"!==version&&(provider=ows_readProviderFromCapabilities(capabilitiesDoc)),{title:getElementText(findChildElement(service,"Title")),name:getElementText(findChildElement(service,nameTag)),abstract:getElementText(findChildElement(service,"Abstract")),fees:getElementText(findChildElement(service,"Fees")),constraints:getElementText(findChildElement(service,"AccessConstraints")),keywords,provider,outputFormats:capabilities_readOutputFormatsFromCapabilities(capabilitiesDoc)}}function readFeatureTypesFromCapabilities(capabilitiesDoc){const version=capabilities_readVersionFromCapabilities(capabilitiesDoc),outputFormats=capabilities_readOutputFormatsFromCapabilities(capabilitiesDoc);return findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"FeatureTypeList"),"FeatureType").map((featureTypeEl=>function parseFeatureType(featureTypeEl,serviceVersion,defaultOutputFormats){const srsTag=serviceVersion.startsWith("2.")?"CRS":"SRS",defaultSrsTag=serviceVersion.startsWith("1.0")?"SRS":`Default${srsTag}`;function parseBBox100(){const bboxEl=findChildElement(featureTypeEl,"LatLongBoundingBox");return["minx","miny","maxx","maxy"].map((name=>getElementAttribute(bboxEl,name))).map(parseFloat)}function parseBBox(){const bboxEl=findChildElement(featureTypeEl,"WGS84BoundingBox");return["LowerCorner","UpperCorner"].map((elName=>findChildElement(bboxEl,elName))).map((cornerEl=>getElementText(cornerEl).split(" "))).reduce(((prev,curr)=>[...prev,...curr])).map(parseFloat)}const otherCrs=serviceVersion.startsWith("1.0")?[]:findChildrenElement(featureTypeEl,`Other${srsTag}`).map(getElementText).map(simplifyEpsgUrn),outputFormats=serviceVersion.startsWith("1.0")?[]:findChildrenElement(findChildElement(featureTypeEl,"OutputFormats"),"Format").map(getElementText),keywords=serviceVersion.startsWith("1.0")?getElementText(findChildElement(featureTypeEl,"Keywords")).split(",").map((keyword=>keyword.trim())):findChildrenElement(findChildElement(featureTypeEl,"Keywords"),"Keyword").map(getElementText).filter(((v,i,arr)=>arr.indexOf(v)===i)),metadata="2.0.0"===serviceVersion?findChildrenElement(featureTypeEl,"MetadataURL").map((metadataUrlEl=>({url:getElementAttribute(metadataUrlEl,"xlink:href")}))):findChildrenElement(featureTypeEl,"MetadataURL").map((metadataUrlEl=>({format:getElementAttribute(metadataUrlEl,"format"),type:getElementAttribute(metadataUrlEl,"type"),url:getElementText(metadataUrlEl).trim()})));return{name:getElementText(findChildElement(featureTypeEl,"Name")),title:getElementText(findChildElement(featureTypeEl,"Title")),abstract:getElementText(findChildElement(featureTypeEl,"Abstract")),defaultCrs:simplifyEpsgUrn(getElementText(findChildElement(featureTypeEl,defaultSrsTag))),otherCrs,outputFormats:outputFormats.length>0?outputFormats:defaultOutputFormats,latLonBoundingBox:serviceVersion.startsWith("1.0")?parseBBox100():parseBBox(),keywords,...metadata.length&&{metadata}}}(featureTypeEl,version,outputFormats)))}function parseBBox(xmlElement){const result=["LowerCorner","UpperCorner"].map((elName=>findChildElement(xmlElement,elName))).map((cornerEl=>getElementText(cornerEl).split(" "))).reduce(((prev,curr)=>[...prev,...curr])).map(parseFloat);return result.some(Number.isNaN)?null:result}function wmts_capabilities_readInfoFromCapabilities(capabilitiesDoc){const rootEl=getRootElement(capabilitiesDoc),service=findChildElement(rootEl,"ServiceIdentification"),keywords=findChildrenElement(findChildElement(service,"Keywords"),"Keyword").map(getElementText),getTileOperation=findChildrenElement(findChildElement(rootEl,"OperationsMetadata"),"Operation").find((el=>"GetTile"==getElementAttribute(el,"name"))),getTileUrls=findChildrenElement(getTileOperation,"Get",!0).reduce(((prev,curr)=>{const encodingType=getElementText(findChildElement(curr,"Value",!0)),url=getElementAttribute(curr,"xlink:href");return"restful"===encodingType.toLowerCase()?{...prev,rest:url}:{...prev,kvp:url}}),{});return{title:getElementText(findChildElement(service,"Title")),name:getElementText(findChildElement(service,"ServiceType")),abstract:getElementText(findChildElement(service,"Abstract")),fees:getElementText(findChildElement(service,"Fees")),constraints:getElementText(findChildElement(service,"AccessConstraints")),keywords,provider:ows_readProviderFromCapabilities(capabilitiesDoc),getTileUrls}}function readMatrixSetsFromCapabilities(capabilitiesDoc){function parseMatrixSet(element){const topLeft=getElementText(findChildElement(element,"TopLeftCorner")).split(" ").map(parseFloat);return{identifier:getElementText(findChildElement(element,"Identifier")),tileWidth:parseInt(getElementText(findChildElement(element,"TileWidth"))),tileHeight:parseInt(getElementText(findChildElement(element,"TileHeight"))),matrixWidth:parseInt(getElementText(findChildElement(element,"MatrixWidth"))),matrixHeight:parseInt(getElementText(findChildElement(element,"MatrixHeight"))),scaleDenominator:parseFloat(getElementText(findChildElement(element,"ScaleDenominator"))),topLeft}}return findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"Contents"),"TileMatrixSet").map((element=>{const wellKnownScaleSet=getElementText(findChildElement(element,"WellKnownScaleSet")),boundingBox=parseBBox(findChildElement(element,"BoundingBox"));return{identifier:getElementText(findChildElement(element,"Identifier")),crs:getElementText(findChildElement(element,"SupportedCRS")),tileMatrices:findChildrenElement(element,"TileMatrix").map(parseMatrixSet),...boundingBox&&{boundingBox},...wellKnownScaleSet&&{wellKnownScaleSet}}}))}function capabilities_readLayersFromCapabilities(capabilitiesDoc){const rootEl=getRootElement(capabilitiesDoc),contentsEl=findChildElement(rootEl,"Contents");function parseMatrixSetLink(element){const fullMatrixSet=findChildrenElement(contentsEl,"TileMatrixSet").find((el=>getElementText(findChildElement(el,"Identifier"))));return{identifier:getElementText(findChildElement(element,"TileMatrixSet")),crs:getElementText(findChildElement(fullMatrixSet,"SupportedCRS")),limits:findChildrenElement(element,"TileMatrixLimits",!0).map((element2=>({tileMatrix:getElementText(findChildElement(element2,"TileMatrix")),minTileRow:parseInt(getElementText(findChildElement(element2,"MinTileRow"))),minTileCol:parseInt(getElementText(findChildElement(element2,"MinTileCol"))),maxTileRow:parseInt(getElementText(findChildElement(element2,"MaxTileRow"))),maxTileCol:parseInt(getElementText(findChildElement(element2,"MaxTileCol")))})))}}const getTileOperation=findChildrenElement(findChildElement(rootEl,"OperationsMetadata"),"Operation").find((el=>"GetTile"==getElementAttribute(el,"name"))),getKvpElt=findChildrenElement(getTileOperation,"Get",!0).filter((elt=>"kvp"===getElementText(findChildElement(elt,"Value",!0)).toLowerCase()))[0],getKvpUrl=getKvpElt?getElementAttribute(getKvpElt,"xlink:href"):"";return findChildrenElement(findChildElement(rootEl,"Contents"),"Layer").map((element=>{const latLonBoundingBox=parseBBox(findChildElement(element,"WGS84BoundingBox"));let defaultStyle="";const styles=findChildrenElement(element,"Style").map((element2=>{const legendUrl=getElementAttribute(findChildElement(element2,"LegendURL"),"xlink:href"),abstract=getElementText(findChildElement(element2,"Abstract")),style={title:getElementText(findChildElement(element2,"Title")),name:getElementText(findChildElement(element2,"Identifier")),...abstract&&{abstract},...legendUrl&&{legendUrl}};return"true"===getElementAttribute(element2,"isDefault")&&(defaultStyle=style.name),style})),outputFormats=findChildrenElement(element,"Format").map(getElementText),resourceLinks=findChildrenElement(element,"ResourceURL").filter((element2=>"tile"===getElementAttribute(element2,"resourceType"))).map((element2=>({format:getElementAttribute(element2,"format"),url:getElementAttribute(element2,"template"),encoding:"REST"})));getKvpUrl&&resourceLinks.push(...outputFormats.map((format=>({encoding:"KVP",url:getKvpUrl,format}))));const matrixSets=findChildrenElement(element,"TileMatrixSetLink").map(parseMatrixSetLink),dimensions=findChildrenElement(element,"Dimension").map((element2=>({identifier:getElementText(findChildElement(element2,"Identifier")),defaultValue:getElementText(findChildElement(element2,"Default")),values:findChildrenElement(element2,"Values").map(getElementText)})));return{name:getElementText(findChildElement(element,"Identifier")),title:getElementText(findChildElement(element,"Title")),abstract:getElementText(findChildElement(element,"Abstract")),styles,resourceLinks,matrixSets,defaultStyle,...latLonBoundingBox&&{latLonBoundingBox},...dimensions&&{dimensions}}}))}function parseFeatureProps(getFeaturesDoc,featureTypeFull,serviceVersion){const collection=getRootElement(getFeaturesDoc);let members;if(serviceVersion.startsWith("2.0"))members=findChildrenElement(collection,"member").map((parent=>getChildrenElement(parent)[0]));else{const membersRoot=findChildElement(collection,"featureMembers");members=membersRoot?getChildrenElement(membersRoot):findChildrenElement(collection,"featureMember").map((parent=>getChildrenElement(parent)[0]))}const idAttr="1.0.0"===serviceVersion?"fid":"gml:id";function parseElementPropertyValue(propName,valueAsString){switch(featureTypeFull.properties[propName]){case"integer":return parseInt(valueAsString);case"float":return parseFloat(valueAsString);case"boolean":return"true"===valueAsString;default:return valueAsString}}function getProperties(memberEl){return getChildrenElement(memberEl).filter((el=>function isElementProperty(propName){return propName in featureTypeFull.properties}(stripNamespace(getElementName(el))))).reduce(((prev,curr)=>{const propName=stripNamespace(getElementName(curr));return{...prev,[propName]:parseElementPropertyValue(propName,getElementText(curr))}}),{})}return members.map((el=>({id:getElementAttribute(el,idAttr),properties:getProperties(el)})))}addTaskHandler("parseWmsCapabilities",globalThis,(({url})=>queryXmlDocument(url).then((xmlDoc=>check(xmlDoc,url))).then((xmlDoc=>({info:readInfoFromCapabilities(xmlDoc),layers:readLayersFromCapabilities(xmlDoc),url:readOperationUrlsFromCapabilities(xmlDoc),version:readVersionFromCapabilities(xmlDoc)}))))),addTaskHandler("parseWfsCapabilities",globalThis,(({url})=>queryXmlDocument(url).then((xmlDoc=>check(xmlDoc,url))).then((xmlDoc=>({info:capabilities_readInfoFromCapabilities(xmlDoc),featureTypes:readFeatureTypesFromCapabilities(xmlDoc),url:capabilities_readOperationUrlsFromCapabilities(xmlDoc),version:capabilities_readVersionFromCapabilities(xmlDoc)}))))),addTaskHandler("queryWfsFeatureTypeDetails",globalThis,(({url,serviceVersion,featureTypeFull})=>queryXmlDocument(generateGetFeatureUrl(url,serviceVersion,featureTypeFull.name,void 0,void 0,Object.keys(featureTypeFull.properties))).then((getFeatureDoc=>{return{props:(featuresWithProps=parseFeatureProps(getFeatureDoc,featureTypeFull,serviceVersion),featuresWithProps.reduce(((prev,curr)=>{for(const propName in curr.properties){const propValue=curr.properties[propName];propName in prev||(prev[propName]={uniqueValues:[]});const uniqueValue=prev[propName].uniqueValues.find((v=>v.value===propValue));uniqueValue?uniqueValue.count++:prev[propName].uniqueValues.push({value:propValue,count:1})}return prev}),{}))};var featuresWithProps})))),addTaskHandler("updateFetchOptions",globalThis,(({options})=>(function setFetchOptions(options){fetchOptions=options,fetchOptionsUpdateCallback&&fetchOptionsUpdateCallback(options)}(options),Promise.resolve({})))),addTaskHandler("parseWmtsCapabilities",globalThis,(({url})=>queryXmlDocument(url).then((xmlDoc=>check(xmlDoc,url))).then((xmlDoc=>({info:wmts_capabilities_readInfoFromCapabilities(xmlDoc),layers:capabilities_readLayersFromCapabilities(xmlDoc),matrixSets:readMatrixSetsFromCapabilities(xmlDoc)})))))},"./node_modules/@rgrove/parse-xml/dist/browser.js":module=>{var mod,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,src_exports={};((target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})})(src_exports,{XmlCdata:()=>XmlCdata,XmlComment:()=>XmlComment,XmlDeclaration:()=>XmlDeclaration,XmlDocument:()=>XmlDocument,XmlDocumentType:()=>XmlDocumentType,XmlElement:()=>XmlElement,XmlError:()=>XmlError,XmlNode:()=>XmlNode,XmlProcessingInstruction:()=>XmlProcessingInstruction,XmlText:()=>XmlText,parseXml:()=>parseXml}),module.exports=(mod=src_exports,((to,from,except,desc)=>{if(from&&"object"==typeof from||"function"==typeof from)for(let key of __getOwnPropNames(from))__hasOwnProp.call(to,key)||key===except||__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to})(__defProp({},"__esModule",{value:!0}),mod));var surrogatePair=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,StringScanner=class{constructor(string){if(this.k=this.u(string,!0),this.d=0,this.length=string.length,this.l=this.k!==this.length,this.h=string,this.l){let charsToBytes=[];for(let byteIndex=0,charIndex=0;charIndex<this.k;++charIndex)charsToBytes[charIndex]=byteIndex,byteIndex+=string.codePointAt(byteIndex)>65535?2:1;this.A=charsToBytes}}get B(){return this.d>=this.k}u(string,multiByteSafe=this.l){return multiByteSafe?string.replace(surrogatePair,"_").length:string.length}p(count=1){this.d=Math.min(this.k,this.d+count)}f(charIndex=this.d){var _a;return this.l?null!=(_a=this.A[charIndex])?_a:1/0:charIndex}G(charCount=1){let chars=this.m(charCount);return this.p(charCount),chars}v(byteCount){let byteIndex=this.f(),result=this.h.slice(byteIndex,byteIndex+byteCount);return this.p(this.u(result)),result}w(fn){let{length,l:multiByteMode,h:string}=this,startByteIndex=this.f(),endByteIndex=startByteIndex;if(multiByteMode)for(;endByteIndex<length;){let char=string[endByteIndex],isSurrogatePair=char>="\ud800"&&char<="\udbff";if(isSurrogatePair&&(char+=string[endByteIndex+1]),!fn(char))break;endByteIndex+=isSurrogatePair?2:1}else for(;endByteIndex<length&&fn(string[endByteIndex]);)++endByteIndex;return this.v(endByteIndex-startByteIndex)}b(stringToConsume){let{length}=stringToConsume,byteIndex=this.f();return stringToConsume===this.h.slice(byteIndex,byteIndex+length)?(this.p(1===length?1:this.u(stringToConsume)),stringToConsume):""}x(regex){let matchByteIndex=this.h.slice(this.f()).search(regex);return matchByteIndex>0?this.v(matchByteIndex):""}s(searchString){let byteIndex=this.f(),matchByteIndex=this.h.indexOf(searchString,byteIndex);return matchByteIndex>0?this.v(matchByteIndex-byteIndex):""}m(count=1){let{d:charIndex,h:string}=this;return this.l?string.slice(this.f(charIndex),this.f(charIndex+count)):string.slice(charIndex,charIndex+count)}n(index=0){this.d=index>=0?Math.min(this.k,index):Math.max(0,this.d+index)}},attValueCharDoubleQuote=/["&<]/,attValueCharSingleQuote=/['&<]/,attValueNormalizedWhitespace=/\r\n|[\n\r\t]/g,endCharData=/<|&|]]>/,predefinedEntities=Object.freeze(Object.assign(Object.create(null),{amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}));function isNameChar(char){let cp=char.codePointAt(0);return cp>=97&&cp<=122||cp>=65&&cp<=90||cp>=48&&cp<=57||45===cp||46===cp||183===cp||cp>=768&&cp<=879||8255===cp||8256===cp||isNameStartChar(char,cp)}function isNameStartChar(char,cp=char.codePointAt(0)){return cp>=97&&cp<=122||cp>=65&&cp<=90||58===cp||95===cp||cp>=192&&cp<=214||cp>=216&&cp<=246||cp>=248&&cp<=767||cp>=880&&cp<=893||cp>=895&&cp<=8191||8204===cp||8205===cp||cp>=8304&&cp<=8591||cp>=11264&&cp<=12271||cp>=12289&&cp<=55295||cp>=63744&&cp<=64975||cp>=65008&&cp<=65533||cp>=65536&&cp<=983039}function isReferenceChar(char){return"#"===char||isNameChar(char)}function isWhitespace(char){let cp=char.codePointAt(0);return 32===cp||9===cp||10===cp||13===cp}function isXmlCodePoint(cp){return cp>=32&&cp<=55295||10===cp||9===cp||13===cp||cp>=57344&&cp<=65533||cp>=65536&&cp<=1114111}var _XmlNode=class _XmlNode{constructor(){this.parent=null,this.start=-1,this.end=-1}get document(){var _a,_b;return null!=(_b=null==(_a=this.parent)?void 0:_a.document)?_b:null}get isRootNode(){return null!==this.parent&&this.parent===this.document&&this.type===_XmlNode.TYPE_ELEMENT}get preserveWhitespace(){var _a;return!!(null==(_a=this.parent)?void 0:_a.preserveWhitespace)}get type(){return""}toJSON(){let json={type:this.type};return this.isRootNode&&(json.isRootNode=!0),this.preserveWhitespace&&(json.preserveWhitespace=!0),-1!==this.start&&(json.start=this.start,json.end=this.end),json}};_XmlNode.TYPE_CDATA="cdata",_XmlNode.TYPE_COMMENT="comment",_XmlNode.TYPE_DOCUMENT="document",_XmlNode.TYPE_DOCUMENT_TYPE="doctype",_XmlNode.TYPE_ELEMENT="element",_XmlNode.TYPE_PROCESSING_INSTRUCTION="pi",_XmlNode.TYPE_TEXT="text",_XmlNode.TYPE_XML_DECLARATION="xmldecl";var XmlNode=_XmlNode,XmlText=class extends XmlNode{constructor(text=""){super(),this.text=text}get type(){return XmlNode.TYPE_TEXT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{text:this.text})}},XmlCdata=class extends XmlText{get type(){return XmlNode.TYPE_CDATA}},XmlComment=class extends XmlNode{constructor(content=""){super(),this.content=content}get type(){return XmlNode.TYPE_COMMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{content:this.content})}},XmlDeclaration=class extends XmlNode{constructor(version,encoding,standalone){super(),this.version=version,this.encoding=null!=encoding?encoding:null,this.standalone=null!=standalone?standalone:null}get type(){return XmlNode.TYPE_XML_DECLARATION}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.version=this.version;for(let key of["encoding","standalone"])null!==this[key]&&(json[key]=this[key]);return json}},XmlElement=class _XmlElement extends XmlNode{constructor(name,attributes=Object.create(null),children=[]){super(),this.name=name,this.attributes=attributes,this.children=children}get isEmpty(){return 0===this.children.length}get preserveWhitespace(){let node=this;for(;node instanceof _XmlElement;){if("xml:space"in node.attributes)return"preserve"===node.attributes["xml:space"];node=node.parent}return!1}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_ELEMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,attributes:this.attributes,children:this.children.map((child=>child.toJSON()))})}},XmlDocument=class extends XmlNode{constructor(children=[]){super(),this.children=children}get document(){return this}get root(){for(let child of this.children)if(child instanceof XmlElement)return child;return null}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_DOCUMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{children:this.children.map((child=>child.toJSON()))})}},XmlDocumentType=class extends XmlNode{constructor(name,publicId,systemId,internalSubset){super(),this.name=name,this.publicId=null!=publicId?publicId:null,this.systemId=null!=systemId?systemId:null,this.internalSubset=null!=internalSubset?internalSubset:null}get type(){return XmlNode.TYPE_DOCUMENT_TYPE}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.name=this.name;for(let key of["publicId","systemId","internalSubset"])null!==this[key]&&(json[key]=this[key]);return json}},XmlError=class extends Error{constructor(message,charIndex,xml){let column=1,excerpt="",line=1;for(let i=0;i<charIndex;++i){let char=xml[i];"\n"===char?(column=1,excerpt="",line+=1):(column+=1,excerpt+=char)}let eol=xml.indexOf("\n",charIndex);excerpt+=-1===eol?xml.slice(charIndex):xml.slice(charIndex,eol);let excerptStart=0;excerpt.length>50&&(column<40?excerpt=excerpt.slice(0,50):(excerptStart=column-20,excerpt=excerpt.slice(excerptStart,column+30))),super(`${message} (line ${line}, column ${column})\n  ${excerpt}\n`+" ".repeat(column-excerptStart+1)+"^\n"),this.column=column,this.excerpt=excerpt,this.line=line,this.name="XmlError",this.pos=charIndex}},XmlProcessingInstruction=class extends XmlNode{constructor(name,content=""){super(),this.name=name,this.content=content}get type(){return XmlNode.TYPE_PROCESSING_INSTRUCTION}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,content:this.content})}},Parser=class{constructor(xml,options={}){let doc=this.document=new XmlDocument;this.j=doc,this.g=options,this.c=new StringScanner(xml),this.g.includeOffsets&&(doc.start=0,doc.end=xml.length),this.parse()}i(node,charIndex){return node.parent=this.j,this.g.includeOffsets&&(node.start=this.c.f(charIndex),node.end=this.c.f()),this.j.children.push(node),!0}y(text,charIndex){let{children}=this.j,{length}=children;if(text=normalizeLineBreaks(text),length>0){let prevNode=children[length-1];if((null==prevNode?void 0:prevNode.type)===XmlNode.TYPE_TEXT){let textNode=prevNode;return textNode.text+=text,this.g.includeOffsets&&(textNode.end=this.c.f()),!0}}return this.i(new XmlText(text),charIndex)}H(){let attributes=Object.create(null);for(;this.e();){let attrName=this.q();if(!attrName)break;let attrValue=this.t()&&this.I();if(!1===attrValue)throw this.a("Attribute value expected");if(attrName in attributes)throw this.a(`Duplicate attribute: ${attrName}`);if("xml:space"===attrName&&"default"!==attrValue&&"preserve"!==attrValue)throw this.a('Value of the `xml:space` attribute must be "default" or "preserve"');attributes[attrName]=attrValue}if(this.g.sortAttributes){let attrNames=Object.keys(attributes).sort(),sortedAttributes=Object.create(null);for(let i=0;i<attrNames.length;++i){let attrName=attrNames[i];sortedAttributes[attrName]=attributes[attrName]}attributes=sortedAttributes}return attributes}I(){let chars,{c:scanner}=this,quote=scanner.m();if('"'!==quote&&"'"!==quote)return!1;scanner.p();let isClosed=!1,value="",regex='"'===quote?attValueCharDoubleQuote:attValueCharSingleQuote;matchLoop:for(;!scanner.B;)switch(chars=scanner.x(regex),chars&&(this.o(chars),value+=chars.replace(attValueNormalizedWhitespace," ")),scanner.m()){case quote:isClosed=!0;break matchLoop;case"&":value+=this.C();continue;case"<":throw this.a("Unescaped `<` is not allowed in an attribute value");default:break matchLoop}if(!isClosed)throw this.a("Unclosed attribute");return scanner.p(),value}J(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<![CDATA["))return!1;let text=scanner.s("]]>");if(this.o(text),!scanner.b("]]>"))throw this.a("Unclosed CDATA section");return this.g.preserveCdata?this.i(new XmlCdata(normalizeLineBreaks(text)),startIndex):this.y(text,startIndex)}K(){let{c:scanner}=this,startIndex=scanner.d,charData=scanner.x(endCharData);if(!charData)return!1;if(this.o(charData),"]]>"===scanner.m(3))throw this.a("Element content may not contain the CDATA section close delimiter `]]>`");return this.y(charData,startIndex)}D(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("\x3c!--"))return!1;let content=scanner.s("--");if(this.o(content),!scanner.b("--\x3e")){if("--"===scanner.m(2))throw this.a("The string `--` isn't allowed inside a comment");throw this.a("Unclosed comment")}return!this.g.preserveComments||this.i(new XmlComment(normalizeLineBreaks(content)),startIndex)}L(){let startIndex=this.c.d,ref=this.C();return!!ref&&this.y(ref,startIndex)}M(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<!DOCTYPE"))return!1;let publicId,systemId,internalSubset,name=this.e()&&this.q();if(!name)throw this.a("Expected a name");if(this.e()){if(scanner.b("PUBLIC")){if(publicId=this.e()&&this.N(),!1===publicId)throw this.a("Expected a public identifier");this.e()}if(void 0!==publicId||scanner.b("SYSTEM")){if(this.e(),systemId=this.r(),!1===systemId)throw this.a("Expected a system identifier");this.e()}}if(scanner.b("[")){if(internalSubset=scanner.x(/\][\x20\t\r\n]*>/),!scanner.b("]"))throw this.a("Unclosed internal subset");this.e()}if(!scanner.b(">"))throw this.a("Unclosed doctype declaration");return!this.g.preserveDocumentType||this.i(new XmlDocumentType(name,publicId,systemId,internalSubset),startIndex)}E(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<"))return!1;let name=this.q();if(!name)return scanner.n(startIndex),!1;let attributes=this.H(),isEmpty=!!scanner.b("/>"),element=new XmlElement(name,attributes);if(element.parent=this.j,!isEmpty){if(!scanner.b(">"))throw this.a(`Unclosed start tag for element \`${name}\``);this.j=element;do{this.K()}while(this.E()||this.L()||this.J()||this.F()||this.D());let endTagName,endTagMark=scanner.d;if(!scanner.b("</")||!(endTagName=this.q())||endTagName!==name)throw scanner.n(endTagMark),this.a(`Missing end tag for element ${name}`);if(this.e(),!scanner.b(">"))throw this.a(`Unclosed end tag for element ${name}`);this.j=element.parent}return this.i(element,startIndex)}t(){return this.e(),!!this.c.b("=")&&(this.e(),!0)}z(){return this.D()||this.F()||this.e()}q(){return isNameStartChar(this.c.m())?this.c.w(isNameChar):""}F(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?"))return!1;let name=this.q();if(!name)throw this.a("Invalid processing instruction");if("xml"===name.toLowerCase())throw scanner.n(startIndex),this.a("XML declaration isn't allowed here");if(!this.e()){if(scanner.b("?>"))return this.i(new XmlProcessingInstruction(name),startIndex);throw this.a("Whitespace is required after a processing instruction name")}let content=scanner.s("?>");if(this.o(content),!scanner.b("?>"))throw this.a("Unterminated processing instruction");return this.i(new XmlProcessingInstruction(name,normalizeLineBreaks(content)),startIndex)}O(){let{c:scanner}=this,startIndex=scanner.d;for(this.P();this.z(););if(this.M())for(;this.z(););return startIndex<scanner.d}N(){let startIndex=this.c.d,value=this.r();if(!1!==value&&!/^[-\x20\r\na-zA-Z0-9'()+,./:=?;!*#@$_%]*$/.test(value))throw this.c.n(startIndex),this.a("Invalid character in public identifier");return value}C(){let{c:scanner}=this;if(!scanner.b("&"))return!1;let parsedValue,ref=scanner.w(isReferenceChar);if(";"!==scanner.G())throw this.a("Unterminated reference (a reference must end with `;`)");if("#"===ref[0]){let codePoint="x"===ref[1]?parseInt(ref.slice(2),16):parseInt(ref.slice(1),10);if(isNaN(codePoint))throw this.a("Invalid character reference");if(!isXmlCodePoint(codePoint))throw this.a("Character reference resolves to an invalid character");parsedValue=String.fromCodePoint(codePoint)}else if(parsedValue=predefinedEntities[ref],void 0===parsedValue){let{ignoreUndefinedEntities,resolveUndefinedEntity}=this.g,wrappedRef=`&${ref};`;if(resolveUndefinedEntity){let resolvedValue=resolveUndefinedEntity(wrappedRef);if(null!=resolvedValue){let type=typeof resolvedValue;if("string"!==type)throw new TypeError(`\`resolveUndefinedEntity()\` must return a string, \`null\`, or \`undefined\`, but returned a value of type ${type}`);return resolvedValue}}if(ignoreUndefinedEntities)return wrappedRef;throw scanner.n(-wrappedRef.length),this.a(`Named entity isn't defined: ${wrappedRef}`)}return parsedValue}r(){let{c:scanner}=this,quote=scanner.b('"')||scanner.b("'");if(!quote)return!1;let value=scanner.s(quote);if(this.o(value),!scanner.b(quote))throw this.a("Missing end quote");return value}e(){return!!this.c.w(isWhitespace)}P(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?xml"))return!1;if(!this.e())throw this.a("Invalid XML declaration");let encoding,standalone,version=!!scanner.b("version")&&this.t()&&this.r();if(!1===version)throw this.a("XML version is missing or invalid");if(!/^1\.[0-9]+$/.test(version))throw this.a("Invalid character in version number");if(this.e()){if(encoding=!!scanner.b("encoding")&&this.t()&&this.r(),encoding){if(!/^[A-Za-z][\w.-]*$/.test(encoding))throw this.a("Invalid character in encoding name");this.e()}if(standalone=!!scanner.b("standalone")&&this.t()&&this.r(),standalone){if("yes"!==standalone&&"no"!==standalone)throw this.a('Only "yes" and "no" are permitted as values of `standalone`');this.e()}}if(!scanner.b("?>"))throw this.a("Invalid or unclosed XML declaration");return!this.g.preserveXmlDeclaration||this.i(new XmlDeclaration(version,encoding||void 0,standalone||void 0),startIndex)}a(message){let{c:scanner}=this;return new XmlError(message,scanner.d,scanner.h)}parse(){if(this.c.b("\ufeff"),this.O(),!this.E())throw this.a("Root element is missing or invalid");for(;this.z(););if(!this.c.B)throw this.a("Extra content at the end of the document")}o(string){let{length}=string;for(let i=0;i<length;++i){let cp=string.codePointAt(i);if(!isXmlCodePoint(cp))throw this.c.n(-([...string].length-i)),this.a("Invalid character");cp>65535&&(i+=1)}}};function normalizeLineBreaks(text){let i=0;for(;-1!==(i=text.indexOf("\r",i));)text="\n"===text[i+1]?text.slice(0,i)+text.slice(i+1):text.slice(0,i)+"\n"+text.slice(i+1);return text}function parseXml(xml,options){return new Parser(xml,options).document}}}]);