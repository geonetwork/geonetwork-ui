/*! For license information please see 2180.f3bca07e.iframe.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkgeonetwork_ui=self.webpackChunkgeonetwork_ui||[]).push([[2180],{"./node_modules/@camptocamp/ogc-client/dist/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{ld:()=>OgcApiEndpoint,VR:()=>WfsEndpoint,us:()=>WmsEndpoint,Nn:()=>WmtsEndpoint,Td:()=>sharedFetch,YT:()=>useCache});var asyncToGenerator=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js");let counter=0;function sendTaskRequest(taskName,workerInstance2,params){return new Promise(((resolve,reject)=>{const requestId=function worker_getUniqueId(){return counter++}(),request={requestId,taskName,params};null===workerInstance2?globalThis.dispatchEvent(new CustomEvent("ogc-client.request",{detail:request})):workerInstance2.postMessage(request);const handler=response=>{response.requestId===requestId&&(null===workerInstance2?globalThis.removeEventListener("message",windowHandler):workerInstance2.removeEventListener("message",workerHandler),"error"in response?reject(response.error):resolve(response.response))},windowHandler=event=>handler(event.detail),workerHandler=event=>handler(event.data);null===workerInstance2?globalThis.addEventListener("ogc-client.response",windowHandler):workerInstance2.addEventListener("message",workerHandler)}))}var mod,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,src_exports={};((target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})})(src_exports,{XmlCdata:()=>XmlCdata,XmlComment:()=>XmlComment,XmlDeclaration:()=>XmlDeclaration,XmlDocument:()=>XmlDocument,XmlDocumentType:()=>XmlDocumentType,XmlElement:()=>XmlElement,XmlError:()=>XmlError,XmlNode:()=>XmlNode,XmlProcessingInstruction:()=>XmlProcessingInstruction,XmlText:()=>XmlText,parseXml:()=>parseXml}),mod=src_exports,((to,from,except,desc)=>{if(from&&"object"==typeof from||"function"==typeof from)for(let key of __getOwnPropNames(from))__hasOwnProp.call(to,key)||key===except||__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})})(__defProp({},"__esModule",{value:!0}),mod);var surrogatePair=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,attValueCharDoubleQuote=/[^"&<]+/y,attValueCharSingleQuote=/[^'&<]+/y,attValueNormalizedWhitespace=/\r\n|[\n\r\t]/g,endCharData=/<|&|]]>/,predefinedEntities=Object.freeze(Object.assign(Object.create(null),{amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}));function isNameChar(char){let cp=getCodePoint(char);return cp>=97&&cp<=122||cp>=65&&cp<=90||cp>=48&&cp<=57||45===cp||46===cp||183===cp||cp>=768&&cp<=879||cp>=8255&&cp<=8256||isNameStartChar(char,cp)}function isNameStartChar(char,cp=getCodePoint(char)){return cp>=97&&cp<=122||cp>=65&&cp<=90||58===cp||95===cp||cp>=192&&cp<=214||cp>=216&&cp<=246||cp>=248&&cp<=767||cp>=880&&cp<=893||cp>=895&&cp<=8191||cp>=8204&&cp<=8205||cp>=8304&&cp<=8591||cp>=11264&&cp<=12271||cp>=12289&&cp<=55295||cp>=63744&&cp<=64975||cp>=65008&&cp<=65533||cp>=65536&&cp<=983039}function isReferenceChar(char){return"#"===char||isNameChar(char)}function isWhitespace(char){let cp=getCodePoint(char);return 32===cp||9===cp||10===cp||13===cp}function isXmlCodePoint(cp){return 9===cp||10===cp||13===cp||cp>=32&&cp<=55295||cp>=57344&&cp<=65533||cp>=65536&&cp<=1114111}function getCodePoint(char){return char.codePointAt(0)||-1}var _XmlNode=class{constructor(){this.parent=null,this.start=-1,this.end=-1}get document(){var _a,_b;return null!=(_b=null==(_a=this.parent)?void 0:_a.document)?_b:null}get isRootNode(){return null!==this.parent&&this.parent===this.document&&this.type===_XmlNode.TYPE_ELEMENT}get preserveWhitespace(){var _a;return!!(null==(_a=this.parent)?void 0:_a.preserveWhitespace)}get type(){return""}toJSON(){let json={type:this.type};return this.isRootNode&&(json.isRootNode=!0),this.preserveWhitespace&&(json.preserveWhitespace=!0),-1!==this.start&&(json.start=this.start,json.end=this.end),json}},XmlNode=_XmlNode;XmlNode.TYPE_CDATA="cdata",XmlNode.TYPE_COMMENT="comment",XmlNode.TYPE_DOCUMENT="document",XmlNode.TYPE_DOCUMENT_TYPE="doctype",XmlNode.TYPE_ELEMENT="element",XmlNode.TYPE_PROCESSING_INSTRUCTION="pi",XmlNode.TYPE_TEXT="text",XmlNode.TYPE_XML_DECLARATION="xmldecl";var XmlText=class extends XmlNode{constructor(text=""){super(),this.text=text}get type(){return XmlNode.TYPE_TEXT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{text:this.text})}},XmlCdata=class extends XmlText{get type(){return XmlNode.TYPE_CDATA}},XmlComment=class extends XmlNode{constructor(content=""){super(),this.content=content}get type(){return XmlNode.TYPE_COMMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{content:this.content})}},XmlDeclaration=class extends XmlNode{constructor(version,encoding,standalone){super(),this.version=version,this.encoding=null!=encoding?encoding:null,this.standalone=null!=standalone?standalone:null}get type(){return XmlNode.TYPE_XML_DECLARATION}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.version=this.version;for(let key of["encoding","standalone"])null!==this[key]&&(json[key]=this[key]);return json}},XmlElement=class extends XmlNode{constructor(name,attributes=Object.create(null),children=[]){super(),this.name=name,this.attributes=attributes,this.children=children}get isEmpty(){return 0===this.children.length}get preserveWhitespace(){let node=this;for(;node instanceof XmlElement;){if("xml:space"in node.attributes)return"preserve"===node.attributes["xml:space"];node=node.parent}return!1}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_ELEMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,attributes:this.attributes,children:this.children.map((child=>child.toJSON()))})}},XmlDocument=class extends XmlNode{constructor(children=[]){super(),this.children=children}get document(){return this}get root(){for(let child of this.children)if(child instanceof XmlElement)return child;return null}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_DOCUMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{children:this.children.map((child=>child.toJSON()))})}},XmlDocumentType=class extends XmlNode{constructor(name,publicId,systemId,internalSubset){super(),this.name=name,this.publicId=null!=publicId?publicId:null,this.systemId=null!=systemId?systemId:null,this.internalSubset=null!=internalSubset?internalSubset:null}get type(){return XmlNode.TYPE_DOCUMENT_TYPE}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.name=this.name;for(let key of["publicId","systemId","internalSubset"])null!==this[key]&&(json[key]=this[key]);return json}},XmlError=class extends Error{constructor(message,charIndex,xml){let column=1,excerpt="",line=1;for(let i=0;i<charIndex;++i){let char=xml[i];"\n"===char?(column=1,excerpt="",line+=1):(column+=1,excerpt+=char)}let eol=xml.indexOf("\n",charIndex);excerpt+=-1===eol?xml.slice(charIndex):xml.slice(charIndex,eol);let excerptStart=0;excerpt.length>50&&(column<40?excerpt=excerpt.slice(0,50):(excerptStart=column-20,excerpt=excerpt.slice(excerptStart,column+30))),super(`${message} (line ${line}, column ${column})\n  ${excerpt}\n`+" ".repeat(column-excerptStart+1)+"^\n"),this.column=column,this.excerpt=excerpt,this.line=line,this.name="XmlError",this.pos=charIndex}},XmlProcessingInstruction=class extends XmlNode{constructor(name,content=""){super(),this.name=name,this.content=content}get type(){return XmlNode.TYPE_PROCESSING_INSTRUCTION}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,content:this.content})}},Parser=class{constructor(xml,options={}){let doc=this.document=new XmlDocument,scanner=this.c=new class{constructor(string){if(this.k=this.q(string,!0),this.d=0,this.length=string.length,this.n=this.k!==this.length,this.m=string,this.n){let charsToBytes=[];for(let byteIndex=0,charIndex=0;charIndex<this.k;++charIndex)charsToBytes[charIndex]=byteIndex,byteIndex+=string.codePointAt(byteIndex)>65535?2:1;this.y=charsToBytes}}get z(){return this.d>=this.k}q(string,multiByteSafe=this.n){return multiByteSafe?string.replace(surrogatePair,"_").length:string.length}g(count=1){this.d=Math.min(this.k,this.d+count)}i(charIndex=this.d){var _a;return this.n?null!=(_a=this.y[charIndex])?_a:1/0:charIndex}F(count=1){let chars=this.h(count);return this.g(count),chars}G(regex){if(!regex.sticky)throw new Error('`regex` must have a sticky flag ("y")');regex.lastIndex=this.i();let result=regex.exec(this.m);if(null===result||0===result.length)return"";let match=result[0];return this.g(this.q(match)),match}v(fn){let char,match="";for(;(char=this.h())&&fn(char);)match+=char,this.g();return match}Q(stringToConsume){if(this.b(stringToConsume))return stringToConsume;if(this.n){let{length}=stringToConsume,charLengthToMatch=this.q(stringToConsume);if(charLengthToMatch!==length&&stringToConsume===this.h(charLengthToMatch))return this.g(charLengthToMatch),stringToConsume}return""}b(stringToConsume){let{length}=stringToConsume;return this.h(length)===stringToConsume?(this.g(length),stringToConsume):""}A(regex){let restOfString=this.m.slice(this.i()),matchByteIndex=restOfString.search(regex);if(matchByteIndex<=0)return"";let result=restOfString.slice(0,matchByteIndex);return this.g(this.q(result)),result}t(searchString){let{m:string}=this,byteIndex=this.i(),matchByteIndex=string.indexOf(searchString,byteIndex);if(matchByteIndex<=0)return"";let result=string.slice(byteIndex,matchByteIndex);return this.g(this.q(result)),result}h(count=1){let{d:charIndex,n:multiByteMode,m:string}=this;return multiByteMode?charIndex>=this.k?"":string.slice(this.i(charIndex),this.i(charIndex+count)):string.slice(charIndex,charIndex+count)}o(index=0){this.d=index>=0?Math.min(this.k,index):Math.max(0,this.d+index)}}(xml);if(this.l=doc,this.f=options,this.f.includeOffsets&&(doc.start=0,doc.end=xml.length),scanner.b("\ufeff"),this.H(),!this.B())throw this.a("Root element is missing or invalid");for(;this.w(););if(!scanner.z)throw this.a("Extra content at the end of the document")}j(node,charIndex){return node.parent=this.l,this.f.includeOffsets&&(node.start=this.c.i(charIndex),node.end=this.c.i()),this.l.children.push(node),!0}x(text,charIndex){let{children}=this.l,{length}=children;if(text=normalizeLineBreaks(text),length>0){let prevNode=children[length-1];if((null==prevNode?void 0:prevNode.type)===XmlNode.TYPE_TEXT){let textNode=prevNode;return textNode.text+=text,this.f.includeOffsets&&(textNode.end=this.c.i()),!0}}return this.j(new XmlText(text),charIndex)}I(){let attributes=Object.create(null);for(;this.e();){let attrName=this.r();if(!attrName)break;let attrValue=this.u()&&this.J();if(!1===attrValue)throw this.a("Attribute value expected");if(attrName in attributes)throw this.a(`Duplicate attribute: ${attrName}`);if("xml:space"===attrName&&"default"!==attrValue&&"preserve"!==attrValue)throw this.a('Value of the `xml:space` attribute must be "default" or "preserve"');attributes[attrName]=attrValue}if(this.f.sortAttributes){let attrNames=Object.keys(attributes).sort(),sortedAttributes=Object.create(null);for(let i=0;i<attrNames.length;++i){let attrName=attrNames[i];sortedAttributes[attrName]=attributes[attrName]}attributes=sortedAttributes}return attributes}J(){let chars,{c:scanner}=this,quote=scanner.h();if('"'!==quote&&"'"!==quote)return!1;scanner.g();let isClosed=!1,value="",regex='"'===quote?attValueCharDoubleQuote:attValueCharSingleQuote;matchLoop:for(;!scanner.z;)switch(chars=scanner.G(regex),chars&&(this.p(chars),value+=chars.replace(attValueNormalizedWhitespace," ")),scanner.h()){case quote:isClosed=!0;break matchLoop;case"&":value+=this.C();continue;case"<":throw this.a("Unescaped `<` is not allowed in an attribute value");case"":break matchLoop}if(!isClosed)throw this.a("Unclosed attribute");return scanner.g(),value}K(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<![CDATA["))return!1;let text=scanner.t("]]>");if(this.p(text),!scanner.b("]]>"))throw this.a("Unclosed CDATA section");return this.f.preserveCdata?this.j(new XmlCdata(normalizeLineBreaks(text)),startIndex):this.x(text,startIndex)}L(){let{c:scanner}=this,startIndex=scanner.d,charData=scanner.A(endCharData);if(!charData)return!1;if(this.p(charData),"]]>"===scanner.h(3))throw this.a("Element content may not contain the CDATA section close delimiter `]]>`");return this.x(charData,startIndex)}D(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("\x3c!--"))return!1;let content=scanner.t("--");if(this.p(content),!scanner.b("--\x3e")){if("--"===scanner.h(2))throw this.a("The string `--` isn't allowed inside a comment");throw this.a("Unclosed comment")}return!this.f.preserveComments||this.j(new XmlComment(normalizeLineBreaks(content)),startIndex)}M(){let startIndex=this.c.d,ref=this.C();return!!ref&&this.x(ref,startIndex)}N(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<!DOCTYPE"))return!1;let publicId,systemId,internalSubset,name=this.e()&&this.r();if(!name)throw this.a("Expected a name");if(this.e()){if(scanner.b("PUBLIC")){if(publicId=this.e()&&this.O(),!1===publicId)throw this.a("Expected a public identifier");this.e()}if(void 0!==publicId||scanner.b("SYSTEM")){if(this.e(),systemId=this.s(),!1===systemId)throw this.a("Expected a system identifier");this.e()}}if(scanner.b("[")){if(internalSubset=scanner.A(/\][\x20\t\r\n]*>/),!scanner.b("]"))throw this.a("Unclosed internal subset");this.e()}if(!scanner.b(">"))throw this.a("Unclosed doctype declaration");return!this.f.preserveDocumentType||this.j(new XmlDocumentType(name,publicId,systemId,internalSubset),startIndex)}B(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<"))return!1;let name=this.r();if(!name)return scanner.o(startIndex),!1;let attributes=this.I(),isEmpty=!!scanner.b("/>"),element=new XmlElement(name,attributes);if(element.parent=this.l,!isEmpty){if(!scanner.b(">"))throw this.a(`Unclosed start tag for element \`${name}\``);this.l=element;do{this.L()}while(this.B()||this.M()||this.K()||this.E()||this.D());let endTagName,endTagMark=scanner.d;if(!scanner.b("</")||!(endTagName=this.r())||endTagName!==name)throw scanner.o(endTagMark),this.a(`Missing end tag for element ${name}`);if(this.e(),!scanner.b(">"))throw this.a(`Unclosed end tag for element ${name}`);this.l=element.parent}return this.j(element,startIndex)}u(){return this.e(),!!this.c.b("=")&&(this.e(),!0)}w(){return this.D()||this.E()||this.e()}r(){return isNameStartChar(this.c.h())?this.c.v(isNameChar):""}E(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?"))return!1;let name=this.r();if(!name)throw this.a("Invalid processing instruction");if("xml"===name.toLowerCase())throw scanner.o(startIndex),this.a("XML declaration isn't allowed here");if(!this.e()){if(scanner.b("?>"))return this.j(new XmlProcessingInstruction(name),startIndex);throw this.a("Whitespace is required after a processing instruction name")}let content=scanner.t("?>");if(this.p(content),!scanner.b("?>"))throw this.a("Unterminated processing instruction");return this.j(new XmlProcessingInstruction(name,normalizeLineBreaks(content)),startIndex)}H(){let{c:scanner}=this,startIndex=scanner.d;for(this.P();this.w(););if(this.N())for(;this.w(););return startIndex<scanner.d}O(){let startIndex=this.c.d,value=this.s();if(!1!==value&&!/^[-\x20\r\na-zA-Z0-9'()+,./:=?;!*#@$_%]*$/.test(value))throw this.c.o(startIndex),this.a("Invalid character in public identifier");return value}C(){let{c:scanner}=this;if(!scanner.b("&"))return!1;let parsedValue,ref=scanner.v(isReferenceChar);if(";"!==scanner.F())throw this.a("Unterminated reference (a reference must end with `;`)");if("#"===ref[0]){let codePoint="x"===ref[1]?parseInt(ref.slice(2),16):parseInt(ref.slice(1),10);if(isNaN(codePoint))throw this.a("Invalid character reference");if(!isXmlCodePoint(codePoint))throw this.a("Character reference resolves to an invalid character");parsedValue=String.fromCodePoint(codePoint)}else if(parsedValue=predefinedEntities[ref],void 0===parsedValue){let{ignoreUndefinedEntities,resolveUndefinedEntity}=this.f,wrappedRef=`&${ref};`;if(resolveUndefinedEntity){let resolvedValue=resolveUndefinedEntity(wrappedRef);if(null!=resolvedValue){let type=typeof resolvedValue;if("string"!==type)throw new TypeError(`\`resolveUndefinedEntity()\` must return a string, \`null\`, or \`undefined\`, but returned a value of type ${type}`);return resolvedValue}}if(ignoreUndefinedEntities)return wrappedRef;throw scanner.o(-wrappedRef.length),this.a(`Named entity isn't defined: ${wrappedRef}`)}return parsedValue}s(){let{c:scanner}=this,quote=scanner.b('"')||scanner.b("'");if(!quote)return!1;let value=scanner.t(quote);if(this.p(value),!scanner.b(quote))throw this.a("Missing end quote");return value}e(){return!!this.c.v(isWhitespace)}P(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?xml"))return!1;if(!this.e())throw this.a("Invalid XML declaration");let encoding,standalone,version=!!scanner.b("version")&&this.u()&&this.s();if(!1===version)throw this.a("XML version is missing or invalid");if(!/^1\.[0-9]+$/.test(version))throw this.a("Invalid character in version number");if(this.e()&&(encoding=!!scanner.b("encoding")&&this.u()&&this.s(),encoding&&this.e(),standalone=!!scanner.b("standalone")&&this.u()&&this.s(),standalone)){if("yes"!==standalone&&"no"!==standalone)throw this.a('Only "yes" and "no" are permitted as values of `standalone`');this.e()}if(!scanner.b("?>"))throw this.a("Invalid or unclosed XML declaration");return!this.f.preserveXmlDeclaration||this.j(new XmlDeclaration(version,encoding||void 0,standalone||void 0),startIndex)}a(message){let{c:scanner}=this;return new XmlError(message,scanner.d,scanner.m)}p(string){let{length}=string;for(let i=0;i<length;++i){let cp=string.codePointAt(i);if(!isXmlCodePoint(cp))throw this.c.o(-([...string].length-i)),this.a("Invalid character");cp>65535&&(i+=1)}}};function normalizeLineBreaks(text){let i=0;for(;-1!==(i=text.indexOf("\r",i));)text="\n"===text[i+1]?text.slice(0,i)+text.slice(i+1):text.slice(0,i)+"\n"+text.slice(i+1);return text}function parseXml(xml,options){return new Parser(xml,options).document}const encodedJs="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICBmdW5jdGlvbiBhZGRUYXNrSGFuZGxlcih0YXNrTmFtZSwgc2NvcGUsIGhhbmRsZXIpIHsKICAgIGNvbnN0IHVzZVdvcmtlciA9IHR5cGVvZiBXb3JrZXJHbG9iYWxTY29wZSAhPT0gInVuZGVmaW5lZCI7CiAgICBjb25zdCBldmVudEhhbmRsZXIgPSBhc3luYyAocmVxdWVzdCkgPT4gewogICAgICBpZiAocmVxdWVzdC50YXNrTmFtZSA9PT0gdGFza05hbWUpIHsKICAgICAgICBsZXQgcmVzcG9uc2UsIGVycm9yOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXNwb25zZSA9IGF3YWl0IGhhbmRsZXIocmVxdWVzdC5wYXJhbXMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGVycm9yID0gZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICgKICAgICAgICAgIC8qKiBAdHlwZSB7V29ya2VyUmVzcG9uc2V9ICovCiAgICAgICAgICB7CiAgICAgICAgICAgIHRhc2tOYW1lLAogICAgICAgICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICAgICAgICAuLi5yZXNwb25zZSAmJiB7IHJlc3BvbnNlIH0sCiAgICAgICAgICAgIC4uLmVycm9yICYmIHsgZXJyb3IgfQogICAgICAgICAgfQogICAgICAgICk7CiAgICAgICAgaWYgKHVzZVdvcmtlcikgewogICAgICAgICAgc2NvcGUucG9zdE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjb3BlLmRpc3BhdGNoRXZlbnQoCiAgICAgICAgICAgIG5ldyBDdXN0b21FdmVudCgib2djLWNsaWVudC5yZXNwb25zZSIsIHsKICAgICAgICAgICAgICBkZXRhaWw6IG1lc3NhZ2UKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgaWYgKHVzZVdvcmtlcikgewogICAgICBzY29wZS5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKGV2ZW50KSA9PiBldmVudEhhbmRsZXIoZXZlbnQuZGF0YSkpOwogICAgfSBlbHNlIHsKICAgICAgc2NvcGUuYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgICAib2djLWNsaWVudC5yZXF1ZXN0IiwKICAgICAgICAoZXZlbnQpID0+IGV2ZW50SGFuZGxlcihldmVudC5kZXRhaWwpCiAgICAgICk7CiAgICB9CiAgfQogIC8qISBAcmdyb3ZlL3BhcnNlLXhtbCB2NC4xLjAgfCBJU0MgTGljZW5zZSB8IENvcHlyaWdodCBSeWFuIEdyb3ZlICovCiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgICBmb3IgKHZhciBuYW1lIGluIGFsbCkKICAgICAgX19kZWZQcm9wKHRhcmdldCwgbmFtZSwgeyBnZXQ6IGFsbFtuYW1lXSwgZW51bWVyYWJsZTogdHJ1ZSB9KTsKICB9OwogIHZhciBfX2NvcHlQcm9wcyA9ICh0bywgZnJvbSwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZm9yIChsZXQga2V5IG9mIF9fZ2V0T3duUHJvcE5hbWVzKGZyb20pKQogICAgICAgIGlmICghX19oYXNPd25Qcm9wLmNhbGwodG8sIGtleSkgJiYga2V5ICE9PSBleGNlcHQpCiAgICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgICB9CiAgICByZXR1cm4gdG87CiAgfTsKICB2YXIgX190b0NvbW1vbkpTID0gKG1vZCkgPT4gX19jb3B5UHJvcHMoX19kZWZQcm9wKHt9LCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSksIG1vZCk7CiAgdmFyIHNyY19leHBvcnRzID0ge307CiAgX19leHBvcnQoc3JjX2V4cG9ydHMsIHsKICAgIFhtbENkYXRhOiAoKSA9PiBYbWxDZGF0YSwKICAgIFhtbENvbW1lbnQ6ICgpID0+IFhtbENvbW1lbnQsCiAgICBYbWxEZWNsYXJhdGlvbjogKCkgPT4gWG1sRGVjbGFyYXRpb24sCiAgICBYbWxEb2N1bWVudDogKCkgPT4gWG1sRG9jdW1lbnQsCiAgICBYbWxEb2N1bWVudFR5cGU6ICgpID0+IFhtbERvY3VtZW50VHlwZSwKICAgIFhtbEVsZW1lbnQ6ICgpID0+IFhtbEVsZW1lbnQsCiAgICBYbWxFcnJvcjogKCkgPT4gWG1sRXJyb3IsCiAgICBYbWxOb2RlOiAoKSA9PiBYbWxOb2RlLAogICAgWG1sUHJvY2Vzc2luZ0luc3RydWN0aW9uOiAoKSA9PiBYbWxQcm9jZXNzaW5nSW5zdHJ1Y3Rpb24sCiAgICBYbWxUZXh0OiAoKSA9PiBYbWxUZXh0LAogICAgcGFyc2VYbWw6ICgpID0+IHBhcnNlWG1sCiAgfSk7CiAgdmFyIGJyb3dzZXIgPSBfX3RvQ29tbW9uSlMoc3JjX2V4cG9ydHMpOwogIHZhciBlbXB0eVN0cmluZyA9ICIiOwogIHZhciBzdXJyb2dhdGVQYWlyID0gL1tcdUQ4MDAtXHVEQkZGXVtcdURDMDAtXHVERkZGXS9nOwogIHZhciBTdHJpbmdTY2FubmVyID0gY2xhc3MgewogICAgY29uc3RydWN0b3Ioc3RyaW5nKSB7CiAgICAgIHRoaXMuayA9IHRoaXMucShzdHJpbmcsIHRydWUpOwogICAgICB0aGlzLmQgPSAwOwogICAgICB0aGlzLmxlbmd0aCA9IHN0cmluZy5sZW5ndGg7CiAgICAgIHRoaXMubiA9IHRoaXMuayAhPT0gdGhpcy5sZW5ndGg7CiAgICAgIHRoaXMubSA9IHN0cmluZzsKICAgICAgaWYgKHRoaXMubikgewogICAgICAgIGxldCBjaGFyc1RvQnl0ZXMgPSBbXTsKICAgICAgICBmb3IgKGxldCBieXRlSW5kZXggPSAwLCBjaGFySW5kZXggPSAwOyBjaGFySW5kZXggPCB0aGlzLms7ICsrY2hhckluZGV4KSB7CiAgICAgICAgICBjaGFyc1RvQnl0ZXNbY2hhckluZGV4XSA9IGJ5dGVJbmRleDsKICAgICAgICAgIGJ5dGVJbmRleCArPSBzdHJpbmcuY29kZVBvaW50QXQoYnl0ZUluZGV4KSA+IDY1NTM1ID8gMiA6IDE7CiAgICAgICAgfQogICAgICAgIHRoaXMueSA9IGNoYXJzVG9CeXRlczsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoZSBjdXJyZW50IGNoYXJhY3RlciBpbmRleCBpcyBhdCB0aGUgZW5kIG9mIHRoZSBpbnB1dCBzdHJpbmcuCiAgICAgKi8KICAgIGdldCB6KCkgewogICAgICByZXR1cm4gdGhpcy5kID49IHRoaXMuazsKICAgIH0KICAgIC8vIC0tIFByb3RlY3RlZCBNZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgY2hhcmFjdGVycyBpbiB0aGUgZ2l2ZW4gc3RyaW5nLCB3aGljaCBtYXkgZGlmZmVyIGZyb20KICAgICAqIHRoZSBieXRlIGxlbmd0aCBpZiB0aGUgc3RyaW5nIGNvbnRhaW5zIG11bHRpYnl0ZSBjaGFyYWN0ZXJzLgogICAgICovCiAgICBxKHN0cmluZywgbXVsdGlCeXRlU2FmZSA9IHRoaXMubikgewogICAgICByZXR1cm4gbXVsdGlCeXRlU2FmZSA/IHN0cmluZy5yZXBsYWNlKHN1cnJvZ2F0ZVBhaXIsICJfIikubGVuZ3RoIDogc3RyaW5nLmxlbmd0aDsKICAgIH0KICAgIC8vIC0tIFB1YmxpYyBNZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLyoqCiAgICAgKiBBZHZhbmNlcyB0aGUgc2Nhbm5lciBieSB0aGUgZ2l2ZW4gbnVtYmVyIG9mIGNoYXJhY3RlcnMsIHN0b3BwaW5nIGlmIHRoZSBlbmQKICAgICAqIG9mIHRoZSBzdHJpbmcgaXMgcmVhY2hlZC4KICAgICAqLwogICAgZyhjb3VudCA9IDEpIHsKICAgICAgdGhpcy5kID0gTWF0aC5taW4odGhpcy5rLCB0aGlzLmQgKyBjb3VudCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGJ5dGUgaW5kZXggb2YgdGhlIGdpdmVuIGNoYXJhY3RlciBpbmRleCBpbiB0aGUgc3RyaW5nLiBUaGUgdHdvCiAgICAgKiBtYXkgZGlmZmVyIGluIHN0cmluZ3MgdGhhdCBjb250YWluIG11bHRpYnl0ZSBjaGFyYWN0ZXJzLgogICAgICovCiAgICBpKGNoYXJJbmRleCA9IHRoaXMuZCkgewogICAgICB2YXIgX2E7CiAgICAgIHJldHVybiB0aGlzLm4gPyAoX2EgPSB0aGlzLnlbY2hhckluZGV4XSkgIT0gbnVsbCA/IF9hIDogSW5maW5pdHkgOiBjaGFySW5kZXg7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGFuZCByZXR1cm5zIHRoZSBnaXZlbiBudW1iZXIgb2YgY2hhcmFjdGVycyBpZiBwb3NzaWJsZSwgYWR2YW5jaW5nCiAgICAgKiB0aGUgc2Nhbm5lciBhbmQgc3RvcHBpbmcgaWYgdGhlIGVuZCBvZiB0aGUgc3RyaW5nIGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogSWYgbm8gY2hhcmFjdGVycyBjb3VsZCBiZSBjb25zdW1lZCwgYW4gZW1wdHkgc3RyaW5nIHdpbGwgYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIEYoY291bnQgPSAxKSB7CiAgICAgIGxldCBjaGFycyA9IHRoaXMuaChjb3VudCk7CiAgICAgIHRoaXMuZyhjb3VudCk7CiAgICAgIHJldHVybiBjaGFyczsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBtYXRjaCBmb3IgdGhlIGdpdmVuIHN0aWNreSByZWdleCwgYWR2YW5jZXMgdGhlIHNjYW5uZXIsIHVwZGF0ZXMKICAgICAqIHRoZSBgbGFzdEluZGV4YCBwcm9wZXJ0eSBvZiB0aGUgcmVnZXgsIGFuZCByZXR1cm5zIHRoZSBtYXRjaGluZyBzdHJpbmcuCiAgICAgKgogICAgICogVGhlIHJlZ2V4IG11c3QgaGF2ZSBhIHN0aWNreSBmbGFnICgieSIpIHNvIHRoYXQgaXRzIGBsYXN0SW5kZXhgIHByb3AgY2FuIGJlCiAgICAgKiB1c2VkIHRvIGFuY2hvciB0aGUgbWF0Y2ggYXQgdGhlIGN1cnJlbnQgc2Nhbm5lciBwb3NpdGlvbi4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjb25zdW1lZCBzdHJpbmcsIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBjb25zdW1lZC4KICAgICAqLwogICAgRyhyZWdleCkgewogICAgICBpZiAoIXJlZ2V4LnN0aWNreSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignYHJlZ2V4YCBtdXN0IGhhdmUgYSBzdGlja3kgZmxhZyAoInkiKScpOwogICAgICB9CiAgICAgIHJlZ2V4Lmxhc3RJbmRleCA9IHRoaXMuaSgpOwogICAgICBsZXQgcmVzdWx0ID0gcmVnZXguZXhlYyh0aGlzLm0pOwogICAgICBpZiAocmVzdWx0ID09PSBudWxsIHx8IHJlc3VsdC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZW1wdHlTdHJpbmc7CiAgICAgIH0KICAgICAgbGV0IG1hdGNoID0gcmVzdWx0WzBdOwogICAgICB0aGlzLmcodGhpcy5xKG1hdGNoKSk7CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYW5kIHJldHVybnMgYWxsIGNoYXJhY3RlcnMgZm9yIHdoaWNoIHRoZSBnaXZlbiBmdW5jdGlvbiByZXR1cm5zIGEKICAgICAqIHRydXRoeSB2YWx1ZSwgc3RvcHBpbmcgb24gdGhlIGZpcnN0IGZhbHN5IHJldHVybiB2YWx1ZSBvciBpZiB0aGUgZW5kIG9mIHRoZQogICAgICogaW5wdXQgaXMgcmVhY2hlZC4KICAgICAqLwogICAgdihmbikgewogICAgICBsZXQgY2hhcjsKICAgICAgbGV0IG1hdGNoID0gZW1wdHlTdHJpbmc7CiAgICAgIHdoaWxlICgoY2hhciA9IHRoaXMuaCgpKSAmJiBmbihjaGFyKSkgewogICAgICAgIG1hdGNoICs9IGNoYXI7CiAgICAgICAgdGhpcy5nKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyB0aGUgZ2l2ZW4gc3RyaW5nIGlmIGl0IGV4aXN0cyBhdCB0aGUgY3VycmVudCBjaGFyYWN0ZXIgaW5kZXgsIGFuZAogICAgICogYWR2YW5jZXMgdGhlIHNjYW5uZXIuCiAgICAgKgogICAgICogSWYgdGhlIGdpdmVuIHN0cmluZyBkb2Vzbid0IGV4aXN0IGF0IHRoZSBjdXJyZW50IGNoYXJhY3RlciBpbmRleCwgYW4gZW1wdHkKICAgICAqIHN0cmluZyB3aWxsIGJlIHJldHVybmVkIGFuZCB0aGUgc2Nhbm5lciB3aWxsIG5vdCBiZSBhZHZhbmNlZC4KICAgICAqLwogICAgUShzdHJpbmdUb0NvbnN1bWUpIHsKICAgICAgaWYgKHRoaXMuYihzdHJpbmdUb0NvbnN1bWUpKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZ1RvQ29uc3VtZTsKICAgICAgfQogICAgICBpZiAodGhpcy5uKSB7CiAgICAgICAgbGV0IHsgbGVuZ3RoIH0gPSBzdHJpbmdUb0NvbnN1bWU7CiAgICAgICAgbGV0IGNoYXJMZW5ndGhUb01hdGNoID0gdGhpcy5xKHN0cmluZ1RvQ29uc3VtZSk7CiAgICAgICAgaWYgKGNoYXJMZW5ndGhUb01hdGNoICE9PSBsZW5ndGggJiYgc3RyaW5nVG9Db25zdW1lID09PSB0aGlzLmgoY2hhckxlbmd0aFRvTWF0Y2gpKSB7CiAgICAgICAgICB0aGlzLmcoY2hhckxlbmd0aFRvTWF0Y2gpOwogICAgICAgICAgcmV0dXJuIHN0cmluZ1RvQ29uc3VtZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGVtcHR5U3RyaW5nOwogICAgfQogICAgLyoqCiAgICAgKiBEb2VzIHRoZSBzYW1lIHRoaW5nIGFzIGBjb25zdW1lU3RyaW5nKClgLCBidXQgZG9lc24ndCBzdXBwb3J0IGNvbnN1bWluZwogICAgICogbXVsdGlieXRlIGNoYXJhY3RlcnMuIFRoaXMgY2FuIGJlIGZhc3RlciBpZiB5b3Ugb25seSBuZWVkIHRvIG1hdGNoIHNpbmdsZQogICAgICogYnl0ZSBjaGFyYWN0ZXJzLgogICAgICovCiAgICBiKHN0cmluZ1RvQ29uc3VtZSkgewogICAgICBsZXQgeyBsZW5ndGggfSA9IHN0cmluZ1RvQ29uc3VtZTsKICAgICAgaWYgKHRoaXMuaChsZW5ndGgpID09PSBzdHJpbmdUb0NvbnN1bWUpIHsKICAgICAgICB0aGlzLmcobGVuZ3RoKTsKICAgICAgICByZXR1cm4gc3RyaW5nVG9Db25zdW1lOwogICAgICB9CiAgICAgIHJldHVybiBlbXB0eVN0cmluZzsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgY2hhcmFjdGVycyB1bnRpbCB0aGUgZ2l2ZW4gZ2xvYmFsIHJlZ2V4IGlzIG1hdGNoZWQsIGFkdmFuY2luZyB0aGUKICAgICAqIHNjYW5uZXIgdXAgdG8gKGJ1dCBub3QgYmV5b25kKSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBtYXRjaC4gSWYgdGhlIHJlZ2V4CiAgICAgKiBkb2Vzbid0IG1hdGNoLCBub3RoaW5nIHdpbGwgYmUgY29uc3VtZWQuCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgY29uc3VtZWQgc3RyaW5nLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgY29uc3VtZWQuCiAgICAgKi8KICAgIEEocmVnZXgpIHsKICAgICAgbGV0IHJlc3RPZlN0cmluZyA9IHRoaXMubS5zbGljZSh0aGlzLmkoKSk7CiAgICAgIGxldCBtYXRjaEJ5dGVJbmRleCA9IHJlc3RPZlN0cmluZy5zZWFyY2gocmVnZXgpOwogICAgICBpZiAobWF0Y2hCeXRlSW5kZXggPD0gMCkgewogICAgICAgIHJldHVybiBlbXB0eVN0cmluZzsKICAgICAgfQogICAgICBsZXQgcmVzdWx0ID0gcmVzdE9mU3RyaW5nLnNsaWNlKDAsIG1hdGNoQnl0ZUluZGV4KTsKICAgICAgdGhpcy5nKHRoaXMucShyZXN1bHQpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgY2hhcmFjdGVycyB1bnRpbCB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGZvdW5kLCBhZHZhbmNpbmcgdGhlIHNjYW5uZXIKICAgICAqIHVwIHRvIChidXQgbm90IGJleW9uZCkgdGhhdCBwb2ludC4gSWYgdGhlIHN0cmluZyBpcyBuZXZlciBmb3VuZCwgbm90aGluZwogICAgICogd2lsbCBiZSBjb25zdW1lZC4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjb25zdW1lZCBzdHJpbmcsIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBjb25zdW1lZC4KICAgICAqLwogICAgdChzZWFyY2hTdHJpbmcpIHsKICAgICAgbGV0IHsgbTogc3RyaW5nIH0gPSB0aGlzOwogICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5pKCk7CiAgICAgIGxldCBtYXRjaEJ5dGVJbmRleCA9IHN0cmluZy5pbmRleE9mKHNlYXJjaFN0cmluZywgYnl0ZUluZGV4KTsKICAgICAgaWYgKG1hdGNoQnl0ZUluZGV4IDw9IDApIHsKICAgICAgICByZXR1cm4gZW1wdHlTdHJpbmc7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHN0cmluZy5zbGljZShieXRlSW5kZXgsIG1hdGNoQnl0ZUluZGV4KTsKICAgICAgdGhpcy5nKHRoaXMucShyZXN1bHQpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgZ2l2ZW4gbnVtYmVyIG9mIGNoYXJhY3RlcnMgc3RhcnRpbmcgYXQgdGhlIGN1cnJlbnQgY2hhcmFjdGVyCiAgICAgKiBpbmRleCwgd2l0aG91dCBhZHZhbmNpbmcgdGhlIHNjYW5uZXIgYW5kIHdpdGhvdXQgZXhjZWVkaW5nIHRoZSBlbmQgb2YgdGhlCiAgICAgKiBpbnB1dCBzdHJpbmcuCiAgICAgKi8KICAgIGgoY291bnQgPSAxKSB7CiAgICAgIGxldCB7IGQ6IGNoYXJJbmRleCwgbjogbXVsdGlCeXRlTW9kZSwgbTogc3RyaW5nIH0gPSB0aGlzOwogICAgICBpZiAobXVsdGlCeXRlTW9kZSkgewogICAgICAgIGlmIChjaGFySW5kZXggPj0gdGhpcy5rKSB7CiAgICAgICAgICByZXR1cm4gZW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHJpbmcuc2xpY2UoCiAgICAgICAgICB0aGlzLmkoY2hhckluZGV4KSwKICAgICAgICAgIHRoaXMuaShjaGFySW5kZXggKyBjb3VudCkKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBzdHJpbmcuc2xpY2UoY2hhckluZGV4LCBjaGFySW5kZXggKyBjb3VudCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlc2V0cyB0aGUgc2Nhbm5lciBwb3NpdGlvbiB0byB0aGUgZ2l2ZW4gY2hhcmFjdGVyIF9pbmRleF8sIG9yIHRvIHRoZSBzdGFydAogICAgICogb2YgdGhlIGlucHV0IHN0cmluZyBpZiBubyBpbmRleCBpcyBnaXZlbi4KICAgICAqCiAgICAgKiBJZiBfaW5kZXhfIGlzIG5lZ2F0aXZlLCB0aGUgc2Nhbm5lciBwb3NpdGlvbiB3aWxsIGJlIG1vdmVkIGJhY2t3YXJkIGJ5IHRoYXQKICAgICAqIG1hbnkgY2hhcmFjdGVycywgc3RvcHBpbmcgaWYgdGhlIGJlZ2lubmluZyBvZiB0aGUgc3RyaW5nIGlzIHJlYWNoZWQuCiAgICAgKi8KICAgIG8oaW5kZXggPSAwKSB7CiAgICAgIHRoaXMuZCA9IGluZGV4ID49IDAgPyBNYXRoLm1pbih0aGlzLmssIGluZGV4KSA6IE1hdGgubWF4KDAsIHRoaXMuZCArIGluZGV4KTsKICAgIH0KICB9OwogIHZhciBhdHRWYWx1ZUNoYXJEb3VibGVRdW90ZSA9IC9bXiImPF0rL3k7CiAgdmFyIGF0dFZhbHVlQ2hhclNpbmdsZVF1b3RlID0gL1teJyY8XSsveTsKICB2YXIgYXR0VmFsdWVOb3JtYWxpemVkV2hpdGVzcGFjZSA9IC9cclxufFtcblxyXHRdL2c7CiAgdmFyIGVuZENoYXJEYXRhID0gLzx8JnxdXT4vOwogIHZhciBwcmVkZWZpbmVkRW50aXRpZXMgPSBPYmplY3QuZnJlZXplKE9iamVjdC5hc3NpZ24oLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksIHsKICAgIGFtcDogIiYiLAogICAgYXBvczogIiciLAogICAgZ3Q6ICI+IiwKICAgIGx0OiAiPCIsCiAgICBxdW90OiAnIicKICB9KSk7CiAgZnVuY3Rpb24gaXNOYW1lQ2hhcihjaGFyKSB7CiAgICBsZXQgY3AgPSBnZXRDb2RlUG9pbnQoY2hhcik7CiAgICByZXR1cm4gY3AgPj0gOTcgJiYgY3AgPD0gMTIyIHx8IGNwID49IDY1ICYmIGNwIDw9IDkwIHx8IGNwID49IDQ4ICYmIGNwIDw9IDU3IHx8IGNwID09PSA0NSB8fCBjcCA9PT0gNDYgfHwgY3AgPT09IDE4MyB8fCBjcCA+PSA3NjggJiYgY3AgPD0gODc5IHx8IGNwID49IDgyNTUgJiYgY3AgPD0gODI1NiB8fCBpc05hbWVTdGFydENoYXIoY2hhciwgY3ApOwogIH0KICBmdW5jdGlvbiBpc05hbWVTdGFydENoYXIoY2hhciwgY3AgPSBnZXRDb2RlUG9pbnQoY2hhcikpIHsKICAgIHJldHVybiBjcCA+PSA5NyAmJiBjcCA8PSAxMjIgfHwgY3AgPj0gNjUgJiYgY3AgPD0gOTAgfHwgY3AgPT09IDU4IHx8IGNwID09PSA5NSB8fCBjcCA+PSAxOTIgJiYgY3AgPD0gMjE0IHx8IGNwID49IDIxNiAmJiBjcCA8PSAyNDYgfHwgY3AgPj0gMjQ4ICYmIGNwIDw9IDc2NyB8fCBjcCA+PSA4ODAgJiYgY3AgPD0gODkzIHx8IGNwID49IDg5NSAmJiBjcCA8PSA4MTkxIHx8IGNwID49IDgyMDQgJiYgY3AgPD0gODIwNSB8fCBjcCA+PSA4MzA0ICYmIGNwIDw9IDg1OTEgfHwgY3AgPj0gMTEyNjQgJiYgY3AgPD0gMTIyNzEgfHwgY3AgPj0gMTIyODkgJiYgY3AgPD0gNTUyOTUgfHwgY3AgPj0gNjM3NDQgJiYgY3AgPD0gNjQ5NzUgfHwgY3AgPj0gNjUwMDggJiYgY3AgPD0gNjU1MzMgfHwgY3AgPj0gNjU1MzYgJiYgY3AgPD0gOTgzMDM5OwogIH0KICBmdW5jdGlvbiBpc1JlZmVyZW5jZUNoYXIoY2hhcikgewogICAgcmV0dXJuIGNoYXIgPT09ICIjIiB8fCBpc05hbWVDaGFyKGNoYXIpOwogIH0KICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2hhcikgewogICAgbGV0IGNwID0gZ2V0Q29kZVBvaW50KGNoYXIpOwogICAgcmV0dXJuIGNwID09PSAzMiB8fCBjcCA9PT0gOSB8fCBjcCA9PT0gMTAgfHwgY3AgPT09IDEzOwogIH0KICBmdW5jdGlvbiBpc1htbENvZGVQb2ludChjcCkgewogICAgcmV0dXJuIGNwID09PSA5IHx8IGNwID09PSAxMCB8fCBjcCA9PT0gMTMgfHwgY3AgPj0gMzIgJiYgY3AgPD0gNTUyOTUgfHwgY3AgPj0gNTczNDQgJiYgY3AgPD0gNjU1MzMgfHwgY3AgPj0gNjU1MzYgJiYgY3AgPD0gMTExNDExMTsKICB9CiAgZnVuY3Rpb24gZ2V0Q29kZVBvaW50KGNoYXIpIHsKICAgIHJldHVybiBjaGFyLmNvZGVQb2ludEF0KDApIHx8IC0xOwogIH0KICB2YXIgX1htbE5vZGUgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5wYXJlbnQgPSBudWxsOwogICAgICB0aGlzLnN0YXJ0ID0gLTE7CiAgICAgIHRoaXMuZW5kID0gLTE7CiAgICB9CiAgICAvKioKICAgICAqIERvY3VtZW50IHRoYXQgY29udGFpbnMgdGhpcyBub2RlLCBvciBgbnVsbGAgaWYgdGhpcyBub2RlIGlzIG5vdCBhc3NvY2lhdGVkCiAgICAgKiB3aXRoIGEgZG9jdW1lbnQuCiAgICAgKi8KICAgIGdldCBkb2N1bWVudCgpIHsKICAgICAgdmFyIF9hLCBfYjsKICAgICAgcmV0dXJuIChfYiA9IChfYSA9IHRoaXMucGFyZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2EuZG9jdW1lbnQpICE9IG51bGwgPyBfYiA6IG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIFdoZXRoZXIgdGhpcyBub2RlIGlzIHRoZSByb290IG5vZGUgb2YgdGhlIGRvY3VtZW50IChhbHNvIGtub3duIGFzIHRoZQogICAgICogZG9jdW1lbnQgZWxlbWVudCkuCiAgICAgKi8KICAgIGdldCBpc1Jvb3ROb2RlKCkgewogICAgICByZXR1cm4gdGhpcy5wYXJlbnQgIT09IG51bGwgJiYgdGhpcy5wYXJlbnQgPT09IHRoaXMuZG9jdW1lbnQgJiYgdGhpcy50eXBlID09PSBfWG1sTm9kZS5UWVBFX0VMRU1FTlQ7CiAgICB9CiAgICAvKioKICAgICAqIFdoZXRoZXIgd2hpdGVzcGFjZSBzaG91bGQgYmUgcHJlc2VydmVkIGluIHRoZSBjb250ZW50IG9mIHRoaXMgZWxlbWVudCBhbmQKICAgICAqIGl0cyBjaGlsZHJlbi4KICAgICAqCiAgICAgKiBUaGlzIGlzIGluZmx1ZW5jZWQgYnkgdGhlIHZhbHVlIG9mIHRoZSBzcGVjaWFsIGB4bWw6c3BhY2VgIGF0dHJpYnV0ZSwgYW5kCiAgICAgKiB3aWxsIGJlIGB0cnVlYCBmb3IgYW55IG5vZGUgd2hvc2UgYHhtbDpzcGFjZWAgYXR0cmlidXRlIGlzIHNldCB0bwogICAgICogInByZXNlcnZlIi4gSWYgYSBub2RlIGhhcyBubyBzdWNoIGF0dHJpYnV0ZSwgaXQgd2lsbCBpbmhlcml0IHRoZSB2YWx1ZSBvZgogICAgICogdGhlIG5lYXJlc3QgYW5jZXN0b3IgdGhhdCBkb2VzIChpZiBhbnkpLgogICAgICoKICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLXdoaXRlLXNwYWNlCiAgICAgKi8KICAgIGdldCBwcmVzZXJ2ZVdoaXRlc3BhY2UoKSB7CiAgICAgIHZhciBfYTsKICAgICAgcmV0dXJuICEhKChfYSA9IHRoaXMucGFyZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2EucHJlc2VydmVXaGl0ZXNwYWNlKTsKICAgIH0KICAgIC8qKgogICAgICogVHlwZSBvZiB0aGlzIG5vZGUuCiAgICAgKgogICAgICogVGhlIHZhbHVlIG9mIHRoaXMgcHJvcGVydHkgaXMgYSBzdHJpbmcgdGhhdCBtYXRjaGVzIG9uZSBvZiB0aGUgc3RhdGljCiAgICAgKiBgVFlQRV8qYCBwcm9wZXJ0aWVzIG9uIHRoZSBgWG1sTm9kZWAgY2xhc3MgKGUuZy4gYFRZUEVfRUxFTUVOVGAsCiAgICAgKiBgVFlQRV9URVhUYCwgZXRjLikuCiAgICAgKgogICAgICogVGhlIGBYbWxOb2RlYCBjbGFzcyBpdHNlbGYgaXMgYSBiYXNlIGNsYXNzIGFuZCBkb2Vzbid0IGhhdmUgaXRzIG93biB0eXBlCiAgICAgKiBuYW1lLgogICAgICovCiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuICIiOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgSlNPTi1zZXJpYWxpemFibGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGlzIG5vZGUsIG1pbnVzIHByb3BlcnRpZXMKICAgICAqIHRoYXQgY291bGQgcmVzdWx0IGluIGNpcmN1bGFyIHJlZmVyZW5jZXMuCiAgICAgKi8KICAgIHRvSlNPTigpIHsKICAgICAgbGV0IGpzb24gPSB7CiAgICAgICAgdHlwZTogdGhpcy50eXBlCiAgICAgIH07CiAgICAgIGlmICh0aGlzLmlzUm9vdE5vZGUpIHsKICAgICAgICBqc29uLmlzUm9vdE5vZGUgPSB0cnVlOwogICAgICB9CiAgICAgIGlmICh0aGlzLnByZXNlcnZlV2hpdGVzcGFjZSkgewogICAgICAgIGpzb24ucHJlc2VydmVXaGl0ZXNwYWNlID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy5zdGFydCAhPT0gLTEpIHsKICAgICAgICBqc29uLnN0YXJ0ID0gdGhpcy5zdGFydDsKICAgICAgICBqc29uLmVuZCA9IHRoaXMuZW5kOwogICAgICB9CiAgICAgIHJldHVybiBqc29uOwogICAgfQogIH07CiAgdmFyIFhtbE5vZGUgPSBfWG1sTm9kZTsKICBYbWxOb2RlLlRZUEVfQ0RBVEEgPSAiY2RhdGEiOwogIFhtbE5vZGUuVFlQRV9DT01NRU5UID0gImNvbW1lbnQiOwogIFhtbE5vZGUuVFlQRV9ET0NVTUVOVCA9ICJkb2N1bWVudCI7CiAgWG1sTm9kZS5UWVBFX0RPQ1VNRU5UX1RZUEUgPSAiZG9jdHlwZSI7CiAgWG1sTm9kZS5UWVBFX0VMRU1FTlQgPSAiZWxlbWVudCI7CiAgWG1sTm9kZS5UWVBFX1BST0NFU1NJTkdfSU5TVFJVQ1RJT04gPSAicGkiOwogIFhtbE5vZGUuVFlQRV9URVhUID0gInRleHQiOwogIFhtbE5vZGUuVFlQRV9YTUxfREVDTEFSQVRJT04gPSAieG1sZGVjbCI7CiAgdmFyIFhtbFRleHQgPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IodGV4dCA9ICIiKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB9CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9URVhUOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIHRleHQ6IHRoaXMudGV4dAogICAgICB9KTsKICAgIH0KICB9OwogIHZhciBYbWxDZGF0YSA9IGNsYXNzIGV4dGVuZHMgWG1sVGV4dCB7CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9DREFUQTsKICAgIH0KICB9OwogIHZhciBYbWxDb21tZW50ID0gY2xhc3MgZXh0ZW5kcyBYbWxOb2RlIHsKICAgIGNvbnN0cnVjdG9yKGNvbnRlbnQgPSAiIikgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLmNvbnRlbnQgPSBjb250ZW50OwogICAgfQogICAgZ2V0IHR5cGUoKSB7CiAgICAgIHJldHVybiBYbWxOb2RlLlRZUEVfQ09NTUVOVDsKICAgIH0KICAgIHRvSlNPTigpIHsKICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oWG1sTm9kZS5wcm90b3R5cGUudG9KU09OLmNhbGwodGhpcyksIHsKICAgICAgICBjb250ZW50OiB0aGlzLmNvbnRlbnQKICAgICAgfSk7CiAgICB9CiAgfTsKICB2YXIgWG1sRGVjbGFyYXRpb24gPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IodmVyc2lvbiwgZW5jb2RpbmcsIHN0YW5kYWxvbmUpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjsKICAgICAgdGhpcy5lbmNvZGluZyA9IGVuY29kaW5nICE9IG51bGwgPyBlbmNvZGluZyA6IG51bGw7CiAgICAgIHRoaXMuc3RhbmRhbG9uZSA9IHN0YW5kYWxvbmUgIT0gbnVsbCA/IHN0YW5kYWxvbmUgOiBudWxsOwogICAgfQogICAgZ2V0IHR5cGUoKSB7CiAgICAgIHJldHVybiBYbWxOb2RlLlRZUEVfWE1MX0RFQ0xBUkFUSU9OOwogICAgfQogICAgdG9KU09OKCkgewogICAgICBsZXQganNvbiA9IFhtbE5vZGUucHJvdG90eXBlLnRvSlNPTi5jYWxsKHRoaXMpOwogICAgICBqc29uLnZlcnNpb24gPSB0aGlzLnZlcnNpb247CiAgICAgIGZvciAobGV0IGtleSBvZiBbImVuY29kaW5nIiwgInN0YW5kYWxvbmUiXSkgewogICAgICAgIGlmICh0aGlzW2tleV0gIT09IG51bGwpIHsKICAgICAgICAgIGpzb25ba2V5XSA9IHRoaXNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpzb247CiAgICB9CiAgfTsKICB2YXIgWG1sRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgWG1sTm9kZSB7CiAgICBjb25zdHJ1Y3RvcihuYW1lLCBhdHRyaWJ1dGVzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksIGNoaWxkcmVuID0gW10pIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgfQogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoaXMgZWxlbWVudCBpcyBlbXB0eSAobWVhbmluZyBpdCBoYXMgbm8gY2hpbGRyZW4pLgogICAgICovCiAgICBnZXQgaXNFbXB0eSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4ubGVuZ3RoID09PSAwOwogICAgfQogICAgZ2V0IHByZXNlcnZlV2hpdGVzcGFjZSgpIHsKICAgICAgbGV0IG5vZGUgPSB0aGlzOwogICAgICB3aGlsZSAobm9kZSBpbnN0YW5jZW9mIFhtbEVsZW1lbnQpIHsKICAgICAgICBpZiAoInhtbDpzcGFjZSIgaW4gbm9kZS5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5hdHRyaWJ1dGVzWyJ4bWw6c3BhY2UiXSA9PT0gInByZXNlcnZlIjsKICAgICAgICB9CiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50OwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogVGV4dCBjb250ZW50IG9mIHRoaXMgZWxlbWVudCBhbmQgYWxsIGl0cyBkZXNjZW5kYW50cy4KICAgICAqLwogICAgZ2V0IHRleHQoKSB7CiAgICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLm1hcCgoY2hpbGQpID0+ICJ0ZXh0IiBpbiBjaGlsZCA/IGNoaWxkLnRleHQgOiAiIikuam9pbigiIik7CiAgICB9CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9FTEVNRU5UOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICBhdHRyaWJ1dGVzOiB0aGlzLmF0dHJpYnV0ZXMsCiAgICAgICAgY2hpbGRyZW46IHRoaXMuY2hpbGRyZW4ubWFwKChjaGlsZCkgPT4gY2hpbGQudG9KU09OKCkpCiAgICAgIH0pOwogICAgfQogIH07CiAgdmFyIFhtbERvY3VtZW50ID0gY2xhc3MgZXh0ZW5kcyBYbWxOb2RlIHsKICAgIGNvbnN0cnVjdG9yKGNoaWxkcmVuID0gW10pIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgfQogICAgZ2V0IGRvY3VtZW50KCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogUm9vdCBlbGVtZW50IG9mIHRoaXMgZG9jdW1lbnQsIG9yIGBudWxsYCBpZiB0aGlzIGRvY3VtZW50IGlzIGVtcHR5LgogICAgICovCiAgICBnZXQgcm9vdCgpIHsKICAgICAgZm9yIChsZXQgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIFhtbEVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIFRleHQgY29udGVudCBvZiB0aGlzIGRvY3VtZW50IGFuZCBhbGwgaXRzIGRlc2NlbmRhbnRzLgogICAgICovCiAgICBnZXQgdGV4dCgpIHsKICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4ubWFwKChjaGlsZCkgPT4gInRleHQiIGluIGNoaWxkID8gY2hpbGQudGV4dCA6ICIiKS5qb2luKCIiKTsKICAgIH0KICAgIGdldCB0eXBlKCkgewogICAgICByZXR1cm4gWG1sTm9kZS5UWVBFX0RPQ1VNRU5UOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIGNoaWxkcmVuOiB0aGlzLmNoaWxkcmVuLm1hcCgoY2hpbGQpID0+IGNoaWxkLnRvSlNPTigpKQogICAgICB9KTsKICAgIH0KICB9OwogIHZhciBYbWxEb2N1bWVudFR5cGUgPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IobmFtZSwgcHVibGljSWQsIHN5c3RlbUlkLCBpbnRlcm5hbFN1YnNldCkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnB1YmxpY0lkID0gcHVibGljSWQgIT0gbnVsbCA/IHB1YmxpY0lkIDogbnVsbDsKICAgICAgdGhpcy5zeXN0ZW1JZCA9IHN5c3RlbUlkICE9IG51bGwgPyBzeXN0ZW1JZCA6IG51bGw7CiAgICAgIHRoaXMuaW50ZXJuYWxTdWJzZXQgPSBpbnRlcm5hbFN1YnNldCAhPSBudWxsID8gaW50ZXJuYWxTdWJzZXQgOiBudWxsOwogICAgfQogICAgZ2V0IHR5cGUoKSB7CiAgICAgIHJldHVybiBYbWxOb2RlLlRZUEVfRE9DVU1FTlRfVFlQRTsKICAgIH0KICAgIHRvSlNPTigpIHsKICAgICAgbGV0IGpzb24gPSBYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKTsKICAgICAganNvbi5uYW1lID0gdGhpcy5uYW1lOwogICAgICBmb3IgKGxldCBrZXkgb2YgWyJwdWJsaWNJZCIsICJzeXN0ZW1JZCIsICJpbnRlcm5hbFN1YnNldCJdKSB7CiAgICAgICAgaWYgKHRoaXNba2V5XSAhPT0gbnVsbCkgewogICAgICAgICAganNvbltrZXldID0gdGhpc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4ganNvbjsKICAgIH0KICB9OwogIHZhciBYbWxFcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3IgewogICAgY29uc3RydWN0b3IobWVzc2FnZSwgY2hhckluZGV4LCB4bWwpIHsKICAgICAgbGV0IGNvbHVtbiA9IDE7CiAgICAgIGxldCBleGNlcnB0ID0gIiI7CiAgICAgIGxldCBsaW5lID0gMTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFySW5kZXg7ICsraSkgewogICAgICAgIGxldCBjaGFyID0geG1sW2ldOwogICAgICAgIGlmIChjaGFyID09PSAiXG4iKSB7CiAgICAgICAgICBjb2x1bW4gPSAxOwogICAgICAgICAgZXhjZXJwdCA9ICIiOwogICAgICAgICAgbGluZSArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb2x1bW4gKz0gMTsKICAgICAgICAgIGV4Y2VycHQgKz0gY2hhcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IGVvbCA9IHhtbC5pbmRleE9mKCJcbiIsIGNoYXJJbmRleCk7CiAgICAgIGV4Y2VycHQgKz0gZW9sID09PSAtMSA/IHhtbC5zbGljZShjaGFySW5kZXgpIDogeG1sLnNsaWNlKGNoYXJJbmRleCwgZW9sKTsKICAgICAgbGV0IGV4Y2VycHRTdGFydCA9IDA7CiAgICAgIGlmIChleGNlcnB0Lmxlbmd0aCA+IDUwKSB7CiAgICAgICAgaWYgKGNvbHVtbiA8IDQwKSB7CiAgICAgICAgICBleGNlcnB0ID0gZXhjZXJwdC5zbGljZSgwLCA1MCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4Y2VycHRTdGFydCA9IGNvbHVtbiAtIDIwOwogICAgICAgICAgZXhjZXJwdCA9IGV4Y2VycHQuc2xpY2UoZXhjZXJwdFN0YXJ0LCBjb2x1bW4gKyAzMCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1cGVyKAogICAgICAgIGAke21lc3NhZ2V9IChsaW5lICR7bGluZX0sIGNvbHVtbiAke2NvbHVtbn0pCiAgJHtleGNlcnB0fQpgICsgIiAiLnJlcGVhdChjb2x1bW4gLSBleGNlcnB0U3RhcnQgKyAxKSArICJeXG4iCiAgICAgICk7CiAgICAgIHRoaXMuY29sdW1uID0gY29sdW1uOwogICAgICB0aGlzLmV4Y2VycHQgPSBleGNlcnB0OwogICAgICB0aGlzLmxpbmUgPSBsaW5lOwogICAgICB0aGlzLm5hbWUgPSAiWG1sRXJyb3IiOwogICAgICB0aGlzLnBvcyA9IGNoYXJJbmRleDsKICAgIH0KICB9OwogIHZhciBYbWxQcm9jZXNzaW5nSW5zdHJ1Y3Rpb24gPSBjbGFzcyBleHRlbmRzIFhtbE5vZGUgewogICAgY29uc3RydWN0b3IobmFtZSwgY29udGVudCA9ICIiKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuY29udGVudCA9IGNvbnRlbnQ7CiAgICB9CiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIFhtbE5vZGUuVFlQRV9QUk9DRVNTSU5HX0lOU1RSVUNUSU9OOwogICAgfQogICAgdG9KU09OKCkgewogICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihYbWxOb2RlLnByb3RvdHlwZS50b0pTT04uY2FsbCh0aGlzKSwgewogICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICBjb250ZW50OiB0aGlzLmNvbnRlbnQKICAgICAgfSk7CiAgICB9CiAgfTsKICB2YXIgZW1wdHlTdHJpbmcyID0gIiI7CiAgdmFyIFBhcnNlciA9IGNsYXNzIHsKICAgIC8qKgogICAgICogQHBhcmFtIHhtbCBYTUwgc3RyaW5nIHRvIHBhcnNlLgogICAgICogQHBhcmFtIG9wdGlvbnMgUGFyc2VyIG9wdGlvbnMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHhtbCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGxldCBkb2MgPSB0aGlzLmRvY3VtZW50ID0gbmV3IFhtbERvY3VtZW50KCk7CiAgICAgIGxldCBzY2FubmVyID0gdGhpcy5jID0gbmV3IFN0cmluZ1NjYW5uZXIoeG1sKTsKICAgICAgdGhpcy5sID0gZG9jOwogICAgICB0aGlzLmYgPSBvcHRpb25zOwogICAgICBpZiAodGhpcy5mLmluY2x1ZGVPZmZzZXRzKSB7CiAgICAgICAgZG9jLnN0YXJ0ID0gMDsKICAgICAgICBkb2MuZW5kID0geG1sLmxlbmd0aDsKICAgICAgfQogICAgICBzY2FubmVyLmIoIlx1RkVGRiIpOwogICAgICB0aGlzLkgoKTsKICAgICAgaWYgKCF0aGlzLkIoKSkgewogICAgICAgIHRocm93IHRoaXMuYSgiUm9vdCBlbGVtZW50IGlzIG1pc3Npbmcgb3IgaW52YWxpZCIpOwogICAgICB9CiAgICAgIHdoaWxlICh0aGlzLncoKSkgewogICAgICB9CiAgICAgIGlmICghc2Nhbm5lci56KSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJFeHRyYSBjb250ZW50IGF0IHRoZSBlbmQgb2YgdGhlIGRvY3VtZW50Iik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQWRkcyB0aGUgZ2l2ZW4gYFhtbE5vZGVgIGFzIGEgY2hpbGQgb2YgYHRoaXMuY3VycmVudE5vZGVgLgogICAgICovCiAgICBqKG5vZGUsIGNoYXJJbmRleCkgewogICAgICBub2RlLnBhcmVudCA9IHRoaXMubDsKICAgICAgaWYgKHRoaXMuZi5pbmNsdWRlT2Zmc2V0cykgewogICAgICAgIG5vZGUuc3RhcnQgPSB0aGlzLmMuaShjaGFySW5kZXgpOwogICAgICAgIG5vZGUuZW5kID0gdGhpcy5jLmkoKTsKICAgICAgfQogICAgICB0aGlzLmwuY2hpbGRyZW4ucHVzaChub2RlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgdGhlIGdpdmVuIF90ZXh0XyB0byB0aGUgZG9jdW1lbnQsIGVpdGhlciBieSBhcHBlbmRpbmcgaXQgdG8gYQogICAgICogcHJlY2VkaW5nIGBYbWxUZXh0YCBub2RlIChpZiBwb3NzaWJsZSkgb3IgYnkgY3JlYXRpbmcgYSBuZXcgYFhtbFRleHRgIG5vZGUuCiAgICAgKi8KICAgIHgodGV4dCwgY2hhckluZGV4KSB7CiAgICAgIGxldCB7IGNoaWxkcmVuIH0gPSB0aGlzLmw7CiAgICAgIGxldCB7IGxlbmd0aCB9ID0gY2hpbGRyZW47CiAgICAgIHRleHQgPSBub3JtYWxpemVMaW5lQnJlYWtzKHRleHQpOwogICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgIGxldCBwcmV2Tm9kZSA9IGNoaWxkcmVuW2xlbmd0aCAtIDFdOwogICAgICAgIGlmICgocHJldk5vZGUgPT0gbnVsbCA/IHZvaWQgMCA6IHByZXZOb2RlLnR5cGUpID09PSBYbWxOb2RlLlRZUEVfVEVYVCkgewogICAgICAgICAgbGV0IHRleHROb2RlID0gcHJldk5vZGU7CiAgICAgICAgICB0ZXh0Tm9kZS50ZXh0ICs9IHRleHQ7CiAgICAgICAgICBpZiAodGhpcy5mLmluY2x1ZGVPZmZzZXRzKSB7CiAgICAgICAgICAgIHRleHROb2RlLmVuZCA9IHRoaXMuYy5pKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaihuZXcgWG1sVGV4dCh0ZXh0KSwgY2hhckluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgZWxlbWVudCBhdHRyaWJ1dGVzLgogICAgICoKICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLXN0YXJ0dGFncwogICAgICovCiAgICBJKCkgewogICAgICBsZXQgYXR0cmlidXRlcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB3aGlsZSAodGhpcy5lKCkpIHsKICAgICAgICBsZXQgYXR0ck5hbWUgPSB0aGlzLnIoKTsKICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgbGV0IGF0dHJWYWx1ZSA9IHRoaXMudSgpICYmIHRoaXMuSigpOwogICAgICAgIGlmIChhdHRyVmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIkF0dHJpYnV0ZSB2YWx1ZSBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoYXR0ck5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgdGhyb3cgdGhpcy5hKGBEdXBsaWNhdGUgYXR0cmlidXRlOiAke2F0dHJOYW1lfWApOwogICAgICAgIH0KICAgICAgICBpZiAoYXR0ck5hbWUgPT09ICJ4bWw6c3BhY2UiICYmIGF0dHJWYWx1ZSAhPT0gImRlZmF1bHQiICYmIGF0dHJWYWx1ZSAhPT0gInByZXNlcnZlIikgewogICAgICAgICAgdGhyb3cgdGhpcy5hKCdWYWx1ZSBvZiB0aGUgYHhtbDpzcGFjZWAgYXR0cmlidXRlIG11c3QgYmUgImRlZmF1bHQiIG9yICJwcmVzZXJ2ZSInKTsKICAgICAgICB9CiAgICAgICAgYXR0cmlidXRlc1thdHRyTmFtZV0gPSBhdHRyVmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZi5zb3J0QXR0cmlidXRlcykgewogICAgICAgIGxldCBhdHRyTmFtZXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKS5zb3J0KCk7CiAgICAgICAgbGV0IHNvcnRlZEF0dHJpYnV0ZXMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dHJOYW1lcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgbGV0IGF0dHJOYW1lID0gYXR0ck5hbWVzW2ldOwogICAgICAgICAgc29ydGVkQXR0cmlidXRlc1thdHRyTmFtZV0gPSBhdHRyaWJ1dGVzW2F0dHJOYW1lXTsKICAgICAgICB9CiAgICAgICAgYXR0cmlidXRlcyA9IHNvcnRlZEF0dHJpYnV0ZXM7CiAgICAgIH0KICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGFuIGBBdHRWYWx1ZWAgKGF0dHJpYnV0ZSB2YWx1ZSkgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMKICAgICAqICAgQ29udGVudHMgb2YgdGhlIGBBdHRWYWx1ZWAgbWludXMgcXVvdGVzLCBvciBgZmFsc2VgIGlmIG5vdGhpbmcgd2FzCiAgICAgKiAgIGNvbnN1bWVkLiBBbiBlbXB0eSBzdHJpbmcgaW5kaWNhdGVzIHRoYXQgYW4gYEF0dFZhbHVlYCB3YXMgY29uc3VtZWQgYnV0CiAgICAgKiAgIHdhcyBlbXB0eS4KICAgICAqCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULUF0dFZhbHVlCiAgICAgKi8KICAgIEooKSB7CiAgICAgIGxldCB7IGM6IHNjYW5uZXIgfSA9IHRoaXM7CiAgICAgIGxldCBxdW90ZSA9IHNjYW5uZXIuaCgpOwogICAgICBpZiAocXVvdGUgIT09ICciJyAmJiBxdW90ZSAhPT0gIiciKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHNjYW5uZXIuZygpOwogICAgICBsZXQgY2hhcnM7CiAgICAgIGxldCBpc0Nsb3NlZCA9IGZhbHNlOwogICAgICBsZXQgdmFsdWUgPSBlbXB0eVN0cmluZzI7CiAgICAgIGxldCByZWdleCA9IHF1b3RlID09PSAnIicgPyBhdHRWYWx1ZUNoYXJEb3VibGVRdW90ZSA6IGF0dFZhbHVlQ2hhclNpbmdsZVF1b3RlOwogICAgICBtYXRjaExvb3A6CiAgICAgICAgd2hpbGUgKCFzY2FubmVyLnopIHsKICAgICAgICAgIGNoYXJzID0gc2Nhbm5lci5HKHJlZ2V4KTsKICAgICAgICAgIGlmIChjaGFycykgewogICAgICAgICAgICB0aGlzLnAoY2hhcnMpOwogICAgICAgICAgICB2YWx1ZSArPSBjaGFycy5yZXBsYWNlKGF0dFZhbHVlTm9ybWFsaXplZFdoaXRlc3BhY2UsICIgIik7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHNjYW5uZXIuaCgpKSB7CiAgICAgICAgICAgIGNhc2UgcXVvdGU6CiAgICAgICAgICAgICAgaXNDbG9zZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrIG1hdGNoTG9vcDsKICAgICAgICAgICAgY2FzZSAiJiI6CiAgICAgICAgICAgICAgdmFsdWUgKz0gdGhpcy5DKCk7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGNhc2UgIjwiOgogICAgICAgICAgICAgIHRocm93IHRoaXMuYSgiVW5lc2NhcGVkIGA8YCBpcyBub3QgYWxsb3dlZCBpbiBhbiBhdHRyaWJ1dGUgdmFsdWUiKTsKICAgICAgICAgICAgY2FzZSBlbXB0eVN0cmluZzI6CiAgICAgICAgICAgICAgYnJlYWsgbWF0Y2hMb29wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgaWYgKCFpc0Nsb3NlZCkgewogICAgICAgIHRocm93IHRoaXMuYSgiVW5jbG9zZWQgYXR0cmlidXRlIik7CiAgICAgIH0KICAgICAgc2Nhbm5lci5nKCk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBDREFUQSBzZWN0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYSBDREFUQSBzZWN0aW9uIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLWNkYXRhLXNlY3QKICAgICAqLwogICAgSygpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8IVtDREFUQVsiKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgdGV4dCA9IHNjYW5uZXIudCgiXV0+Iik7CiAgICAgIHRoaXMucCh0ZXh0KTsKICAgICAgaWYgKCFzY2FubmVyLmIoIl1dPiIpKSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJVbmNsb3NlZCBDREFUQSBzZWN0aW9uIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZi5wcmVzZXJ2ZUNkYXRhID8gdGhpcy5qKG5ldyBYbWxDZGF0YShub3JtYWxpemVMaW5lQnJlYWtzKHRleHQpKSwgc3RhcnRJbmRleCkgOiB0aGlzLngodGV4dCwgc3RhcnRJbmRleCk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGNoYXJhY3RlciBkYXRhIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgY2hhcmFjdGVyIGRhdGEgd2FzIGNvbnN1bWVkLgogICAgICogQHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sLTIwMDgxMTI2LyNkdC1jaGFyZGF0YQogICAgICovCiAgICBMKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBsZXQgc3RhcnRJbmRleCA9IHNjYW5uZXIuZDsKICAgICAgbGV0IGNoYXJEYXRhID0gc2Nhbm5lci5BKGVuZENoYXJEYXRhKTsKICAgICAgaWYgKCFjaGFyRGF0YSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB0aGlzLnAoY2hhckRhdGEpOwogICAgICBpZiAoc2Nhbm5lci5oKDMpID09PSAiXV0+IikgewogICAgICAgIHRocm93IHRoaXMuYSgiRWxlbWVudCBjb250ZW50IG1heSBub3QgY29udGFpbiB0aGUgQ0RBVEEgc2VjdGlvbiBjbG9zZSBkZWxpbWl0ZXIgYF1dPmAiKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy54KGNoYXJEYXRhLCBzdGFydEluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBjb21tZW50IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYSBjb21tZW50IHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtQ29tbWVudAogICAgICovCiAgICBEKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBsZXQgc3RhcnRJbmRleCA9IHNjYW5uZXIuZDsKICAgICAgaWYgKCFzY2FubmVyLmIoIjwhLS0iKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgY29udGVudCA9IHNjYW5uZXIudCgiLS0iKTsKICAgICAgdGhpcy5wKGNvbnRlbnQpOwogICAgICBpZiAoIXNjYW5uZXIuYigiLS0+IikpIHsKICAgICAgICBpZiAoc2Nhbm5lci5oKDIpID09PSAiLS0iKSB7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIlRoZSBzdHJpbmcgYC0tYCBpc24ndCBhbGxvd2VkIGluc2lkZSBhIGNvbW1lbnQiKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgdGhpcy5hKCJVbmNsb3NlZCBjb21tZW50Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZi5wcmVzZXJ2ZUNvbW1lbnRzID8gdGhpcy5qKG5ldyBYbWxDb21tZW50KG5vcm1hbGl6ZUxpbmVCcmVha3MoY29udGVudCkpLCBzdGFydEluZGV4KSA6IHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGEgcmVmZXJlbmNlIGluIGEgY29udGVudCBjb250ZXh0IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIFRoaXMgZGlmZmVycyBmcm9tIGBjb25zdW1lUmVmZXJlbmNlKClgIGluIHRoYXQgYSBjb25zdW1lZCByZWZlcmVuY2Ugd2lsbCBiZQogICAgICogYWRkZWQgdG8gdGhlIGRvY3VtZW50IGFzIGEgdGV4dCBub2RlIGluc3RlYWQgb2YgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhIHJlZmVyZW5jZSB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI2VudHByb2MKICAgICAqLwogICAgTSgpIHsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSB0aGlzLmMuZDsKICAgICAgbGV0IHJlZiA9IHRoaXMuQygpOwogICAgICByZXR1cm4gcmVmID8gdGhpcy54KHJlZiwgc3RhcnRJbmRleCkgOiBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBkb2N0eXBlIGRlY2xhcmF0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIFRoaXMgaXMgYSBsb29zZSBpbXBsZW1lbnRhdGlvbiBzaW5jZSBkb2N0eXBlIGRlY2xhcmF0aW9ucyBhcmUgY3VycmVudGx5CiAgICAgKiBkaXNjYXJkZWQgd2l0aG91dCBmdXJ0aGVyIHBhcnNpbmcuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhIGRvY3R5cGUgZGVjbGFyYXRpb24gd2FzIGNvbnN1bWVkLgogICAgICogQHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sLTIwMDgxMTI2LyNkdGQKICAgICAqLwogICAgTigpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8IURPQ1RZUEUiKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgbmFtZSA9IHRoaXMuZSgpICYmIHRoaXMucigpOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIkV4cGVjdGVkIGEgbmFtZSIpOwogICAgICB9CiAgICAgIGxldCBwdWJsaWNJZDsKICAgICAgbGV0IHN5c3RlbUlkOwogICAgICBpZiAodGhpcy5lKCkpIHsKICAgICAgICBpZiAoc2Nhbm5lci5iKCJQVUJMSUMiKSkgewogICAgICAgICAgcHVibGljSWQgPSB0aGlzLmUoKSAmJiB0aGlzLk8oKTsKICAgICAgICAgIGlmIChwdWJsaWNJZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgdGhyb3cgdGhpcy5hKCJFeHBlY3RlZCBhIHB1YmxpYyBpZGVudGlmaWVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHB1YmxpY0lkICE9PSB2b2lkIDAgfHwgc2Nhbm5lci5iKCJTWVNURU0iKSkgewogICAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgICBzeXN0ZW1JZCA9IHRoaXMucygpOwogICAgICAgICAgaWYgKHN5c3RlbUlkID09PSBmYWxzZSkgewogICAgICAgICAgICB0aHJvdyB0aGlzLmEoIkV4cGVjdGVkIGEgc3lzdGVtIGlkZW50aWZpZXIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgaW50ZXJuYWxTdWJzZXQ7CiAgICAgIGlmIChzY2FubmVyLmIoIlsiKSkgewogICAgICAgIGludGVybmFsU3Vic2V0ID0gc2Nhbm5lci5BKC9cXVtceDIwXHRcclxuXSo+Lyk7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIl0iKSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKCJVbmNsb3NlZCBpbnRlcm5hbCBzdWJzZXQiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lKCk7CiAgICAgIH0KICAgICAgaWYgKCFzY2FubmVyLmIoIj4iKSkgewogICAgICAgIHRocm93IHRoaXMuYSgiVW5jbG9zZWQgZG9jdHlwZSBkZWNsYXJhdGlvbiIpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmYucHJlc2VydmVEb2N1bWVudFR5cGUgPyB0aGlzLmoobmV3IFhtbERvY3VtZW50VHlwZShuYW1lLCBwdWJsaWNJZCwgc3lzdGVtSWQsIGludGVybmFsU3Vic2V0KSwgc3RhcnRJbmRleCkgOiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBhbiBlbGVtZW50IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYW4gZWxlbWVudCB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULWVsZW1lbnQKICAgICAqLwogICAgQigpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8IikpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGV0IG5hbWUgPSB0aGlzLnIoKTsKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgc2Nhbm5lci5vKHN0YXJ0SW5kZXgpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgYXR0cmlidXRlcyA9IHRoaXMuSSgpOwogICAgICBsZXQgaXNFbXB0eSA9ICEhc2Nhbm5lci5iKCIvPiIpOwogICAgICBsZXQgZWxlbWVudCA9IG5ldyBYbWxFbGVtZW50KG5hbWUsIGF0dHJpYnV0ZXMpOwogICAgICBlbGVtZW50LnBhcmVudCA9IHRoaXMubDsKICAgICAgaWYgKCFpc0VtcHR5KSB7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIj4iKSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKGBVbmNsb3NlZCBzdGFydCB0YWcgZm9yIGVsZW1lbnQgXGAke25hbWV9XGBgKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sID0gZWxlbWVudDsKICAgICAgICBkbyB7CiAgICAgICAgICB0aGlzLkwoKTsKICAgICAgICB9IHdoaWxlICh0aGlzLkIoKSB8fCB0aGlzLk0oKSB8fCB0aGlzLksoKSB8fCB0aGlzLkUoKSB8fCB0aGlzLkQoKSk7CiAgICAgICAgbGV0IGVuZFRhZ01hcmsgPSBzY2FubmVyLmQ7CiAgICAgICAgbGV0IGVuZFRhZ05hbWU7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIjwvIikgfHwgIShlbmRUYWdOYW1lID0gdGhpcy5yKCkpIHx8IGVuZFRhZ05hbWUgIT09IG5hbWUpIHsKICAgICAgICAgIHNjYW5uZXIubyhlbmRUYWdNYXJrKTsKICAgICAgICAgIHRocm93IHRoaXMuYShgTWlzc2luZyBlbmQgdGFnIGZvciBlbGVtZW50ICR7bmFtZX1gKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgaWYgKCFzY2FubmVyLmIoIj4iKSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKGBVbmNsb3NlZCBlbmQgdGFnIGZvciBlbGVtZW50ICR7bmFtZX1gKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sID0gZWxlbWVudC5wYXJlbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaihlbGVtZW50LCBzdGFydEluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYW4gYEVxYCBwcm9kdWN0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYW4gYEVxYCBwcm9kdWN0aW9uIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtRXEKICAgICAqLwogICAgdSgpIHsKICAgICAgdGhpcy5lKCk7CiAgICAgIGlmICh0aGlzLmMuYigiPSIpKSB7CiAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBgTWlzY2AgY29udGVudCBpZiBwb3NzaWJsZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyBXaGV0aGVyIGFueXRoaW5nIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtTWlzYwogICAgICovCiAgICB3KCkgewogICAgICByZXR1cm4gdGhpcy5EKCkgfHwgdGhpcy5FKCkgfHwgdGhpcy5lKCk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIG9uZSBvciBtb3JlIGBOYW1lYCBjaGFyYWN0ZXJzIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIGBOYW1lYCBjaGFyYWN0ZXJzLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm9uZSB3ZXJlIGNvbnN1bWVkLgogICAgICogQHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sLTIwMDgxMTI2LyNOVC1OYW1lCiAgICAgKi8KICAgIHIoKSB7CiAgICAgIHJldHVybiBpc05hbWVTdGFydENoYXIodGhpcy5jLmgoKSkgPyB0aGlzLmMudihpc05hbWVDaGFyKSA6IGVtcHR5U3RyaW5nMjsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBwcm9jZXNzaW5nIGluc3RydWN0aW9uIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEByZXR1cm5zIFdoZXRoZXIgYSBwcm9jZXNzaW5nIGluc3RydWN0aW9uIHdhcyBjb25zdW1lZC4KICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jc2VjLXBpCiAgICAgKi8KICAgIEUoKSB7CiAgICAgIGxldCB7IGM6IHNjYW5uZXIgfSA9IHRoaXM7CiAgICAgIGxldCBzdGFydEluZGV4ID0gc2Nhbm5lci5kOwogICAgICBpZiAoIXNjYW5uZXIuYigiPD8iKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgbmFtZSA9IHRoaXMucigpOwogICAgICBpZiAobmFtZSkgewogICAgICAgIGlmIChuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ4bWwiKSB7CiAgICAgICAgICBzY2FubmVyLm8oc3RhcnRJbmRleCk7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIlhNTCBkZWNsYXJhdGlvbiBpc24ndCBhbGxvd2VkIGhlcmUiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJJbnZhbGlkIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb24iKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuZSgpKSB7CiAgICAgICAgaWYgKHNjYW5uZXIuYigiPz4iKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuaihuZXcgWG1sUHJvY2Vzc2luZ0luc3RydWN0aW9uKG5hbWUpLCBzdGFydEluZGV4KTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgdGhpcy5hKCJXaGl0ZXNwYWNlIGlzIHJlcXVpcmVkIGFmdGVyIGEgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBuYW1lIik7CiAgICAgIH0KICAgICAgbGV0IGNvbnRlbnQgPSBzY2FubmVyLnQoIj8+Iik7CiAgICAgIHRoaXMucChjb250ZW50KTsKICAgICAgaWYgKCFzY2FubmVyLmIoIj8+IikpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIlVudGVybWluYXRlZCBwcm9jZXNzaW5nIGluc3RydWN0aW9uIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaihuZXcgWG1sUHJvY2Vzc2luZ0luc3RydWN0aW9uKG5hbWUsIG5vcm1hbGl6ZUxpbmVCcmVha3MoY29udGVudCkpLCBzdGFydEluZGV4KTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBwcm9sb2cgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhIHByb2xvZyB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI3NlYy1wcm9sb2ctZHRkCiAgICAgKi8KICAgIEgoKSB7CiAgICAgIGxldCB7IGM6IHNjYW5uZXIgfSA9IHRoaXM7CiAgICAgIGxldCBzdGFydEluZGV4ID0gc2Nhbm5lci5kOwogICAgICB0aGlzLlAoKTsKICAgICAgd2hpbGUgKHRoaXMudygpKSB7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuTigpKSB7CiAgICAgICAgd2hpbGUgKHRoaXMudygpKSB7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzdGFydEluZGV4IDwgc2Nhbm5lci5kOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBhIHB1YmxpYyBpZGVudGlmaWVyIGxpdGVyYWwgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMKICAgICAqICAgVmFsdWUgb2YgdGhlIHB1YmxpYyBpZGVudGlmaWVyIGxpdGVyYWwgbWludXMgcXVvdGVzLCBvciBgZmFsc2VgIGlmCiAgICAgKiAgIG5vdGhpbmcgd2FzIGNvbnN1bWVkLiBBbiBlbXB0eSBzdHJpbmcgaW5kaWNhdGVzIHRoYXQgYSBwdWJsaWMgaWQgbGl0ZXJhbAogICAgICogICB3YXMgY29uc3VtZWQgYnV0IHdhcyBlbXB0eS4KICAgICAqCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULVB1YmlkTGl0ZXJhbAogICAgICovCiAgICBPKCkgewogICAgICBsZXQgc3RhcnRJbmRleCA9IHRoaXMuYy5kOwogICAgICBsZXQgdmFsdWUgPSB0aGlzLnMoKTsKICAgICAgaWYgKHZhbHVlICE9PSBmYWxzZSAmJiAhL15bLVx4MjBcclxuYS16QS1aMC05JygpKywuLzo9PzshKiNAJF8lXSokLy50ZXN0KHZhbHVlKSkgewogICAgICAgIHRoaXMuYy5vKHN0YXJ0SW5kZXgpOwogICAgICAgIHRocm93IHRoaXMuYSgiSW52YWxpZCBjaGFyYWN0ZXIgaW4gcHVibGljIGlkZW50aWZpZXIiKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGEgcmVmZXJlbmNlIGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIFRoaXMgZGlmZmVycyBmcm9tIGBjb25zdW1lQ29udGVudFJlZmVyZW5jZSgpYCBpbiB0aGF0IGEgY29uc3VtZWQgcmVmZXJlbmNlCiAgICAgKiB3aWxsIGJlIHJldHVybmVkIHJhdGhlciB0aGFuIGFkZGVkIHRvIHRoZSBkb2N1bWVudC4KICAgICAqCiAgICAgKiBAcmV0dXJucwogICAgICogICBQYXJzZWQgcmVmZXJlbmNlIHZhbHVlLCBvciBgZmFsc2VgIGlmIG5vdGhpbmcgd2FzIGNvbnN1bWVkICh0bwogICAgICogICBkaXN0aW5ndWlzaCBmcm9tIGEgcmVmZXJlbmNlIHRoYXQgcmVzb2x2ZXMgdG8gYW4gZW1wdHkgc3RyaW5nKS4KICAgICAqCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULVJlZmVyZW5jZQogICAgICovCiAgICBDKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBpZiAoIXNjYW5uZXIuYigiJiIpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxldCByZWYgPSBzY2FubmVyLnYoaXNSZWZlcmVuY2VDaGFyKTsKICAgICAgaWYgKHNjYW5uZXIuRigpICE9PSAiOyIpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIlVudGVybWluYXRlZCByZWZlcmVuY2UgKGEgcmVmZXJlbmNlIG11c3QgZW5kIHdpdGggYDtgKSIpOwogICAgICB9CiAgICAgIGxldCBwYXJzZWRWYWx1ZTsKICAgICAgaWYgKHJlZlswXSA9PT0gIiMiKSB7CiAgICAgICAgbGV0IGNvZGVQb2ludCA9IHJlZlsxXSA9PT0gIngiID8gcGFyc2VJbnQocmVmLnNsaWNlKDIpLCAxNikgOiBwYXJzZUludChyZWYuc2xpY2UoMSksIDEwKTsKICAgICAgICBpZiAoaXNOYU4oY29kZVBvaW50KSkgewogICAgICAgICAgdGhyb3cgdGhpcy5hKCJJbnZhbGlkIGNoYXJhY3RlciByZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc1htbENvZGVQb2ludChjb2RlUG9pbnQpKSB7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoIkNoYXJhY3RlciByZWZlcmVuY2UgcmVzb2x2ZXMgdG8gYW4gaW52YWxpZCBjaGFyYWN0ZXIiKTsKICAgICAgICB9CiAgICAgICAgcGFyc2VkVmFsdWUgPSBTdHJpbmcuZnJvbUNvZGVQb2ludChjb2RlUG9pbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnNlZFZhbHVlID0gcHJlZGVmaW5lZEVudGl0aWVzW3JlZl07CiAgICAgICAgaWYgKHBhcnNlZFZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgIGxldCB7CiAgICAgICAgICAgIGlnbm9yZVVuZGVmaW5lZEVudGl0aWVzLAogICAgICAgICAgICByZXNvbHZlVW5kZWZpbmVkRW50aXR5CiAgICAgICAgICB9ID0gdGhpcy5mOwogICAgICAgICAgbGV0IHdyYXBwZWRSZWYgPSBgJiR7cmVmfTtgOwogICAgICAgICAgaWYgKHJlc29sdmVVbmRlZmluZWRFbnRpdHkpIHsKICAgICAgICAgICAgbGV0IHJlc29sdmVkVmFsdWUgPSByZXNvbHZlVW5kZWZpbmVkRW50aXR5KHdyYXBwZWRSZWYpOwogICAgICAgICAgICBpZiAocmVzb2x2ZWRWYWx1ZSAhPT0gbnVsbCAmJiByZXNvbHZlZFZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiByZXNvbHZlZFZhbHVlOwogICAgICAgICAgICAgIGlmICh0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgXGByZXNvbHZlVW5kZWZpbmVkRW50aXR5KClcYCBtdXN0IHJldHVybiBhIHN0cmluZywgXGBudWxsXGAsIG9yIFxgdW5kZWZpbmVkXGAsIGJ1dCByZXR1cm5lZCBhIHZhbHVlIG9mIHR5cGUgJHt0eXBlfWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlnbm9yZVVuZGVmaW5lZEVudGl0aWVzKSB7CiAgICAgICAgICAgIHJldHVybiB3cmFwcGVkUmVmOwogICAgICAgICAgfQogICAgICAgICAgc2Nhbm5lci5vKC13cmFwcGVkUmVmLmxlbmd0aCk7CiAgICAgICAgICB0aHJvdyB0aGlzLmEoYE5hbWVkIGVudGl0eSBpc24ndCBkZWZpbmVkOiAke3dyYXBwZWRSZWZ9YCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwYXJzZWRWYWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3VtZXMgYSBgU3lzdGVtTGl0ZXJhbGAgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQSBgU3lzdGVtTGl0ZXJhbGAgaXMgc2ltaWxhciB0byBhbiBhdHRyaWJ1dGUgdmFsdWUsIGJ1dCBhbGxvd3MgdGhlCiAgICAgKiBjaGFyYWN0ZXJzIGA8YCBhbmQgYCZgIGFuZCBkb2Vzbid0IHJlcGxhY2UgcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiBAcmV0dXJucwogICAgICogICBWYWx1ZSBvZiB0aGUgYFN5c3RlbUxpdGVyYWxgIG1pbnVzIHF1b3Rlcywgb3IgYGZhbHNlYCBpZiBub3RoaW5nIHdhcwogICAgICogICBjb25zdW1lZC4gQW4gZW1wdHkgc3RyaW5nIGluZGljYXRlcyB0aGF0IGEgYFN5c3RlbUxpdGVyYWxgIHdhcyBjb25zdW1lZAogICAgICogICBidXQgd2FzIGVtcHR5LgogICAgICoKICAgICAqIEBzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMDgvUkVDLXhtbC0yMDA4MTEyNi8jTlQtU3lzdGVtTGl0ZXJhbAogICAgICovCiAgICBzKCkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICBsZXQgcXVvdGUgPSBzY2FubmVyLmIoJyInKSB8fCBzY2FubmVyLmIoIiciKTsKICAgICAgaWYgKCFxdW90ZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgdmFsdWUgPSBzY2FubmVyLnQocXVvdGUpOwogICAgICB0aGlzLnAodmFsdWUpOwogICAgICBpZiAoIXNjYW5uZXIuYihxdW90ZSkpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIk1pc3NpbmcgZW5kIHF1b3RlIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgLyoqCiAgICAgKiBDb25zdW1lcyBvbmUgb3IgbW9yZSB3aGl0ZXNwYWNlIGNoYXJhY3RlcnMgaWYgcG9zc2libGUuCiAgICAgKgogICAgICogQHJldHVybnMgV2hldGhlciBhbnkgd2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHdlcmUgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI3doaXRlCiAgICAgKi8KICAgIGUoKSB7CiAgICAgIHJldHVybiAhIXRoaXMuYy52KGlzV2hpdGVzcGFjZSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnN1bWVzIGFuIFhNTCBkZWNsYXJhdGlvbiBpZiBwb3NzaWJsZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyBXaGV0aGVyIGFuIFhNTCBkZWNsYXJhdGlvbiB3YXMgY29uc3VtZWQuCiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWwtMjAwODExMjYvI05ULVhNTERlY2wKICAgICAqLwogICAgUCgpIHsKICAgICAgbGV0IHsgYzogc2Nhbm5lciB9ID0gdGhpczsKICAgICAgbGV0IHN0YXJ0SW5kZXggPSBzY2FubmVyLmQ7CiAgICAgIGlmICghc2Nhbm5lci5iKCI8P3htbCIpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICghdGhpcy5lKCkpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIkludmFsaWQgWE1MIGRlY2xhcmF0aW9uIik7CiAgICAgIH0KICAgICAgbGV0IHZlcnNpb24gPSAhIXNjYW5uZXIuYigidmVyc2lvbiIpICYmIHRoaXMudSgpICYmIHRoaXMucygpOwogICAgICBpZiAodmVyc2lvbiA9PT0gZmFsc2UpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIlhNTCB2ZXJzaW9uIGlzIG1pc3Npbmcgb3IgaW52YWxpZCIpOwogICAgICB9IGVsc2UgaWYgKCEvXjFcLlswLTldKyQvLnRlc3QodmVyc2lvbikpIHsKICAgICAgICB0aHJvdyB0aGlzLmEoIkludmFsaWQgY2hhcmFjdGVyIGluIHZlcnNpb24gbnVtYmVyIik7CiAgICAgIH0KICAgICAgbGV0IGVuY29kaW5nOwogICAgICBsZXQgc3RhbmRhbG9uZTsKICAgICAgaWYgKHRoaXMuZSgpKSB7CiAgICAgICAgZW5jb2RpbmcgPSAhIXNjYW5uZXIuYigiZW5jb2RpbmciKSAmJiB0aGlzLnUoKSAmJiB0aGlzLnMoKTsKICAgICAgICBpZiAoZW5jb2RpbmcpIHsKICAgICAgICAgIHRoaXMuZSgpOwogICAgICAgIH0KICAgICAgICBzdGFuZGFsb25lID0gISFzY2FubmVyLmIoInN0YW5kYWxvbmUiKSAmJiB0aGlzLnUoKSAmJiB0aGlzLnMoKTsKICAgICAgICBpZiAoc3RhbmRhbG9uZSkgewogICAgICAgICAgaWYgKHN0YW5kYWxvbmUgIT09ICJ5ZXMiICYmIHN0YW5kYWxvbmUgIT09ICJubyIpIHsKICAgICAgICAgICAgdGhyb3cgdGhpcy5hKCdPbmx5ICJ5ZXMiIGFuZCAibm8iIGFyZSBwZXJtaXR0ZWQgYXMgdmFsdWVzIG9mIGBzdGFuZGFsb25lYCcpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghc2Nhbm5lci5iKCI/PiIpKSB7CiAgICAgICAgdGhyb3cgdGhpcy5hKCJJbnZhbGlkIG9yIHVuY2xvc2VkIFhNTCBkZWNsYXJhdGlvbiIpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmYucHJlc2VydmVYbWxEZWNsYXJhdGlvbiA/IHRoaXMuaihuZXcgWG1sRGVjbGFyYXRpb24oCiAgICAgICAgdmVyc2lvbiwKICAgICAgICBlbmNvZGluZyB8fCB2b2lkIDAsCiAgICAgICAgc3RhbmRhbG9uZSB8fCB2b2lkIDAKICAgICAgKSwgc3RhcnRJbmRleCkgOiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFuIGBYbWxFcnJvcmAgZm9yIHRoZSBjdXJyZW50IHNjYW5uZXIgcG9zaXRpb24uCiAgICAgKi8KICAgIGEobWVzc2FnZSkgewogICAgICBsZXQgeyBjOiBzY2FubmVyIH0gPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFhtbEVycm9yKG1lc3NhZ2UsIHNjYW5uZXIuZCwgc2Nhbm5lci5tKTsKICAgIH0KICAgIC8qKgogICAgICogVGhyb3dzIGFuIGludmFsaWQgY2hhcmFjdGVyIGVycm9yIGlmIGFueSBjaGFyYWN0ZXIgaW4gdGhlIGdpdmVuIF9zdHJpbmdfCiAgICAgKiBpc24ndCBhIHZhbGlkIFhNTCBjaGFyYWN0ZXIuCiAgICAgKi8KICAgIHAoc3RyaW5nKSB7CiAgICAgIGxldCB7IGxlbmd0aCB9ID0gc3RyaW5nOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgbGV0IGNwID0gc3RyaW5nLmNvZGVQb2ludEF0KGkpOwogICAgICAgIGlmICghaXNYbWxDb2RlUG9pbnQoY3ApKSB7CiAgICAgICAgICB0aGlzLmMubygtKFsuLi5zdHJpbmddLmxlbmd0aCAtIGkpKTsKICAgICAgICAgIHRocm93IHRoaXMuYSgiSW52YWxpZCBjaGFyYWN0ZXIiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNwID4gNjU1MzUpIHsKICAgICAgICAgIGkgKz0gMTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIGZ1bmN0aW9uIG5vcm1hbGl6ZUxpbmVCcmVha3ModGV4dCkgewogICAgbGV0IGkgPSAwOwogICAgd2hpbGUgKChpID0gdGV4dC5pbmRleE9mKCJcciIsIGkpKSAhPT0gLTEpIHsKICAgICAgdGV4dCA9IHRleHRbaSArIDFdID09PSAiXG4iID8gdGV4dC5zbGljZSgwLCBpKSArIHRleHQuc2xpY2UoaSArIDEpIDogdGV4dC5zbGljZSgwLCBpKSArICJcbiIgKyB0ZXh0LnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIHJldHVybiB0ZXh0OwogIH0KICBmdW5jdGlvbiBwYXJzZVhtbCh4bWwsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgUGFyc2VyKHhtbCwgb3B0aW9ucykuZG9jdW1lbnQ7CiAgfQogIGNsYXNzIFhtbFBhcnNlRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlKSB7CiAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgfQogIH0KICBmdW5jdGlvbiBwYXJzZVhtbFN0cmluZyh4bWxTdHJpbmcpIHsKICAgIGxldCBkb2MgPSBudWxsOwogICAgdHJ5IHsKICAgICAgZG9jID0gYnJvd3Nlci5wYXJzZVhtbCh4bWxTdHJpbmcpOwogICAgfSBjYXRjaCAoZSkgewogICAgICB0aHJvdyBuZXcgWG1sUGFyc2VFcnJvcihlLm1lc3NhZ2UpOwogICAgfQogICAgcmV0dXJuIGRvYzsKICB9CiAgZnVuY3Rpb24gc3RyaXBOYW1lc3BhY2UobmFtZSkgewogICAgY29uc3QgY29sb24gPSBuYW1lLmluZGV4T2YoIjoiKTsKICAgIHJldHVybiBjb2xvbiA+IC0xID8gbmFtZS5zdWJzdHIoY29sb24gKyAxKSA6IG5hbWU7CiAgfQogIGZ1bmN0aW9uIGdldFJvb3RFbGVtZW50KHhtbERvYykgewogICAgcmV0dXJuIHhtbERvYy5jaGlsZHJlblswXTsKICB9CiAgZnVuY3Rpb24gZ2V0RWxlbWVudE5hbWUoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQubmFtZSB8fCAiIjsKICB9CiAgZnVuY3Rpb24gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCBuYW1lLCBuZXN0ZWQgPSBmYWxzZSkgewogICAgY29uc3Qgc3RyaXBwZWROYW1lID0gc3RyaXBOYW1lc3BhY2UobmFtZSk7CiAgICBmdW5jdGlvbiByZWR1Y2VyKHByZXYsIGN1cnIpIHsKICAgICAgaWYgKHN0cmlwTmFtZXNwYWNlKGdldEVsZW1lbnROYW1lKGN1cnIpKSA9PT0gc3RyaXBwZWROYW1lKSB7CiAgICAgICAgcHJldi5wdXNoKGN1cnIpOwogICAgICB9CiAgICAgIGlmIChuZXN0ZWQgJiYgQXJyYXkuaXNBcnJheShjdXJyLmNoaWxkcmVuKSkgewogICAgICAgIHJldHVybiBbLi4ucHJldiwgLi4uY3Vyci5jaGlsZHJlbi5yZWR1Y2UocmVkdWNlciwgW10pXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gcHJldjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGVsZW1lbnQgJiYgQXJyYXkuaXNBcnJheShlbGVtZW50LmNoaWxkcmVuKSA/IGVsZW1lbnQuY2hpbGRyZW4ucmVkdWNlKHJlZHVjZXIsIFtdKSA6IFtdOwogIH0KICBmdW5jdGlvbiBmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsIG5hbWUsIG5lc3RlZCA9IGZhbHNlKSB7CiAgICByZXR1cm4gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCBuYW1lLCBuZXN0ZWQpWzBdIHx8IG51bGw7CiAgfQogIGZ1bmN0aW9uIGdldENoaWxkcmVuRWxlbWVudChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudCAmJiBBcnJheS5pc0FycmF5KGVsZW1lbnQuY2hpbGRyZW4pID8gWwogICAgICAuLi5lbGVtZW50LmNoaWxkcmVuLmZpbHRlcigKICAgICAgICAoZWwpID0+IGVsIGluc3RhbmNlb2YgYnJvd3Nlci5YbWxFbGVtZW50CiAgICAgICkKICAgIF0gOiBbXTsKICB9CiAgZnVuY3Rpb24gZ2V0RWxlbWVudFRleHQoZWxlbWVudCkgewogICAgY29uc3QgdGV4dE5vZGUgPSBlbGVtZW50ICYmIEFycmF5LmlzQXJyYXkoZWxlbWVudC5jaGlsZHJlbikgPyBlbGVtZW50LmNoaWxkcmVuLmZpbmQoKG5vZGUpID0+IG5vZGUudHlwZSA9PT0gInRleHQiKSA6IG51bGw7CiAgICByZXR1cm4gdGV4dE5vZGUgPyB0ZXh0Tm9kZS50ZXh0IDogIiI7CiAgfQogIGZ1bmN0aW9uIGdldEVsZW1lbnRBdHRyaWJ1dGUoZWxlbWVudCwgYXR0ck5hbWUpIHsKICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQuYXR0cmlidXRlc1thdHRyTmFtZV0gfHwgIiI7CiAgfQogIGNsYXNzIEVuZHBvaW50RXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBodHRwU3RhdHVzLCBpc0Nyb3NzT3JpZ2luUmVsYXRlZCkgewogICAgICBzdXBlcihtZXNzYWdlKTsKICAgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICAgICAgdGhpcy5odHRwU3RhdHVzID0gaHR0cFN0YXR1czsKICAgICAgdGhpcy5pc0Nyb3NzT3JpZ2luUmVsYXRlZCA9IGlzQ3Jvc3NPcmlnaW5SZWxhdGVkOwogICAgfQogIH0KICBjb25zdCBFTkNPRElOR1MgPSBbInV0Zi04IiwgInV0Zi0xNiIsICJpc28tODg1OS0xIl07CiAgY29uc3QgRkFMTEJBQ0tfRU5DT0RJTkcgPSAidXRmLTgiOwogIGZ1bmN0aW9uIGV4dHJhY3RFbmNvZGluZyhjb250ZW50VHlwZSkgewogICAgY29uc3QgbWF0Y2hlcyA9IC9jaGFyc2V0PShbXjtdKykvLmV4ZWMoY29udGVudFR5cGUpOwogICAgcmV0dXJuIG1hdGNoZXMgPyBtYXRjaGVzWzFdIDogbnVsbDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlU3RyaW5nKGJ1ZmZlciwgY29udGVudFR5cGUpIHsKICAgIGNvbnN0IGVuY29kaW5nSGludCA9IGNvbnRlbnRUeXBlID8gZXh0cmFjdEVuY29kaW5nKGNvbnRlbnRUeXBlKSA6IG51bGw7CiAgICBjb25zdCBlbmNvZGluZ0F0dGVtcHRzID0gZW5jb2RpbmdIaW50ID8gW2VuY29kaW5nSGludCwgLi4uRU5DT0RJTkdTXSA6IEVOQ09ESU5HUzsKICAgIGZvciAoY29uc3QgZW5jb2Rpbmcgb2YgZW5jb2RpbmdBdHRlbXB0cykgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoZW5jb2RpbmcsIHsgZmF0YWw6IHRydWUgfSk7CiAgICAgICAgcmV0dXJuIGRlY29kZXIuZGVjb2RlKGJ1ZmZlcik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgfQogICAgfQogICAgY29uc29sZS53YXJuKAogICAgICBgW29nYy1jbGllbnRdIFhNTCBkb2N1bWVudCBlbmNvZGluZyBjb3VsZCBub3QgYmUgZGV0ZXJtaW5lZCwgZmFsbGluZyBiYWNrIHRvICR7RkFMTEJBQ0tfRU5DT0RJTkd9LmAKICAgICk7CiAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKEZBTExCQUNLX0VOQ09ESU5HKS5kZWNvZGUoYnVmZmVyKTsKICB9CiAgY29uc3QgZmV0Y2hQcm9taXNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IGZldGNoT3B0aW9ucyA9IHt9OwogIGZ1bmN0aW9uIHNldEZldGNoT3B0aW9ucyhvcHRpb25zKSB7CiAgICBmZXRjaE9wdGlvbnMgPSBvcHRpb25zOwogIH0KICBmdW5jdGlvbiBnZXRGZXRjaE9wdGlvbnMoKSB7CiAgICByZXR1cm4gZmV0Y2hPcHRpb25zOwogIH0KICBmdW5jdGlvbiBzaGFyZWRGZXRjaCh1cmwsIG1ldGhvZCA9ICJHRVQiKSB7CiAgICBjb25zdCBmZXRjaEtleSA9IGAke21ldGhvZH0jJHt1cmx9YDsKICAgIGlmIChmZXRjaFByb21pc2VzLmhhcyhmZXRjaEtleSkpIHsKICAgICAgcmV0dXJuIGZldGNoUHJvbWlzZXMuZ2V0KGZldGNoS2V5KTsKICAgIH0KICAgIGNvbnN0IHByb21pc2UgPSBmZXRjaCh1cmwsIHsgLi4uZ2V0RmV0Y2hPcHRpb25zKCksIG1ldGhvZCB9KS5jYXRjaCgoZSkgPT4gZSkudGhlbigocmVzcCkgPT4gewogICAgICBmZXRjaFByb21pc2VzLmRlbGV0ZShmZXRjaEtleSk7CiAgICAgIHJldHVybiByZXNwOwogICAgfSk7CiAgICBmZXRjaFByb21pc2VzLnNldChmZXRjaEtleSwgcHJvbWlzZSk7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKChyZXNwKSA9PiB7CiAgICAgIGlmIChyZXNwIGluc3RhbmNlb2YgRXJyb3IpCiAgICAgICAgdGhyb3cgcmVzcDsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcXVlcnlYbWxEb2N1bWVudCh1cmwpIHsKICAgIHJldHVybiBzaGFyZWRGZXRjaCh1cmwpLmNhdGNoKAogICAgICAoKSA9PiAoCiAgICAgICAgLy8gYXR0ZW1wdCBhIEhFQUQgdG8gc2VlIGlmIHRoZSBmYWlsdXJlIGNvbWVzIGZyb20gQ09SUyBvciB0aGUgc2VydmljZSBpcyBnZW5lcmFsbHkgdW5yZWFjaGFibGUKICAgICAgICBmZXRjaCh1cmwsIHsgLi4uZ2V0RmV0Y2hPcHRpb25zKCksIG1ldGhvZDogIkhFQUQiLCBtb2RlOiAibm8tY29ycyIgfSkuY2F0Y2goKGVycm9yKSA9PiB7CiAgICAgICAgICB0aHJvdyBuZXcgRW5kcG9pbnRFcnJvcigKICAgICAgICAgICAgYEZldGNoaW5nIHRoZSBkb2N1bWVudCBmYWlsZWQgZWl0aGVyIGR1ZSB0byBuZXR3b3JrIGVycm9ycyBvciB1bnJlYWNoYWJsZSBob3N0LCBlcnJvciBpczogJHtlcnJvci5tZXNzYWdlfWAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pLnRoZW4oKCkgPT4gewogICAgICAgICAgdGhyb3cgbmV3IEVuZHBvaW50RXJyb3IoCiAgICAgICAgICAgIGBUaGUgZG9jdW1lbnQgY291bGQgbm90IGJlIGZldGNoZWQgZHVlIHRvIENPUlMgbGltaXRhdGlvbnNgLAogICAgICAgICAgICAwLAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0pCiAgICAgICkKICAgICkudGhlbihhc3luYyAocmVzcCkgPT4gewogICAgICBpZiAoIXJlc3Aub2spIHsKICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgcmVzcC50ZXh0KCk7CiAgICAgICAgdGhyb3cgbmV3IEVuZHBvaW50RXJyb3IoCiAgICAgICAgICBgUmVjZWl2ZWQgYW4gZXJyb3Igd2l0aCBjb2RlICR7cmVzcC5zdGF0dXN9OiAke3RleHR9YCwKICAgICAgICAgIHJlc3Auc3RhdHVzLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICB9CiAgICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IHJlc3AuYXJyYXlCdWZmZXIoKTsKICAgICAgY29uc3QgY29udGVudFR5cGVIZWFkZXIgPSByZXNwLmhlYWRlcnMuZ2V0KCJDb250ZW50LVR5cGUiKTsKICAgICAgcmV0dXJuIGRlY29kZVN0cmluZyhidWZmZXIsIGNvbnRlbnRUeXBlSGVhZGVyKTsKICAgIH0pLnRoZW4oKHhtbCkgPT4gcGFyc2VYbWxTdHJpbmcoeG1sKSk7CiAgfQogIGZ1bmN0aW9uIHNldFF1ZXJ5UGFyYW1zKHVybCwgcGFyYW1zKSB7CiAgICBjb25zdCBlbmNvZGVkVXJsTWF0Y2ggPSB1cmwubWF0Y2goLyhodHRwcz8lM0ElMkYlMkZbXi9dKykkLyk7CiAgICBpZiAoZW5jb2RlZFVybE1hdGNoKSB7CiAgICAgIGNvbnN0IGVuY29kZWRVcmwgPSBlbmNvZGVkVXJsTWF0Y2hbMV07CiAgICAgIGNvbnN0IG1vZGlmaWVkVXJsID0gc2V0UXVlcnlQYXJhbXMoZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRVcmwpLCBwYXJhbXMpOwogICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZW5jb2RlZFVybCwgZW5jb2RlVVJJQ29tcG9uZW50KG1vZGlmaWVkVXJsKSk7CiAgICB9CiAgICBjb25zdCB1cmxPYmogPSBuZXcgVVJMKHVybCk7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocGFyYW1zKTsKICAgIGNvbnN0IGtleXNMb3dlciA9IGtleXMubWFwKChrZXkpID0+IGtleS50b0xvd2VyQ2FzZSgpKTsKICAgIGNvbnN0IHRvRGVsZXRlID0gW107CiAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHVybE9iai5zZWFyY2hQYXJhbXMua2V5cygpKSB7CiAgICAgIGlmIChrZXlzTG93ZXIuaW5kZXhPZihwYXJhbS50b0xvd2VyQ2FzZSgpKSA+IC0xKSB7CiAgICAgICAgdG9EZWxldGUucHVzaChwYXJhbSk7CiAgICAgIH0KICAgIH0KICAgIHRvRGVsZXRlLm1hcCgocGFyYW0pID0+IHVybE9iai5zZWFyY2hQYXJhbXMuZGVsZXRlKHBhcmFtKSk7CiAgICBrZXlzLmZvckVhY2goCiAgICAgIChrZXkpID0+IHVybE9iai5zZWFyY2hQYXJhbXMuc2V0KAogICAgICAgIGtleSwKICAgICAgICBwYXJhbXNba2V5XSA9PT0gdHJ1ZSA/ICIiIDogcGFyYW1zW2tleV0KICAgICAgKQogICAgKTsKICAgIHJldHVybiB1cmxPYmoudG9TdHJpbmcoKTsKICB9CiAgY29uc3QgTGF0TG9uQ3JzTGlzdCA9IFsKICAgICJFUFNHOjQwNDYiLAogICAgLy8gUkdSREMgMjAwNQogICAgIkVQU0c6NDA3NSIsCiAgICAvLyBTUkVGOTgKICAgICJFUFNHOjQxMjAiLAogICAgLy8gR3JlZWsKICAgICJFUFNHOjQxMjIiLAogICAgLy8gQVRTNzcKICAgICJFUFNHOjQxMjQiLAogICAgLy8gUlQ5MAogICAgIkVQU0c6NDEyNiIsCiAgICAvLyBMS1M5NCAoRVRSUzg5KQogICAgIkVQU0c6NDE0OSIsCiAgICAvLyBDSDE5MDMKICAgICJFUFNHOjQxNTEiLAogICAgLy8gQ0hUUkY5NQogICAgIkVQU0c6NDE1MyIsCiAgICAvLyBSYXNzYWRpcmFuCiAgICAiRVBTRzo0MTU1IiwKICAgIC8vIERhYm9sYSAxOTgxCiAgICAiRVBTRzo0MTU3IiwKICAgIC8vIE1vdW50IERpbGxvbgogICAgIkVQU0c6NDE1OSIsCiAgICAvLyBFTEQ3OQogICAgIkVQU0c6NDE2MSIsCiAgICAvLyBQYW1wYSBkZWwgQ2FzdGlsbG8KICAgICJFUFNHOjQxNjMiLAogICAgLy8gWWVtZW4gTkdOOTYKICAgICJFUFNHOjQxNjUiLAogICAgLy8gQmlzc2F1CiAgICAiRVBTRzo0MTY3IiwKICAgIC8vIE5aR0QyMDAwCiAgICAiRVBTRzo0MTY5IiwKICAgIC8vIEFtZXJpY2FuIFNhbW9hIDE5NjIKICAgICJFUFNHOjQxNzEiLAogICAgLy8gUkdGOTMKICAgICJFUFNHOjQxNzMiLAogICAgLy8gSVJFTkVUOTUKICAgICJFUFNHOjQxNzUiLAogICAgLy8gU2llcnJhIExlb25lIDE5NjgKICAgICJFUFNHOjQxNzgiLAogICAgLy8gUHVsa292byAxOTQyKDgzKQogICAgIkVQU0c6NDE4MCIsCiAgICAvLyBFU1Q5NwogICAgIkVQU0c6NDE4MiIsCiAgICAvLyBBem9yZXMgT2NjaWRlbnRhbCAxOTM5CiAgICAiRVBTRzo0MTg0IiwKICAgIC8vIEF6b3JlcyBPcmllbnRhbCAxOTQwCiAgICAiRVBTRzo0MTg4IiwKICAgIC8vIE9TTkkgMTk1MgogICAgIkVQU0c6NDE5MCIsCiAgICAvLyBQT1NHQVIgOTgKICAgICJFUFNHOjQxOTEiLAogICAgLy8gQWxiYW5pYW4gMTk4NwogICAgIkVQU0c6NDE5NiIsCiAgICAvLyBBbW1hc3NhbGlrIDE5NTgKICAgICJFUFNHOjQxOTgiLAogICAgLy8gS291c3NlcmkKICAgICJFUFNHOjQyMDIiLAogICAgLy8gQUdENjYKICAgICJFUFNHOjQyMTAiLAogICAgLy8gQXJjIDE5NjAKICAgICJFUFNHOjQyMTEiLAogICAgLy8gQmF0YXZpYQogICAgIkVQU0c6NDIxNCIsCiAgICAvLyBCZWlqaW5nIDE5NTQKICAgICJFUFNHOjQyMjYiLAogICAgLy8gQ290ZSBkJ0l2b2lyZQogICAgIkVQU0c6NDIyOSIsCiAgICAvLyBFZ3lwdCAxOTA3CiAgICAiRVBTRzo0MjMxIiwKICAgIC8vIEVEODcKICAgICJFUFNHOjQyMzMiLAogICAgLy8gR2FuZGFqaWthIDE5NzAKICAgICJFUFNHOjQyMzYiLAogICAgLy8gSHUgVHp1IFNoYW4gMTk1MAogICAgIkVQU0c6NDIzOCIsCiAgICAvLyBJRDc0CiAgICAiRVBTRzo0MjQwIiwKICAgIC8vIEluZGlhbiAxOTc1CiAgICAiRVBTRzo0MjQyIiwKICAgIC8vIEpBRDY5CiAgICAiRVBTRzo0MjQ0IiwKICAgIC8vIEthbmRhd2FsYQogICAgIkVQU0c6NDI0NiIsCiAgICAvLyBLT0MKICAgICJFUFNHOjQyNDgiLAogICAgLy8gUFNBRDU2CiAgICAiRVBTRzo0MjUwIiwKICAgIC8vIExlaWdvbgogICAgIkVQU0c6NDI1MiIsCiAgICAvLyBMb21lCiAgICAiRVBTRzo0MjU1IiwKICAgIC8vIEhlcmF0IE5vcnRoCiAgICAiRVBTRzo0MjU4IiwKICAgIC8vIEVUUlM4OQogICAgIkVQU0c6NDI2MSIsCiAgICAvLyBNZXJjaGljaAogICAgIkVQU0c6NDI2NCIsCiAgICAvLyBNaGFzdAogICAgIkVQU0c6NDI2NyIsCiAgICAvLyBOQUQyNwogICAgIkVQU0c6NDI3MCIsCiAgICAvLyBOYWhyd2FuIDE5NjcKICAgICJFUFNHOjQyNzMiLAogICAgLy8gTkdPIDE5NDgKICAgICJFUFNHOjQyNzYiLAogICAgLy8gTlNXQyA5Wi0yCiAgICAiRVBTRzo0Mjc5IiwKICAgIC8vIE9TKFNOKTgwCiAgICAiRVBTRzo0MjgxIiwKICAgIC8vIFBhbGVzdGluZSAxOTIzCiAgICAiRVBTRzo0Mjg0IiwKICAgIC8vIFB1bGtvdm8gMTk0MgogICAgIkVQU0c6NDI4NiIsCiAgICAvLyBRYXRhciAxOTQ4CiAgICAiRVBTRzo0Mjg4IiwKICAgIC8vIExvbWEgUXVpbnRhbmEKICAgICJFUFNHOjQyOTIiLAogICAgLy8gU2FwcGVyIEhpbGwgMTk0MwogICAgIkVQU0c6NDI5NSIsCiAgICAvLyBTZXJpbmR1bmcKICAgICJFUFNHOjQyOTciLAogICAgLy8gVGFuYW5hcml2ZQogICAgIkVQU0c6NDI5OSIsCiAgICAvLyBUTTY1CiAgICAiRVBTRzo0MzAyIiwKICAgIC8vIFRyaW5pZGFkIDE5MDMKICAgICJFUFNHOjQzMjQiLAogICAgLy8gV0dTIDcyQkUKICAgICJFUFNHOjQzMjYiCiAgICAvLyBXR1MgODQKICBdOwogIGZ1bmN0aW9uIGhhc0ludmVydGVkQ29vcmRpbmF0ZXMoY3JzTmFtZSkgewogICAgcmV0dXJuIExhdExvbkNyc0xpc3QuaW5kZXhPZihzaW1wbGlmeUVwc2dVcm4oY3JzTmFtZSkpID4gLTE7CiAgfQogIGZ1bmN0aW9uIHNpbXBsaWZ5RXBzZ1VybihmdWxsQ3JzTmFtZSkgewogICAgaWYgKC9edXJuOig/OngtKT9vZ2M6ZGVmOmNyczplcHNnOi8udGVzdChmdWxsQ3JzTmFtZS50b0xvd2VyQ2FzZSgpKSkgewogICAgICBjb25zdCBjb2RlID0gLyhbMC05XSspJC8uZXhlYyhmdWxsQ3JzTmFtZSlbMV07CiAgICAgIHJldHVybiBgRVBTRzoke2NvZGV9YDsKICAgIH0KICAgIHJldHVybiBmdWxsQ3JzTmFtZTsKICB9CiAgZnVuY3Rpb24gcmVhZFZlcnNpb25Gcm9tQ2FwYWJpbGl0aWVzJDEoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICByZXR1cm4gZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKS5hdHRyaWJ1dGVzWyJ2ZXJzaW9uIl07CiAgfQogIGZ1bmN0aW9uIHJlYWRMYXllcnNGcm9tQ2FwYWJpbGl0aWVzJDEoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICBjb25zdCB2ZXJzaW9uID0gcmVhZFZlcnNpb25Gcm9tQ2FwYWJpbGl0aWVzJDEoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGNvbnN0IGNhcGFiaWxpdHkgPSBmaW5kQ2hpbGRFbGVtZW50KAogICAgICBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLAogICAgICAiQ2FwYWJpbGl0eSIKICAgICk7CiAgICByZXR1cm4gZmluZENoaWxkcmVuRWxlbWVudChjYXBhYmlsaXR5LCAiTGF5ZXIiKS5tYXAoCiAgICAgIChsYXllckVsKSA9PiBwYXJzZUxheWVyKGxheWVyRWwsIHZlcnNpb24pCiAgICApOwogIH0KICBmdW5jdGlvbiByZWFkSW5mb0Zyb21DYXBhYmlsaXRpZXMkMihjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IHNlcnZpY2UgPSBmaW5kQ2hpbGRFbGVtZW50KGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYyksICJTZXJ2aWNlIik7CiAgICBjb25zdCBrZXl3b3JkcyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIktleXdvcmRMaXN0IiksCiAgICAgICJLZXl3b3JkIgogICAgKS5tYXAoZ2V0RWxlbWVudFRleHQpLmZpbHRlcigodiwgaSwgYXJyKSA9PiBhcnIuaW5kZXhPZih2KSA9PT0gaSk7CiAgICByZXR1cm4gewogICAgICB0aXRsZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiVGl0bGUiKSksCiAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIk5hbWUiKSksCiAgICAgIGFic3RyYWN0OiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJBYnN0cmFjdCIpKSwKICAgICAgZmVlczogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiRmVlcyIpKSwKICAgICAgY29uc3RyYWludHM6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIkFjY2Vzc0NvbnN0cmFpbnRzIikpLAogICAgICBrZXl3b3JkcwogICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMYXllcihsYXllckVsLCB2ZXJzaW9uLCBpbmhlcml0ZWRTcnMgPSBbXSwgaW5oZXJpdGVkU3R5bGVzID0gW10sIGluaGVyaXRlZEF0dHJpYnV0aW9uID0gbnVsbCwgaW5oZXJpdGVkQm91bmRpbmdCb3hlcyA9IG51bGwpIHsKICAgIGNvbnN0IHNyc1RhZyA9IHZlcnNpb24gPT09ICIxLjMuMCIgPyAiQ1JTIiA6ICJTUlMiOwogICAgY29uc3Qgc3JzTGlzdCA9IGZpbmRDaGlsZHJlbkVsZW1lbnQobGF5ZXJFbCwgc3JzVGFnKS5tYXAoZ2V0RWxlbWVudFRleHQpOwogICAgY29uc3QgYXZhaWxhYmxlQ3JzID0gc3JzTGlzdC5sZW5ndGggPiAwID8gc3JzTGlzdCA6IGluaGVyaXRlZFNyczsKICAgIGNvbnN0IGxheWVyU3R5bGVzID0gZmluZENoaWxkcmVuRWxlbWVudChsYXllckVsLCAiU3R5bGUiKS5tYXAoCiAgICAgIHBhcnNlTGF5ZXJTdHlsZQogICAgKTsKICAgIGNvbnN0IHN0eWxlcyA9IGxheWVyU3R5bGVzLmxlbmd0aCA+IDAgPyBsYXllclN0eWxlcyA6IGluaGVyaXRlZFN0eWxlczsKICAgIGZ1bmN0aW9uIHBhcnNlQkJveDIoYmJveEVsKSB7CiAgICAgIGNvbnN0IHNycyA9IGdldEVsZW1lbnRBdHRyaWJ1dGUoYmJveEVsLCBzcnNUYWcpOwogICAgICBjb25zdCBhdHRycyA9IGhhc0ludmVydGVkQ29vcmRpbmF0ZXMoc3JzKSAmJiB2ZXJzaW9uID09PSAiMS4zLjAiID8gWyJtaW55IiwgIm1pbngiLCAibWF4eSIsICJtYXh4Il0gOiBbIm1pbngiLCAibWlueSIsICJtYXh4IiwgIm1heHkiXTsKICAgICAgcmV0dXJuIGF0dHJzLm1hcCgobmFtZSkgPT4gZ2V0RWxlbWVudEF0dHJpYnV0ZShiYm94RWwsIG5hbWUpKTsKICAgIH0KICAgIGZ1bmN0aW9uIHBhcnNlRXhHZW9ncmFwaGljQm91bmRpbmdCb3goYmJveEVsKSB7CiAgICAgIHJldHVybiBbCiAgICAgICAgIndlc3RCb3VuZExvbmdpdHVkZSIsCiAgICAgICAgInNvdXRoQm91bmRMYXRpdHVkZSIsCiAgICAgICAgImVhc3RCb3VuZExvbmdpdHVkZSIsCiAgICAgICAgIm5vcnRoQm91bmRMYXRpdHVkZSIKICAgICAgXS5tYXAoKG5hbWUpID0+IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoYmJveEVsLCBuYW1lKSkpOwogICAgfQogICAgZnVuY3Rpb24gcGFyc2VMYXRMb25Cb3VuZGluZ0JveChiYm94RWwpIHsKICAgICAgcmV0dXJuIFsibWlueCIsICJtaW55IiwgIm1heHgiLCAibWF4eSJdLm1hcCgKICAgICAgICAobmFtZSkgPT4gZ2V0RWxlbWVudEF0dHJpYnV0ZShiYm94RWwsIG5hbWUpCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGlvbkVsID0gZmluZENoaWxkRWxlbWVudChsYXllckVsLCAiQXR0cmlidXRpb24iKTsKICAgIGNvbnN0IGF0dHJpYnV0aW9uID0gYXR0cmlidXRpb25FbCAhPT0gbnVsbCA/IHBhcnNlTGF5ZXJBdHRyaWJ1dGlvbihhdHRyaWJ1dGlvbkVsKSA6IGluaGVyaXRlZEF0dHJpYnV0aW9uOwogICAgY29uc3QgbGF0TG9uQmJveEVsID0gdmVyc2lvbiA9PT0gIjEuMy4wIiA/IGZpbmRDaGlsZEVsZW1lbnQobGF5ZXJFbCwgIkVYX0dlb2dyYXBoaWNCb3VuZGluZ0JveCIpIDogZmluZENoaWxkRWxlbWVudChsYXllckVsLCAiTGF0TG9uQm91bmRpbmdCb3giKTsKICAgIGNvbnN0IGJhc2VCb3VuZGluZ0JveCA9IHt9OwogICAgaWYgKGxhdExvbkJib3hFbCkgewogICAgICBiYXNlQm91bmRpbmdCb3hbIkVQU0c6NDMyNiJdID0gdmVyc2lvbiA9PT0gIjEuMy4wIiA/IHBhcnNlRXhHZW9ncmFwaGljQm91bmRpbmdCb3gobGF0TG9uQmJveEVsKSA6IHBhcnNlTGF0TG9uQm91bmRpbmdCb3gobGF0TG9uQmJveEVsKTsKICAgIH0KICAgIGxldCBib3VuZGluZ0JveGVzID0gZmluZENoaWxkcmVuRWxlbWVudChsYXllckVsLCAiQm91bmRpbmdCb3giKS5yZWR1Y2UoCiAgICAgIChwcmV2LCBiYm94RWwpID0+ICh7CiAgICAgICAgLi4ucHJldiwKICAgICAgICBbZ2V0RWxlbWVudEF0dHJpYnV0ZShiYm94RWwsIHNyc1RhZyldOiBwYXJzZUJCb3gyKGJib3hFbCkKICAgICAgfSksCiAgICAgIGJhc2VCb3VuZGluZ0JveAogICAgKTsKICAgIGJvdW5kaW5nQm94ZXMgPSBPYmplY3Qua2V5cyhib3VuZGluZ0JveGVzKS5sZW5ndGggPiAwIHx8IGluaGVyaXRlZEJvdW5kaW5nQm94ZXMgPT09IG51bGwgPyBib3VuZGluZ0JveGVzIDogaW5oZXJpdGVkQm91bmRpbmdCb3hlczsKICAgIGNvbnN0IGNoaWxkcmVuID0gZmluZENoaWxkcmVuRWxlbWVudChsYXllckVsLCAiTGF5ZXIiKS5tYXAoCiAgICAgIChsYXllcikgPT4gcGFyc2VMYXllcihsYXllciwgdmVyc2lvbiwgYXZhaWxhYmxlQ3JzLCBzdHlsZXMsIGF0dHJpYnV0aW9uLCBib3VuZGluZ0JveGVzKQogICAgKTsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQobGF5ZXJFbCwgIk5hbWUiKSksCiAgICAgIHRpdGxlOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGxheWVyRWwsICJUaXRsZSIpKSwKICAgICAgYWJzdHJhY3Q6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQobGF5ZXJFbCwgIkFic3RyYWN0IikpLAogICAgICBhdmFpbGFibGVDcnMsCiAgICAgIHN0eWxlcywKICAgICAgYXR0cmlidXRpb24sCiAgICAgIGJvdW5kaW5nQm94ZXMsCiAgICAgIC4uLmNoaWxkcmVuLmxlbmd0aCAmJiB7IGNoaWxkcmVuIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlTGF5ZXJTdHlsZShzdHlsZUVsKSB7CiAgICBjb25zdCBsZWdlbmRVcmwgPSBnZXRFbGVtZW50QXR0cmlidXRlKAogICAgICBmaW5kQ2hpbGRFbGVtZW50KGZpbmRDaGlsZEVsZW1lbnQoc3R5bGVFbCwgIkxlZ2VuZFVSTCIpLCAiT25saW5lUmVzb3VyY2UiKSwKICAgICAgInhsaW5rOmhyZWYiCiAgICApOwogICAgcmV0dXJuIHsKICAgICAgbmFtZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzdHlsZUVsLCAiTmFtZSIpKSwKICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc3R5bGVFbCwgIlRpdGxlIikpLAogICAgICAuLi5sZWdlbmRVcmwgJiYgeyBsZWdlbmRVcmwgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMYXllckF0dHJpYnV0aW9uKGF0dHJpYnV0aW9uRWwpIHsKICAgIGNvbnN0IGxvZ29VcmwgPSBnZXRFbGVtZW50QXR0cmlidXRlKAogICAgICBmaW5kQ2hpbGRFbGVtZW50KAogICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoYXR0cmlidXRpb25FbCwgIkxvZ29VUkwiKSwKICAgICAgICAiT25saW5lUmVzb3VyY2UiCiAgICAgICksCiAgICAgICJ4bGluazpocmVmIgogICAgKTsKICAgIGNvbnN0IHVybCA9IGdldEVsZW1lbnRBdHRyaWJ1dGUoCiAgICAgIGZpbmRDaGlsZEVsZW1lbnQoYXR0cmlidXRpb25FbCwgIk9ubGluZVJlc291cmNlIiksCiAgICAgICJ4bGluazpocmVmIgogICAgKTsKICAgIGNvbnN0IHRpdGxlID0gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChhdHRyaWJ1dGlvbkVsLCAiVGl0bGUiKSk7CiAgICByZXR1cm4gewogICAgICAuLi50aXRsZSAmJiB7IHRpdGxlIH0sCiAgICAgIC4uLnVybCAmJiB7IHVybCB9LAogICAgICAuLi5sb2dvVXJsICYmIHsgbG9nb1VybCB9CiAgICB9OwogIH0KICBmdW5jdGlvbiByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKSB7CiAgICByZXR1cm4gZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKS5hdHRyaWJ1dGVzWyJ2ZXJzaW9uIl07CiAgfQogIGZ1bmN0aW9uIHJlYWRPdXRwdXRGb3JtYXRzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IHZlcnNpb24gPSByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGxldCBvdXRwdXRGb3JtYXRzOwogICAgaWYgKHZlcnNpb24uc3RhcnRzV2l0aCgiMS4wIikpIHsKICAgICAgY29uc3QgZ2V0RmVhdHVyZSA9IGZpbmRDaGlsZEVsZW1lbnQoCiAgICAgICAgZmluZENoaWxkRWxlbWVudCgKICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwgIkNhcGFiaWxpdHkiKSwKICAgICAgICAgICJSZXF1ZXN0IgogICAgICAgICksCiAgICAgICAgIkdldEZlYXR1cmUiCiAgICAgICk7CiAgICAgIG91dHB1dEZvcm1hdHMgPSBnZXRDaGlsZHJlbkVsZW1lbnQoCiAgICAgICAgZmluZENoaWxkRWxlbWVudChnZXRGZWF0dXJlLCAiUmVzdWx0Rm9ybWF0IikKICAgICAgKS5tYXAoZ2V0RWxlbWVudE5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3Qgb3BlcmF0aW9ucyA9IGZpbmRDaGlsZEVsZW1lbnQoCiAgICAgICAgZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKSwKICAgICAgICAiT3BlcmF0aW9uc01ldGFkYXRhIgogICAgICApOwogICAgICBjb25zdCBnZXRGZWF0dXJlID0gZmluZENoaWxkcmVuRWxlbWVudChvcGVyYXRpb25zLCAiT3BlcmF0aW9uIikuZmluZCgKICAgICAgICAoZWwpID0+IGdldEVsZW1lbnRBdHRyaWJ1dGUoZWwsICJuYW1lIikgPT09ICJHZXRGZWF0dXJlIgogICAgICApOwogICAgICBjb25zdCBwYXJhbWV0ZXIgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGdldEZlYXR1cmUsICJQYXJhbWV0ZXIiKS5maW5kKAogICAgICAgIChlbCkgPT4gZ2V0RWxlbWVudEF0dHJpYnV0ZShlbCwgIm5hbWUiKSA9PT0gIm91dHB1dEZvcm1hdCIKICAgICAgKTsKICAgICAgb3V0cHV0Rm9ybWF0cyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQocGFyYW1ldGVyLCAiVmFsdWUiLCB0cnVlKS5tYXAoCiAgICAgICAgZ2V0RWxlbWVudFRleHQKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBvdXRwdXRGb3JtYXRzOwogIH0KICBmdW5jdGlvbiByZWFkSW5mb0Zyb21DYXBhYmlsaXRpZXMkMShjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IHZlcnNpb24gPSByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGNvbnN0IHNlcnZpY2VUYWcgPSB2ZXJzaW9uLnN0YXJ0c1dpdGgoIjEuMCIpID8gIlNlcnZpY2UiIDogIlNlcnZpY2VJZGVudGlmaWNhdGlvbiI7CiAgICBjb25zdCBuYW1lVGFnID0gdmVyc2lvbi5zdGFydHNXaXRoKCIxLjAiKSA/ICJOYW1lIiA6ICJTZXJ2aWNlVHlwZSI7CiAgICBjb25zdCBzZXJ2aWNlID0gZmluZENoaWxkRWxlbWVudChnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLCBzZXJ2aWNlVGFnKTsKICAgIGxldCBrZXl3b3JkczsKICAgIGlmICh2ZXJzaW9uLnN0YXJ0c1dpdGgoIjEuMCIpKSB7CiAgICAgIGtleXdvcmRzID0gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiS2V5d29yZHMiKSkuc3BsaXQoIiwiKS5tYXAoKGtleXdvcmQpID0+IGtleXdvcmQudHJpbSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIGtleXdvcmRzID0gZmluZENoaWxkcmVuRWxlbWVudCgKICAgICAgICBmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJLZXl3b3JkcyIpLAogICAgICAgICJLZXl3b3JkIgogICAgICApLm1hcChnZXRFbGVtZW50VGV4dCk7CiAgICB9CiAgICByZXR1cm4gewogICAgICB0aXRsZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiVGl0bGUiKSksCiAgICAgIG5hbWU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgbmFtZVRhZykpLAogICAgICBhYnN0cmFjdDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiQWJzdHJhY3QiKSksCiAgICAgIGZlZXM6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIkZlZXMiKSksCiAgICAgIGNvbnN0cmFpbnRzOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJBY2Nlc3NDb25zdHJhaW50cyIpKSwKICAgICAga2V5d29yZHMsCiAgICAgIG91dHB1dEZvcm1hdHM6IHJlYWRPdXRwdXRGb3JtYXRzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpCiAgICB9OwogIH0KICBmdW5jdGlvbiByZWFkRmVhdHVyZVR5cGVzRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IHZlcnNpb24gPSByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGNvbnN0IG91dHB1dEZvcm1hdHMgPSByZWFkT3V0cHV0Rm9ybWF0c0Zyb21DYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGNvbnN0IGNhcGFiaWxpdHkgPSBmaW5kQ2hpbGRFbGVtZW50KAogICAgICBnZXRSb290RWxlbWVudChjYXBhYmlsaXRpZXNEb2MpLAogICAgICAiRmVhdHVyZVR5cGVMaXN0IgogICAgKTsKICAgIHJldHVybiBmaW5kQ2hpbGRyZW5FbGVtZW50KGNhcGFiaWxpdHksICJGZWF0dXJlVHlwZSIpLm1hcCgKICAgICAgKGZlYXR1cmVUeXBlRWwpID0+IHBhcnNlRmVhdHVyZVR5cGUoZmVhdHVyZVR5cGVFbCwgdmVyc2lvbiwgb3V0cHV0Rm9ybWF0cykKICAgICk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlRmVhdHVyZVR5cGUoZmVhdHVyZVR5cGVFbCwgc2VydmljZVZlcnNpb24sIGRlZmF1bHRPdXRwdXRGb3JtYXRzKSB7CiAgICBjb25zdCBzcnNUYWcgPSBzZXJ2aWNlVmVyc2lvbi5zdGFydHNXaXRoKCIyLiIpID8gIkNSUyIgOiAiU1JTIjsKICAgIGNvbnN0IGRlZmF1bHRTcnNUYWcgPSBzZXJ2aWNlVmVyc2lvbi5zdGFydHNXaXRoKCIxLjAiKSA/ICJTUlMiIDogYERlZmF1bHQke3Nyc1RhZ31gOwogICAgZnVuY3Rpb24gcGFyc2VCQm94MTAwKCkgewogICAgICBjb25zdCBiYm94RWwgPSBmaW5kQ2hpbGRFbGVtZW50KGZlYXR1cmVUeXBlRWwsICJMYXRMb25nQm91bmRpbmdCb3giKTsKICAgICAgcmV0dXJuIFsibWlueCIsICJtaW55IiwgIm1heHgiLCAibWF4eSJdLm1hcCgobmFtZSkgPT4gZ2V0RWxlbWVudEF0dHJpYnV0ZShiYm94RWwsIG5hbWUpKS5tYXAocGFyc2VGbG9hdCk7CiAgICB9CiAgICBmdW5jdGlvbiBwYXJzZUJCb3gyKCkgewogICAgICBjb25zdCBiYm94RWwgPSBmaW5kQ2hpbGRFbGVtZW50KGZlYXR1cmVUeXBlRWwsICJXR1M4NEJvdW5kaW5nQm94Iik7CiAgICAgIHJldHVybiBbIkxvd2VyQ29ybmVyIiwgIlVwcGVyQ29ybmVyIl0ubWFwKChlbE5hbWUpID0+IGZpbmRDaGlsZEVsZW1lbnQoYmJveEVsLCBlbE5hbWUpKS5tYXAoKGNvcm5lckVsKSA9PiBnZXRFbGVtZW50VGV4dChjb3JuZXJFbCkuc3BsaXQoIiAiKSkucmVkdWNlKChwcmV2LCBjdXJyKSA9PiBbLi4ucHJldiwgLi4uY3Vycl0pLm1hcChwYXJzZUZsb2F0KTsKICAgIH0KICAgIGNvbnN0IG90aGVyQ3JzID0gc2VydmljZVZlcnNpb24uc3RhcnRzV2l0aCgiMS4wIikgPyBbXSA6IGZpbmRDaGlsZHJlbkVsZW1lbnQoZmVhdHVyZVR5cGVFbCwgYE90aGVyJHtzcnNUYWd9YCkubWFwKGdldEVsZW1lbnRUZXh0KS5tYXAoc2ltcGxpZnlFcHNnVXJuKTsKICAgIGNvbnN0IG91dHB1dEZvcm1hdHMgPSBzZXJ2aWNlVmVyc2lvbi5zdGFydHNXaXRoKCIxLjAiKSA/IFtdIDogZmluZENoaWxkcmVuRWxlbWVudCgKICAgICAgZmluZENoaWxkRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiT3V0cHV0Rm9ybWF0cyIpLAogICAgICAiRm9ybWF0IgogICAgKS5tYXAoZ2V0RWxlbWVudFRleHQpOwogICAgcmV0dXJuIHsKICAgICAgbmFtZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiTmFtZSIpKSwKICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZmVhdHVyZVR5cGVFbCwgIlRpdGxlIikpLAogICAgICBhYnN0cmFjdDogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChmZWF0dXJlVHlwZUVsLCAiQWJzdHJhY3QiKSksCiAgICAgIGRlZmF1bHRDcnM6IHNpbXBsaWZ5RXBzZ1VybigKICAgICAgICBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGZlYXR1cmVUeXBlRWwsIGRlZmF1bHRTcnNUYWcpKQogICAgICApLAogICAgICBvdGhlckNycywKICAgICAgb3V0cHV0Rm9ybWF0czogb3V0cHV0Rm9ybWF0cy5sZW5ndGggPiAwID8gb3V0cHV0Rm9ybWF0cyA6IGRlZmF1bHRPdXRwdXRGb3JtYXRzLAogICAgICBsYXRMb25Cb3VuZGluZ0JveDogc2VydmljZVZlcnNpb24uc3RhcnRzV2l0aCgiMS4wIikgPyBwYXJzZUJCb3gxMDAoKSA6IHBhcnNlQkJveDIoKQogICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VCQm94KHhtbEVsZW1lbnQpIHsKICAgIGNvbnN0IHJlc3VsdCA9IFsiTG93ZXJDb3JuZXIiLCAiVXBwZXJDb3JuZXIiXS5tYXAoKGVsTmFtZSkgPT4gZmluZENoaWxkRWxlbWVudCh4bWxFbGVtZW50LCBlbE5hbWUpKS5tYXAoKGNvcm5lckVsKSA9PiBnZXRFbGVtZW50VGV4dChjb3JuZXJFbCkuc3BsaXQoIiAiKSkucmVkdWNlKChwcmV2LCBjdXJyKSA9PiBbLi4ucHJldiwgLi4uY3Vycl0pLm1hcChwYXJzZUZsb2F0KTsKICAgIGlmIChyZXN1bHQuc29tZShOdW1iZXIuaXNOYU4pKQogICAgICByZXR1cm4gbnVsbDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHJlYWRJbmZvRnJvbUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXNEb2MpIHsKICAgIGNvbnN0IHJvb3RFbCA9IGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYyk7CiAgICBjb25zdCBzZXJ2aWNlID0gZmluZENoaWxkRWxlbWVudChyb290RWwsICJTZXJ2aWNlSWRlbnRpZmljYXRpb24iKTsKICAgIGNvbnN0IGtleXdvcmRzID0gZmluZENoaWxkcmVuRWxlbWVudCgKICAgICAgZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiS2V5d29yZHMiKSwKICAgICAgIktleXdvcmQiCiAgICApLm1hcChnZXRFbGVtZW50VGV4dCk7CiAgICBjb25zdCBtZXRhZGF0YSA9IGZpbmRDaGlsZEVsZW1lbnQocm9vdEVsLCAiT3BlcmF0aW9uc01ldGFkYXRhIik7CiAgICBjb25zdCBnZXRUaWxlT3BlcmF0aW9uID0gZmluZENoaWxkcmVuRWxlbWVudChtZXRhZGF0YSwgIk9wZXJhdGlvbiIpLmZpbmQoCiAgICAgIChlbCkgPT4gZ2V0RWxlbWVudEF0dHJpYnV0ZShlbCwgIm5hbWUiKSA9PSAiR2V0VGlsZSIKICAgICk7CiAgICBjb25zdCBnZXRUaWxlVXJscyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZ2V0VGlsZU9wZXJhdGlvbiwgIkdldCIsIHRydWUpLnJlZHVjZSgKICAgICAgKHByZXYsIGN1cnIpID0+IHsKICAgICAgICBjb25zdCBlbmNvZGluZ1R5cGUgPSBnZXRFbGVtZW50VGV4dCgKICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoY3VyciwgIlZhbHVlIiwgdHJ1ZSkKICAgICAgICApOwogICAgICAgIGNvbnN0IHVybCA9IGdldEVsZW1lbnRBdHRyaWJ1dGUoY3VyciwgInhsaW5rOmhyZWYiKTsKICAgICAgICBpZiAoZW5jb2RpbmdUeXBlLnRvTG93ZXJDYXNlKCkgPT09ICJyZXN0ZnVsIikKICAgICAgICAgIHJldHVybiB7IC4uLnByZXYsIHJlc3Q6IHVybCB9OwogICAgICAgIHJldHVybiB7IC4uLnByZXYsIGt2cDogdXJsIH07CiAgICAgIH0sCiAgICAgIHt9CiAgICApOwogICAgcmV0dXJuIHsKICAgICAgdGl0bGU6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIlRpdGxlIikpLAogICAgICBuYW1lOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJTZXJ2aWNlVHlwZSIpKSwKICAgICAgYWJzdHJhY3Q6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoc2VydmljZSwgIkFic3RyYWN0IikpLAogICAgICBmZWVzOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KHNlcnZpY2UsICJGZWVzIikpLAogICAgICBjb25zdHJhaW50czogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChzZXJ2aWNlLCAiQWNjZXNzQ29uc3RyYWludHMiKSksCiAgICAgIGtleXdvcmRzLAogICAgICBnZXRUaWxlVXJscwogICAgfTsKICB9CiAgZnVuY3Rpb24gcmVhZE1hdHJpeFNldHNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYykgewogICAgZnVuY3Rpb24gcGFyc2VNYXRyaXhTZXQoZWxlbWVudCkgewogICAgICBjb25zdCB0b3BMZWZ0ID0gZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiVG9wTGVmdENvcm5lciIpKS5zcGxpdCgiICIpLm1hcChwYXJzZUZsb2F0KTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpZGVudGlmaWVyOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJJZGVudGlmaWVyIikpLAogICAgICAgIHRpbGVXaWR0aDogcGFyc2VJbnQoCiAgICAgICAgICBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJUaWxlV2lkdGgiKSkKICAgICAgICApLAogICAgICAgIHRpbGVIZWlnaHQ6IHBhcnNlSW50KAogICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiVGlsZUhlaWdodCIpKQogICAgICAgICksCiAgICAgICAgbWF0cml4V2lkdGg6IHBhcnNlSW50KAogICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiTWF0cml4V2lkdGgiKSkKICAgICAgICApLAogICAgICAgIG1hdHJpeEhlaWdodDogcGFyc2VJbnQoCiAgICAgICAgICBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJNYXRyaXhIZWlnaHQiKSkKICAgICAgICApLAogICAgICAgIHNjYWxlRGVub21pbmF0b3I6IHBhcnNlRmxvYXQoCiAgICAgICAgICBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQsICJTY2FsZURlbm9taW5hdG9yIikpCiAgICAgICAgKSwKICAgICAgICB0b3BMZWZ0CiAgICAgIH07CiAgICB9CiAgICBjb25zdCBjb250ZW50cyA9IGZpbmRDaGlsZEVsZW1lbnQoCiAgICAgIGdldFJvb3RFbGVtZW50KGNhcGFiaWxpdGllc0RvYyksCiAgICAgICJDb250ZW50cyIKICAgICk7CiAgICBjb25zdCBtYXRyaXhTZXRzID0gZmluZENoaWxkcmVuRWxlbWVudChjb250ZW50cywgIlRpbGVNYXRyaXhTZXQiKTsKICAgIHJldHVybiBtYXRyaXhTZXRzLm1hcCgoZWxlbWVudCkgPT4gewogICAgICBjb25zdCB3ZWxsS25vd25TY2FsZVNldCA9IGdldEVsZW1lbnRUZXh0KAogICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIldlbGxLbm93blNjYWxlU2V0IikKICAgICAgKTsKICAgICAgY29uc3QgYm91bmRpbmdCb3ggPSBwYXJzZUJCb3goZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiQm91bmRpbmdCb3giKSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaWRlbnRpZmllcjogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiSWRlbnRpZmllciIpKSwKICAgICAgICBjcnM6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIlN1cHBvcnRlZENSUyIpKSwKICAgICAgICB0aWxlTWF0cmljZXM6IGZpbmRDaGlsZHJlbkVsZW1lbnQoZWxlbWVudCwgIlRpbGVNYXRyaXgiKS5tYXAoCiAgICAgICAgICBwYXJzZU1hdHJpeFNldAogICAgICAgICksCiAgICAgICAgLi4uYm91bmRpbmdCb3ggJiYgeyBib3VuZGluZ0JveCB9LAogICAgICAgIC4uLndlbGxLbm93blNjYWxlU2V0ICYmIHsgd2VsbEtub3duU2NhbGVTZXQgfQogICAgICB9OwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHJlYWRMYXllcnNGcm9tQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllc0RvYykgewogICAgY29uc3Qgcm9vdEVsID0gZ2V0Um9vdEVsZW1lbnQoY2FwYWJpbGl0aWVzRG9jKTsKICAgIGNvbnN0IGNvbnRlbnRzRWwgPSBmaW5kQ2hpbGRFbGVtZW50KHJvb3RFbCwgIkNvbnRlbnRzIik7CiAgICBmdW5jdGlvbiBwYXJzZU1hdHJpeFNldExpbmsoZWxlbWVudCkgewogICAgICBjb25zdCBmdWxsTWF0cml4U2V0ID0gZmluZENoaWxkcmVuRWxlbWVudChjb250ZW50c0VsLCAiVGlsZU1hdHJpeFNldCIpLmZpbmQoCiAgICAgICAgKGVsKSA9PiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsLCAiSWRlbnRpZmllciIpKQogICAgICApOwogICAgICByZXR1cm4gewogICAgICAgIGlkZW50aWZpZXI6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIlRpbGVNYXRyaXhTZXQiKSksCiAgICAgICAgY3JzOiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGZ1bGxNYXRyaXhTZXQsICJTdXBwb3J0ZWRDUlMiKSksCiAgICAgICAgbGltaXRzOiBmaW5kQ2hpbGRyZW5FbGVtZW50KGVsZW1lbnQsICJUaWxlTWF0cml4TGltaXRzIiwgdHJ1ZSkubWFwKAogICAgICAgICAgKGVsZW1lbnQyKSA9PiAoewogICAgICAgICAgICB0aWxlTWF0cml4OiBnZXRFbGVtZW50VGV4dChmaW5kQ2hpbGRFbGVtZW50KGVsZW1lbnQyLCAiVGlsZU1hdHJpeCIpKSwKICAgICAgICAgICAgbWluVGlsZVJvdzogcGFyc2VJbnQoCiAgICAgICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIk1pblRpbGVSb3ciKSkKICAgICAgICAgICAgKSwKICAgICAgICAgICAgbWluVGlsZUNvbDogcGFyc2VJbnQoCiAgICAgICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIk1pblRpbGVDb2wiKSkKICAgICAgICAgICAgKSwKICAgICAgICAgICAgbWF4VGlsZVJvdzogcGFyc2VJbnQoCiAgICAgICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIk1heFRpbGVSb3ciKSkKICAgICAgICAgICAgKSwKICAgICAgICAgICAgbWF4VGlsZUNvbDogcGFyc2VJbnQoCiAgICAgICAgICAgICAgZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIk1heFRpbGVDb2wiKSkKICAgICAgICAgICAgKQogICAgICAgICAgfSkKICAgICAgICApCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBnZXRUaWxlT3BlcmF0aW9uID0gZmluZENoaWxkcmVuRWxlbWVudCgKICAgICAgZmluZENoaWxkRWxlbWVudChyb290RWwsICJPcGVyYXRpb25zTWV0YWRhdGEiKSwKICAgICAgIk9wZXJhdGlvbiIKICAgICkuZmluZCgoZWwpID0+IGdldEVsZW1lbnRBdHRyaWJ1dGUoZWwsICJuYW1lIikgPT0gIkdldFRpbGUiKTsKICAgIGNvbnN0IGdldEt2cEVsdCA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZ2V0VGlsZU9wZXJhdGlvbiwgIkdldCIsIHRydWUpLmZpbHRlcigKICAgICAgKGVsdCkgPT4gewogICAgICAgIGNvbnN0IGVuY29kaW5nVHlwZSA9IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWx0LCAiVmFsdWUiLCB0cnVlKSk7CiAgICAgICAgcmV0dXJuIGVuY29kaW5nVHlwZS50b0xvd2VyQ2FzZSgpID09PSAia3ZwIjsKICAgICAgfQogICAgKVswXTsKICAgIGNvbnN0IGdldEt2cFVybCA9IGdldEt2cEVsdCA/IGdldEVsZW1lbnRBdHRyaWJ1dGUoZ2V0S3ZwRWx0LCAieGxpbms6aHJlZiIpIDogIiI7CiAgICBjb25zdCBjb250ZW50cyA9IGZpbmRDaGlsZEVsZW1lbnQocm9vdEVsLCAiQ29udGVudHMiKTsKICAgIGNvbnN0IGxheWVycyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoY29udGVudHMsICJMYXllciIpOwogICAgcmV0dXJuIGxheWVycy5tYXAoKGVsZW1lbnQpID0+IHsKICAgICAgY29uc3QgbGF0TG9uQm91bmRpbmdCb3ggPSBwYXJzZUJCb3goCiAgICAgICAgZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiV0dTODRCb3VuZGluZ0JveCIpCiAgICAgICk7CiAgICAgIGxldCBkZWZhdWx0U3R5bGUgPSAiIjsKICAgICAgY29uc3Qgc3R5bGVzID0gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCAiU3R5bGUiKS5tYXAoKGVsZW1lbnQyKSA9PiB7CiAgICAgICAgY29uc3QgbGVnZW5kVXJsID0gZ2V0RWxlbWVudEF0dHJpYnV0ZSgKICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJMZWdlbmRVUkwiKSwKICAgICAgICAgICJ4bGluazpocmVmIgogICAgICAgICk7CiAgICAgICAgY29uc3Qgc3R5bGUgPSB7CiAgICAgICAgICB0aXRsZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIlRpdGxlIikpLAogICAgICAgICAgbmFtZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIklkZW50aWZpZXIiKSksCiAgICAgICAgICAuLi5sZWdlbmRVcmwgJiYgeyBsZWdlbmRVcmwgfQogICAgICAgIH07CiAgICAgICAgaWYgKGdldEVsZW1lbnRBdHRyaWJ1dGUoZWxlbWVudDIsICJpc0RlZmF1bHQiKSA9PT0gInRydWUiKSB7CiAgICAgICAgICBkZWZhdWx0U3R5bGUgPSBzdHlsZS5uYW1lOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3R5bGU7CiAgICAgIH0pOwogICAgICBjb25zdCBvdXRwdXRGb3JtYXRzID0gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCAiRm9ybWF0IikubWFwKAogICAgICAgIGdldEVsZW1lbnRUZXh0CiAgICAgICk7CiAgICAgIGNvbnN0IHJlc291cmNlTGlua3MgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KAogICAgICAgIGVsZW1lbnQsCiAgICAgICAgIlJlc291cmNlVVJMIgogICAgICApLmZpbHRlcigKICAgICAgICAoZWxlbWVudDIpID0+IGdldEVsZW1lbnRBdHRyaWJ1dGUoZWxlbWVudDIsICJyZXNvdXJjZVR5cGUiKSA9PT0gInRpbGUiCiAgICAgICkubWFwKChlbGVtZW50MikgPT4gewogICAgICAgIGNvbnN0IGZvcm1hdCA9IGdldEVsZW1lbnRBdHRyaWJ1dGUoZWxlbWVudDIsICJmb3JtYXQiKTsKICAgICAgICBjb25zdCB1cmwgPSBnZXRFbGVtZW50QXR0cmlidXRlKGVsZW1lbnQyLCAidGVtcGxhdGUiKTsKICAgICAgICByZXR1cm4geyBmb3JtYXQsIHVybCwgZW5jb2Rpbmc6ICJSRVNUIiB9OwogICAgICB9KTsKICAgICAgaWYgKGdldEt2cFVybCkgewogICAgICAgIHJlc291cmNlTGlua3MucHVzaCgKICAgICAgICAgIC4uLm91dHB1dEZvcm1hdHMubWFwKChmb3JtYXQpID0+ICh7CiAgICAgICAgICAgIGVuY29kaW5nOiAiS1ZQIiwKICAgICAgICAgICAgdXJsOiBnZXRLdnBVcmwsCiAgICAgICAgICAgIGZvcm1hdAogICAgICAgICAgfSkpCiAgICAgICAgKTsKICAgICAgfQogICAgICBjb25zdCBtYXRyaXhTZXRzID0gZmluZENoaWxkcmVuRWxlbWVudChlbGVtZW50LCAiVGlsZU1hdHJpeFNldExpbmsiKS5tYXAoCiAgICAgICAgcGFyc2VNYXRyaXhTZXRMaW5rCiAgICAgICk7CiAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBmaW5kQ2hpbGRyZW5FbGVtZW50KGVsZW1lbnQsICJEaW1lbnNpb24iKS5tYXAoCiAgICAgICAgKGVsZW1lbnQyKSA9PiB7CiAgICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gZ2V0RWxlbWVudFRleHQoCiAgICAgICAgICAgIGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudDIsICJJZGVudGlmaWVyIikKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBnZXRFbGVtZW50VGV4dCgKICAgICAgICAgICAgZmluZENoaWxkRWxlbWVudChlbGVtZW50MiwgIkRlZmF1bHQiKQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IGZpbmRDaGlsZHJlbkVsZW1lbnQoZWxlbWVudDIsICJWYWx1ZXMiKS5tYXAoCiAgICAgICAgICAgIGdldEVsZW1lbnRUZXh0CiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuIHsgaWRlbnRpZmllciwgZGVmYXVsdFZhbHVlLCB2YWx1ZXMgfTsKICAgICAgICB9CiAgICAgICk7CiAgICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiSWRlbnRpZmllciIpKSwKICAgICAgICB0aXRsZTogZ2V0RWxlbWVudFRleHQoZmluZENoaWxkRWxlbWVudChlbGVtZW50LCAiVGl0bGUiKSksCiAgICAgICAgYWJzdHJhY3Q6IGdldEVsZW1lbnRUZXh0KGZpbmRDaGlsZEVsZW1lbnQoZWxlbWVudCwgIkFic3RyYWN0IikpLAogICAgICAgIHN0eWxlcywKICAgICAgICByZXNvdXJjZUxpbmtzLAogICAgICAgIG1hdHJpeFNldHMsCiAgICAgICAgZGVmYXVsdFN0eWxlLAogICAgICAgIC4uLmxhdExvbkJvdW5kaW5nQm94ICYmIHsgbGF0TG9uQm91bmRpbmdCb3ggfSwKICAgICAgICAuLi5kaW1lbnNpb25zICYmIHsgZGltZW5zaW9ucyB9CiAgICAgIH07CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcGFyc2VGZWF0dXJlUHJvcHMoZ2V0RmVhdHVyZXNEb2MsIGZlYXR1cmVUeXBlRnVsbCwgc2VydmljZVZlcnNpb24pIHsKICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRSb290RWxlbWVudChnZXRGZWF0dXJlc0RvYyk7CiAgICBsZXQgbWVtYmVyczsKICAgIGlmIChzZXJ2aWNlVmVyc2lvbi5zdGFydHNXaXRoKCIyLjAiKSkgewogICAgICBtZW1iZXJzID0gZmluZENoaWxkcmVuRWxlbWVudChjb2xsZWN0aW9uLCAibWVtYmVyIikubWFwKAogICAgICAgIChwYXJlbnQpID0+IGdldENoaWxkcmVuRWxlbWVudChwYXJlbnQpWzBdCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBtZW1iZXJzUm9vdCA9IGZpbmRDaGlsZEVsZW1lbnQoY29sbGVjdGlvbiwgImZlYXR1cmVNZW1iZXJzIik7CiAgICAgIG1lbWJlcnMgPSBtZW1iZXJzUm9vdCA/IGdldENoaWxkcmVuRWxlbWVudChtZW1iZXJzUm9vdCkgOiBmaW5kQ2hpbGRyZW5FbGVtZW50KGNvbGxlY3Rpb24sICJmZWF0dXJlTWVtYmVyIikubWFwKAogICAgICAgIChwYXJlbnQpID0+IGdldENoaWxkcmVuRWxlbWVudChwYXJlbnQpWzBdCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBpZEF0dHIgPSBzZXJ2aWNlVmVyc2lvbiA9PT0gIjEuMC4wIiA/ICJmaWQiIDogImdtbDppZCI7CiAgICBmdW5jdGlvbiBpc0VsZW1lbnRQcm9wZXJ0eShwcm9wTmFtZSkgewogICAgICByZXR1cm4gcHJvcE5hbWUgaW4gZmVhdHVyZVR5cGVGdWxsLnByb3BlcnRpZXM7CiAgICB9CiAgICBmdW5jdGlvbiBwYXJzZUVsZW1lbnRQcm9wZXJ0eVZhbHVlKHByb3BOYW1lLCB2YWx1ZUFzU3RyaW5nKSB7CiAgICAgIGNvbnN0IHR5cGUgPSBmZWF0dXJlVHlwZUZ1bGwucHJvcGVydGllc1twcm9wTmFtZV07CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgImludGVnZXIiOgogICAgICAgICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlQXNTdHJpbmcpOwogICAgICAgIGNhc2UgImZsb2F0IjoKICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlQXNTdHJpbmcpOwogICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgcmV0dXJuIHZhbHVlQXNTdHJpbmcgPT09ICJ0cnVlIjsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHZhbHVlQXNTdHJpbmc7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldFByb3BlcnRpZXMobWVtYmVyRWwpIHsKICAgICAgcmV0dXJuIGdldENoaWxkcmVuRWxlbWVudChtZW1iZXJFbCkuZmlsdGVyKChlbCkgPT4gaXNFbGVtZW50UHJvcGVydHkoc3RyaXBOYW1lc3BhY2UoZ2V0RWxlbWVudE5hbWUoZWwpKSkpLnJlZHVjZSgocHJldiwgY3VycikgPT4gewogICAgICAgIGNvbnN0IHByb3BOYW1lID0gc3RyaXBOYW1lc3BhY2UoZ2V0RWxlbWVudE5hbWUoY3VycikpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5wcmV2LAogICAgICAgICAgW3Byb3BOYW1lXTogcGFyc2VFbGVtZW50UHJvcGVydHlWYWx1ZShwcm9wTmFtZSwgZ2V0RWxlbWVudFRleHQoY3VycikpCiAgICAgICAgfTsKICAgICAgfSwge30pOwogICAgfQogICAgcmV0dXJuIG1lbWJlcnMubWFwKChlbCkgPT4gKHsKICAgICAgaWQ6IGdldEVsZW1lbnRBdHRyaWJ1dGUoZWwsIGlkQXR0ciksCiAgICAgIHByb3BlcnRpZXM6IGdldFByb3BlcnRpZXMoZWwpCiAgICB9KSk7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVGZWF0dXJlUHJvcHNEZXRhaWxzKGZlYXR1cmVzV2l0aFByb3BzKSB7CiAgICByZXR1cm4gZmVhdHVyZXNXaXRoUHJvcHMucmVkdWNlKChwcmV2LCBjdXJyKSA9PiB7CiAgICAgIGZvciAoY29uc3QgcHJvcE5hbWUgaW4gY3Vyci5wcm9wZXJ0aWVzKSB7CiAgICAgICAgY29uc3QgcHJvcFZhbHVlID0gY3Vyci5wcm9wZXJ0aWVzW3Byb3BOYW1lXTsKICAgICAgICBpZiAoIShwcm9wTmFtZSBpbiBwcmV2KSkgewogICAgICAgICAgcHJldltwcm9wTmFtZV0gPSB7IHVuaXF1ZVZhbHVlczogW10gfTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdW5pcXVlVmFsdWUgPSBwcmV2W3Byb3BOYW1lXS51bmlxdWVWYWx1ZXMuZmluZCgKICAgICAgICAgICh2KSA9PiB2LnZhbHVlID09PSBwcm9wVmFsdWUKICAgICAgICApOwogICAgICAgIGlmICh1bmlxdWVWYWx1ZSkKICAgICAgICAgIHVuaXF1ZVZhbHVlLmNvdW50Kys7CiAgICAgICAgZWxzZQogICAgICAgICAgcHJldltwcm9wTmFtZV0udW5pcXVlVmFsdWVzLnB1c2goeyB2YWx1ZTogcHJvcFZhbHVlLCBjb3VudDogMSB9KTsKICAgICAgfQogICAgICByZXR1cm4gcHJldjsKICAgIH0sIHt9KTsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVHZXRGZWF0dXJlVXJsKHNlcnZpY2VVcmwsIHZlcnNpb24sIGZlYXR1cmVUeXBlLCBvdXRwdXRGb3JtYXQsIG1heEZlYXR1cmVzLCBhdHRyaWJ1dGVzLCBoaXRzT25seSwgb3V0cHV0Q3JzLCBleHRlbnQsIGV4dGVudENycykgewogICAgY29uc3QgdHlwZVBhcmFtID0gdmVyc2lvbiA9PT0gIjIuMC4wIiA/ICJUWVBFTkFNRVMiIDogIlRZUEVOQU1FIjsKICAgIGNvbnN0IGNvdW50UGFyYW0gPSB2ZXJzaW9uID09PSAiMi4wLjAiID8gIkNPVU5UIiA6ICJNQVhGRUFUVVJFUyI7CiAgICBjb25zdCBuZXdQYXJhbXMgPSB7CiAgICAgIFNFUlZJQ0U6ICJXRlMiLAogICAgICBSRVFVRVNUOiAiR2V0RmVhdHVyZSIsCiAgICAgIFZFUlNJT046IHZlcnNpb24sCiAgICAgIFt0eXBlUGFyYW1dOiBmZWF0dXJlVHlwZQogICAgfTsKICAgIGlmIChvdXRwdXRGb3JtYXQgIT09IHZvaWQgMCkKICAgICAgbmV3UGFyYW1zLk9VVFBVVEZPUk1BVCA9IG91dHB1dEZvcm1hdDsKICAgIGlmIChhdHRyaWJ1dGVzICE9PSB2b2lkIDApCiAgICAgIG5ld1BhcmFtcy5QUk9QRVJUWU5BTUUgPSBhdHRyaWJ1dGVzLmpvaW4oIiwiKTsKICAgIGlmIChoaXRzT25seSkgewogICAgICBuZXdQYXJhbXMuUkVTVUxUVFlQRSA9ICJoaXRzIjsKICAgICAgbmV3UGFyYW1zW2NvdW50UGFyYW1dID0gIjEiOwogICAgfSBlbHNlIGlmIChtYXhGZWF0dXJlcyAhPT0gdm9pZCAwKQogICAgICBuZXdQYXJhbXNbY291bnRQYXJhbV0gPSBtYXhGZWF0dXJlcy50b1N0cmluZygxMCk7CiAgICBpZiAob3V0cHV0Q3JzKSB7CiAgICAgIG5ld1BhcmFtcy5TUlNOQU1FID0gb3V0cHV0Q3JzOwogICAgfQogICAgaWYgKGV4dGVudCkgewogICAgICBjb25zdCBleHRlbnRKb2luZWQgPSBleHRlbnQuam9pbigiLCIpOwogICAgICBuZXdQYXJhbXMuQkJPWCA9IGV4dGVudENycyA/IGAke2V4dGVudEpvaW5lZH0sJHtleHRlbnRDcnN9YCA6IGV4dGVudEpvaW5lZDsKICAgIH0KICAgIHJldHVybiBzZXRRdWVyeVBhcmFtcyhzZXJ2aWNlVXJsLCBuZXdQYXJhbXMpOwogIH0KICBhZGRUYXNrSGFuZGxlcigKICAgICJwYXJzZVdtc0NhcGFiaWxpdGllcyIsCiAgICBnbG9iYWxUaGlzLAogICAgKHsgdXJsIH0pID0+IHF1ZXJ5WG1sRG9jdW1lbnQodXJsKS50aGVuKCh4bWxEb2MpID0+ICh7CiAgICAgIGluZm86IHJlYWRJbmZvRnJvbUNhcGFiaWxpdGllcyQyKHhtbERvYyksCiAgICAgIGxheWVyczogcmVhZExheWVyc0Zyb21DYXBhYmlsaXRpZXMkMSh4bWxEb2MpLAogICAgICB2ZXJzaW9uOiByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMkMSh4bWxEb2MpCiAgICB9KSkKICApOwogIGFkZFRhc2tIYW5kbGVyKAogICAgInBhcnNlV2ZzQ2FwYWJpbGl0aWVzIiwKICAgIGdsb2JhbFRoaXMsCiAgICAoeyB1cmwgfSkgPT4gcXVlcnlYbWxEb2N1bWVudCh1cmwpLnRoZW4oKHhtbERvYykgPT4gKHsKICAgICAgaW5mbzogcmVhZEluZm9Gcm9tQ2FwYWJpbGl0aWVzJDEoeG1sRG9jKSwKICAgICAgZmVhdHVyZVR5cGVzOiByZWFkRmVhdHVyZVR5cGVzRnJvbUNhcGFiaWxpdGllcyh4bWxEb2MpLAogICAgICB2ZXJzaW9uOiByZWFkVmVyc2lvbkZyb21DYXBhYmlsaXRpZXMoeG1sRG9jKQogICAgfSkpCiAgKTsKICBhZGRUYXNrSGFuZGxlcigKICAgICJxdWVyeVdmc0ZlYXR1cmVUeXBlRGV0YWlscyIsCiAgICBnbG9iYWxUaGlzLAogICAgKHsKICAgICAgdXJsLAogICAgICBzZXJ2aWNlVmVyc2lvbiwKICAgICAgZmVhdHVyZVR5cGVGdWxsCiAgICB9KSA9PiB7CiAgICAgIGNvbnN0IGdldEZlYXR1cmVVcmwgPSBnZW5lcmF0ZUdldEZlYXR1cmVVcmwoCiAgICAgICAgdXJsLAogICAgICAgIHNlcnZpY2VWZXJzaW9uLAogICAgICAgIGZlYXR1cmVUeXBlRnVsbC5uYW1lLAogICAgICAgIHZvaWQgMCwKICAgICAgICB2b2lkIDAsCiAgICAgICAgT2JqZWN0LmtleXMoZmVhdHVyZVR5cGVGdWxsLnByb3BlcnRpZXMpCiAgICAgICk7CiAgICAgIHJldHVybiBxdWVyeVhtbERvY3VtZW50KGdldEZlYXR1cmVVcmwpLnRoZW4oKGdldEZlYXR1cmVEb2MpID0+ICh7CiAgICAgICAgcHJvcHM6IGNvbXB1dGVGZWF0dXJlUHJvcHNEZXRhaWxzKAogICAgICAgICAgcGFyc2VGZWF0dXJlUHJvcHMoZ2V0RmVhdHVyZURvYywgZmVhdHVyZVR5cGVGdWxsLCBzZXJ2aWNlVmVyc2lvbikKICAgICAgICApCiAgICAgIH0pKTsKICAgIH0KICApOwogIGFkZFRhc2tIYW5kbGVyKAogICAgInVwZGF0ZUZldGNoT3B0aW9ucyIsCiAgICBnbG9iYWxUaGlzLAogICAgKHsgb3B0aW9ucyB9KSA9PiB7CiAgICAgIHNldEZldGNoT3B0aW9ucyhvcHRpb25zKTsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7fSk7CiAgICB9CiAgKTsKICBhZGRUYXNrSGFuZGxlcigKICAgICJwYXJzZVdtdHNDYXBhYmlsaXRpZXMiLAogICAgZ2xvYmFsVGhpcywKICAgICh7IHVybCB9KSA9PiBxdWVyeVhtbERvY3VtZW50KHVybCkudGhlbigoeG1sRG9jKSA9PiAoewogICAgICBpbmZvOiByZWFkSW5mb0Zyb21DYXBhYmlsaXRpZXMoeG1sRG9jKSwKICAgICAgbGF5ZXJzOiByZWFkTGF5ZXJzRnJvbUNhcGFiaWxpdGllcyh4bWxEb2MpLAogICAgICBtYXRyaXhTZXRzOiByZWFkTWF0cml4U2V0c0Zyb21DYXBhYmlsaXRpZXMoeG1sRG9jKQogICAgfSkpCiAgKTsKfSkoKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9d29ya2VyLWsxSnFLZGhHLmpzLm1hcAo=",blob="undefined"!=typeof window&&window.Blob&&new Blob([atob(encodedJs)],{type:"text/javascript;charset=utf-8"});function WorkerWrapper(options){let objURL;try{if(objURL=blob&&(window.URL||window.webkitURL).createObjectURL(blob),!objURL)throw"";const worker=new Worker(objURL,{name:null==options?void 0:options.name});return worker.addEventListener("error",(()=>{(window.URL||window.webkitURL).revokeObjectURL(objURL)})),worker}catch(e){return new Worker("data:text/javascript;base64,"+encodedJs,{name:null==options?void 0:options.name})}finally{objURL&&(window.URL||window.webkitURL).revokeObjectURL(objURL)}}let workerInstance,fallbackWithoutWorker=!1;function getWorkerInstance(){return fallbackWithoutWorker?null:(workerInstance||(workerInstance=new WorkerWrapper),workerInstance)}var browser=__webpack_require__("./node_modules/@camptocamp/ogc-client/node_modules/@rgrove/parse-xml/dist/browser.js");class XmlParseError extends Error{constructor(message){super(message)}}function stripNamespace(name){const colon=name.indexOf(":");return colon>-1?name.substr(colon+1):name}function getRootElement(xmlDoc){return xmlDoc.children[0]}function getElementName(element){return element.name||""}function findChildrenElement(element,name,nested=!1){const strippedName=stripNamespace(name);return element&&Array.isArray(element.children)?element.children.reduce((function reducer(prev,curr){return stripNamespace(getElementName(curr))===strippedName&&prev.push(curr),nested&&Array.isArray(curr.children)?[...prev,...curr.children.reduce(reducer,[])]:prev}),[]):[]}function findChildElement(element,name,nested=!1){return findChildrenElement(element,name,nested)[0]||null}function getChildrenElement(element){return element&&Array.isArray(element.children)?[...element.children.filter((el=>el instanceof browser.XmlElement))]:[]}function getElementText(element){const textNode=element&&Array.isArray(element.children)?element.children.find((node=>"text"===node.type)):null;return textNode?textNode.text:""}function getElementAttribute(element,attrName){return element&&element.attributes[attrName]||""}class EndpointError extends Error{constructor(message,httpStatus,isCrossOriginRelated){super(message),this.message=message,this.httpStatus=httpStatus,this.isCrossOriginRelated=isCrossOriginRelated}}const ENCODINGS=["utf-8","utf-16","iso-8859-1"],FALLBACK_ENCODING="utf-8";const fetchPromises=new Map;let fetchOptions={},fetchOptionsUpdateCallback=null;function getFetchOptions(){return fetchOptions}function sharedFetch(url,method="GET"){const fetchKey=`${method}#${url}`;if(fetchPromises.has(fetchKey))return fetchPromises.get(fetchKey);const promise=fetch(url,{...getFetchOptions(),method}).catch((e=>e)).then((resp=>(fetchPromises.delete(fetchKey),resp)));return fetchPromises.set(fetchKey,promise),promise.then((resp=>{if(resp instanceof Error)throw resp;return resp}))}function queryXmlDocument(url){return sharedFetch(url).catch((()=>fetch(url,{...getFetchOptions(),method:"HEAD",mode:"no-cors"}).catch((error=>{throw new EndpointError(`Fetching the document failed either due to network errors or unreachable host, error is: ${error.message}`,0,!1)})).then((()=>{throw new EndpointError("The document could not be fetched due to CORS limitations",0,!0)})))).then(function(){var _ref=(0,asyncToGenerator.Z)((function*(resp){if(!resp.ok){const text=yield resp.text();throw new EndpointError(`Received an error with code ${resp.status}: ${text}`,resp.status,!1)}return function decodeString(buffer,contentType){const encodingHint=contentType?function extractEncoding(contentType){const matches=/charset=([^;]+)/.exec(contentType);return matches?matches[1]:null}(contentType):null,encodingAttempts=encodingHint?[encodingHint,...ENCODINGS]:ENCODINGS;for(const encoding of encodingAttempts)try{return new TextDecoder(encoding,{fatal:!0}).decode(buffer)}catch(e){}return console.warn(`[ogc-client] XML document encoding could not be determined, falling back to ${FALLBACK_ENCODING}.`),new TextDecoder(FALLBACK_ENCODING).decode(buffer)}(yield resp.arrayBuffer(),resp.headers.get("Content-Type"))}));return function(_x){return _ref.apply(this,arguments)}}()).then((xml=>function parseXmlString(xmlString){let doc=null;try{doc=(0,browser.parseXml)(xmlString)}catch(e){throw new XmlParseError(e.message)}return doc}(xml)))}function setQueryParams(url,params){const encodedUrlMatch=url.match(/(https?%3A%2F%2F[^/]+)$/);if(encodedUrlMatch){const encodedUrl=encodedUrlMatch[1],modifiedUrl=setQueryParams(decodeURIComponent(encodedUrl),params);return url.replace(encodedUrl,encodeURIComponent(modifiedUrl))}const urlObj=new URL(url),keys=Object.keys(params),keysLower=keys.map((key=>key.toLowerCase())),toDelete=[];for(const param of urlObj.searchParams.keys())keysLower.indexOf(param.toLowerCase())>-1&&toDelete.push(param);return toDelete.map((param=>urlObj.searchParams.delete(param))),keys.forEach((key=>urlObj.searchParams.set(key,!0===params[key]?"":params[key]))),urlObj.toString()}function getTypeFromXsdType(xsdType){switch(xsdType.indexOf(":")>-1?xsdType.substr(xsdType.indexOf(":")+1):xsdType){case"string":default:return"string";case"boolean":return"boolean";case"float":case"double":case"decimal":return"float";case"long":case"byte":case"integer":case"int":case"positiveInteger":case"negativeInteger":case"nonPositiveInteger":case"nonNegativeInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":return"integer"}}let cachePromise,cacheExpiryDuration=36e5;function getCache(){return void 0!==cachePromise?cachePromise:"caches"in globalThis?(cachePromise=caches.open("ogc-client").catch((e=>(console.info("[ogc-client] Cache could not be accessed for the following reason:",e),null))),cachePromise):(cachePromise=Promise.resolve(null),cachePromise)}function _storeCacheEntry(){return(_storeCacheEntry=(0,asyncToGenerator.Z)((function*(object,...keys){const cache=yield getCache();if(!cache)return;const entryUrl="https://cache/"+keys.join("/");yield cache.put(entryUrl,new Response(JSON.stringify(object),{headers:{"x-expiry":(Date.now()+cacheExpiryDuration).toString(10)}}))}))).apply(this,arguments)}function _hasValidCacheEntry(){return(_hasValidCacheEntry=(0,asyncToGenerator.Z)((function*(...keys){const cache=yield getCache();if(!cache)return;const entryUrl="https://cache/"+keys.join("/");return cache.match(entryUrl).then((req=>!!req&&parseInt(req.headers.get("x-expiry"))>Date.now()))}))).apply(this,arguments)}function _readCacheEntry(){return(_readCacheEntry=(0,asyncToGenerator.Z)((function*(...keys){const cache=yield getCache();if(!cache)return;const entryUrl="https://cache/"+keys.join("/"),response=yield cache.match(entryUrl);return response?response.clone().json():null}))).apply(this,arguments)}const tasksMap=new Map;function useCache(_x2){return _useCache.apply(this,arguments)}function _useCache(){return _useCache=(0,asyncToGenerator.Z)((function*(factory,...keys){if(yield function purgeEntries(){return _purgeEntries.apply(this,arguments)}(),yield function hasValidCacheEntry(){return _hasValidCacheEntry.apply(this,arguments)}(...keys))return function readCacheEntry(){return _readCacheEntry.apply(this,arguments)}(...keys);const taskKey=keys.join("#");if(tasksMap.has(taskKey))return tasksMap.get(taskKey);const taskRun=factory();taskRun instanceof Promise&&(taskRun.then((()=>tasksMap.delete(taskKey))),tasksMap.set(taskKey,taskRun));const result=yield taskRun;return yield function storeCacheEntry(_x){return _storeCacheEntry.apply(this,arguments)}(result,...keys),result})),_useCache.apply(this,arguments)}function _purgeEntries(){return(_purgeEntries=(0,asyncToGenerator.Z)((function*(){const cache=yield getCache();if(!cache)return;const keys=yield cache.keys();for(const key of keys){const resp=yield cache.match(key);parseInt(resp.headers.get("x-expiry"))<=Date.now()&&(yield cache.delete(key))}}))).apply(this,arguments)}function generateGetFeatureUrl(serviceUrl,version,featureType,outputFormat,maxFeatures,attributes,hitsOnly,outputCrs,extent,extentCrs){const countParam="2.0.0"===version?"COUNT":"MAXFEATURES",newParams={SERVICE:"WFS",REQUEST:"GetFeature",VERSION:version,["2.0.0"===version?"TYPENAMES":"TYPENAME"]:featureType};if(void 0!==outputFormat&&(newParams.OUTPUTFORMAT=outputFormat),void 0!==attributes&&(newParams.PROPERTYNAME=attributes.join(",")),hitsOnly?(newParams.RESULTTYPE="hits",newParams[countParam]="1"):void 0!==maxFeatures&&(newParams[countParam]=maxFeatures.toString(10)),outputCrs&&(newParams.SRSNAME=outputCrs),extent){const extentJoined=extent.join(",");newParams.BBOX=extentCrs?`${extentJoined},${extentCrs}`:extentJoined}return setQueryParams(serviceUrl,newParams)}function isMimeTypeJson(mimeType){return mimeType.toLowerCase().indexOf("json")>-1}function isMimeTypeGeoJson(mimeType){return/geo.?json/.test(mimeType)}function isMimeTypeJsonFg(mimeType){return/json.?fg|fg.?json/.test(mimeType)}class WfsEndpoint{_capabilitiesUrl;_capabilitiesPromise;_info;_featureTypes;_version;constructor(url){this._capabilitiesUrl=setQueryParams(url,{SERVICE:"WFS",REQUEST:"GetCapabilities"}),this._capabilitiesPromise=useCache((()=>function parseWfsCapabilities(capabilitiesUrl){return sendTaskRequest("parseWfsCapabilities",getWorkerInstance(),{url:capabilitiesUrl})}(this._capabilitiesUrl)),"WFS","CAPABILITIES",this._capabilitiesUrl).then((({info,featureTypes,version})=>{this._info=info,this._featureTypes=featureTypes,this._version=version}))}isReady(){return this._capabilitiesPromise.then((()=>this))}getServiceInfo(){return this._info}getFeatureTypes(){return this._featureTypes.map((featureType=>({name:featureType.name,..."title"in featureType&&{title:featureType.title},..."abstract"in featureType&&{abstract:featureType.abstract},..."latLonBoundingBox"in featureType&&{boundingBox:featureType.latLonBoundingBox}})))}_getFeatureTypeByName(name){if(!this._featureTypes)return null;const isQualified=stripNamespace(name)!==name;return this._featureTypes.find((featureType=>isQualified?featureType.name===name:stripNamespace(featureType.name)===name))||null}getFeatureTypeSummary(name){const featureType=this._getFeatureTypeByName(name);return featureType?{name:featureType.name,..."title"in featureType&&{title:featureType.title},..."abstract"in featureType&&{abstract:featureType.abstract},..."latLonBoundingBox"in featureType&&{boundingBox:featureType.latLonBoundingBox},defaultCrs:featureType.defaultCrs,otherCrs:featureType.otherCrs,outputFormats:featureType.outputFormats}:null}getFeatureTypeFull(name){const featureType=this._getFeatureTypeByName(name);return featureType?useCache((()=>{const describeUrl=function generateDescribeFeatureTypeUrl(serviceUrl,version,featureType){return setQueryParams(serviceUrl,{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:version,["2.0.0"===version?"TYPENAMES":"TYPENAME"]:featureType})}(this._capabilitiesUrl,this._version,name),getFeatureUrl=generateGetFeatureUrl(this._capabilitiesUrl,this._version,name,void 0,void 0,void 0,!0);return Promise.all([queryXmlDocument(describeUrl),queryXmlDocument(getFeatureUrl)]).then((([describeResponse,getFeatureResponse])=>function parseFeatureTypeInfo(featureType,describeFeatureTypeDoc,getFeatureHitsDoc,serviceVersion){const{name,title,abstract,defaultCrs,otherCrs,outputFormats,latLonBoundingBox:boundingBox}=featureType,hitsAttr=serviceVersion.startsWith("2.0")?"numberMatched":"numberOfFeatures",objectCount=parseInt(getElementAttribute(getRootElement(getFeatureHitsDoc),hitsAttr)),complexTypeEl=findChildrenElement(getRootElement(describeFeatureTypeDoc),"complexType",!0)[0],typeElementsEls=findChildrenElement(complexTypeEl,"element",!0),properties=typeElementsEls.filter((el=>getElementAttribute(el,"type").startsWith("xsd:"))).reduce(((prev,curr)=>({...prev,[getElementAttribute(curr,"name")]:getTypeFromXsdType(getElementAttribute(curr,"type"))})),{}),geomEl=typeElementsEls.filter((el=>getElementAttribute(el,"type").startsWith("gml:")))[0],geometryName=geomEl?getElementAttribute(geomEl,"name"):void 0,geometryType=geomEl?function getGeomTypeFromGmlType(gmlType){switch(gmlType.indexOf(":")>-1?gmlType.substr(gmlType.indexOf(":")+1):gmlType){case"PointPropertyType":return"point";case"MultiPointPropertyType":return"multipoint";case"CurvePropertyType":case"LineStringPropertyType":case"MultiCurvePropertyType":case"MultiLineStringPropertyType":return"linestring";case"PolygonPropertyType":case"SurfacePropertyType":return"polygon";case"MultiPolygonPropertyType":case"MultiSurfacePropertyType":return"multipolygon";default:return"unknown"}}(getElementAttribute(geomEl,"type")):void 0;return{name,...title&&{title},...abstract&&{abstract},...boundingBox&&{boundingBox},...defaultCrs&&{defaultCrs},...otherCrs&&{otherCrs},...outputFormats&&{outputFormats},properties,...geometryName&&{geometryName},...geometryType&&{geometryType},...!Number.isNaN(objectCount)&&{objectCount}}}(featureType,describeResponse,getFeatureResponse,this._version)))}),"WFS","FEATURETYPEINFO",this._capabilitiesUrl,name):null}getSingleFeatureTypeName(){return this._featureTypes&&1===this._featureTypes.length?this._featureTypes[0].name:null}getFeatureTypePropDetails(name){var _this=this;return(0,asyncToGenerator.Z)((function*(){const featureTypeFull=yield _this.getFeatureTypeFull(name);return null===featureTypeFull?null:useCache((()=>function queryWfsFeatureTypeDetails(capabilitiesUrl,serviceVersion,featureTypeFull){return sendTaskRequest("queryWfsFeatureTypeDetails",getWorkerInstance(),{url:capabilitiesUrl,serviceVersion,featureTypeFull})}(_this._capabilitiesUrl,_this._version,featureTypeFull).then((result=>result.props))),"WFS","FEATURETYPEPROPDETAILS",_this._capabilitiesUrl,name)}))()}getVersion(){return this._version}_getJsonCompatibleOutputFormat(featureType){const featureTypeInfo=this._getFeatureTypeByName(featureType);if(!featureTypeInfo)throw new Error(`The following feature type was not found in the service: ${featureType}`);const candidates=featureTypeInfo.outputFormats.filter(isMimeTypeJson);return candidates.length?candidates[0]:null}supportsJson(featureType){return this._featureTypes?!!this._getJsonCompatibleOutputFormat(featureType):null}getFeatureUrl(featureType,options){if(!this._featureTypes)return null;const{maxFeatures,asJson,outputFormat,outputCrs,extent,extentCrs}=options||{},internalFeatureType=this._getFeatureTypeByName(featureType);if(!internalFeatureType)throw new Error(`The following feature type was not found in the service: ${featureType}`);let format=outputFormat;if(asJson){if(format=this._getJsonCompatibleOutputFormat(featureType)||void 0,!format)throw new Error(`The endpoint does not appear to support GeoJSON for the feature type ${internalFeatureType.name}`)}else outputFormat&&-1===internalFeatureType.outputFormats.indexOf(outputFormat)&&console.warn(`[ogc-client] The following output format type was not found in the feature type ${internalFeatureType.name}: ${outputFormat}`);return generateGetFeatureUrl(this._capabilitiesUrl,this._version,internalFeatureType.name,format,maxFeatures,void 0,void 0,outputCrs,extent,extentCrs)}}class WmsEndpoint{_capabilitiesPromise;_info;_layers;_version;constructor(url){const capabilitiesUrl=setQueryParams(url,{SERVICE:"WMS",REQUEST:"GetCapabilities"});this._capabilitiesPromise=useCache((()=>function parseWmsCapabilities(capabilitiesUrl){return sendTaskRequest("parseWmsCapabilities",getWorkerInstance(),{url:capabilitiesUrl})}(capabilitiesUrl)),"WMS","CAPABILITIES",capabilitiesUrl).then((({info,layers,version})=>{this._info=info,this._layers=layers,this._version=version}))}isReady(){return this._capabilitiesPromise.then((()=>this))}getServiceInfo(){return this._info}getLayers(){return this._layers.map((function layerSummaryMapper(layerFull){return{title:layerFull.title,name:layerFull.name,abstract:layerFull.abstract,..."children"in layerFull&&{children:layerFull.children.map(layerSummaryMapper)}}}))}getLayerByName(name){let result=null;return this._layers.map((function layerLookup(layer){null===result&&(layer.name!==name?"children"in layer&&layer.children.map(layerLookup):result=layer)})),result}getSingleLayerName(){if(!this._layers)return null;const layers=[];return this._layers.map((function layerLookup(layer){layer.name&&layers.push(layer),"children"in layer&&layer.children.map(layerLookup)})),1===layers.length?layers[0].name:null}getVersion(){return this._version}}class WmtsEndpoint{_capabilitiesPromise;_info=null;_layers=null;_matrixSets=null;constructor(url){const capabilitiesUrl=setQueryParams(url,{SERVICE:"WMTS",REQUEST:"GetCapabilities"});this._capabilitiesPromise=useCache((()=>function parseWmtsCapabilities(capabilitiesUrl){return sendTaskRequest("parseWmtsCapabilities",getWorkerInstance(),{url:capabilitiesUrl})}(capabilitiesUrl)),"WMTS","CAPABILITIES",capabilitiesUrl).then((({info,layers,matrixSets})=>{this._info=info,this._layers=layers,this._matrixSets=matrixSets}))}isReady(){return this._capabilitiesPromise.then((()=>this))}getServiceInfo(){return this._info}getLayers(){return this._layers}getMatrixSets(){return this._matrixSets}getMatrixSetByIdentifier(identifier){return this._matrixSets?this._matrixSets.find((matrixSet=>matrixSet.identifier===identifier))??null:null}getLayerByName(name){return this._layers?this._layers.find((layer=>layer.name===name))??null:null}getSingleLayerName(){return this._layers&&1===this._layers.length?this._layers[0].name:null}getLayerResourceLink(layerName,formatHint){if(!this._layers)return null;const layer=this.getLayerByName(layerName);let resourceLinkIndex=0;formatHint&&(resourceLinkIndex=layer.resourceLinks.findIndex((resourceLink2=>resourceLink2.format===formatHint))||0);const resourceLink=layer.resourceLinks[resourceLinkIndex];return formatHint&&resourceLink.format!==formatHint&&console.warn(`[ogc-client] Requested '${formatHint}' format for the WMTS layer but it is not available in REST encoding, falling back to '${resourceLink.format}'`),resourceLink}getTileUrl(layerName,styleName,matrixSetName,tileMatrix,tileRow,tileCol,outputFormat){if(!this._layers)return null;const resourceLink=this.getLayerResourceLink(layerName,outputFormat);return function generateGetTileUrl(baseUrl,requestEncoding,layerName,styleName,matrixSetName,tileMatrix,tileRow,tileCol,outputFormat){const context={layer:layerName,style:styleName,tilematrixset:matrixSetName,Service:"WMTS",Request:"GetTile",Format:outputFormat,TileMatrix:tileMatrix,TileCol:tileCol.toString(),TileRow:tileRow.toString()};if("REST"===requestEncoding){let url=baseUrl;for(const key in context)url=url.replace(new RegExp(`{${key}}`,"ig"),context[key]);return url}return setQueryParams(baseUrl,context)}(resourceLink.url,resourceLink.encoding,layerName,styleName,matrixSetName,tileMatrix,tileRow,tileCol,resourceLink.format)}getDefaultDimensions(layerName){if(!this._layers)return null;const layer=this.getLayerByName(layerName);return layer.dimensions?layer.dimensions.reduce(((prev,curr)=>({...prev,[curr.identifier]:curr.defaultValue})),{}):{}}tileGridModule;getOpenLayersTileGrid(layerName,matrixSetIdentifier){if(!this._layers)return null;this.tileGridModule||(this.tileGridModule=Promise.all([__webpack_require__.e(206),__webpack_require__.e(6586),__webpack_require__.e(7564)]).then(__webpack_require__.bind(__webpack_require__,"./node_modules/@camptocamp/ogc-client/dist/wmts/ol-tilegrid.js")).catch((e=>(console.warn("[ogc-client] Cannot use getOpenLayersTileGrid, the 'ol' package is probably not available.\n",e),null))));const layer=this.getLayerByName(layerName),matrixSetLink=layer.matrixSets.find((matrixSet2=>matrixSet2.identifier===matrixSetIdentifier))??layer.matrixSets[0],matrixSet=this.getMatrixSetByIdentifier(matrixSetLink.identifier);return this.tileGridModule.then((({buildOpenLayersTileGrid})=>buildOpenLayersTileGrid(matrixSet,matrixSetLink.limits)))}}const CollectionParameterTypes=["string","number","integer","date","point","linestring","polygon","geometry"];function fetchDocument(url){const urlObj=new URL(url,window.location.toString());urlObj.searchParams.set("f","json");const options=getFetchOptions(),optionsHeaders="headers"in options?options.headers:{};return fetch(urlObj.toString(),{...options,headers:{...optionsHeaders,Accept:"application/json"}}).then((resp=>{if(!resp.ok)throw new Error(`The document at ${urlObj} could not be fetched.`);return resp.json().catch((()=>{throw new Error(`The document at ${urlObj} does not appear to be valid JSON.`)}))}))}function fetchRoot(url){return fetchDocument(url).then((doc=>{if(!hasLinks(doc,["data","http://www.opengis.net/def/rel/ogc/1.0/data"])||!hasLinks(doc,["conformance","http://www.opengis.net/def/rel/ogc/1.0/conformance"])){let parentUrl=getParentPath(url);if(!parentUrl)throw new Error("Could not find a root JSON document containing both a link with rel='data' and a link with rel='conformance'.");if("collections"in doc){const urlObj=new URL(parentUrl);urlObj.pathname=`${urlObj.pathname}/`,parentUrl=urlObj.toString()}return fetchRoot(parentUrl)}return doc}))}function fetchCollectionRoot(url){return fetchDocument(url).then((doc=>{if(hasLinks(doc,["data","http://www.opengis.net/def/rel/ogc/1.0/data"]))return null;let parentUrl=getParentPath(url);return hasLinks(doc,["items"])?doc:("collections"in doc&&(parentUrl=`${parentUrl}/`),fetchCollectionRoot(parentUrl))}))}function getLinks(doc,relType){return doc.links?.filter((link=>Array.isArray(relType)?relType.indexOf(link.rel)>-1:link.rel===relType))||[]}function getLinkUrl(doc,relType,baseUrl){const link=getLinks(doc,relType)[0];return link?new URL(link.href,baseUrl||window.location.toString()).toString():null}function fetchLink(doc,relType,baseUrl){const url=getLinkUrl(doc,relType,baseUrl);return url?fetchDocument(url):Promise.reject(new EndpointError(`Could not find link with type: ${relType}`))}function hasLinks(doc,relType){return!!getLinkUrl(doc,relType)}function assertHasLinks(doc,relType){if(!hasLinks(doc,relType))throw new EndpointError(`Could not find link with type: ${relType}`)}function getParentPath(url){const urlObj=new URL(url,window.location.toString()),pathParts=urlObj.pathname.replace(/\/$/,"").split("/");return pathParts.length<=2?null:(urlObj.pathname=pathParts.slice(0,-1).join("/"),urlObj.toString())}function parseEndpointInfo(rootDoc){try{assertHasLinks(rootDoc,["data","http://www.opengis.net/def/rel/ogc/1.0/data"]),assertHasLinks(rootDoc,["conformance","http://www.opengis.net/def/rel/ogc/1.0/conformance"])}catch(e){throw new EndpointError(`The endpoint appears non-conforming, the following error was encountered:\n${e.message}`)}return{title:rootDoc.title,description:rootDoc.description,attribution:rootDoc.attribution}}function parseConformance(doc){return doc.conformsTo}function parseCollections(itemType=null){return doc=>doc.collections.filter((collection=>null===itemType||collection.itemType===itemType)).map((collection=>collection.id))}function checkTileConformance(conformance){return conformance.indexOf("http://www.opengis.net/spec/ogcapi-tiles-1/1.0/conf/core")>-1}function checkStyleConformance(conformance){return conformance.indexOf("http://www.opengis.net/spec/ogcapi-styles-1/0.0/conf/core")>-1}function checkHasRecords([collections,conformance]){return(["http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/record-core","http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/record-collection","http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/record-api"].every((confClass=>conformance.indexOf(confClass)>-1))||conformance.indexOf("http://www.opengis.net/spec/ogcapi-records-1/1.0/conf/core")>-1)&&collections.some((collection=>"record"===collection.itemType))}function checkHasFeatures([collections,conformance]){return conformance.indexOf("http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/core")>-1&&collections.some((collection=>"feature"===collection.itemType))}function parseCollectionParameters(doc){return"properties"in doc&&"object"==typeof doc.properties?Object.keys(doc.properties).map((name=>{const prop=doc.properties[name];let type="string";if("string"==typeof prop.$ref){const schemaRef=prop.$ref.toLowerCase();schemaRef.indexOf("point")>-1?type="point":schemaRef.indexOf("linestring")>-1?type="linestring":schemaRef.indexOf("polygon")>-1?type="polygon":schemaRef.indexOf("geometry")>-1&&(type="geometry")}else"string"==typeof prop.type&&CollectionParameterTypes.indexOf(prop.type.toLowerCase())>-1&&(type=prop.type.toLowerCase());return{name,type,..."string"==typeof prop.title&&{title:prop.title}}})):Array.isArray(doc)?doc.map((prop=>({name:prop,type:"string"}))):[]}class OgcApiEndpoint{constructor(baseUrl){this.baseUrl=baseUrl}root_;conformance_;data_;get root(){return this.root_||(this.root_=fetchRoot(this.baseUrl).catch((e=>{throw new Error(`The endpoint appears non-conforming, the following error was encountered:\n${e.message}`)}))),this.root_}get conformance(){return this.conformance_||(this.conformance_=this.root.then((root=>fetchLink(root,["conformance","http://www.opengis.net/def/rel/ogc/1.0/conformance"],this.baseUrl)))),this.conformance_}get collectionsUrl(){return this.root.then((root=>getLinkUrl(root,["data","http://www.opengis.net/def/rel/ogc/1.0/data"],this.baseUrl)))}get data(){var _this=this;return this.data_||(this.data_=this.collectionsUrl.then(fetchDocument).then(function(){var _ref=(0,asyncToGenerator.Z)((function*(data){const singleCollection=yield fetchCollectionRoot(_this.baseUrl);return null!==singleCollection&&Array.isArray(data.collections)&&(data.collections=data.collections.filter((collection=>collection.id===singleCollection.id))),data}));return function(_x){return _ref.apply(this,arguments)}}())),this.data_}get info(){return this.root.then(parseEndpointInfo)}get conformanceClasses(){return this.conformance.then(parseConformance)}get allCollections(){return this.data.then(parseCollections())}get recordCollections(){return Promise.all([this.data,this.hasRecords]).then((([data,hasRecords])=>hasRecords?data:{collections:[]})).then(parseCollections("record"))}get featureCollections(){return Promise.all([this.data,this.hasFeatures]).then((([data,hasFeatures])=>hasFeatures?data:{collections:[]})).then(parseCollections("feature"))}get hasTiles(){return this.conformanceClasses.then(checkTileConformance)}get hasStyles(){return this.conformanceClasses.then(checkStyleConformance)}get hasFeatures(){return Promise.all([this.data.then((data=>data.collections)),this.conformanceClasses]).then(checkHasFeatures)}get hasRecords(){return Promise.all([this.data.then((data=>data.collections)),this.conformanceClasses]).then(checkHasRecords)}getCollectionDocument(collectionId){var _this2=this;return Promise.all([this.allCollections,this.data]).then((([collections,data])=>{if(-1===collections.indexOf(collectionId))throw new EndpointError(`Collection not found: ${collectionId}`);return data.collections.find((collection=>collection.id===collectionId))})).then(function(){var _ref2=(0,asyncToGenerator.Z)((function*(collection){return hasLinks(collection,["self"])?fetchLink(collection,"self",_this2.baseUrl):fetchDocument(`${yield _this2.collectionsUrl}/${collectionId}`)}));return function(_x2){return _ref2.apply(this,arguments)}}())}getCollectionInfo(collectionId){var _this3=this;return(0,asyncToGenerator.Z)((function*(){const collectionDoc=yield _this3.getCollectionDocument(collectionId),baseInfo=function parseBaseCollectionInfo(doc){const{links,...props}=doc,itemFormats=links.filter((link=>"items"===link.rel)).map((link=>link.type)),bulkDownloadLinks=links.filter((link=>"enclosure"===link.rel)).reduce(((acc,link)=>(acc[link.type]=link.href,acc)),{}),mimeTypes=Object.keys(bulkDownloadLinks),jsonMimeType=mimeTypes.find(isMimeTypeJsonFg)||mimeTypes.find(isMimeTypeGeoJson)||mimeTypes.find(isMimeTypeJson);return{itemFormats,bulkDownloadLinks,jsonDownloadLink:jsonMimeType?bulkDownloadLinks[jsonMimeType]:null,...props}}(collectionDoc),[queryables,sortables]=yield Promise.all([fetchLink(collectionDoc,["queryables","http://www.opengis.net/def/rel/ogc/1.0/queryables"],_this3.baseUrl).then(parseCollectionParameters).catch((()=>[])),fetchLink(collectionDoc,["sortables","http://www.opengis.net/def/rel/ogc/1.0/sortables"],_this3.baseUrl).then(parseCollectionParameters).catch((()=>[]))]);return{...baseInfo,queryables,sortables}}))()}getCollectionItems(collectionId,limit=10,offset=0,skipGeometry=null,sortby=null,bbox=null,properties=null){return this.getCollectionDocument(collectionId).then((collectionDoc=>{const url=new URL(getLinkUrl(collectionDoc,"items",this.baseUrl),window.location.toString());return url.searchParams.set("limit",limit.toString()),url.searchParams.set("offset",offset.toString()),null!==skipGeometry&&url.searchParams.set("skipGeometry",skipGeometry.toString()),null!==sortby&&url.searchParams.set("sortby",sortby.join(",").toString()),null!==bbox&&url.searchParams.set("bbox",bbox.join(",").toString()),null!==properties&&url.searchParams.set("properties",properties.join(",").toString()),url.toString()})).then(fetchDocument).then((doc=>doc.features))}getCollectionItem(collectionId,itemId){return this.getCollectionDocument(collectionId).then((collectionDoc=>{const url=new URL(getLinkUrl(collectionDoc,"items",this.baseUrl),window.location.toString());return url.pathname+=`/${itemId}`,url.toString()})).then(fetchDocument)}getCollectionItemsUrl(collectionId,options={}){return this.getCollectionDocument(collectionId).then((collectionDoc=>{const baseUrl=this.baseUrl||"",itemLinks=getLinks(collectionDoc,"items");let url,linkWithFormat=itemLinks.find((link=>link.type===options?.outputFormat));return options.asJson&&(linkWithFormat=itemLinks.find((link=>isMimeTypeJsonFg(link.type)))||itemLinks.find((link=>isMimeTypeGeoJson(link.type)))||itemLinks.find((link=>isMimeTypeJson(link.type)))),options?.outputFormat&&!linkWithFormat?(console.warn(`[ogc-client] The following output format type was not found in the collection '${collectionId}': ${options.outputFormat}`),url=new URL(itemLinks[0].href,baseUrl),url.searchParams.set("f",options.outputFormat)):url=linkWithFormat?new URL(linkWithFormat.href,baseUrl):new URL(itemLinks[0].href,baseUrl),void 0!==options.query&&(url.search+=(url.search?"&":"")+options.query),void 0!==options.limit&&url.searchParams.set("limit",options.limit.toString()),void 0!==options.offset&&url.searchParams.set("offset",options.offset.toString()),void 0!==options.outputCrs&&url.searchParams.set("crs",options.outputCrs),void 0!==options.extent&&4===options.extent.length&&url.searchParams.set("bbox",options.extent.join(",")),void 0!==options.extentCrs&&url.searchParams.set("bbox-crs",options.extentCrs),url.toString()})).catch((error=>{throw console.error("Error fetching collection items URL:",error),error}))}}function addTaskHandler(taskName,scope,handler){const useWorker="undefined"!=typeof WorkerGlobalScope,eventHandler=function(){var _ref=(0,asyncToGenerator.Z)((function*(request){if(request.taskName===taskName){let response,error;try{response=yield handler(request.params)}catch(e){error=e}const message={taskName,requestId:request.requestId,...response&&{response},...error&&{error}};useWorker?scope.postMessage(message):scope.dispatchEvent(new CustomEvent("ogc-client.response",{detail:message}))}}));return function eventHandler(_x){return _ref.apply(this,arguments)}}();useWorker?scope.addEventListener("message",(event=>eventHandler(event.data))):scope.addEventListener("ogc-client.request",(event=>eventHandler(event.detail)))}const LatLonCrsList=["EPSG:4046","EPSG:4075","EPSG:4120","EPSG:4122","EPSG:4124","EPSG:4126","EPSG:4149","EPSG:4151","EPSG:4153","EPSG:4155","EPSG:4157","EPSG:4159","EPSG:4161","EPSG:4163","EPSG:4165","EPSG:4167","EPSG:4169","EPSG:4171","EPSG:4173","EPSG:4175","EPSG:4178","EPSG:4180","EPSG:4182","EPSG:4184","EPSG:4188","EPSG:4190","EPSG:4191","EPSG:4196","EPSG:4198","EPSG:4202","EPSG:4210","EPSG:4211","EPSG:4214","EPSG:4226","EPSG:4229","EPSG:4231","EPSG:4233","EPSG:4236","EPSG:4238","EPSG:4240","EPSG:4242","EPSG:4244","EPSG:4246","EPSG:4248","EPSG:4250","EPSG:4252","EPSG:4255","EPSG:4258","EPSG:4261","EPSG:4264","EPSG:4267","EPSG:4270","EPSG:4273","EPSG:4276","EPSG:4279","EPSG:4281","EPSG:4284","EPSG:4286","EPSG:4288","EPSG:4292","EPSG:4295","EPSG:4297","EPSG:4299","EPSG:4302","EPSG:4324","EPSG:4326"];function simplifyEpsgUrn(fullCrsName){if(/^urn:(?:x-)?ogc:def:crs:epsg:/.test(fullCrsName.toLowerCase())){return`EPSG:${/([0-9]+)$/.exec(fullCrsName)[1]}`}return fullCrsName}function readVersionFromCapabilities(capabilitiesDoc){return getRootElement(capabilitiesDoc).attributes.version}function readLayersFromCapabilities(capabilitiesDoc){const version=readVersionFromCapabilities(capabilitiesDoc);return findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"Capability"),"Layer").map((layerEl=>parseLayer(layerEl,version)))}function readInfoFromCapabilities(capabilitiesDoc){const service=findChildElement(getRootElement(capabilitiesDoc),"Service"),keywords=findChildrenElement(findChildElement(service,"KeywordList"),"Keyword").map(getElementText).filter(((v,i,arr)=>arr.indexOf(v)===i));return{title:getElementText(findChildElement(service,"Title")),name:getElementText(findChildElement(service,"Name")),abstract:getElementText(findChildElement(service,"Abstract")),fees:getElementText(findChildElement(service,"Fees")),constraints:getElementText(findChildElement(service,"AccessConstraints")),keywords}}function parseLayer(layerEl,version,inheritedSrs=[],inheritedStyles=[],inheritedAttribution=null,inheritedBoundingBoxes=null){const srsTag="1.3.0"===version?"CRS":"SRS",srsList=findChildrenElement(layerEl,srsTag).map(getElementText),availableCrs=srsList.length>0?srsList:inheritedSrs,layerStyles=findChildrenElement(layerEl,"Style").map(parseLayerStyle),styles=layerStyles.length>0?layerStyles:inheritedStyles;function parseBBox(bboxEl){return(function hasInvertedCoordinates(crsName){return LatLonCrsList.indexOf(simplifyEpsgUrn(crsName))>-1}(getElementAttribute(bboxEl,srsTag))&&"1.3.0"===version?["miny","minx","maxy","maxx"]:["minx","miny","maxx","maxy"]).map((name=>getElementAttribute(bboxEl,name)))}const attributionEl=findChildElement(layerEl,"Attribution"),attribution=null!==attributionEl?function parseLayerAttribution(attributionEl){const logoUrl=getElementAttribute(findChildElement(findChildElement(attributionEl,"LogoURL"),"OnlineResource"),"xlink:href"),url=getElementAttribute(findChildElement(attributionEl,"OnlineResource"),"xlink:href"),title=getElementText(findChildElement(attributionEl,"Title"));return{...title&&{title},...url&&{url},...logoUrl&&{logoUrl}}}(attributionEl):inheritedAttribution,latLonBboxEl=findChildElement(layerEl,"1.3.0"===version?"EX_GeographicBoundingBox":"LatLonBoundingBox"),baseBoundingBox={};latLonBboxEl&&(baseBoundingBox["EPSG:4326"]="1.3.0"===version?function parseExGeographicBoundingBox(bboxEl){return["westBoundLongitude","southBoundLatitude","eastBoundLongitude","northBoundLatitude"].map((name=>getElementText(findChildElement(bboxEl,name))))}(latLonBboxEl):function parseLatLonBoundingBox(bboxEl){return["minx","miny","maxx","maxy"].map((name=>getElementAttribute(bboxEl,name)))}(latLonBboxEl));let boundingBoxes=findChildrenElement(layerEl,"BoundingBox").reduce(((prev,bboxEl)=>({...prev,[getElementAttribute(bboxEl,srsTag)]:parseBBox(bboxEl)})),baseBoundingBox);boundingBoxes=Object.keys(boundingBoxes).length>0||null===inheritedBoundingBoxes?boundingBoxes:inheritedBoundingBoxes;const children=findChildrenElement(layerEl,"Layer").map((layer=>parseLayer(layer,version,availableCrs,styles,attribution,boundingBoxes)));return{name:getElementText(findChildElement(layerEl,"Name")),title:getElementText(findChildElement(layerEl,"Title")),abstract:getElementText(findChildElement(layerEl,"Abstract")),availableCrs,styles,attribution,boundingBoxes,...children.length&&{children}}}function parseLayerStyle(styleEl){const legendUrl=getElementAttribute(findChildElement(findChildElement(styleEl,"LegendURL"),"OnlineResource"),"xlink:href");return{name:getElementText(findChildElement(styleEl,"Name")),title:getElementText(findChildElement(styleEl,"Title")),...legendUrl&&{legendUrl}}}function capabilities_readVersionFromCapabilities(capabilitiesDoc){return getRootElement(capabilitiesDoc).attributes.version}function readOutputFormatsFromCapabilities(capabilitiesDoc){let outputFormats;if(capabilities_readVersionFromCapabilities(capabilitiesDoc).startsWith("1.0")){const getFeature=findChildElement(findChildElement(findChildElement(getRootElement(capabilitiesDoc),"Capability"),"Request"),"GetFeature");outputFormats=getChildrenElement(findChildElement(getFeature,"ResultFormat")).map(getElementName)}else{const getFeature=findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"OperationsMetadata"),"Operation").find((el=>"GetFeature"===getElementAttribute(el,"name"))),parameter=findChildrenElement(getFeature,"Parameter").find((el=>"outputFormat"===getElementAttribute(el,"name")));outputFormats=findChildrenElement(parameter,"Value",!0).map(getElementText)}return outputFormats}function capabilities_readInfoFromCapabilities(capabilitiesDoc){const version=capabilities_readVersionFromCapabilities(capabilitiesDoc),serviceTag=version.startsWith("1.0")?"Service":"ServiceIdentification",nameTag=version.startsWith("1.0")?"Name":"ServiceType",service=findChildElement(getRootElement(capabilitiesDoc),serviceTag);let keywords;return keywords=version.startsWith("1.0")?getElementText(findChildElement(service,"Keywords")).split(",").map((keyword=>keyword.trim())):findChildrenElement(findChildElement(service,"Keywords"),"Keyword").map(getElementText),{title:getElementText(findChildElement(service,"Title")),name:getElementText(findChildElement(service,nameTag)),abstract:getElementText(findChildElement(service,"Abstract")),fees:getElementText(findChildElement(service,"Fees")),constraints:getElementText(findChildElement(service,"AccessConstraints")),keywords,outputFormats:readOutputFormatsFromCapabilities(capabilitiesDoc)}}function readFeatureTypesFromCapabilities(capabilitiesDoc){const version=capabilities_readVersionFromCapabilities(capabilitiesDoc),outputFormats=readOutputFormatsFromCapabilities(capabilitiesDoc);return findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"FeatureTypeList"),"FeatureType").map((featureTypeEl=>function parseFeatureType(featureTypeEl,serviceVersion,defaultOutputFormats){const srsTag=serviceVersion.startsWith("2.")?"CRS":"SRS",defaultSrsTag=serviceVersion.startsWith("1.0")?"SRS":`Default${srsTag}`;function parseBBox100(){const bboxEl=findChildElement(featureTypeEl,"LatLongBoundingBox");return["minx","miny","maxx","maxy"].map((name=>getElementAttribute(bboxEl,name))).map(parseFloat)}function parseBBox(){const bboxEl=findChildElement(featureTypeEl,"WGS84BoundingBox");return["LowerCorner","UpperCorner"].map((elName=>findChildElement(bboxEl,elName))).map((cornerEl=>getElementText(cornerEl).split(" "))).reduce(((prev,curr)=>[...prev,...curr])).map(parseFloat)}const otherCrs=serviceVersion.startsWith("1.0")?[]:findChildrenElement(featureTypeEl,`Other${srsTag}`).map(getElementText).map(simplifyEpsgUrn),outputFormats=serviceVersion.startsWith("1.0")?[]:findChildrenElement(findChildElement(featureTypeEl,"OutputFormats"),"Format").map(getElementText);return{name:getElementText(findChildElement(featureTypeEl,"Name")),title:getElementText(findChildElement(featureTypeEl,"Title")),abstract:getElementText(findChildElement(featureTypeEl,"Abstract")),defaultCrs:simplifyEpsgUrn(getElementText(findChildElement(featureTypeEl,defaultSrsTag))),otherCrs,outputFormats:outputFormats.length>0?outputFormats:defaultOutputFormats,latLonBoundingBox:serviceVersion.startsWith("1.0")?parseBBox100():parseBBox()}}(featureTypeEl,version,outputFormats)))}function parseBBox(xmlElement){const result=["LowerCorner","UpperCorner"].map((elName=>findChildElement(xmlElement,elName))).map((cornerEl=>getElementText(cornerEl).split(" "))).reduce(((prev,curr)=>[...prev,...curr])).map(parseFloat);return result.some(Number.isNaN)?null:result}function wmts_capabilities_readInfoFromCapabilities(capabilitiesDoc){const rootEl=getRootElement(capabilitiesDoc),service=findChildElement(rootEl,"ServiceIdentification"),keywords=findChildrenElement(findChildElement(service,"Keywords"),"Keyword").map(getElementText),getTileOperation=findChildrenElement(findChildElement(rootEl,"OperationsMetadata"),"Operation").find((el=>"GetTile"==getElementAttribute(el,"name"))),getTileUrls=findChildrenElement(getTileOperation,"Get",!0).reduce(((prev,curr)=>{const encodingType=getElementText(findChildElement(curr,"Value",!0)),url=getElementAttribute(curr,"xlink:href");return"restful"===encodingType.toLowerCase()?{...prev,rest:url}:{...prev,kvp:url}}),{});return{title:getElementText(findChildElement(service,"Title")),name:getElementText(findChildElement(service,"ServiceType")),abstract:getElementText(findChildElement(service,"Abstract")),fees:getElementText(findChildElement(service,"Fees")),constraints:getElementText(findChildElement(service,"AccessConstraints")),keywords,getTileUrls}}function readMatrixSetsFromCapabilities(capabilitiesDoc){function parseMatrixSet(element){const topLeft=getElementText(findChildElement(element,"TopLeftCorner")).split(" ").map(parseFloat);return{identifier:getElementText(findChildElement(element,"Identifier")),tileWidth:parseInt(getElementText(findChildElement(element,"TileWidth"))),tileHeight:parseInt(getElementText(findChildElement(element,"TileHeight"))),matrixWidth:parseInt(getElementText(findChildElement(element,"MatrixWidth"))),matrixHeight:parseInt(getElementText(findChildElement(element,"MatrixHeight"))),scaleDenominator:parseFloat(getElementText(findChildElement(element,"ScaleDenominator"))),topLeft}}return findChildrenElement(findChildElement(getRootElement(capabilitiesDoc),"Contents"),"TileMatrixSet").map((element=>{const wellKnownScaleSet=getElementText(findChildElement(element,"WellKnownScaleSet")),boundingBox=parseBBox(findChildElement(element,"BoundingBox"));return{identifier:getElementText(findChildElement(element,"Identifier")),crs:getElementText(findChildElement(element,"SupportedCRS")),tileMatrices:findChildrenElement(element,"TileMatrix").map(parseMatrixSet),...boundingBox&&{boundingBox},...wellKnownScaleSet&&{wellKnownScaleSet}}}))}function capabilities_readLayersFromCapabilities(capabilitiesDoc){const rootEl=getRootElement(capabilitiesDoc),contentsEl=findChildElement(rootEl,"Contents");function parseMatrixSetLink(element){const fullMatrixSet=findChildrenElement(contentsEl,"TileMatrixSet").find((el=>getElementText(findChildElement(el,"Identifier"))));return{identifier:getElementText(findChildElement(element,"TileMatrixSet")),crs:getElementText(findChildElement(fullMatrixSet,"SupportedCRS")),limits:findChildrenElement(element,"TileMatrixLimits",!0).map((element2=>({tileMatrix:getElementText(findChildElement(element2,"TileMatrix")),minTileRow:parseInt(getElementText(findChildElement(element2,"MinTileRow"))),minTileCol:parseInt(getElementText(findChildElement(element2,"MinTileCol"))),maxTileRow:parseInt(getElementText(findChildElement(element2,"MaxTileRow"))),maxTileCol:parseInt(getElementText(findChildElement(element2,"MaxTileCol")))})))}}const getTileOperation=findChildrenElement(findChildElement(rootEl,"OperationsMetadata"),"Operation").find((el=>"GetTile"==getElementAttribute(el,"name"))),getKvpElt=findChildrenElement(getTileOperation,"Get",!0).filter((elt=>"kvp"===getElementText(findChildElement(elt,"Value",!0)).toLowerCase()))[0],getKvpUrl=getKvpElt?getElementAttribute(getKvpElt,"xlink:href"):"";return findChildrenElement(findChildElement(rootEl,"Contents"),"Layer").map((element=>{const latLonBoundingBox=parseBBox(findChildElement(element,"WGS84BoundingBox"));let defaultStyle="";const styles=findChildrenElement(element,"Style").map((element2=>{const legendUrl=getElementAttribute(findChildElement(element2,"LegendURL"),"xlink:href"),style={title:getElementText(findChildElement(element2,"Title")),name:getElementText(findChildElement(element2,"Identifier")),...legendUrl&&{legendUrl}};return"true"===getElementAttribute(element2,"isDefault")&&(defaultStyle=style.name),style})),outputFormats=findChildrenElement(element,"Format").map(getElementText),resourceLinks=findChildrenElement(element,"ResourceURL").filter((element2=>"tile"===getElementAttribute(element2,"resourceType"))).map((element2=>({format:getElementAttribute(element2,"format"),url:getElementAttribute(element2,"template"),encoding:"REST"})));getKvpUrl&&resourceLinks.push(...outputFormats.map((format=>({encoding:"KVP",url:getKvpUrl,format}))));const matrixSets=findChildrenElement(element,"TileMatrixSetLink").map(parseMatrixSetLink),dimensions=findChildrenElement(element,"Dimension").map((element2=>({identifier:getElementText(findChildElement(element2,"Identifier")),defaultValue:getElementText(findChildElement(element2,"Default")),values:findChildrenElement(element2,"Values").map(getElementText)})));return{name:getElementText(findChildElement(element,"Identifier")),title:getElementText(findChildElement(element,"Title")),abstract:getElementText(findChildElement(element,"Abstract")),styles,resourceLinks,matrixSets,defaultStyle,...latLonBoundingBox&&{latLonBoundingBox},...dimensions&&{dimensions}}}))}function parseFeatureProps(getFeaturesDoc,featureTypeFull,serviceVersion){const collection=getRootElement(getFeaturesDoc);let members;if(serviceVersion.startsWith("2.0"))members=findChildrenElement(collection,"member").map((parent=>getChildrenElement(parent)[0]));else{const membersRoot=findChildElement(collection,"featureMembers");members=membersRoot?getChildrenElement(membersRoot):findChildrenElement(collection,"featureMember").map((parent=>getChildrenElement(parent)[0]))}const idAttr="1.0.0"===serviceVersion?"fid":"gml:id";function parseElementPropertyValue(propName,valueAsString){switch(featureTypeFull.properties[propName]){case"integer":return parseInt(valueAsString);case"float":return parseFloat(valueAsString);case"boolean":return"true"===valueAsString;default:return valueAsString}}function getProperties(memberEl){return getChildrenElement(memberEl).filter((el=>function isElementProperty(propName){return propName in featureTypeFull.properties}(stripNamespace(getElementName(el))))).reduce(((prev,curr)=>{const propName=stripNamespace(getElementName(curr));return{...prev,[propName]:parseElementPropertyValue(propName,getElementText(curr))}}),{})}return members.map((el=>({id:getElementAttribute(el,idAttr),properties:getProperties(el)})))}addTaskHandler("parseWmsCapabilities",globalThis,(({url})=>queryXmlDocument(url).then((xmlDoc=>({info:readInfoFromCapabilities(xmlDoc),layers:readLayersFromCapabilities(xmlDoc),version:readVersionFromCapabilities(xmlDoc)}))))),addTaskHandler("parseWfsCapabilities",globalThis,(({url})=>queryXmlDocument(url).then((xmlDoc=>({info:capabilities_readInfoFromCapabilities(xmlDoc),featureTypes:readFeatureTypesFromCapabilities(xmlDoc),version:capabilities_readVersionFromCapabilities(xmlDoc)}))))),addTaskHandler("queryWfsFeatureTypeDetails",globalThis,(({url,serviceVersion,featureTypeFull})=>queryXmlDocument(generateGetFeatureUrl(url,serviceVersion,featureTypeFull.name,void 0,void 0,Object.keys(featureTypeFull.properties))).then((getFeatureDoc=>{return{props:(featuresWithProps=parseFeatureProps(getFeatureDoc,featureTypeFull,serviceVersion),featuresWithProps.reduce(((prev,curr)=>{for(const propName in curr.properties){const propValue=curr.properties[propName];propName in prev||(prev[propName]={uniqueValues:[]});const uniqueValue=prev[propName].uniqueValues.find((v=>v.value===propValue));uniqueValue?uniqueValue.count++:prev[propName].uniqueValues.push({value:propValue,count:1})}return prev}),{}))};var featuresWithProps})))),addTaskHandler("updateFetchOptions",globalThis,(({options})=>(function setFetchOptions(options){fetchOptions=options,fetchOptionsUpdateCallback&&fetchOptionsUpdateCallback(options)}(options),Promise.resolve({})))),addTaskHandler("parseWmtsCapabilities",globalThis,(({url})=>queryXmlDocument(url).then((xmlDoc=>({info:wmts_capabilities_readInfoFromCapabilities(xmlDoc),layers:capabilities_readLayersFromCapabilities(xmlDoc),matrixSets:readMatrixSetsFromCapabilities(xmlDoc)})))))},"./node_modules/@camptocamp/ogc-client/node_modules/@rgrove/parse-xml/dist/browser.js":module=>{var mod,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,src_exports={};((target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})})(src_exports,{XmlCdata:()=>XmlCdata,XmlComment:()=>XmlComment,XmlDeclaration:()=>XmlDeclaration,XmlDocument:()=>XmlDocument,XmlDocumentType:()=>XmlDocumentType,XmlElement:()=>XmlElement,XmlError:()=>XmlError,XmlNode:()=>XmlNode,XmlProcessingInstruction:()=>XmlProcessingInstruction,XmlText:()=>XmlText,parseXml:()=>parseXml}),module.exports=(mod=src_exports,((to,from,except,desc)=>{if(from&&"object"==typeof from||"function"==typeof from)for(let key of __getOwnPropNames(from))__hasOwnProp.call(to,key)||key===except||__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to})(__defProp({},"__esModule",{value:!0}),mod));var surrogatePair=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,attValueCharDoubleQuote=/[^"&<]+/y,attValueCharSingleQuote=/[^'&<]+/y,attValueNormalizedWhitespace=/\r\n|[\n\r\t]/g,endCharData=/<|&|]]>/,predefinedEntities=Object.freeze(Object.assign(Object.create(null),{amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}));function isNameChar(char){let cp=getCodePoint(char);return cp>=97&&cp<=122||cp>=65&&cp<=90||cp>=48&&cp<=57||45===cp||46===cp||183===cp||cp>=768&&cp<=879||cp>=8255&&cp<=8256||isNameStartChar(char,cp)}function isNameStartChar(char,cp=getCodePoint(char)){return cp>=97&&cp<=122||cp>=65&&cp<=90||58===cp||95===cp||cp>=192&&cp<=214||cp>=216&&cp<=246||cp>=248&&cp<=767||cp>=880&&cp<=893||cp>=895&&cp<=8191||cp>=8204&&cp<=8205||cp>=8304&&cp<=8591||cp>=11264&&cp<=12271||cp>=12289&&cp<=55295||cp>=63744&&cp<=64975||cp>=65008&&cp<=65533||cp>=65536&&cp<=983039}function isReferenceChar(char){return"#"===char||isNameChar(char)}function isWhitespace(char){let cp=getCodePoint(char);return 32===cp||9===cp||10===cp||13===cp}function isXmlCodePoint(cp){return 9===cp||10===cp||13===cp||cp>=32&&cp<=55295||cp>=57344&&cp<=65533||cp>=65536&&cp<=1114111}function getCodePoint(char){return char.codePointAt(0)||-1}var _XmlNode=class{constructor(){this.parent=null,this.start=-1,this.end=-1}get document(){var _a,_b;return null!=(_b=null==(_a=this.parent)?void 0:_a.document)?_b:null}get isRootNode(){return null!==this.parent&&this.parent===this.document&&this.type===_XmlNode.TYPE_ELEMENT}get preserveWhitespace(){var _a;return!!(null==(_a=this.parent)?void 0:_a.preserveWhitespace)}get type(){return""}toJSON(){let json={type:this.type};return this.isRootNode&&(json.isRootNode=!0),this.preserveWhitespace&&(json.preserveWhitespace=!0),-1!==this.start&&(json.start=this.start,json.end=this.end),json}},XmlNode=_XmlNode;XmlNode.TYPE_CDATA="cdata",XmlNode.TYPE_COMMENT="comment",XmlNode.TYPE_DOCUMENT="document",XmlNode.TYPE_DOCUMENT_TYPE="doctype",XmlNode.TYPE_ELEMENT="element",XmlNode.TYPE_PROCESSING_INSTRUCTION="pi",XmlNode.TYPE_TEXT="text",XmlNode.TYPE_XML_DECLARATION="xmldecl";var XmlText=class extends XmlNode{constructor(text=""){super(),this.text=text}get type(){return XmlNode.TYPE_TEXT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{text:this.text})}},XmlCdata=class extends XmlText{get type(){return XmlNode.TYPE_CDATA}},XmlComment=class extends XmlNode{constructor(content=""){super(),this.content=content}get type(){return XmlNode.TYPE_COMMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{content:this.content})}},XmlDeclaration=class extends XmlNode{constructor(version,encoding,standalone){super(),this.version=version,this.encoding=null!=encoding?encoding:null,this.standalone=null!=standalone?standalone:null}get type(){return XmlNode.TYPE_XML_DECLARATION}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.version=this.version;for(let key of["encoding","standalone"])null!==this[key]&&(json[key]=this[key]);return json}},XmlElement=class extends XmlNode{constructor(name,attributes=Object.create(null),children=[]){super(),this.name=name,this.attributes=attributes,this.children=children}get isEmpty(){return 0===this.children.length}get preserveWhitespace(){let node=this;for(;node instanceof XmlElement;){if("xml:space"in node.attributes)return"preserve"===node.attributes["xml:space"];node=node.parent}return!1}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_ELEMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,attributes:this.attributes,children:this.children.map((child=>child.toJSON()))})}},XmlDocument=class extends XmlNode{constructor(children=[]){super(),this.children=children}get document(){return this}get root(){for(let child of this.children)if(child instanceof XmlElement)return child;return null}get text(){return this.children.map((child=>"text"in child?child.text:"")).join("")}get type(){return XmlNode.TYPE_DOCUMENT}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{children:this.children.map((child=>child.toJSON()))})}},XmlDocumentType=class extends XmlNode{constructor(name,publicId,systemId,internalSubset){super(),this.name=name,this.publicId=null!=publicId?publicId:null,this.systemId=null!=systemId?systemId:null,this.internalSubset=null!=internalSubset?internalSubset:null}get type(){return XmlNode.TYPE_DOCUMENT_TYPE}toJSON(){let json=XmlNode.prototype.toJSON.call(this);json.name=this.name;for(let key of["publicId","systemId","internalSubset"])null!==this[key]&&(json[key]=this[key]);return json}},XmlError=class extends Error{constructor(message,charIndex,xml){let column=1,excerpt="",line=1;for(let i=0;i<charIndex;++i){let char=xml[i];"\n"===char?(column=1,excerpt="",line+=1):(column+=1,excerpt+=char)}let eol=xml.indexOf("\n",charIndex);excerpt+=-1===eol?xml.slice(charIndex):xml.slice(charIndex,eol);let excerptStart=0;excerpt.length>50&&(column<40?excerpt=excerpt.slice(0,50):(excerptStart=column-20,excerpt=excerpt.slice(excerptStart,column+30))),super(`${message} (line ${line}, column ${column})\n  ${excerpt}\n`+" ".repeat(column-excerptStart+1)+"^\n"),this.column=column,this.excerpt=excerpt,this.line=line,this.name="XmlError",this.pos=charIndex}},XmlProcessingInstruction=class extends XmlNode{constructor(name,content=""){super(),this.name=name,this.content=content}get type(){return XmlNode.TYPE_PROCESSING_INSTRUCTION}toJSON(){return Object.assign(XmlNode.prototype.toJSON.call(this),{name:this.name,content:this.content})}},Parser=class{constructor(xml,options={}){let doc=this.document=new XmlDocument,scanner=this.c=new class{constructor(string){if(this.k=this.q(string,!0),this.d=0,this.length=string.length,this.n=this.k!==this.length,this.m=string,this.n){let charsToBytes=[];for(let byteIndex=0,charIndex=0;charIndex<this.k;++charIndex)charsToBytes[charIndex]=byteIndex,byteIndex+=string.codePointAt(byteIndex)>65535?2:1;this.y=charsToBytes}}get z(){return this.d>=this.k}q(string,multiByteSafe=this.n){return multiByteSafe?string.replace(surrogatePair,"_").length:string.length}g(count=1){this.d=Math.min(this.k,this.d+count)}i(charIndex=this.d){var _a;return this.n?null!=(_a=this.y[charIndex])?_a:1/0:charIndex}F(count=1){let chars=this.h(count);return this.g(count),chars}G(regex){if(!regex.sticky)throw new Error('`regex` must have a sticky flag ("y")');regex.lastIndex=this.i();let result=regex.exec(this.m);if(null===result||0===result.length)return"";let match=result[0];return this.g(this.q(match)),match}v(fn){let char,match="";for(;(char=this.h())&&fn(char);)match+=char,this.g();return match}Q(stringToConsume){if(this.b(stringToConsume))return stringToConsume;if(this.n){let{length}=stringToConsume,charLengthToMatch=this.q(stringToConsume);if(charLengthToMatch!==length&&stringToConsume===this.h(charLengthToMatch))return this.g(charLengthToMatch),stringToConsume}return""}b(stringToConsume){let{length}=stringToConsume;return this.h(length)===stringToConsume?(this.g(length),stringToConsume):""}A(regex){let restOfString=this.m.slice(this.i()),matchByteIndex=restOfString.search(regex);if(matchByteIndex<=0)return"";let result=restOfString.slice(0,matchByteIndex);return this.g(this.q(result)),result}t(searchString){let{m:string}=this,byteIndex=this.i(),matchByteIndex=string.indexOf(searchString,byteIndex);if(matchByteIndex<=0)return"";let result=string.slice(byteIndex,matchByteIndex);return this.g(this.q(result)),result}h(count=1){let{d:charIndex,n:multiByteMode,m:string}=this;return multiByteMode?charIndex>=this.k?"":string.slice(this.i(charIndex),this.i(charIndex+count)):string.slice(charIndex,charIndex+count)}o(index=0){this.d=index>=0?Math.min(this.k,index):Math.max(0,this.d+index)}}(xml);if(this.l=doc,this.f=options,this.f.includeOffsets&&(doc.start=0,doc.end=xml.length),scanner.b("\ufeff"),this.H(),!this.B())throw this.a("Root element is missing or invalid");for(;this.w(););if(!scanner.z)throw this.a("Extra content at the end of the document")}j(node,charIndex){return node.parent=this.l,this.f.includeOffsets&&(node.start=this.c.i(charIndex),node.end=this.c.i()),this.l.children.push(node),!0}x(text,charIndex){let{children}=this.l,{length}=children;if(text=normalizeLineBreaks(text),length>0){let prevNode=children[length-1];if((null==prevNode?void 0:prevNode.type)===XmlNode.TYPE_TEXT){let textNode=prevNode;return textNode.text+=text,this.f.includeOffsets&&(textNode.end=this.c.i()),!0}}return this.j(new XmlText(text),charIndex)}I(){let attributes=Object.create(null);for(;this.e();){let attrName=this.r();if(!attrName)break;let attrValue=this.u()&&this.J();if(!1===attrValue)throw this.a("Attribute value expected");if(attrName in attributes)throw this.a(`Duplicate attribute: ${attrName}`);if("xml:space"===attrName&&"default"!==attrValue&&"preserve"!==attrValue)throw this.a('Value of the `xml:space` attribute must be "default" or "preserve"');attributes[attrName]=attrValue}if(this.f.sortAttributes){let attrNames=Object.keys(attributes).sort(),sortedAttributes=Object.create(null);for(let i=0;i<attrNames.length;++i){let attrName=attrNames[i];sortedAttributes[attrName]=attributes[attrName]}attributes=sortedAttributes}return attributes}J(){let chars,{c:scanner}=this,quote=scanner.h();if('"'!==quote&&"'"!==quote)return!1;scanner.g();let isClosed=!1,value="",regex='"'===quote?attValueCharDoubleQuote:attValueCharSingleQuote;matchLoop:for(;!scanner.z;)switch(chars=scanner.G(regex),chars&&(this.p(chars),value+=chars.replace(attValueNormalizedWhitespace," ")),scanner.h()){case quote:isClosed=!0;break matchLoop;case"&":value+=this.C();continue;case"<":throw this.a("Unescaped `<` is not allowed in an attribute value");case"":break matchLoop}if(!isClosed)throw this.a("Unclosed attribute");return scanner.g(),value}K(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<![CDATA["))return!1;let text=scanner.t("]]>");if(this.p(text),!scanner.b("]]>"))throw this.a("Unclosed CDATA section");return this.f.preserveCdata?this.j(new XmlCdata(normalizeLineBreaks(text)),startIndex):this.x(text,startIndex)}L(){let{c:scanner}=this,startIndex=scanner.d,charData=scanner.A(endCharData);if(!charData)return!1;if(this.p(charData),"]]>"===scanner.h(3))throw this.a("Element content may not contain the CDATA section close delimiter `]]>`");return this.x(charData,startIndex)}D(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("\x3c!--"))return!1;let content=scanner.t("--");if(this.p(content),!scanner.b("--\x3e")){if("--"===scanner.h(2))throw this.a("The string `--` isn't allowed inside a comment");throw this.a("Unclosed comment")}return!this.f.preserveComments||this.j(new XmlComment(normalizeLineBreaks(content)),startIndex)}M(){let startIndex=this.c.d,ref=this.C();return!!ref&&this.x(ref,startIndex)}N(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<!DOCTYPE"))return!1;let publicId,systemId,internalSubset,name=this.e()&&this.r();if(!name)throw this.a("Expected a name");if(this.e()){if(scanner.b("PUBLIC")){if(publicId=this.e()&&this.O(),!1===publicId)throw this.a("Expected a public identifier");this.e()}if(void 0!==publicId||scanner.b("SYSTEM")){if(this.e(),systemId=this.s(),!1===systemId)throw this.a("Expected a system identifier");this.e()}}if(scanner.b("[")){if(internalSubset=scanner.A(/\][\x20\t\r\n]*>/),!scanner.b("]"))throw this.a("Unclosed internal subset");this.e()}if(!scanner.b(">"))throw this.a("Unclosed doctype declaration");return!this.f.preserveDocumentType||this.j(new XmlDocumentType(name,publicId,systemId,internalSubset),startIndex)}B(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<"))return!1;let name=this.r();if(!name)return scanner.o(startIndex),!1;let attributes=this.I(),isEmpty=!!scanner.b("/>"),element=new XmlElement(name,attributes);if(element.parent=this.l,!isEmpty){if(!scanner.b(">"))throw this.a(`Unclosed start tag for element \`${name}\``);this.l=element;do{this.L()}while(this.B()||this.M()||this.K()||this.E()||this.D());let endTagName,endTagMark=scanner.d;if(!scanner.b("</")||!(endTagName=this.r())||endTagName!==name)throw scanner.o(endTagMark),this.a(`Missing end tag for element ${name}`);if(this.e(),!scanner.b(">"))throw this.a(`Unclosed end tag for element ${name}`);this.l=element.parent}return this.j(element,startIndex)}u(){return this.e(),!!this.c.b("=")&&(this.e(),!0)}w(){return this.D()||this.E()||this.e()}r(){return isNameStartChar(this.c.h())?this.c.v(isNameChar):""}E(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?"))return!1;let name=this.r();if(!name)throw this.a("Invalid processing instruction");if("xml"===name.toLowerCase())throw scanner.o(startIndex),this.a("XML declaration isn't allowed here");if(!this.e()){if(scanner.b("?>"))return this.j(new XmlProcessingInstruction(name),startIndex);throw this.a("Whitespace is required after a processing instruction name")}let content=scanner.t("?>");if(this.p(content),!scanner.b("?>"))throw this.a("Unterminated processing instruction");return this.j(new XmlProcessingInstruction(name,normalizeLineBreaks(content)),startIndex)}H(){let{c:scanner}=this,startIndex=scanner.d;for(this.P();this.w(););if(this.N())for(;this.w(););return startIndex<scanner.d}O(){let startIndex=this.c.d,value=this.s();if(!1!==value&&!/^[-\x20\r\na-zA-Z0-9'()+,./:=?;!*#@$_%]*$/.test(value))throw this.c.o(startIndex),this.a("Invalid character in public identifier");return value}C(){let{c:scanner}=this;if(!scanner.b("&"))return!1;let parsedValue,ref=scanner.v(isReferenceChar);if(";"!==scanner.F())throw this.a("Unterminated reference (a reference must end with `;`)");if("#"===ref[0]){let codePoint="x"===ref[1]?parseInt(ref.slice(2),16):parseInt(ref.slice(1),10);if(isNaN(codePoint))throw this.a("Invalid character reference");if(!isXmlCodePoint(codePoint))throw this.a("Character reference resolves to an invalid character");parsedValue=String.fromCodePoint(codePoint)}else if(parsedValue=predefinedEntities[ref],void 0===parsedValue){let{ignoreUndefinedEntities,resolveUndefinedEntity}=this.f,wrappedRef=`&${ref};`;if(resolveUndefinedEntity){let resolvedValue=resolveUndefinedEntity(wrappedRef);if(null!=resolvedValue){let type=typeof resolvedValue;if("string"!==type)throw new TypeError(`\`resolveUndefinedEntity()\` must return a string, \`null\`, or \`undefined\`, but returned a value of type ${type}`);return resolvedValue}}if(ignoreUndefinedEntities)return wrappedRef;throw scanner.o(-wrappedRef.length),this.a(`Named entity isn't defined: ${wrappedRef}`)}return parsedValue}s(){let{c:scanner}=this,quote=scanner.b('"')||scanner.b("'");if(!quote)return!1;let value=scanner.t(quote);if(this.p(value),!scanner.b(quote))throw this.a("Missing end quote");return value}e(){return!!this.c.v(isWhitespace)}P(){let{c:scanner}=this,startIndex=scanner.d;if(!scanner.b("<?xml"))return!1;if(!this.e())throw this.a("Invalid XML declaration");let encoding,standalone,version=!!scanner.b("version")&&this.u()&&this.s();if(!1===version)throw this.a("XML version is missing or invalid");if(!/^1\.[0-9]+$/.test(version))throw this.a("Invalid character in version number");if(this.e()&&(encoding=!!scanner.b("encoding")&&this.u()&&this.s(),encoding&&this.e(),standalone=!!scanner.b("standalone")&&this.u()&&this.s(),standalone)){if("yes"!==standalone&&"no"!==standalone)throw this.a('Only "yes" and "no" are permitted as values of `standalone`');this.e()}if(!scanner.b("?>"))throw this.a("Invalid or unclosed XML declaration");return!this.f.preserveXmlDeclaration||this.j(new XmlDeclaration(version,encoding||void 0,standalone||void 0),startIndex)}a(message){let{c:scanner}=this;return new XmlError(message,scanner.d,scanner.m)}p(string){let{length}=string;for(let i=0;i<length;++i){let cp=string.codePointAt(i);if(!isXmlCodePoint(cp))throw this.c.o(-([...string].length-i)),this.a("Invalid character");cp>65535&&(i+=1)}}};function normalizeLineBreaks(text){let i=0;for(;-1!==(i=text.indexOf("\r",i));)text="\n"===text[i+1]?text.slice(0,i)+text.slice(i+1):text.slice(0,i)+"\n"+text.slice(i+1);return text}function parseXml(xml,options){return new Parser(xml,options).document}}}]);