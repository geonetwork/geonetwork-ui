<gn-ui-button
  type="outline"
  extraClass="w-full flex flex-row"
  [title]="title"
  [attr.aria-owns]="id"
  (click)="openOverlay()"
  (keydown)="handleTriggerKeydown($event)"
  cdkOverlayOrigin
  #overlayOrigin="cdkOverlayOrigin"
>
  <div class="flex-grow text-left truncate font-medium mr-2">
    {{ title }}
  </div>
  <div
    *ngIf="hasSelectedChoices"
    class="flex-shrink-0 rounded-full bg-primary text-white font-bold text-[13px] w-6 h-6 py-[3px] mr-1 selected-count"
  >
    {{ selected.length }}
  </div>
  <mat-icon class="flex-shrink-0 opacity-[40%]">
    <ng-container *ngIf="overlayOpen">expand_less</ng-container>
    <ng-container *ngIf="!overlayOpen">expand_more</ng-container>
  </mat-icon>
</gn-ui-button>

<ng-template
  cdkConnectedOverlay
  cdkConnectedOverlayHasBackdrop
  cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
  [cdkConnectedOverlayOrigin]="overlayOrigin"
  [cdkConnectedOverlayOpen]="overlayOpen"
  [cdkConnectedOverlayPositions]="overlayPositions"
  [cdkConnectedOverlayScrollStrategy]="scrollStrategy"
  [cdkConnectedOverlayFlexibleDimensions]="true"
  (backdropClick)="closeOverlay()"
  (detach)="closeOverlay()"
>
  <div
    class="bg-white border border-gray-300 rounded shadow-lg py-2 w-full overflow-x-hidden overflow-y-auto overlay-container"
    [style.max-height]="overlayMaxHeight"
    [style.width]="overlayWidth"
    role="listbox"
    tabindex="-1"
    [attr.id]="id"
    [attr.aria-multiselectable]="true"
    [attr.aria-label]="title"
    (keydown)="handleOverlayKeydown($event)"
  >
    <div
      *ngIf="allowSearch"
      class="border border-gray-300 rounded mb-2 mx-2 p-2 min-h-[44px] flex flex-row flex-wrap gap-2"
    >
      <button
        type="button"
        *ngFor="let selected of selectedChoices"
        [title]="selected.label"
        class="max-w-full bg-main text-white rounded pr-[7px] pl-[10px] flex flex-row items-center opacity-[70%] hover:opacity-100 focus:opacity-100 transition-all duration-100"
        (click)="select(selected, false)"
      >
        <span class="text-sm leading-[26px] truncate">{{
          selected.label
        }}</span>
        <span
          class="ml-1 px-[2.5px] rounded-full bg-white text-main h-[13px] w-[13px] leading-[13px] flex-shrink-0"
          >&times;</span
        >
      </button>
    </div>
    <label
      *ngFor="let choice of choices"
      class="flex px-5 py-1 w-full text-gray-900 cursor-pointer hover:text-primary-darkest hover:bg-gray-50 focus-within:text-primary-darkest focus-within:bg-gray-50 transition-all duration-100"
    >
      <input
        class="w-[18px] h-[18px] align-text-top flex-shrink-0"
        type="checkbox"
        #checkBox
        [checked]="isSelected(choice)"
        (change)="select(choice, $event.target.checked)"
      />
      <span class="ml-[8px] text-[14px] truncate">
        {{ choice.label }}
      </span>
    </label>
  </div>
</ng-template>
